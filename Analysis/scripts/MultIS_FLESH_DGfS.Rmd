---
title: "DGfS Modeling: Bridging the Gap: Exploring a Middle-Way Approach for Prosodic Annotation"
author: "Aleksandra Ćwiek, Alina Gregori, Paula G. Sánchez-Ramón, Frank Kügler, Pilar Prieto"
date: "2024-02-28"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 4
    toc_float: yes
    df_print: paged
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: '3'
  html_notebook:
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
editor_options: 
  chunk_output_type: console
  markdown: 
    wrap: 72
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

Prosodic annotation plays a critical role in linguistic research,
enabling a detailed exploration of communication subtleties in diverse
languages and contexts. Various methods for prosodic annotation exist,
with some well-known and accepted, such as ToBI [@silverman1992].
However, prosody research encounters challenges in the manual annotation
of data, primarily regarding inter-rater reliability, where multiple
annotators' agreement varies significantly [even between 60% and 90%,
@breen2012], leading to potential errors and manipulation.

Manual annotation remains time-consuming and labor-intensive, resulting
in limited data availability, hindering the development of reliable
computational models for comprehensive and robust prosodic annotation
across various schemes and languages [see @ananthakrishnan2008;
@rosenberg2010 as examples for ToBI on Standard American English]. To
tackle this challenge, our project aims to adopt a middle-way approach,
harnessing the expertise of skilled annotators alongside the power of
computational tools while being cautious of potential challenges such as
the complexity of prosody, interpretation of results, and ethical
considerations regarding biases in training data and social impacts. By
establishing robust computational models, we seek to significantly speed
up the annotation process, generalize findings to new linguistic data,
and pave the way for more extensive cross-linguistic studies in prosodic
research.

In our project, we aim to establish connections between prosodic
prominence marking and automatic predictions of focus conditions --
focus representing a pragmatic domain of prominence [cf. e.g.,
@krifka2008]. To achieve this, we will analyze data from German and
Catalan speakers producing focus types as degrees of prominence in a
semi-controlled environment. The perceived prominence of focus types in
these data was annotated on a scale from 0 to 3 for prosodic prominence
[DIMA, @kügler2015; @kügler2019; @kügler2022]. German and Catalan are
suitable languages for investigating the applicability of computational
systems across different languages, given their distinct prosodic
prominence marking in terms of rhythm class and accentuation patterns
[cf. @krahmer2007 for Germanic and Romance languages; @cole2019 for
differences between Spanish, French, and English].

To capture acoustic markers of prominence, such as F0 (max peak, mean,
range), intensity (max peak, mean, range), and duration, we will extract
these measures from the accented syllables of focused words. These
acoustic markers will serve as predictors in a Bayesian ordinal model to
rate prominence. Our models will account for language-specific
variations in acoustic features of prominence between Catalan and
German.

Our goal is to identify the most predictive features of prominence in
prosody for German and Catalan, effectively bridging the gap between
manual and computer-aided annotation. By establishing these links, we
aim to address the challenges posed by tiresome manual annotation.
Subsequently, we plan to employ our findings to build a classifier for
automatic focus-type assignment to utterances, which will undergo
verification by human annotators.

# Data preparation

## Source setup

```{r source setup, echo = TRUE, message=FALSE, warning = FALSE}

########## folders ##########
# current folder (first go to session -> set working directory -> to source file location)
parentfolder <- dirname(getwd())

data          <- paste0(parentfolder, '/MultIS_data/')
audiodata     <- paste0(parentfolder, '/audio_processed/')
dataworkspace <- paste0(parentfolder, '/data_processed/')
datamerged    <- paste0(parentfolder, '/data_merged/')
models        <- paste0(parentfolder, '/models/')
plots         <- paste0(parentfolder, '/plots/')
scripts       <- paste0(parentfolder, '/scripts/')

########## source file ##########

#source(paste0(scripts, "adjectives-preparation.R"))

#################### packages ####################

# audiovisual processing
library(seewave) # this for signal processing
library(signal)
library(rPraat)
library(dplR)
library(signal)
library(rstudioapi)
library(stringr)
library(wrassp)
library(readr)
library(readxl)
library(readtextgrid)   #reading txt grids
library(textgRid)
library(zoo)
library(pracma)
#library(stringi) # for syllable replacement
library(tuneR)

# data manipulation and viz
library(tidyverse)
library(ggpubr)
library(gridExtra)
colorBlindBlack8  <- c("#000000", "#E69F00", "#56B4E9", "#009E73", 
                       "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

# modeling
library(broom) # for tidy model outputs
library(brms)
library(cmdstanr)
library(HDInterval) # package for credible interval computation
library(tidybayes) # plotting
library(bayesplot)
# option for Bayesian regression models:
# use all available cores for parallel computing
options(mc.cores = parallel::detectCores())

# Bayes factor
#library(BayesFactor)
library(bayestestR)

# Diagnostics GUI
library(shinystan)

```

```{r read df, echo=TRUE, message=FALSE, warning=FALSE}
df <- read.csv(paste0(data, "df.csv"))
```


# Descriptive statistics

Now that we have a table with stressed and pre and postonic syllables,
let us look at some descriptive statistics.

Correct inconsistencies in spelling.

```{r correct syll, echo=TRUE, message=FALSE, warning=FALSE}
# Update df with modified 'Syll' values
df <- df %>%
  mutate(Syll = case_when(
    Syll == "<p>Y" ~ "<p>",
    Syll == "Pre" ~ "pre",
    Syll == "Post" ~ "post",
    Syll == "pre_post" ~ "post_pre",
    Syll == "Pre_Post" ~ "post_pre",
    Syll == "Post_Pre" ~ "post_pre",
    Syll == "Post_pre" ~ "post_pre",
    Syll == "post:pre" ~ "post_pre",
    Syll == "post-pre" ~ "post_pre",
    Syll == "post–pre" ~ "post_pre",
    Syll == "post_Pre" ~ "post_pre",
    Syll == "prepost" ~ "post_pre",
    Syll == "post_post" ~ "post_pre",
    Syll == "post_pre " ~ "post_pre", # Remove trailing space
    TRUE ~ Syll # Keep other values as they are
  ))

unique(df$Syll)
```

Correct column Word.

```{r}
df <- df %>%
  # Replace "N\t" with "N"
  mutate(Word = gsub("N\\t", "N", Word)) %>%
  # Change "NP" to "N" and "Adj" to "A"
  mutate(Word = case_when(
    Word == "NP" ~ "N",
    Word == "Adj" ~ "A",
    TRUE ~ Word
  )) %>%
  # Convert Word column to factor after all replacements
  mutate(Word = as.factor(Word)) %>%
  # Filter out specific rows based on Syll_num and File
  filter(!(Syll_num == 8 & File == "C08_T_21_C") & 
         !(Syll_num == 2 & File == "G26_T_31_B"))
```

Correct prominence ratings.

```{r}
df <- df %>%
  # First, handle the specific updates for Prosodic_Prom
  mutate(# Ensure Prosodic_Prom is numeric before applying case_when
    Prosodic_Prom = as.numeric(Prosodic_Prom),
    Prosodic_Prom = case_when(
    File == "G17_T_35_B" & Syll == "pfan" ~ 2,
    File == "C02_T_13_I" & Syll == "lor_pre" ~ 1,
    File == "C02_T_14_F" & Syll == "lor_pre" ~ 1,
    TRUE ~ Prosodic_Prom
  )) %>%
  # Then, filter out the specific row to delete
  # This case is arguably important, but since it is not the real target word, I delete it
  filter(!(File == "G14_T_22_R" & Syll == "an"))
```

For some plots, we also need a subset of only target syllables.

```{r target sylls only, echo=TRUE, message=FALSE, warning=FALSE}
# Create subset without pre and post-tonic
df_targets <- df %>%
  filter(!(Syll %in% c("pre", "post", "", "post_pre", "disfluency", "break", "<p>")))
```

## NAs prior to outlier removal

```{r calculate NAs, echo=TRUE, message=FALSE, warning=FALSE}
# Columns to process
columns_to_process <- c("duration", "F0_mean", "F0_max", "F0_min", "F0_range", 
                        "env_mean", "env_max", "env_min", "env_range"
                        )

# Function to calculate raw number and proportion of NAs
calculate_na_stats <- function(df, columns) {
  na_counts <- colSums(is.na(df[, columns]))
  total_counts <- nrow(df)
  proportions <- na_counts / total_counts * 100
  return(data.frame("NA_Count" = na_counts, "Proportion" = proportions))
}

# Initial NA stats
na_stats_before <- calculate_na_stats(df_targets, columns_to_process)
print(na_stats_before)
```

Replace Inf values.

```{r replace inf, echo=TRUE, message=FALSE, warning=FALSE}
# Loop through each column and replace Inf and -Inf with NA
for (col_name in columns_to_process) {
  # Replace Inf and -Inf with NA
  df[[col_name]][df[[col_name]] == Inf | df[[col_name]] == -Inf] <- NA
}

# Process targets again
df_targets <- df %>%
  filter(!(Syll %in% c("pre", "post", "", "post_pre", "disfluency", "break", "<p>")))

# NA stats after replacing Inf and -Inf
na_stats_after_replacement <- calculate_na_stats(df_targets, columns_to_process)
print(na_stats_after_replacement)
```

## Outliers

```{r outliers, eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE}
# Initialize a list to store outlier information
outliers_info <- list()

# Loop through each column
for (col_name in columns_to_process) {
  cat("Processing column:", col_name, "\n")
  
  # Calculate IQR
  Q1 <- quantile(df[[col_name]], 0.25, na.rm = TRUE)
  Q3 <- quantile(df[[col_name]], 0.75, na.rm = TRUE)
  IQR <- Q3 - Q1
  
  # Define lower and upper bounds for outliers
  lower_bound <- Q1 - 1.5 * IQR
  upper_bound <- Q3 + 1.5 * IQR
  
  # Identify outliers
  outliers <- df[[col_name]] < lower_bound | df[[col_name]] > upper_bound
  
  # Get outlier information
  outliers_info[[col_name]] <- list(
    N_outliers = sum(outliers, na.rm = TRUE),
    Prop_outliers = (sum(outliers, na.rm = TRUE) / length(df[[col_name]])) * 100,
    Mean_outliers = mean(df[[col_name]][outliers], na.rm = TRUE),
    Mean_with_outliers = mean(df[[col_name]], na.rm = TRUE),
    Mean_without_outliers = mean(df[[col_name]][!outliers], na.rm = TRUE)
  )
  
  # Replace outliers with NA
  df[[col_name]][outliers] <- NA
}

# Create a summary table
outliers_summary <- data.frame(t(sapply(outliers_info, unlist)))
colnames(outliers_summary) <- c("N_outliers", "Prop_outliers", "Mean_outliers", "Mean_with_outliers", "Mean_without_outliers")

# Remove unnecessary variables
rm(outliers_info, Q1, Q3, lower_bound, upper_bound, IQR, col_name)

# Print the summary table
print(outliers_summary)
```

Check NAs after all removals

```{r NAs after all, echo=TRUE, message=FALSE, warning=FALSE}
# Process targets again
df_targets <- df %>%
  filter(!(Syll %in% c("pre", "post", "", "post_pre", "disfluency", "break", "<p>")))

# NA stats after outlier removal
na_stats_after_outliers <- calculate_na_stats(df_targets, columns_to_process)
print(na_stats_after_outliers)

rm(columns_to_process)
```

## Frequencies and proportions

How many target syllables do we have per language?

```{r sylls per lang, echo=TRUE, message=FALSE, warning=FALSE}
df %>%
  filter(!(Syll %in% c("pre", "post", "", "post_pre", "disfluency", "break", "<p>"))) %>%
  group_by(Language) %>%
  summarize(Cumulative_Count = n())
```

How are they distributed across different focus conditions?

```{r sylls per foc, echo=TRUE, message=FALSE, warning=FALSE}
syll_per_foc <- 
  df %>%
  filter(!(Syll %in% c("pre", "post", "", "post_pre", "disfluency", "break", "<p>"))) %>%
  group_by(Language, Focus) %>%
  summarize(Count = n()) %>%
  mutate(Proportion = Count / sum(Count))
syll_per_foc

## Count
ggplot(syll_per_foc, aes(x = Focus, y = Count, fill = Language)) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.7) +
  labs(#title = "Count of focus types",
       x = "Focus", y = "Count") +
  scale_fill_manual(values = colorBlindBlack8) + 
  theme_minimal()
ggsave(filename = paste0(plots, "focus_count.pdf"), plot = last_plot(), width = 6, height = 4)


## Proportion
ggplot(syll_per_foc, aes(x = Focus, y = Proportion, fill = Language)) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.7) +
  labs(#title = "Proportion of focus types",
       x = "Focus", y = "Proportion") +
  scale_fill_manual(values = colorBlindBlack8) + 
  theme_minimal()
ggsave(filename = paste0(plots, "focus_prop.pdf"), plot = last_plot(), width = 6, height = 4)
```

And how are they distributed across perceived prosodic prominence
ratings?

```{r sylls per pros, echo=TRUE, message=FALSE, warning=FALSE}
syll_per_pros <- 
  df %>%
  filter(!(Syll %in% c("pre", "post", "", "post_pre", "disfluency", "break", "<p>"))) %>%
  group_by(Language, Prosodic_Prom) %>%
  summarize(Count = n()) %>%
  mutate(Proportion = Count / sum(Count))
syll_per_pros

# Identify NA
df %>%
  filter(!(Syll %in% c("pre", "post", "", "post_pre", "disfluency", "break", "<p>"))) %>%
  filter(Language == "German", is.na(Prosodic_Prom)) %>%
  select(File, Syll)
df %>%
  filter(!(Syll %in% c("pre", "post", "", "post_pre", "disfluency", "break", "<p>"))) %>%
  filter(Language == "Catalan", is.na(Prosodic_Prom)) %>%
  select(File, Syll)

## Count
ggplot(syll_per_pros, aes(x = Prosodic_Prom, y = Count, fill = Language)) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.7) +
  labs(#title = "Count of Syll per Language and Prominence",
       x = "Perceived prominence", y = "Count") +
  scale_fill_manual(values = colorBlindBlack8) + 
  theme_minimal()
ggsave(filename = paste0(plots, "prominence_count.pdf"), plot = last_plot(), width = 6, height = 4)

## Proportion
ggplot(syll_per_pros, aes(x = Prosodic_Prom, y = Proportion, fill = Language)) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.7) +
  labs(#title = "Proportion of Syll per Language and Prominence",
       x = "Perceived prominence", y = "Proportion") +
  scale_fill_manual(values = colorBlindBlack8) + 
  theme_minimal()
ggsave(filename = paste0(plots, "prominence_prop.pdf"), plot = last_plot(), width = 6, height = 4)
```

Update df_targets

```{r target sylls update, echo=TRUE, message=FALSE, warning=FALSE}
df_targets <- df %>%
  filter(!(Syll %in% c("pre", "post", "", "post_pre", "disfluency", "break", "<p>")))
```


## Averages prominence

### Duration

What is the average duration of the different prosodic prominence
ratings in Catalan vs in German?

```{r avg duration prom, echo=TRUE, message=FALSE, warning=FALSE}
df %>%
  filter(!(Syll %in% c("pre", "post", "", "post_pre", "disfluency", "break", "<p>"))) %>%
  group_by(Language, Prosodic_Prom) %>%
  summarize(Average_Duration = mean(duration, na.rm = TRUE))
```

Let's plot it.

```{r avg duration plot, echo=TRUE, message=FALSE, warning=FALSE}
ggplot(df_targets %>% filter(!is.na(Prosodic_Prom)), aes(x = Language, y = duration, fill = as.factor(Prosodic_Prom))) +
  geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +
  geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
  labs(
    #title = "Duration of Prosodic Prominence Ratings by Language",
    x = "Language",
    y = "Duration",
    fill = "Prosodic prominence"
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  theme_minimal()
ggsave(filename = paste0(plots, "prominence_duration.pdf"), plot = last_plot(), width = 6, height = 4)
```

### Mean f0

What is the average F0 of the different prosodic prominence ratings in
Catalan vs in German?

```{r avg F0 prom, echo=TRUE, message=FALSE, warning=FALSE}
# Calculate z-scores for F0 within each combination of Language and Speaker
df_targets <- df_targets %>%
  group_by(Language, Participant) %>%
  mutate(F0_mean_z = scale(F0_mean))

# Calculate means for raw F0
df_targets %>%
  group_by(Language, Prosodic_Prom) %>%
  summarize(Average_F0 = mean(F0_mean, na.rm = TRUE))

# Calculate means for z-scored F0
df_targets %>%
  group_by(Language, Prosodic_Prom) %>%
  summarize(Average_F0_z = mean(F0_mean_z, na.rm = TRUE))
```

Let's plot it.

```{r avg F0 plot prom, echo=TRUE, message=FALSE, warning=FALSE}
## Raw F0
ggplot(df_targets %>% filter(!is.na(Prosodic_Prom)), aes(x = Language, y = F0_mean, fill = as.factor(Prosodic_Prom))) +
  geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +
  geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
  labs(
    #title = "F0 means of Prosodic Prominence Ratings by Language",
    x = "Language",
    y = "Mean f0 (Hertz)",
    fill = "Prosodic prominence"
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  theme_minimal()
ggsave(filename = paste0(plots, "prominence_f0Mean_raw.pdf"), plot = last_plot(), width = 6, height = 4)

## z-scored F0
ggplot(df_targets %>% filter(!is.na(Prosodic_Prom)), aes(x = Language, y = F0_mean_z, fill = as.factor(Prosodic_Prom))) +
  geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +
  geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
  labs(
    #title = "F0 means of Prosodic Prominence Ratings by Language",
    x = "Language",
    y = "Mean f0 (z-scored)",
    fill = "Prosodic prominence"
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  theme_minimal()
ggsave(filename = paste0(plots, "prominence_f0Mean_z.pdf"), plot = last_plot(), width = 6, height = 4)
```

### F0 range

What is the average F0 of the different prosodic prominence ratings in
Catalan vs in German?

```{r range F0 prom, echo=TRUE, message=FALSE, warning=FALSE}
# Calculate z-scores for F0 within each combination of Language and Speaker
df_targets <- df_targets %>%
  group_by(Language, Participant) %>%
  mutate(F0_range_z = scale(F0_range))

# Calculate means for raw F0
df_targets %>%
  group_by(Language, Prosodic_Prom) %>%
  summarize(Average_F0_range = mean(F0_range, na.rm = TRUE))

# Calculate means for z-scored F0
df_targets %>%
  group_by(Language, Prosodic_Prom) %>%
  summarize(Average_F0_range_z = mean(F0_range_z, na.rm = TRUE))
```

Let's plot it.

```{r range F0 plot prom, echo=TRUE, message=FALSE, warning=FALSE}
## Raw F0
ggplot(df_targets %>% filter(!is.na(Prosodic_Prom)), aes(x = Language, y = F0_range, fill = as.factor(Prosodic_Prom))) +
  geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +
  geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
  labs(
    #title = "F0 means of Prosodic Prominence Ratings by Language",
    x = "Language",
    y = "f0 range (Hertz)",
    fill = "Prosodic prominence"
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  theme_minimal()
ggsave(filename = paste0(plots, "prominence_f0Range_raw.pdf"), plot = last_plot(), width = 6, height = 4)

## z-scored F0
ggplot(df_targets %>% filter(!is.na(Prosodic_Prom)), aes(x = Language, y = F0_range_z, fill = as.factor(Prosodic_Prom))) +
  geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +
  geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
  labs(
    #title = "F0 means of Prosodic Prominence Ratings by Language",
    x = "Language",
    y = "f0 range (z-scored)",
    fill = "Prosodic prominence"
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  theme_minimal()
ggsave(filename = paste0(plots, "prominence_f0Range_z.pdf"), plot = last_plot(), width = 6, height = 4)
```

### Mean amplitude envelope

What is the average amplitude envelope of the different prosodic
prominence ratings in Catalan vs in German?

```{r avg env prom, echo=TRUE, message=FALSE, warning=FALSE}
# Calculate z-scores for F0 within each combination of Language and Speaker
df_targets <- df_targets %>%
  group_by(Language, Participant) %>%
  mutate(env_mean_z = scale(env_mean))

# Calculate means for raw F0
df_targets %>%
  group_by(Language, Prosodic_Prom) %>%
  summarize(Average_env = mean(env_mean, na.rm = TRUE))

# Calculate means for z-scored F0
df_targets %>%
  group_by(Language, Prosodic_Prom) %>%
  summarize(Average_env_z = mean(env_mean_z, na.rm = TRUE))
```

Let's plot it.

```{r avg env plot prom, echo=TRUE, message=FALSE, warning=FALSE}
## Raw env
ggplot(df_targets %>% filter(!is.na(Prosodic_Prom)), aes(x = Language, y = env_mean, fill = as.factor(Prosodic_Prom))) +
  geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +
  geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
  labs(
    #title = "ENV means of Prosodic Prominence Ratings by Language",
    x = "Language",
    y = "Mean amplitude envelope",
    fill = "Prosodic Prominence"
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  theme_minimal()
ggsave(filename = paste0(plots, "prominence_envMean_raw.pdf"), plot = last_plot(), width = 6, height = 4)

## z-scored env
ggplot(df_targets %>% filter(!is.na(Prosodic_Prom)), aes(x = Language, y = env_mean_z, fill = as.factor(Prosodic_Prom))) +
  geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +
  geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
  labs(
    #title = "ENV means of Prosodic Prominence Ratings by Language",
    x = "Language",
    y = "Mean amplitude envelope (z-scored)",
    fill = "Prosodic Prominence"
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  theme_minimal()
ggsave(filename = paste0(plots, "prominence_envMean_z.pdf"), plot = last_plot(), width = 6, height = 4)
```

### Amplitude envelope range

What is the average amplitude envelope of the different prosodic
prominence ratings in Catalan vs in German?

```{r range env prom, echo=TRUE, message=FALSE, warning=FALSE}
# Calculate z-scores for F0 within each combination of Language and Speaker
df_targets <- df_targets %>%
  group_by(Language, Participant) %>%
  mutate(env_range_z = scale(env_range))

# Calculate means for raw envelope range
df_targets %>%
  group_by(Language, Prosodic_Prom) %>%
  summarize(Average_env_range = mean(env_range, na.rm = TRUE))

# Calculate means for z-scored envelope range
df_targets %>%
  group_by(Language, Prosodic_Prom) %>%
  summarize(Average_env_range_z = mean(env_range_z, na.rm = TRUE))
```

Let's plot it.

```{r range env plot prom, echo=TRUE, message=FALSE, warning=FALSE}
## Raw env
ggplot(df_targets %>% filter(!is.na(Prosodic_Prom)), aes(x = Language, y = env_range, fill = as.factor(Prosodic_Prom))) +
  geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +
  geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
  labs(
    #title = "ENV means of Prosodic Prominence Ratings by Language",
    x = "Language",
    y = "Amplitude envelope range",
    fill = "Prosodic prominence"
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  theme_minimal()
ggsave(filename = paste0(plots, "prominence_envRange_raw.pdf"), plot = last_plot(), width = 6, height = 4)

## z-scored env
ggplot(df_targets %>% filter(!is.na(Prosodic_Prom)), aes(x = Language, y = env_range_z, fill = as.factor(Prosodic_Prom))) +
  geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +
  geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
  labs(
    #title = "ENV means of Prosodic Prominence Ratings by Language",
    x = "Language",
    y = "Amplitude envelope range (z-scored)",
    fill = "Prosodic prominence"
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  theme_minimal()
ggsave(filename = paste0(plots, "prominence_envRange_z.pdf"), plot = last_plot(), width = 6, height = 4)
```

## Averages focus

Change levels.

```{r}
df$Focus <- factor(df$Focus, levels = c("background", "information", "filler", "contrastive", "corrective"))
df_targets$Focus <- factor(df_targets$Focus, levels = c("background", "information", "filler", "contrastive", "corrective"))
```

### Duration

What is the average duration of the different focus conditions in
Catalan vs in German?

```{r avg duration, echo=TRUE, message=FALSE, warning=FALSE}
df %>%
  filter(!(Syll %in% c("pre", "post", "", "post_pre", "disfluency", "break", "<p>"))) %>%
  group_by(Language, Focus, Word) %>%
  summarize(Average_Duration = mean(duration, na.rm = TRUE)) %>% 
  print(n=30)
```

Let's plot it.

```{r avg duration plot focus, echo=TRUE, message=FALSE, warning=FALSE}
# Unique Word conditions to loop through
word_conditions <- unique(df_targets$Word)

# Loop through each Word condition to create, print, and save a plot
for (word in word_conditions) {
  # Filter the dataframe for the current Word condition
  df_filtered <- df_targets %>%
    filter(Word == word, !is.na(Focus))
  
  # Generate the plot
  p <- ggplot(df_filtered, aes(x = Language, y = duration, fill = as.factor(Focus))) +
    geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +
    geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
    labs(
      x = "Language",
      y = "Duration",
      fill = "Focus",
      title = word
    ) +
    scale_fill_manual(values = colorBlindBlack8) +
    theme_minimal()
  
  # Dynamically generate the filename
  filename <- paste0(plots, "focus_duration_", word, ".pdf")
  
  # Save the plot
  ggsave(filename = filename, plot = p, width = 6, height = 4)
}

rm(p,df_filtered,filename)
```

### Mean f0

What is the average F0 of the different Focus ratings in Catalan vs in
German?

```{r avg F0, echo=TRUE, message=FALSE, warning=FALSE}
# Calculate means for raw F0
df_targets %>%
  group_by(Language, Focus, Word) %>%
  summarize(Average_F0 = mean(F0_mean, na.rm = TRUE)) %>% 
  print(n = 30)

# Calculate means for z-scored F0
df_targets %>%
  group_by(Language, Focus, Word) %>%
  summarize(Average_F0_z = mean(F0_mean_z, na.rm = TRUE)) %>% 
  print(n = 30)
```

Let's plot it.

```{r avg F0 plot, echo=TRUE, message=FALSE, warning=FALSE}
# Unique Word conditions to loop through
word_conditions <- unique(df_targets$Word)

# Loop through each Word condition to create and save plots
for (word in word_conditions) {
  # Filter the dataframe for the current Word condition
  df_filtered <- df_targets %>%
    filter(Word == word, !is.na(Focus))
  
  # Plot for raw F0_mean
  p_raw <- ggplot(df_filtered, aes(x = Language, y = F0_mean, fill = as.factor(Focus))) +
    geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +
    geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
    labs(x = "Language", y = "Mean f0 (Hertz)", fill = "Focus", title = word) +
    scale_fill_manual(values = colorBlindBlack8) +
    theme_minimal()
  
  # Save the raw F0_mean plot
  ggsave(filename = paste0(plots, "focus_f0Mean_raw_", word, ".pdf"), plot = p_raw, width = 6, height = 4)
  
  # Plot for z-scored F0_mean
  p_z <- ggplot(df_filtered, aes(x = Language, y = F0_mean_z, fill = as.factor(Focus))) +
    geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +
    geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
    labs(x = "Language", y = "Mean f0 (z-scored)", fill = "Focus", title = word) +
    scale_fill_manual(values = colorBlindBlack8) +
    theme_minimal()
  
  # Save the z-scored F0_mean plot
  ggsave(filename = paste0(plots, "focus_f0Mean_z_", word, ".pdf"), plot = p_z, width = 6, height = 4)
}

rm(p_raw,p_z,df_filtered)
```

### F0 range

What is the average F0 of the different Focus ratings in Catalan vs in
German?

```{r range F0, echo=TRUE, message=FALSE, warning=FALSE}
# Calculate means for raw F0
df_targets %>%
  group_by(Language, Focus, Word) %>%
  summarize(Average_F0_range = mean(F0_range, na.rm = TRUE)) %>% 
  print(n = 30)

# Calculate means for z-scored F0
df_targets %>%
  group_by(Language, Focus, Word) %>%
  summarize(Average_F0_range_z = mean(F0_range_z, na.rm = TRUE)) %>% 
  print(n = 30)
```

Let's plot it.

```{r range F0 plot, echo=TRUE, message=FALSE, warning=FALSE}
# Unique Word conditions to loop through
word_conditions <- unique(df_targets$Word)

# Loop through each Word condition to create and save plots
for (word in word_conditions) {
  # Filter the dataframe for the current Word condition
  df_filtered <- df_targets %>%
    filter(Word == word, !is.na(Focus))
  
  # Plot for raw F0_mean
  p_raw <- ggplot(df_filtered, aes(x = Language, y = F0_range, fill = as.factor(Focus))) +
    geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +
    geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
    labs(x = "Language", y = "F0 range (Hertz)", fill = "Focus", title = word) +
    scale_fill_manual(values = colorBlindBlack8) +
    theme_minimal()
  
  # Save the raw F0_mean plot
  ggsave(filename = paste0(plots, "focus_f0Range_raw_", word, ".pdf"), plot = p_raw, width = 6, height = 4)
  
  # Plot for z-scored F0_mean
  p_z <- ggplot(df_filtered, aes(x = Language, y = F0_range_z, fill = as.factor(Focus))) +
    geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +
    geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
    labs(x = "Language", y = "F0 range (z-scored)", fill = "Focus", title = word) +
    scale_fill_manual(values = colorBlindBlack8) +
    theme_minimal()
  
  # Save the z-scored F0_mean plot
  ggsave(filename = paste0(plots, "focus_f0Range_z_", word, ".pdf"), plot = p_z, width = 6, height = 4)
}

rm(p_raw,p_z,df_filtered)
```

### Mean amplitude envelope

What is the average amplitude envelope of the different Focus ratings in
Catalan vs in German?

```{r avg env, echo=TRUE, message=FALSE, warning=FALSE}
# Calculate means for raw F0
df_targets %>%
  group_by(Language, Focus, Word) %>%
  summarize(Average_env = mean(env_mean, na.rm = TRUE)) %>% 
  print(n = 30)

# Calculate means for z-scored F0
df_targets %>%
  group_by(Language, Focus, Word) %>%
  summarize(Average_env_z = mean(env_mean_z, na.rm = TRUE)) %>% 
  print(n = 30)
```

Let's plot it.

```{r avg env plot, echo=TRUE, message=FALSE, warning=FALSE}
# Unique Word conditions to loop through
word_conditions <- unique(df_targets$Word)

# Loop through each Word condition to create and save plots
for (word in word_conditions) {
  # Filter the dataframe for the current Word condition
  df_filtered <- df_targets %>%
    filter(Word == word, !is.na(Focus))
  
  p_raw <- ggplot(df_filtered, aes(x = Language, y = env_mean, fill = as.factor(Focus))) +
    geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +
    geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
    labs(x = "Language", y = "Mean amplitude envelope", fill = "Focus", title = word) +
    scale_fill_manual(values = colorBlindBlack8) +
    theme_minimal()
  
  ggsave(filename = paste0(plots, "focus_envMean_raw_", word, ".pdf"), plot = p_raw, width = 6, height = 4)
  
  p_z <- ggplot(df_filtered, aes(x = Language, y = env_mean_z, fill = as.factor(Focus))) +
    geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +
    geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
    labs(x = "Language", y = "Mean amplitude envelope (z-scored)", fill = "Focus", title = word) +
    scale_fill_manual(values = colorBlindBlack8) +
    theme_minimal()
  
  ggsave(filename = paste0(plots, "focus_envMean_z_", word, ".pdf"), plot = p_z, width = 6, height = 4)
}

rm(p_raw,p_z,df_filtered)
```

### Amplitude envelope range

What is the average amplitude envelope of the different Focus ratings in
Catalan vs in German?

```{r range env, echo=TRUE, message=FALSE, warning=FALSE}
# Calculate means for raw envelope range
df_targets %>%
  group_by(Language, Focus, Word) %>%
  summarize(Average_env_range = mean(env_range, na.rm = TRUE)) %>% 
  print(n = 30)

# Calculate means for z-scored envelope range
df_targets %>%
  group_by(Language, Focus, Word) %>%
  summarize(Average_env_range_z = mean(env_range_z, na.rm = TRUE)) %>% 
  print(n = 30)
```

Let's plot it.

```{r range env plot, echo=TRUE, message=FALSE, warning=FALSE}
# Unique Word conditions to loop through
word_conditions <- unique(df_targets$Word)

# Loop through each Word condition to create and save plots
for (word in word_conditions) {
  # Filter the dataframe for the current Word condition
  df_filtered <- df_targets %>%
    filter(Word == word, !is.na(Focus))
  
  p_raw <- ggplot(df_filtered, aes(x = Language, y = env_range, fill = as.factor(Focus))) +
    geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +
    geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
    labs(x = "Language", y = "Amplitude envelope range", fill = "Focus", title = word) +
    scale_fill_manual(values = colorBlindBlack8) +
    theme_minimal()
  
  ggsave(filename = paste0(plots, "focus_envRange_raw_", word, ".pdf"), plot = p_raw, width = 6, height = 4)
  
  p_z <- ggplot(df_filtered, aes(x = Language, y = env_range_z, fill = as.factor(Focus))) +
    geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +
    geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
    labs(x = "Language", y = "Amplitude envelope range (z-scored)", fill = "Focus", title = word) +
    scale_fill_manual(values = colorBlindBlack8) +
    theme_minimal()
  
  ggsave(filename = paste0(plots, "focus_envRange_z_", word, ".pdf"), plot = p_z, width = 6, height = 4)
}

rm(p_raw,p_z,df_filtered)
```

# Pre- and posttonic

Check which item type do main "target" syllables have (sanity-check).

```{r}
df %>%
  filter(!(Syll %in% c("pre", "post", "", "post_pre", "disfluency", "break", "<p>"))) %>%
  distinct(Item_type) %>%
  pull(Item_type)
```

All target, that is good.

Add scaled variables to df

```{r}
df <- df %>%
  group_by(Language, Participant) %>%
  mutate(env_mean_z = scale(env_mean),
         env_range_z = scale(env_range),
         env_min_z = scale(env_min),
         env_max_z = scale(env_max),
         env_slope_z = scale(env_slope),
         F0_mean_z = scale(F0_mean),
         F0_range_z = scale(F0_range),
         F0_min_z = scale(F0_min),
         F0_max_z = scale(F0_max),
         F0_slope_z = scale(F0_slope))
```


Create a new df that for each main target syllables also contains info
on the pre and post-tonic.

```{r}
# Combined process to find "pre" syllables for Syll_num - 1 based on initial conditions
df_prepost <- df %>%
  # First, find rows that do not match the initial exclusion criteria and get their File and Syll_num
  filter(!(Syll %in% c("pre", "post", "", "post_pre", "disfluency", "break", "<p>"))) %>%
  ## PRE
  # Then, for each of these, find the corresponding "pre" Syll for Syll_num - 1
  mutate(Syll_num_target = Syll_num - 1) %>%
  # Join df with itself based on File and the target Syll_num
  left_join(df, by = c("File", "Syll_num_target" = "Syll_num")) %>%
  # Remove the specified columns
  select(-Age.y, -Gender.y, -Word.y, -TP.y, -Focus.y, -Item_type.y, -Item_num.y, -Participant.y, -Language.y, -Syll_num_target) %>%
  # Modify the joined columns to be NA where Syll does not contain "pre"
  mutate(across(ends_with(".y"), ~ if_else(grepl("pre", Syll.y), ., NA), .names = "{.col}")) %>%
  # Dynamically rename columns that end with .y to end with _pre
  rename_with(~ sub("\\.y$", "_pre", .), ends_with(".y")) %>% 
  # Dynamically rename columns to remove the .x ending
  rename_with(~ sub("\\.x$", "", .), ends_with(".x")) %>% 
  ## POST
  # Now, for each of these, find the corresponding "post" Syll for Syll_num + 1
  mutate(Syll_num_target = Syll_num + 1) %>%
  # Join df with itself based on File and the target Syll_num
  left_join(df, by = c("File", "Syll_num_target" = "Syll_num")) %>% 
    # Remove the specified columns
  select(-Age.y, -Gender.y, -Word.y, -TP.y, -Focus.y, -Item_type.y, -Item_num.y, -Participant.y, -Language.y, -Syll_num_target) %>%
  # Modify the joined columns to be NA where Syll does not contain "pre"
  mutate(across(ends_with(".y"), ~ if_else(grepl("post", Syll.y), ., NA), .names = "{.col}")) %>%
  # Dynamically rename columns that end with .y to end with _pre
  rename_with(~ sub("\\.y$", "_post", .), ends_with(".y")) %>% 
  # Dynamically rename columns to remove the .x ending
  rename_with(~ sub("\\.x$", "", .), ends_with(".x"))

```

## Visualize pre- and posttonic

Prepare dataframe.

```{r}
# Assuming df is your data frame
df_long <- df_prepost %>%
  select(File, Language, Item_type, Focus, Syll_num,
         starts_with("F0_"), starts_with("env_"), starts_with("duration")) %>%
  pivot_longer(cols = -c(File, Language, Item_type, Focus, Syll_num),
               names_to = "variable",
               values_to = "value") %>%
  mutate(
    phase = case_when(
      grepl("_pre$", variable) ~ "pre",
      grepl("_post$", variable) ~ "post",
      TRUE ~ "target"
    ),
    # Remove suffixes from variable names for a cleaner look
    variable = gsub("_pre|_post", "", variable)
  )

# Correct the phase factor levels
df_long$phase <- factor(df_long$phase, levels = c("pre", "target", "post"))
```

### Variable x Language plots

```{r}
# Assuming colorBlindBlack8 and plots are defined
languages <- unique(df_long$Language)
variables <- unique(df_long$variable)

# Without lines
for (var in variables) {
  for (lang in languages) {
    # Filter df_long for the current language and variable
    data_filtered <- subset(df_long, variable == var & Language == lang)
    
    # Generate the plot for the current language and variable
    p <- ggplot(data = data_filtered, aes(x = phase, y = value, fill = phase)) +
      geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +
      geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
      scale_fill_manual(values = colorBlindBlack8) +
      labs(x = "Syllable",
           y = var,
           title = lang) +
      theme_minimal() +
      theme(legend.position = "none")
    
    # Dynamically generate the file name to include both language and variable
    file_name <- paste0(plots, "prepost_", var, "_", lang, ".pdf")
    
    # Save the plot
    ggsave(filename = file_name, plot = p, width = 10, height = 8)
  }
}

# With lines
for (var in variables) {
  for (lang in languages) {
    # Filter df_long for the current language and variable
    data_filtered <- subset(df_long, variable == var & Language == lang)
    
    # Generate the plot for the current language and variable
    p <- ggplot(data = data_filtered, aes(x = phase, y = value, fill = phase)) +
      geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +
      geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
      geom_line(aes(group = interaction(File, Syll_num)), color = "grey", alpha = 0.1) +
      scale_fill_manual(values = colorBlindBlack8) +
      labs(x = "Syllable",
           y = var,
           title = lang) +
      theme_minimal() +
      theme(legend.position = "none")
    
    # Dynamically generate the file name to include both language and variable
    file_name <- paste0(plots, "prepost_", var, "_lines", "_", lang, ".pdf")
    
    # Save the plot
    ggsave(filename = file_name, plot = p, width = 10, height = 8)
  }
}

rm(languages,lang,variables,var,data_filtered)

```

### Variables, Language side-by-side

```{r}
# Assuming colorBlindBlack8 and plots are defined
variables <- unique(df_long$variable)

# Without lines
for (var in variables) {
    # Filter df_long for the current language and variable
    data_filtered <- subset(df_long, variable == var)
    
    # Generate the plot for the current language and variable
    p <- ggplot(data = data_filtered, aes(x = phase, y = value, fill = Language)) +
      geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +
      geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
      scale_fill_manual(values = colorBlindBlack8) +
      labs(x = "Syllable",
           y = var) +
      theme_minimal()
    
    # Dynamically generate the file name to include both language and variable
    file_name <- paste0(plots, "prepost_", var, ".pdf")
    
    # Save the plot
    ggsave(filename = file_name, plot = p, width = 10, height = 8)
}

# With lines
for (var in variables) {
    # Filter df_long for the current language and variable
    data_filtered <- subset(df_long, variable == var)
    
    # Generate the plot for the current language and variable
    p <- ggplot(data = data_filtered, aes(x = phase, y = value, fill = Language)) +
      geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +
      geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
      geom_line(aes(group = interaction(File, Syll_num)), color = "grey", alpha = 0.1) +
      scale_fill_manual(values = colorBlindBlack8) +
      labs(x = "Syllable",
           y = var) +
      theme_minimal()
    
    # Dynamically generate the file name to include both language and variable
    file_name <- paste0(plots, "prepost_", var, "_lines", ".pdf")
    
    # Save the plot
    ggsave(filename = file_name, plot = p, width = 10, height = 8)
}

rm(variables,var,data_filtered)

```

### Duration

```{r}
df_long %>%
  filter(variable == "duration") %>%
  group_by(phase) %>%
  summarize(
    count = n(),
    mean = mean(value, na.rm = TRUE),
    median = median(value, na.rm = TRUE),
    sd = sd(value, na.rm = TRUE),
    min = min(value, na.rm = TRUE),
    max = max(value, na.rm = TRUE)
  )

# Plot F0_mean across phases using direct filtering within ggplot
ggplot(data = subset(df_long, variable == "duration"), 
       aes(x = phase, y = value, fill = Language)) +
  geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +
  geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
  scale_fill_manual(values = colorBlindBlack8) +
  #geom_violin(fill = "lightblue", color = "blue", alpha = 0.5) +
  #geom_point(position = position_jitter(width = 0.2, height = 0), alpha = 0.2, color = "darkblue") +
  labs(#title = "Distribution of F0_mean Across Phases",
       x = "Syllable", 
       y = "Duration") +
  theme_minimal()
ggsave(filename = paste0(plots, "prepost_duration.pdf"), plot = last_plot(), width = 10, height = 8)

ggplot(data = subset(df_long, variable == "duration"), 
       aes(x = phase, y = value, fill = phase)) +
  geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +
  geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
  geom_line(aes(group = interaction(File, Syll_num)), color = "grey", alpha = 0.1) +
  scale_fill_manual(values = colorBlindBlack8) +
  #geom_violin(fill = "lightblue", color = "blue", alpha = 0.5) +
  #geom_point(position = position_jitter(width = 0.2, height = 0), alpha = 0.2, color = "darkblue") +
  labs(#title = "Distribution of F0_mean Across Phases",
       x = "Syllable", 
       y = "Duration") +
  theme_minimal() +
  theme(legend.position = "none")
ggsave(filename = paste0(plots, "prepost_duration_lines.pdf"), plot = last_plot(), width = 10, height = 8)
```

### F0 mean

```{r}
df_long %>%
  filter(variable == "F0_mean") %>%
  group_by(phase) %>%
  summarize(
    count = n(),
    mean = mean(value, na.rm = TRUE),
    median = median(value, na.rm = TRUE),
    sd = sd(value, na.rm = TRUE),
    min = min(value, na.rm = TRUE),
    max = max(value, na.rm = TRUE)
  )

# Plot F0_mean across phases using direct filtering within ggplot
ggplot(data = subset(df_long, variable == "F0_mean"), 
       aes(x = phase, y = value, fill = phase)) +
  geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +
  geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
  scale_fill_manual(values = colorBlindBlack8) +
  #geom_violin(fill = "lightblue", color = "blue", alpha = 0.5) +
  #geom_point(position = position_jitter(width = 0.2, height = 0), alpha = 0.2, color = "darkblue") +
  labs(#title = "Distribution of F0_mean Across Phases",
       x = "Syllable", 
       y = "F0 mean") +
  theme_minimal() +
  theme(legend.position = "none")
ggsave(filename = paste0(plots, "prepost_F0mean.pdf"), plot = last_plot(), width = 10, height = 8)

ggplot(data = subset(df_long, variable == "F0_mean"), 
       aes(x = phase, y = value, fill = phase)) +
  geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +
  geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
  geom_line(aes(group = interaction(File, Syll_num)), color = "grey", alpha = 0.1) +
  scale_fill_manual(values = colorBlindBlack8) +
  #geom_violin(fill = "lightblue", color = "blue", alpha = 0.5) +
  #geom_point(position = position_jitter(width = 0.2, height = 0), alpha = 0.2, color = "darkblue") +
  labs(#title = "Distribution of F0_mean Across Phases",
       x = "Syllable", 
       y = "F0 mean") +
  theme_minimal() +
  theme(legend.position = "none")
ggsave(filename = paste0(plots, "prepost_F0mean_lines.pdf"), plot = last_plot(), width = 10, height = 8)
```

### F0 range

```{r}
# Plot F0_mean across phases using direct filtering within ggplot
ggplot(data = subset(df_long, variable == "F0_range"), 
       aes(x = phase, y = value)) +
  geom_violin(fill = "lightblue", color = "blue", alpha = 0.5) +
  geom_point(position = position_jitter(width = 0.2, height = 0), alpha = 0.5, color = "darkblue") +
  labs(#title = "Distribution of F0_mean Across Phases",
       x = "Syllable", 
       y = "f0 range") +
  theme_minimal()

ggplot(data = subset(df_long, variable == "F0_range"), 
       aes(x = phase, y = value)) +
  geom_violin(fill = "lightblue", color = "blue", alpha = 0.5) +
  geom_point(position = position_jitter(width = 0.2, height = 0), alpha = 0.5, color = "darkblue") +
  geom_line(aes(group = interaction(File, Syll_num)), color = "grey", alpha = 0.1) +
    labs(#title = "Distribution of F0_mean Across Phases",
       x = "Syllable", 
       y = "f0 range") +
  theme_minimal()
```

### Amplitude envelope mean

```{r}
# Plot F0_mean across phases using direct filtering within ggplot
ggplot(data = subset(df_long, variable == "env_mean"), 
       aes(x = phase, y = value)) +
  geom_violin(fill = "lightblue", color = "blue", alpha = 0.5) +
  geom_point(position = position_jitter(width = 0.2, height = 0), alpha = 0.5, color = "darkblue") +
  labs(#title = "Distribution of F0_mean Across Phases",
       x = "Syllable", 
       y = "Mean amplitude envelope") +
  theme_minimal()

ggplot(data = subset(df_long, variable == "env_mean"), 
       aes(x = phase, y = value)) +
  geom_violin(fill = "lightblue", color = "blue", alpha = 0.5) +
  geom_point(position = position_jitter(width = 0.2, height = 0), alpha = 0.5, color = "darkblue") +
  geom_line(aes(group = interaction(File, Syll_num)), color = "grey", alpha = 0.1) +
    labs(#title = "Distribution of F0_mean Across Phases",
       x = "Syllable", 
       y = "Mean amplitude envelope") +
  theme_minimal()
```

### Amplitude envelope range

```{r}
# Plot F0_mean across phases using direct filtering within ggplot
ggplot(data = subset(df_long, variable == "env_range"), 
       aes(x = phase, y = value)) +
  geom_violin(fill = "lightblue", color = "blue", alpha = 0.5) +
  geom_point(position = position_jitter(width = 0.2, height = 0), alpha = 0.5, color = "darkblue") +
  labs(#title = "Distribution of F0_mean Across Phases",
       x = "Syllable", 
       y = "Amplitude envelope range") +
  theme_minimal()

ggplot(data = subset(df_long, variable == "env_range"), 
       aes(x = phase, y = value)) +
  geom_violin(fill = "lightblue", color = "blue", alpha = 0.5) +
  geom_point(position = position_jitter(width = 0.2, height = 0), alpha = 0.5, color = "darkblue") +
  geom_line(aes(group = interaction(File, Syll_num)), color = "grey", alpha = 0.1) +
    labs(#title = "Distribution of F0_mean Across Phases",
       x = "Syllable", 
       y = "Amplitude envelope range") +
  theme_minimal()
```

# Modeling focus

Our question is whether different acoustic parameters can predict focus
conditions.

We leave out Focus = filler, and the two Focus conditions NC and PROP in Catalan.

```{r}
df_prepost_model <- df_prepost %>%
  filter(!(Focus == "filler" | 
           (Word %in% c("NC", "PRON"))))
```

Which acoustic parameters do we have for now?

```{r}
str(df_prepost_model)
```

1.  F0_mean

2.  F0_min

3.  F0_max

4.  F0_range

5.  env_mean

6.  env_min

7.  env_max

8.  env_range

9.  duration

10. F0_mean_pre

11. F0_min_pre

12. F0_max_pre

13. F0_range_pre

14. env_mean_pre

15. env_min_pre

16. env_max_pre

17. env_range_pre

18. duration_pre

19. F0_mean_post

20. F0_min_post

21. F0_max_post

22. F0_range_post

23. env_mean_post

24. env_min_post

25. env_max_post

26. env_range_post

27. duration_post

With the grouping parameters:

1.  Language

2.  Gender

3.  Age

These are a lot of variables, I don't know if the model will hold it. I
will first try without the pre- and post-tonic.

```{r}
df_prepost_model$Focus <- as.factor(df_prepost_model$Focus)

levels(df_prepost_model$Focus)

df_prepost_model$Focus <- factor(df_prepost_model$Focus, levels = c("background", "information", "contrastive", "corrective"))
```

Check distribution.

```{r}
table(df_prepost_model$Focus)

ggplot(df_prepost_model, aes(x = Focus)) +
  geom_bar() +
  labs(title = "Distribution of Focus Levels", x = "Focus", y = "Count") +
  theme_minimal()
```

## Priors

```{r}
get_prior(formula = Focus ~ 1 + F0_mean + F0_range + env_mean + env_range + duration +
            (1 + F0_mean + F0_range + env_mean + env_range + duration || Language) +
            (1 + F0_mean + F0_range + env_mean + env_range + duration || Gender),
          data = df_prepost_model,
          family = categorical())
```

## Full target only

```{r}
mdl_focusFullTarget <- brm(Focus ~ 1 + F0_mean + F0_range + env_mean + env_range + duration +
                            (1 + F0_mean + F0_range + env_mean + env_range + duration || Language) +
                            (1 + F0_mean + F0_range + env_mean + env_range + duration || Gender),
                   data = df_prepost_model,
                   #prior = priors_intOnlyH1,
                   family = categorical(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 2000,
                   warmup = 1000,
                   seed = 998,
                   control = list(max_treedepth = 13,
                                  adapt_delta = 0.99),
                   file = paste0(models, "mdl_focusFullTarget.rds"))

# if we need to compress the model more
#saveRDS(mdl_focusFullTarget, file = paste0(models, "mdl_focusFullTarget.rds"), compress = "xz")

mdl_focusFullTarget <- readRDS(paste0(models, "mdl_focusFullTarget.rds"))
```

## Separating for DGfS

### Priors

```{r}
priors_f0Mean <- c(
  prior('normal(0, 3)', class = 'Intercept'),
  prior('normal(0, 1)', class = b)
)

priors_f0Range <- c(
  prior('normal(0, 2)', class = 'Intercept'),
  prior('normal(0, 1)', class = b)
)

priors_envMean <- c(
  prior('normal(0, 1)', class = 'Intercept'),
  prior('normal(0, 0.5)', class = b)
)

priors_envRange <- c(
  prior('normal(0, 0.5)', class = 'Intercept'),
  prior('normal(0, 0.1)', class = b)
)

priors_dur <- c(
  prior('normal(0, 5)', class = 'Intercept'),
  prior('normal(0, 2)', class = b)
)
```

### Contrast-coding


```{r}
df_prepost_model <- df_prepost_model %>%
  mutate(
    Gender_s = if_else(Gender == "female", -0.5, 0.5),
    Word_s = if_else(Word == "N", -0.5, 0.5)
  )

df_prepost_model$Language <- as.factor(df_prepost_model$Language)
```

### Fixef interpretation

```{r}
transform_fixef <- function(model) {
  # Extract fixed effects summary
  fe_summary <- summary(model)$fixed
  
  # Initialize a dataframe to store results
  results <- data.frame(Term = rownames(fe_summary)[-1], 
                        Estimate_corr = numeric(length(rownames(fe_summary)[-1])),
                        Est_Error_corr = numeric(length(rownames(fe_summary)[-1])), 
                        Q2.5_corr = numeric(length(rownames(fe_summary)[-1])),
                        Q97.5_corr = numeric(length(rownames(fe_summary)[-1])), stringsAsFactors = FALSE)
  
  # Loop through each fixed effect, excluding the intercept
  for (i in 2:nrow(fe_summary)) {
    #term <- fe_summary$term[i]
    
    # Calculate transformations using column numbers for Q2.5 and Q97.5
    estimate_in_hz <- exp(fe_summary[1,1]) * exp(fe_summary[i, 1]) - exp(fe_summary[1,1])
    est_error_in_hz <- exp(fe_summary[1,1]) * exp(fe_summary[i, 2]) - exp(fe_summary[1,1])
    q2_5_in_hz <- exp(fe_summary[1,1]) * exp(fe_summary[i, 3]) - exp(fe_summary[1,1])
    q97_5_in_hz <- exp(fe_summary[1,1]) * exp(fe_summary[i, 4]) - exp(fe_summary[1,1])
    
    # Update results dataframe directly without rbind to maintain the association between terms and their calculations
    results$Estimate_corr[i-1] <- estimate_in_hz
    results$Est_Error_corr[i-1] <- est_error_in_hz
    results$Q2.5_corr[i-1] <- q2_5_in_hz
    results$Q97.5_corr[i-1] <- q97_5_in_hz
  }
  
  return(results)
}
```


### Models

#### Duration

##### No random structure

###### No interaction

```{r}
mdl_focus_dur_noRS <- brm(duration ~ 1 + Focus + Gender_s + Word_s,
                   data = df_prepost_model,
                   prior = priors_dur,
                   family = lognormal(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 2000,
                   warmup = 1000,
                   seed = 998,
                   control = list(max_treedepth = 12,
                                  adapt_delta = 0.99),
                   file = paste0(models, "mdl_focus_dur_noRS.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_dur_noRS <- readRDS(paste0(models, "mdl_focus_dur_noRS.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_dur_noRS)
```

```{r}
plot(mdl_focus_dur_noRS)
```

```{r}
pp_check(mdl_focus_dur_noRS, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_dur_noRS_loo.rds"))) {
  mdl_focus_dur_noRS_loo <- readRDS(paste0(models, "mdl_focus_dur_noRS_loo.rds"))
} else {
  mdl_focus_dur_noRS_loo <- loo(mdl_focus_dur_noRS)
  saveRDS(mdl_focus_dur_noRS_loo, paste0(models, "mdl_focus_dur_noRS_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_dur_noRS_loo
```

###### Interaction

Trying with interaction.

```{r}
mdl_focus_dur_noRS_int <- brm(duration ~ 1 + Focus * Gender_s + Focus * Word_s + Gender_s * Word_s, 
                   data = df_prepost_model,
                   prior = priors_dur,
                   family = lognormal(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 2000,
                   warmup = 1000,
                   seed = 998,
                   control = list(max_treedepth = 12,
                                  adapt_delta = 0.99),
                   file = paste0(models, "mdl_focus_dur_noRS_int.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_dur_noRS_int <- readRDS(paste0(models, "mdl_focus_dur_noRS_int.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_dur_noRS_int)
```

```{r}
plot(mdl_focus_dur_noRS_int)
```

```{r}
pp_check(mdl_focus_dur_noRS_int, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_dur_noRS_int_loo.rds"))) {
  mdl_focus_dur_noRS_int_loo <- readRDS(paste0(models, "mdl_focus_dur_noRS_int_loo.rds"))
} else {
  mdl_focus_dur_noRS_int_loo <- loo(mdl_focus_dur_noRS_int)
  saveRDS(mdl_focus_dur_noRS_int_loo, paste0(models, "mdl_focus_dur_noRS_int_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_dur_noRS_int_loo
```

##### No random slopes

###### No interaction

```{r}
mdl_focus_dur_noSlopes <- brm(duration ~ 1 + Focus + Gender_s + Word_s +
                               (1 | Language),
                   data = df_prepost_model,
                   prior = priors_dur,
                   family = lognormal(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 4000,
                   warmup = 2000,
                   seed = 998,
                   control = list(max_treedepth = 14,
                                  adapt_delta = 0.999),
                   file = paste0(models, "mdl_focus_dur_noSlopes.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_dur_noSlopes <- readRDS(paste0(models, "mdl_focus_dur_noSlopes.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_dur_noSlopes)
```

```{r}
plot(mdl_focus_dur_noSlopes)
```

```{r}
pp_check(mdl_focus_dur_noSlopes, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_dur_noSlopes_loo.rds"))) {
  mdl_focus_dur_noSlopes_loo <- readRDS(paste0(models, "mdl_focus_dur_noSlopes_loo.rds"))
} else {
  mdl_focus_dur_noSlopes_loo <- loo(mdl_focus_dur_noSlopes)
  saveRDS(mdl_focus_dur_noSlopes_loo, paste0(models, "mdl_focus_dur_noSlopes_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_dur_noSlopes_loo
```

###### Interaction

Trying with interaction.

```{r}
mdl_focus_dur_noSlopes_int <- brm(duration ~ 1 + Focus * Gender_s + Focus * Word_s + Gender_s * Word_s +
                               (1 | Language),
                   data = df_prepost_model,
                   prior = priors_dur,
                   family = lognormal(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 4000,
                   warmup = 2000,
                   seed = 998,
                   control = list(max_treedepth = 14,
                                  adapt_delta = 0.999),
                   file = paste0(models, "mdl_focus_dur_noSlopes_int.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_dur_noSlopes_int <- readRDS(paste0(models, "mdl_focus_dur_noSlopes_int.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_dur_noSlopes_int)
```

```{r}
plot(mdl_focus_dur_noSlopes_int)
```

```{r}
pp_check(mdl_focus_dur_noSlopes_int, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_dur_noSlopes_int_loo.rds"))) {
  mdl_focus_dur_noSlopes_int_loo <- readRDS(paste0(models, "mdl_focus_dur_noSlopes_int_loo.rds"))
} else {
  mdl_focus_dur_noSlopes_int_loo <- loo(mdl_focus_dur_noSlopes_int)
  saveRDS(mdl_focus_dur_noSlopes_int_loo, paste0(models, "mdl_focus_dur_noSlopes_int_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_dur_noSlopes_int_loo
```


##### With random structure

###### No interaction

```{r}
mdl_focus_dur_full <- brm(duration ~ 1 + Focus + Gender_s + Word_s +
                               (1 + Focus || Language),
                   data = df_prepost_model,
                   prior = priors_dur,
                   family = lognormal(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 4000,
                   warmup = 2000,
                   seed = 998,
                   control = list(max_treedepth = 14,
                                  adapt_delta = 0.999),
                   file = paste0(models, "mdl_focus_dur_full.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_dur_full <- readRDS(paste0(models, "mdl_focus_dur_full.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_dur_full)
```

```{r}
plot(mdl_focus_dur_full)
```

```{r}
pp_check(mdl_focus_dur_full, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_dur_full_loo.rds"))) {
  mdl_focus_dur_full_loo <- readRDS(paste0(models, "mdl_focus_dur_full_loo.rds"))
} else {
  mdl_focus_dur_full_loo <- loo(mdl_focus_dur_full)
  saveRDS(mdl_focus_dur_full_loo, paste0(models, "mdl_focus_dur_full_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_dur_full_loo
```

###### Interaction

Trying with interaction.

```{r}
mdl_focus_dur_full_int <- brm(duration ~ 1 + Focus * Gender_s + Focus * Word_s + Gender_s * Word_s +
                               (1 + Focus || Language),
                   data = df_prepost_model,
                   prior = priors_dur,
                   family = lognormal(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 4000,
                   warmup = 2000,
                   seed = 998,
                   control = list(max_treedepth = 14,
                                  adapt_delta = 0.999),
                   file = paste0(models, "mdl_focus_dur_full_int.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_dur_full_int <- readRDS(paste0(models, "mdl_focus_dur_full_int.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_dur_full_int)
```

```{r}
plot(mdl_focus_dur_full_int)
```

```{r}
pp_check(mdl_focus_dur_full_int, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_dur_full_int_loo.rds"))) {
  mdl_focus_dur_full_int_loo <- readRDS(paste0(models, "mdl_focus_dur_full_int_loo.rds"))
} else {
  mdl_focus_dur_full_int_loo <- loo(mdl_focus_dur_full_int)
  saveRDS(mdl_focus_dur_full_int_loo, paste0(models, "mdl_focus_dur_full_int_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_dur_full_int_loo
```

##### Best-fit

```{r}
comp_duration <- loo_compare(mdl_focus_dur_noRS_loo,
                             mdl_focus_dur_noRS_int_loo,
                             mdl_focus_dur_noSlopes_loo,
                             mdl_focus_dur_noSlopes_int_loo,
                             mdl_focus_dur_full_loo,
                             mdl_focus_dur_full_int_loo)
comp_duration
```

Look at it.

```{r}
summary(mdl_focus_dur_full_int)
```

Not bad.

```{r}
plot(mdl_focus_dur_full_int)
```

Looks ok. Some divergence.

```{r}
pp_check(mdl_focus_dur_full_int, ndraws = 100)
```

pp_check is ok-ish.

---

Interpreting the results.

```{r}
summary(mdl_focus_dur_full_int)

exp(fixef(mdl_focus_dur_full_int))

exp(fixef(mdl_focus_dur_full_int)[1,1]) #Intercept in ms
exp(fixef(mdl_focus_dur_full_int)[1,1])*exp(fixef(mdl_focus_dur_full_int)[6,1])-exp(fixef(mdl_focus_dur_full_int)[1,1]) # estimate Word_s
exp(fixef(mdl_focus_dur_full_int)[1,1])*exp(fixef(mdl_focus_dur_full_int)[9,1])-exp(fixef(mdl_focus_dur_full_int)[1,1]) # estimate Focuscorrective:Gender_s in Hz
exp(fixef(mdl_focus_dur_full_int)[1,1])*exp(fixef(mdl_focus_dur_full_int)[10,1])-exp(fixef(mdl_focus_dur_full_int)[1,1]) # estimate Focusinformation:Word_s in Hz
exp(fixef(mdl_focus_dur_full_int)[1,1])*exp(fixef(mdl_focus_dur_full_int)[12,1])-exp(fixef(mdl_focus_dur_full_int)[1,1]) # estimate Focuscorrective:Word_s in Hz

transform_fixef(mdl_focus_dur_full_int)
```


```{r}
hypothesis(mdl_focus_dur_full_int, c("Focusinformation < 0", 
                                            "Focuscontrastive < 0", 
                                            "Focuscorrective < 0", 
                                            "Gender_s < 0", 
                                            "Word_s > 0",
                                            "Focusinformation:Gender_s > 0",
                                            "Focuscontrastive:Gender_s > 0",
                                            "Focuscorrective:Gender_s < 0",
                                            "Focusinformation:Word_s < 0",
                                            "Focuscontrastive:Word_s > 0",
                                            "Focuscorrective:Word_s > 0",
                                            "Gender_s:Word_s > 0"))

plot(hypothesis(mdl_focus_dur_full_int, c("Focusinformation < 0", 
                                            "Focuscontrastive < 0", 
                                            "Focuscorrective < 0", 
                                            "Gender_s < 0", 
                                            "Word_s > 0",
                                            "Focusinformation:Gender_s > 0",
                                            "Focuscontrastive:Gender_s > 0",
                                            "Focuscorrective:Gender_s < 0",
                                            "Focusinformation:Word_s < 0",
                                            "Focuscontrastive:Word_s > 0",
                                            "Focuscorrective:Word_s > 0",
                                            "Gender_s:Word_s > 0")))
```

###### Posterior plot

```{r}
rownames(summary(mdl_focus_dur_full_int)$fixed)

post_focus_dur_full_int <- mdl_focus_dur_full_int %>% 
  gather_draws(`b_Focusinformation`, 
               `b_Focuscontrastive`, 
               `b_Focuscorrective`, 
               `b_Gender_s`, 
               `b_Word_s`, 
               `b_Focusinformation:Gender_s`, 
               `b_Focuscontrastive:Gender_s`, 
               `b_Focuscorrective:Gender_s`, 
               `b_Focusinformation:Word_s`, 
               `b_Focuscontrastive:Word_s`, 
               `b_Focuscorrective:Word_s`, 
               `b_Gender_s:Word_s`)

# Plotting intervals with densities
postplot_focus_dur_full_int <- 
  ggplot(post_focus_dur_full_int, 
         aes(x = .value, y = .variable)) +
  stat_halfeye(.width = 0.95, fill = colorBlindBlack8[2], alpha = 0.7, size = 2) +
  geom_segment(x = 0, xend = 0, y = -Inf, yend = Inf,
               linetype = "dashed", color = "grey", size = 1) + 
  theme_bw() +
  labs(x = "Posterior density", y = "Variable") +
  scale_x_continuous(limits = c(-2, 1.5))

postplot_focus_dur_full_int
ggsave(filename = paste0(plots, "postplot_focus_dur_full_int.pdf"), plot = postplot_focus_dur_full_int, width = 8, height = 12)

```



#### F0 mean

##### No random structure

###### No interaction

```{r}
mdl_focus_f0Mean_noRS <- brm(F0_mean ~ 1 + Focus + Gender_s + Word_s,
                   data = df_prepost_model,
                   prior = priors_f0Mean,
                   family = lognormal(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 2000,
                   warmup = 1000,
                   seed = 998,
                   control = list(max_treedepth = 12,
                                  adapt_delta = 0.99),
                   file = paste0(models, "mdl_focus_f0Mean_noRS.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_f0Mean_noRS <- readRDS(paste0(models, "mdl_focus_f0Mean_noRS.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_f0Mean_noRS)
```

```{r}
plot(mdl_focus_f0Mean_noRS)
```

```{r}
pp_check(mdl_focus_f0Mean_noRS, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_f0Mean_noRS_loo.rds"))) {
  mdl_focus_f0Mean_noRS_loo <- readRDS(paste0(models, "mdl_focus_f0Mean_noRS_loo.rds"))
} else {
  mdl_focus_f0Mean_noRS_loo <- loo(mdl_focus_f0Mean_noRS)
  saveRDS(mdl_focus_f0Mean_noRS_loo, paste0(models, "mdl_focus_f0Mean_noRS_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_f0Mean_noRS_loo
```

###### Interaction

Trying with interaction.

```{r}
mdl_focus_f0Mean_noRS_int <- brm(F0_mean ~ 1 + Focus * Gender_s + Focus * Word_s + Gender_s * Word_s, 
                   data = df_prepost_model,
                   prior = priors_f0Mean,
                   family = lognormal(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 2000,
                   warmup = 1000,
                   seed = 998,
                   control = list(max_treedepth = 12,
                                  adapt_delta = 0.99),
                   file = paste0(models, "mdl_focus_f0Mean_noRS_int.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_f0Mean_noRS_int <- readRDS(paste0(models, "mdl_focus_f0Mean_noRS_int.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_f0Mean_noRS_int)
```

```{r}
plot(mdl_focus_f0Mean_noRS_int)
```

```{r}
pp_check(mdl_focus_f0Mean_noRS_int, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_f0Mean_noRS_int_loo.rds"))) {
  mdl_focus_f0Mean_noRS_int_loo <- readRDS(paste0(models, "mdl_focus_f0Mean_noRS_int_loo.rds"))
} else {
  mdl_focus_f0Mean_noRS_int_loo <- loo(mdl_focus_f0Mean_noRS_int)
  saveRDS(mdl_focus_f0Mean_noRS_int_loo, paste0(models, "mdl_focus_f0Mean_noRS_int_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_f0Mean_noRS_int_loo
```

##### No random slopes

###### No interaction

```{r}
mdl_focus_f0Mean_noSlopes <- brm(F0_mean ~ 1 + Focus + Gender_s + Word_s +
                               (1 | Language),
                   data = df_prepost_model,
                   prior = priors_f0Mean,
                   family = lognormal(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 4000,
                   warmup = 2000,
                   seed = 998,
                   control = list(max_treedepth = 14,
                                  adapt_delta = 0.999),
                   file = paste0(models, "mdl_focus_f0Mean_noSlopes.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_f0Mean_noSlopes <- readRDS(paste0(models, "mdl_focus_f0Mean_noSlopes.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_f0Mean_noSlopes)
```

```{r}
plot(mdl_focus_f0Mean_noSlopes)
```

```{r}
pp_check(mdl_focus_f0Mean_noSlopes, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_f0Mean_noSlopes_loo.rds"))) {
  mdl_focus_f0Mean_noSlopes_loo <- readRDS(paste0(models, "mdl_focus_f0Mean_noSlopes_loo.rds"))
} else {
  mdl_focus_f0Mean_noSlopes_loo <- loo(mdl_focus_f0Mean_noSlopes)
  saveRDS(mdl_focus_f0Mean_noSlopes_loo, paste0(models, "mdl_focus_f0Mean_noSlopes_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_f0Mean_noSlopes_loo
```

###### Interaction

Trying with interaction.

```{r}
mdl_focus_f0Mean_noSlopes_int <- brm(F0_mean ~ 1 + Focus * Gender_s + Focus * Word_s + Gender_s * Word_s +
                               (1 | Language),
                   data = df_prepost_model,
                   prior = priors_f0Mean,
                   family = lognormal(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 4000,
                   warmup = 2000,
                   seed = 998,
                   control = list(max_treedepth = 14,
                                  adapt_delta = 0.999),
                   file = paste0(models, "mdl_focus_f0Mean_noSlopes_int.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_f0Mean_noSlopes_int <- readRDS(paste0(models, "mdl_focus_f0Mean_noSlopes_int.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_f0Mean_noSlopes_int)
```

```{r}
plot(mdl_focus_f0Mean_noSlopes_int)
```

```{r}
pp_check(mdl_focus_f0Mean_noSlopes_int, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_f0Mean_noSlopes_int_loo.rds"))) {
  mdl_focus_f0Mean_noSlopes_int_loo <- readRDS(paste0(models, "mdl_focus_f0Mean_noSlopes_int_loo.rds"))
} else {
  mdl_focus_f0Mean_noSlopes_int_loo <- loo(mdl_focus_f0Mean_noSlopes_int)
  saveRDS(mdl_focus_f0Mean_noSlopes_int_loo, paste0(models, "mdl_focus_f0Mean_noSlopes_int_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_f0Mean_noSlopes_int_loo
```


##### With random structure

###### No interaction

```{r}
mdl_focus_f0Mean_full <- brm(F0_mean ~ 1 + Focus + Gender_s + Word_s +
                               (1 + Focus || Language),
                   data = df_prepost_model,
                   prior = priors_f0Mean,
                   family = lognormal(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 4000,
                   warmup = 2000,
                   seed = 998,
                   control = list(max_treedepth = 14,
                                  adapt_delta = 0.999),
                   file = paste0(models, "mdl_focus_f0Mean_full.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_f0Mean_full <- readRDS(paste0(models, "mdl_focus_f0Mean_full.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_f0Mean_full)
```

```{r}
plot(mdl_focus_f0Mean_full)
```

```{r}
pp_check(mdl_focus_f0Mean_full, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_f0Mean_full_loo.rds"))) {
  mdl_focus_f0Mean_full_loo <- readRDS(paste0(models, "mdl_focus_f0Mean_full_loo.rds"))
} else {
  mdl_focus_f0Mean_full_loo <- loo(mdl_focus_f0Mean_full)
  saveRDS(mdl_focus_f0Mean_full_loo, paste0(models, "mdl_focus_f0Mean_full_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_f0Mean_full_loo
```

###### Interaction

Trying with interaction.

```{r}
mdl_focus_f0Mean_full_int <- brm(F0_mean ~ 1 + Focus * Gender_s + Focus * Word_s + Gender_s * Word_s +
                               (1 + Focus || Language),
                   data = df_prepost_model,
                   prior = priors_f0Mean,
                   family = lognormal(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 4000,
                   warmup = 2000,
                   seed = 998,
                   control = list(max_treedepth = 14,
                                  adapt_delta = 0.999),
                   file = paste0(models, "mdl_focus_f0Mean_full_int.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_f0Mean_full_int <- readRDS(paste0(models, "mdl_focus_f0Mean_full_int.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_f0Mean_full_int)
```

```{r}
plot(mdl_focus_f0Mean_full_int)
```

```{r}
pp_check(mdl_focus_f0Mean_full_int, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_f0Mean_full_int_loo.rds"))) {
  mdl_focus_f0Mean_full_int_loo <- readRDS(paste0(models, "mdl_focus_f0Mean_full_int_loo.rds"))
} else {
  mdl_focus_f0Mean_full_int_loo <- loo(mdl_focus_f0Mean_full_int)
  saveRDS(mdl_focus_f0Mean_full_int_loo, paste0(models, "mdl_focus_f0Mean_full_int_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_f0Mean_full_int_loo
```

##### Best-fit

```{r}
comp_f0Mean <- loo_compare(mdl_focus_f0Mean_noRS_loo,
                             mdl_focus_f0Mean_noRS_int_loo,
                             mdl_focus_f0Mean_noSlopes_loo,
                             mdl_focus_f0Mean_noSlopes_int_loo,
                             mdl_focus_f0Mean_full_loo,
                             mdl_focus_f0Mean_full_int_loo)
comp_f0Mean
```

Look at it.

```{r}
summary(mdl_focus_f0Mean_noSlopes_int)
```

Some very low Tail_ESS. For now, this will have to suffice.

```{r}
plot(mdl_focus_f0Mean_noSlopes_int)
```

The intercept looks pretty bad.

```{r}
pp_check(mdl_focus_f0Mean_noSlopes_int, ndraws = 100)
```

pp_check is ok.

---

Interpreting the results.

```{r}
summary(mdl_focus_f0Mean_noSlopes_int)

exp(fixef(mdl_focus_f0Mean_noSlopes_int))

exp(fixef(mdl_focus_f0Mean_noSlopes_int)[1,1]) #Intercept in Hz
exp(fixef(mdl_focus_f0Mean_noSlopes_int)[1,1])*exp(fixef(mdl_focus_f0Mean_noSlopes_int)[4,1])-exp(fixef(mdl_focus_f0Mean_noSlopes_int)[1,1]) # estimate Focuscorrective in Hz
exp(fixef(mdl_focus_f0Mean_noSlopes_int)[1,1])*exp(fixef(mdl_focus_f0Mean_noSlopes_int)[5,1])-exp(fixef(mdl_focus_f0Mean_noSlopes_int)[1,1]) # estimate Gender_s in Hz
exp(fixef(mdl_focus_f0Mean_noSlopes_int)[1,1])*exp(fixef(mdl_focus_f0Mean_noSlopes_int)[12,1])-exp(fixef(mdl_focus_f0Mean_noSlopes_int)[1,1]) # estimate Focuscorrective:Word_s in Hz

transform_fixef(mdl_focus_f0Mean_noSlopes_int)
```


```{r}
hypothesis(mdl_focus_f0Mean_noSlopes_int, c("Focusinformation < 0", 
                                            "Focuscontrastive > 0", 
                                            "Focuscorrective < 0", 
                                            "Gender_s < 0", 
                                            "Word_s < 0",
                                            "Focusinformation:Gender_s > 0",
                                            "Focuscontrastive:Gender_s > 0",
                                            "Focuscorrective:Gender_s > 0",
                                            "Focusinformation:Word_s < 0",
                                            "Focuscontrastive:Word_s > 0",
                                            "Focuscorrective:Word_s > 0",
                                            "Gender_s:Word_s > 0"))

plot(hypothesis(mdl_focus_f0Mean_noSlopes_int, c("Focusinformation < 0", 
                                            "Focuscontrastive > 0", 
                                            "Focuscorrective < 0", 
                                            "Gender_s < 0", 
                                            "Word_s < 0",
                                            "Focusinformation:Gender_s > 0",
                                            "Focuscontrastive:Gender_s > 0",
                                            "Focuscorrective:Gender_s > 0",
                                            "Focusinformation:Word_s < 0",
                                            "Focuscontrastive:Word_s > 0",
                                            "Focuscorrective:Word_s > 0",
                                            "Gender_s:Word_s > 0")))
```

###### Posterior plot

```{r}
rownames(summary(mdl_focus_f0Mean_noSlopes_int)$fixed)

post_focus_f0Mean_noSlopes_int <- mdl_focus_f0Mean_noSlopes_int %>% 
  gather_draws(`b_Focusinformation`, 
               `b_Focuscontrastive`, 
               `b_Focuscorrective`, 
               `b_Gender_s`, 
               `b_Word_s`, 
               `b_Focusinformation:Gender_s`, 
               `b_Focuscontrastive:Gender_s`, 
               `b_Focuscorrective:Gender_s`, 
               `b_Focusinformation:Word_s`, 
               `b_Focuscontrastive:Word_s`, 
               `b_Focuscorrective:Word_s`, 
               `b_Gender_s:Word_s`)

# Plotting intervals with densities
postplot_focus_f0Mean_noSlopes_int <- 
  ggplot(post_focus_f0Mean_noSlopes_int, 
         aes(x = .value, y = .variable)) +
  stat_halfeye(.width = 0.95, fill = colorBlindBlack8[2], alpha = 0.7, size = 2) +
  geom_segment(x = 0, xend = 0, y = -Inf, yend = Inf,
               linetype = "dashed", color = "grey", size = 1) + 
  theme_bw() +
  labs(x = "Posterior density", y = "Variable")

postplot_focus_f0Mean_noSlopes_int
ggsave(filename = paste0(plots, "postplot_focus_f0Mean_noSlopes_int.pdf"), plot = postplot_focus_f0Mean_noSlopes_int, width = 8, height = 12)

```


#### F0 range

F0 range contains 0, so lognormal is not possible. We transform the data to enable modeling in a lognormal scale using gaussian() family. We must consider it when interpreting the fixed effects with the exp().

```{r}
# Add a small constant and log-transform F0_range_transformed
df_prepost_model$F0_range_transformed <- log(df_prepost_model$F0_range_transformed + 1)
```


##### No random structure

###### No interaction

```{r}
mdl_focus_f0range_noRS <- brm(F0_range_transformed ~ 1 + Focus + Gender_s + Word_s,
                   data = df_prepost_model,
                   prior = priors_f0Range,
                   family = gaussian(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 2000,
                   warmup = 1000,
                   seed = 998,
                   control = list(max_treedepth = 12,
                                  adapt_delta = 0.99),
                   file = paste0(models, "mdl_focus_f0range_noRS.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_f0range_noRS <- readRDS(paste0(models, "mdl_focus_f0range_noRS.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_f0range_noRS)
```

```{r}
plot(mdl_focus_f0range_noRS)
```

```{r}
pp_check(mdl_focus_f0range_noRS, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_f0range_noRS_loo.rds"))) {
  mdl_focus_f0range_noRS_loo <- readRDS(paste0(models, "mdl_focus_f0range_noRS_loo.rds"))
} else {
  mdl_focus_f0range_noRS_loo <- loo(mdl_focus_f0range_noRS)
  saveRDS(mdl_focus_f0range_noRS_loo, paste0(models, "mdl_focus_f0range_noRS_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_f0range_noRS_loo
```

###### Interaction

Trying with interaction.

```{r}
mdl_focus_f0range_noRS_int <- brm(F0_range_transformed ~ 1 + Focus * Gender_s + Focus * Word_s + Gender_s * Word_s, 
                   data = df_prepost_model,
                   prior = priors_f0Range,
                   family = gaussian(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 2000,
                   warmup = 1000,
                   seed = 998,
                   control = list(max_treedepth = 12,
                                  adapt_delta = 0.99),
                   file = paste0(models, "mdl_focus_f0range_noRS_int.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_f0range_noRS_int <- readRDS(paste0(models, "mdl_focus_f0range_noRS_int.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_f0range_noRS_int)
```

```{r}
plot(mdl_focus_f0range_noRS_int)
```

```{r}
pp_check(mdl_focus_f0range_noRS_int, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_f0range_noRS_int_loo.rds"))) {
  mdl_focus_f0range_noRS_int_loo <- readRDS(paste0(models, "mdl_focus_f0range_noRS_int_loo.rds"))
} else {
  mdl_focus_f0range_noRS_int_loo <- loo(mdl_focus_f0range_noRS_int)
  saveRDS(mdl_focus_f0range_noRS_int_loo, paste0(models, "mdl_focus_f0range_noRS_int_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_f0range_noRS_int_loo
```

##### No random slopes

###### No interaction

```{r}
mdl_focus_f0range_noSlopes <- brm(F0_range_transformed ~ 1 + Focus + Gender_s + Word_s +
                               (1 | Language),
                   data = df_prepost_model,
                   prior = priors_f0Range,
                   family = gaussian(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 4000,
                   warmup = 2000,
                   seed = 998,
                   control = list(max_treedepth = 14,
                                  adapt_delta = 0.999),
                   file = paste0(models, "mdl_focus_f0range_noSlopes.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_f0range_noSlopes <- readRDS(paste0(models, "mdl_focus_f0range_noSlopes.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_f0range_noSlopes)
```

```{r}
plot(mdl_focus_f0range_noSlopes)
```

```{r}
pp_check(mdl_focus_f0range_noSlopes, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_f0range_noSlopes_loo.rds"))) {
  mdl_focus_f0range_noSlopes_loo <- readRDS(paste0(models, "mdl_focus_f0range_noSlopes_loo.rds"))
} else {
  mdl_focus_f0range_noSlopes_loo <- loo(mdl_focus_f0range_noSlopes)
  saveRDS(mdl_focus_f0range_noSlopes_loo, paste0(models, "mdl_focus_f0range_noSlopes_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_f0range_noSlopes_loo
```

###### Interaction

Trying with interaction.

```{r}
mdl_focus_f0range_noSlopes_int <- brm(F0_range_transformed ~ 1 + Focus * Gender_s + Focus * Word_s + Gender_s * Word_s +
                               (1 | Language),
                   data = df_prepost_model,
                   prior = priors_f0Range,
                   family = gaussian(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 4000,
                   warmup = 2000,
                   seed = 998,
                   control = list(max_treedepth = 14,
                                  adapt_delta = 0.999),
                   file = paste0(models, "mdl_focus_f0range_noSlopes_int.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_f0range_noSlopes_int <- readRDS(paste0(models, "mdl_focus_f0range_noSlopes_int.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_f0range_noSlopes_int)
```

```{r}
plot(mdl_focus_f0range_noSlopes_int)
```

```{r}
pp_check(mdl_focus_f0range_noSlopes_int, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_f0range_noSlopes_int_loo.rds"))) {
  mdl_focus_f0range_noSlopes_int_loo <- readRDS(paste0(models, "mdl_focus_f0range_noSlopes_int_loo.rds"))
} else {
  mdl_focus_f0range_noSlopes_int_loo <- loo(mdl_focus_f0range_noSlopes_int)
  saveRDS(mdl_focus_f0range_noSlopes_int_loo, paste0(models, "mdl_focus_f0range_noSlopes_int_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_f0range_noSlopes_int_loo
```


##### With random structure

###### No interaction

```{r}
mdl_focus_f0range_full <- brm(F0_range_transformed ~ 1 + Focus + Gender_s + Word_s +
                               (1 + Focus || Language),
                   data = df_prepost_model,
                   prior = priors_f0Range,
                   family = gaussian(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 4000,
                   warmup = 2000,
                   seed = 998,
                   control = list(max_treedepth = 14,
                                  adapt_delta = 0.999),
                   file = paste0(models, "mdl_focus_f0range_full.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_f0range_full <- readRDS(paste0(models, "mdl_focus_f0range_full.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_f0range_full)
```

```{r}
plot(mdl_focus_f0range_full)
```

```{r}
pp_check(mdl_focus_f0range_full, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_f0range_full_loo.rds"))) {
  mdl_focus_f0range_full_loo <- readRDS(paste0(models, "mdl_focus_f0range_full_loo.rds"))
} else {
  mdl_focus_f0range_full_loo <- loo(mdl_focus_f0range_full)
  saveRDS(mdl_focus_f0range_full_loo, paste0(models, "mdl_focus_f0range_full_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_f0range_full_loo
```

###### Interaction

Trying with interaction.

```{r}
mdl_focus_f0range_full_int <- brm(F0_range_transformed ~ 1 + Focus * Gender_s + Focus * Word_s + Gender_s * Word_s +
                               (1 + Focus || Language),
                   data = df_prepost_model,
                   prior = priors_f0Range,
                   family = gaussian(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 4000,
                   warmup = 2000,
                   seed = 998,
                   control = list(max_treedepth = 14,
                                  adapt_delta = 0.999),
                   file = paste0(models, "mdl_focus_f0range_full_int.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_f0range_full_int <- readRDS(paste0(models, "mdl_focus_f0range_full_int.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_f0range_full_int)
```

```{r}
plot(mdl_focus_f0range_full_int)
```

```{r}
pp_check(mdl_focus_f0range_full_int, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_f0range_full_int_loo.rds"))) {
  mdl_focus_f0range_full_int_loo <- readRDS(paste0(models, "mdl_focus_f0range_full_int_loo.rds"))
} else {
  mdl_focus_f0range_full_int_loo <- loo(mdl_focus_f0range_full_int)
  saveRDS(mdl_focus_f0range_full_int_loo, paste0(models, "mdl_focus_f0range_full_int_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_f0range_full_int_loo
```

##### Best-fit

```{r}
comp_f0Range <- loo_compare(mdl_focus_f0range_noRS_loo,
                             mdl_focus_f0range_noRS_int_loo,
                             mdl_focus_f0range_noSlopes_loo,
                             mdl_focus_f0range_noSlopes_int_loo,
                             mdl_focus_f0range_full_loo,
                             mdl_focus_f0range_full_int_loo)
comp_f0Range
```

Look at it.

```{r}
summary(mdl_focus_f0range_noSlopes_int)
```

All fine.

```{r}
plot(mdl_focus_f0range_noSlopes_int)
```

All fine.

```{r}
pp_check(mdl_focus_f0range_noSlopes_int, ndraws = 100)
```

pp_check could be better, but it is ok-ish.

---

Interpreting the results.

I need a new function to backtransform.

```{r}
transform_fixef_back <- function(model) {
  # Extract fixed effects summary
  fe_summary <- summary(model)$fixed
  
  # Initialize a dataframe to store results
  # Directly use rownames from fe_summary for Term names
  results <- data.frame(Term = rownames(fe_summary)[-1], Estimate_corr = numeric(length(rownames(fe_summary)[-1])),
                        Est_Error_corr = numeric(length(rownames(fe_summary)[-1])), Q2.5_corr = numeric(length(rownames(fe_summary)[-1])),
                        Q97.5_corr = numeric(length(rownames(fe_summary)[-1])), stringsAsFactors = FALSE)
  
  # Loop through each fixed effect, excluding the intercept
  for (i in 2:nrow(fe_summary)) {
    # Calculate transformations using column numbers for Estimate, Est.Error, Q2.5, and Q97.5
    estimate_in_hz <- (exp(fe_summary[1,1]) * exp(fe_summary[i, 1]) - exp(fe_summary[1,1])) - 1
    est_error_in_hz <- (exp(fe_summary[1,1]) * exp(fe_summary[i, 2]) - exp(fe_summary[1,1]))
    q2_5_in_hz <- (exp(fe_summary[1,1]) * exp(fe_summary[i, 3]) - exp(fe_summary[1,1]))
    q97_5_in_hz <- (exp(fe_summary[1,1]) * exp(fe_summary[i, 4]) - exp(fe_summary[1,1]))
    
    # Update results dataframe directly without rbind to maintain the association between terms and their calculations
    results$Estimate_corr[i-1] <- estimate_in_hz
    results$Est_Error_corr[i-1] <- est_error_in_hz
    results$Q2.5_corr[i-1] <- q2_5_in_hz
    results$Q97.5_corr[i-1] <- q97_5_in_hz
  }
  
  return(results)
}
```


```{r}
summary(mdl_focus_f0range_noSlopes_int)

exp(fixef(mdl_focus_f0range_noSlopes_int))

exp(fixef(mdl_focus_f0range_noSlopes_int)[1,1]) -1 #Intercept in Hz
(exp(fixef(mdl_focus_f0range_noSlopes_int)[1,1])*exp(fixef(mdl_focus_f0range_noSlopes_int)[4,1])-exp(fixef(mdl_focus_f0range_noSlopes_int)[1,1])) -1 # estimate Focuscorrective in Hz
exp(fixef(mdl_focus_f0range_noSlopes_int)[1,1])*exp(fixef(mdl_focus_f0range_noSlopes_int)[5,1])-exp(fixef(mdl_focus_f0range_noSlopes_int)[1,1]) # estimate Gender_s in Hz
exp(fixef(mdl_focus_f0range_noSlopes_int)[1,1])*exp(fixef(mdl_focus_f0range_noSlopes_int)[12,1])-exp(fixef(mdl_focus_f0range_noSlopes_int)[1,1]) # estimate Focuscorrective:Word_s in Hz

transform_fixef_back(mdl_focus_f0range_noSlopes_int)
```


```{r}
hypothesis(mdl_focus_f0range_noSlopes_int, c("Focusinformation < 0", 
                                            "Focuscontrastive < 0", 
                                            "Focuscorrective < 0", 
                                            "Gender_s < 0", 
                                            "Word_s < 0",
                                            "Focusinformation:Gender_s < 0",
                                            "Focuscontrastive:Gender_s < 0",
                                            "Focuscorrective:Gender_s < 0",
                                            "Focusinformation:Word_s > 0",
                                            "Focuscontrastive:Word_s > 0",
                                            "Focuscorrective:Word_s > 0",
                                            "Gender_s:Word_s > 0"))

plot(hypothesis(mdl_focus_f0range_noSlopes_int, c("Focusinformation < 0", 
                                            "Focuscontrastive < 0", 
                                            "Focuscorrective < 0", 
                                            "Gender_s < 0", 
                                            "Word_s < 0",
                                            "Focusinformation:Gender_s < 0",
                                            "Focuscontrastive:Gender_s < 0",
                                            "Focuscorrective:Gender_s < 0",
                                            "Focusinformation:Word_s > 0",
                                            "Focuscontrastive:Word_s > 0",
                                            "Focuscorrective:Word_s > 0",
                                            "Gender_s:Word_s > 0")))
```

###### Posterior plot

```{r}
rownames(summary(mdl_focus_f0range_noSlopes_int)$fixed)

post_focus_f0range_noSlopes_int <- mdl_focus_f0range_noSlopes_int %>% 
  gather_draws(`b_Focusinformation`, 
               `b_Focuscontrastive`, 
               `b_Focuscorrective`, 
               `b_Gender_s`, 
               `b_Word_s`, 
               `b_Focusinformation:Gender_s`, 
               `b_Focuscontrastive:Gender_s`, 
               `b_Focuscorrective:Gender_s`, 
               `b_Focusinformation:Word_s`, 
               `b_Focuscontrastive:Word_s`, 
               `b_Focuscorrective:Word_s`, 
               `b_Gender_s:Word_s`)

# Plotting intervals with densities
postplot_focus_f0range_noSlopes_int <- 
  ggplot(post_focus_f0range_noSlopes_int, 
         aes(x = .value, y = .variable)) +
  stat_halfeye(.width = 0.95, fill = colorBlindBlack8[2], alpha = 0.7, size = 2) +
  geom_segment(x = 0, xend = 0, y = -Inf, yend = Inf,
               linetype = "dashed", color = "grey", size = 1) + 
  theme_bw() +
  labs(x = "Posterior density", y = "Variable")

postplot_focus_f0range_noSlopes_int
ggsave(filename = paste0(plots, "postplot_focus_f0range_noSlopes_int.pdf"), plot = postplot_focus_f0range_noSlopes_int, width = 8, height = 12)

```


#### Amplitude envelope mean

##### No random structure

###### No interaction

```{r}
mdl_focus_envMean_noRS <- brm(env_mean ~ 1 + Focus + Gender_s + Word_s,
                   data = df_prepost_model,
                   prior = priors_envMean,
                   family = lognormal(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 2000,
                   warmup = 1000,
                   seed = 998,
                   control = list(max_treedepth = 12,
                                  adapt_delta = 0.99),
                   file = paste0(models, "mdl_focus_envMean_noRS.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_envMean_noRS <- readRDS(paste0(models, "mdl_focus_envMean_noRS.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_envMean_noRS)
```

```{r}
plot(mdl_focus_envMean_noRS)
```

```{r}
pp_check(mdl_focus_envMean_noRS, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_envMean_noRS_loo.rds"))) {
  mdl_focus_envMean_noRS_loo <- readRDS(paste0(models, "mdl_focus_envMean_noRS_loo.rds"))
} else {
  mdl_focus_envMean_noRS_loo <- loo(mdl_focus_envMean_noRS)
  saveRDS(mdl_focus_envMean_noRS_loo, paste0(models, "mdl_focus_envMean_noRS_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_envMean_noRS_loo
```

###### Interaction

Trying with interaction.

```{r}
mdl_focus_envMean_noRS_int <- brm(env_mean ~ 1 + Focus * Gender_s + Focus * Word_s + Gender_s * Word_s, 
                   data = df_prepost_model,
                   prior = priors_envMean,
                   family = lognormal(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 2000,
                   warmup = 1000,
                   seed = 998,
                   control = list(max_treedepth = 12,
                                  adapt_delta = 0.99),
                   file = paste0(models, "mdl_focus_envMean_noRS_int.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_envMean_noRS_int <- readRDS(paste0(models, "mdl_focus_envMean_noRS_int.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_envMean_noRS_int)
```

```{r}
plot(mdl_focus_envMean_noRS_int)
```

```{r}
pp_check(mdl_focus_envMean_noRS_int, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_envMean_noRS_int_loo.rds"))) {
  mdl_focus_envMean_noRS_int_loo <- readRDS(paste0(models, "mdl_focus_envMean_noRS_int_loo.rds"))
} else {
  mdl_focus_envMean_noRS_int_loo <- loo(mdl_focus_envMean_noRS_int)
  saveRDS(mdl_focus_envMean_noRS_int_loo, paste0(models, "mdl_focus_envMean_noRS_int_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_envMean_noRS_int_loo
```

##### No random slopes

###### No interaction

```{r}
mdl_focus_envMean_noSlopes <- brm(env_mean ~ 1 + Focus + Gender_s + Word_s +
                               (1 | Language),
                   data = df_prepost_model,
                   prior = priors_envMean,
                   family = lognormal(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 4000,
                   warmup = 2000,
                   seed = 998,
                   control = list(max_treedepth = 14,
                                  adapt_delta = 0.999),
                   file = paste0(models, "mdl_focus_envMean_noSlopes.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_envMean_noSlopes <- readRDS(paste0(models, "mdl_focus_envMean_noSlopes.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_envMean_noSlopes)
```

```{r}
plot(mdl_focus_envMean_noSlopes)
```

```{r}
pp_check(mdl_focus_envMean_noSlopes, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_envMean_noSlopes_loo.rds"))) {
  mdl_focus_envMean_noSlopes_loo <- readRDS(paste0(models, "mdl_focus_envMean_noSlopes_loo.rds"))
} else {
  mdl_focus_envMean_noSlopes_loo <- loo(mdl_focus_envMean_noSlopes)
  saveRDS(mdl_focus_envMean_noSlopes_loo, paste0(models, "mdl_focus_envMean_noSlopes_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_envMean_noSlopes_loo
```

###### Interaction

Trying with interaction.

```{r}
mdl_focus_envMean_noSlopes_int <- brm(env_mean ~ 1 + Focus * Gender_s + Focus * Word_s + Gender_s * Word_s +
                               (1 | Language),
                   data = df_prepost_model,
                   prior = priors_envMean,
                   family = lognormal(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 4000,
                   warmup = 2000,
                   seed = 998,
                   control = list(max_treedepth = 14,
                                  adapt_delta = 0.999),
                   file = paste0(models, "mdl_focus_envMean_noSlopes_int.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_envMean_noSlopes_int <- readRDS(paste0(models, "mdl_focus_envMean_noSlopes_int.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_envMean_noSlopes_int)
```

```{r}
plot(mdl_focus_envMean_noSlopes_int)
```

```{r}
pp_check(mdl_focus_envMean_noSlopes_int, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_envMean_noSlopes_int_loo.rds"))) {
  mdl_focus_envMean_noSlopes_int_loo <- readRDS(paste0(models, "mdl_focus_envMean_noSlopes_int_loo.rds"))
} else {
  mdl_focus_envMean_noSlopes_int_loo <- loo(mdl_focus_envMean_noSlopes_int)
  saveRDS(mdl_focus_envMean_noSlopes_int_loo, paste0(models, "mdl_focus_envMean_noSlopes_int_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_envMean_noSlopes_int_loo
```


##### With random structure

###### No interaction

```{r}
mdl_focus_envMean_full <- brm(env_mean ~ 1 + Focus + Gender_s + Word_s +
                               (1 + Focus || Language),
                   data = df_prepost_model,
                   prior = priors_envMean,
                   family = lognormal(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 4000,
                   warmup = 2000,
                   seed = 998,
                   control = list(max_treedepth = 14,
                                  adapt_delta = 0.999),
                   file = paste0(models, "mdl_focus_envMean_full.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_envMean_full <- readRDS(paste0(models, "mdl_focus_envMean_full.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_envMean_full)
```

```{r}
plot(mdl_focus_envMean_full)
```

```{r}
pp_check(mdl_focus_envMean_full, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_envMean_full_loo.rds"))) {
  mdl_focus_envMean_full_loo <- readRDS(paste0(models, "mdl_focus_envMean_full_loo.rds"))
} else {
  mdl_focus_envMean_full_loo <- loo(mdl_focus_envMean_full)
  saveRDS(mdl_focus_envMean_full_loo, paste0(models, "mdl_focus_envMean_full_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_envMean_full_loo
```

###### Interaction

Trying with interaction.

```{r}
mdl_focus_envMean_full_int <- brm(env_mean ~ 1 + Focus * Gender_s + Focus * Word_s + Gender_s * Word_s +
                               (1 + Focus || Language),
                   data = df_prepost_model,
                   prior = priors_envMean,
                   family = lognormal(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 4000,
                   warmup = 2000,
                   seed = 998,
                   control = list(max_treedepth = 14,
                                  adapt_delta = 0.999),
                   file = paste0(models, "mdl_focus_envMean_full_int.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_envMean_full_int <- readRDS(paste0(models, "mdl_focus_envMean_full_int.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_envMean_full_int)
```

```{r}
plot(mdl_focus_envMean_full_int)
```

```{r}
pp_check(mdl_focus_envMean_full_int, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_envMean_full_int_loo.rds"))) {
  mdl_focus_envMean_full_int_loo <- readRDS(paste0(models, "mdl_focus_envMean_full_int_loo.rds"))
} else {
  mdl_focus_envMean_full_int_loo <- loo(mdl_focus_envMean_full_int)
  saveRDS(mdl_focus_envMean_full_int_loo, paste0(models, "mdl_focus_envMean_full_int_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_envMean_full_int_loo
```

##### Best-fit

```{r}
comp_envMean <- loo_compare(mdl_focus_envMean_noRS_loo,
                             mdl_focus_envMean_noRS_int_loo,
                             mdl_focus_envMean_noSlopes_loo,
                             mdl_focus_envMean_noSlopes_int_loo,
                             mdl_focus_envMean_full_loo,
                             mdl_focus_envMean_full_int_loo)
comp_envMean
```

Look at it.

```{r}
summary(mdl_focus_envMean_full_int )
```

All fine.

```{r}
plot(mdl_focus_envMean_full_int )
```

All fine.

```{r}
pp_check(mdl_focus_envMean_full_int , ndraws = 100)
```

pp_check could be better, but it is ok-ish.

---

Interpreting the results.

```{r}
summary(mdl_focus_envMean_full_int )

exp(fixef(mdl_focus_envMean_full_int ))

transform_fixef(mdl_focus_envMean_full_int )
```


```{r}
hypothesis(mdl_focus_envMean_full_int , c("Focusinformation < 0", 
                                            "Focuscontrastive < 0", 
                                            "Focuscorrective < 0", 
                                            "Gender_s > 0", 
                                            "Word_s > 0",
                                            "Focusinformation:Gender_s > 0",
                                            "Focuscontrastive:Gender_s < 0",
                                            "Focuscorrective:Gender_s > 0",
                                            "Focusinformation:Word_s < 0",
                                            "Focuscontrastive:Word_s < 0",
                                            "Focuscorrective:Word_s > 0",
                                            "Gender_s:Word_s < 0"))

plot(hypothesis(mdl_focus_envMean_full_int , c("Focusinformation < 0", 
                                            "Focuscontrastive < 0", 
                                            "Focuscorrective < 0", 
                                            "Gender_s > 0", 
                                            "Word_s > 0",
                                            "Focusinformation:Gender_s > 0",
                                            "Focuscontrastive:Gender_s < 0",
                                            "Focuscorrective:Gender_s > 0",
                                            "Focusinformation:Word_s < 0",
                                            "Focuscontrastive:Word_s < 0",
                                            "Focuscorrective:Word_s > 0",
                                            "Gender_s:Word_s < 0")))
```

###### Posterior plot

```{r}
rownames(summary(mdl_focus_envMean_full_int)$fixed)

post_focus_envMean_full_int <- mdl_focus_envMean_full_int  %>% 
  gather_draws(`b_Focusinformation`, 
               `b_Focuscontrastive`, 
               `b_Focuscorrective`, 
               `b_Gender_s`, 
               `b_Word_s`, 
               `b_Focusinformation:Gender_s`, 
               `b_Focuscontrastive:Gender_s`, 
               `b_Focuscorrective:Gender_s`, 
               `b_Focusinformation:Word_s`, 
               `b_Focuscontrastive:Word_s`, 
               `b_Focuscorrective:Word_s`, 
               `b_Gender_s:Word_s`)

# Plotting intervals with densities
postplot_focus_envMean_full_int <- 
  ggplot(post_focus_envMean_full_int, 
         aes(x = .value, y = .variable)) +
  stat_halfeye(.width = 0.95, fill = colorBlindBlack8[2], alpha = 0.7, size = 2) +
  geom_segment(x = 0, xend = 0, y = -Inf, yend = Inf,
               linetype = "dashed", color = "grey", size = 1) + 
  theme_bw() +
  labs(x = "Posterior density", y = "Variable") +
    scale_x_continuous(limits = c(-1.2, 1.2))

postplot_focus_envMean_full_int
ggsave(filename = paste0(plots, "postplot_focus_envMean_full_int.pdf"), plot = postplot_focus_envMean_full_int, width = 8, height = 12)
```


#### Amplitude envelope range

##### No random structure

###### No interaction

```{r}
mdl_focus_envRange_noRS <- brm(env_range ~ 1 + Focus + Gender_s + Word_s,
                   data = df_prepost_model,
                   prior = priors_envRange,
                   family = lognormal(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 2000,
                   warmup = 1000,
                   seed = 998,
                   control = list(max_treedepth = 12,
                                  adapt_delta = 0.99),
                   file = paste0(models, "mdl_focus_envRange_noRS.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_envRange_noRS <- readRDS(paste0(models, "mdl_focus_envRange_noRS.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_envRange_noRS)
```

```{r}
plot(mdl_focus_envRange_noRS)
```

```{r}
pp_check(mdl_focus_envRange_noRS, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_envRange_noRS_loo.rds"))) {
  mdl_focus_envRange_noRS_loo <- readRDS(paste0(models, "mdl_focus_envRange_noRS_loo.rds"))
} else {
  mdl_focus_envRange_noRS_loo <- loo(mdl_focus_envRange_noRS)
  saveRDS(mdl_focus_envRange_noRS_loo, paste0(models, "mdl_focus_envRange_noRS_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_envRange_noRS_loo
```

###### Interaction

Trying with interaction.

```{r}
mdl_focus_envRange_noRS_int <- brm(env_range ~ 1 + Focus * Gender_s + Focus * Word_s + Gender_s * Word_s, 
                   data = df_prepost_model,
                   prior = priors_envRange,
                   family = lognormal(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 2000,
                   warmup = 1000,
                   seed = 998,
                   control = list(max_treedepth = 12,
                                  adapt_delta = 0.99),
                   file = paste0(models, "mdl_focus_envRange_noRS_int.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_envRange_noRS_int <- readRDS(paste0(models, "mdl_focus_envRange_noRS_int.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_envRange_noRS_int)
```

```{r}
plot(mdl_focus_envRange_noRS_int)
```

```{r}
pp_check(mdl_focus_envRange_noRS_int, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_envRange_noRS_int_loo.rds"))) {
  mdl_focus_envRange_noRS_int_loo <- readRDS(paste0(models, "mdl_focus_envRange_noRS_int_loo.rds"))
} else {
  mdl_focus_envRange_noRS_int_loo <- loo(mdl_focus_envRange_noRS_int)
  saveRDS(mdl_focus_envRange_noRS_int_loo, paste0(models, "mdl_focus_envRange_noRS_int_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_envRange_noRS_int_loo
```

##### No random slopes

###### No interaction

```{r}
mdl_focus_envRange_noSlopes <- brm(env_range ~ 1 + Focus + Gender_s + Word_s +
                               (1 | Language),
                   data = df_prepost_model,
                   prior = priors_envRange,
                   family = lognormal(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 4000,
                   warmup = 2000,
                   seed = 998,
                   control = list(max_treedepth = 14,
                                  adapt_delta = 0.999),
                   file = paste0(models, "mdl_focus_envRange_noSlopes.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_envRange_noSlopes <- readRDS(paste0(models, "mdl_focus_envRange_noSlopes.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_envRange_noSlopes)
```

```{r}
plot(mdl_focus_envRange_noSlopes)
```

```{r}
pp_check(mdl_focus_envRange_noSlopes, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_envRange_noSlopes_loo.rds"))) {
  mdl_focus_envRange_noSlopes_loo <- readRDS(paste0(models, "mdl_focus_envRange_noSlopes_loo.rds"))
} else {
  mdl_focus_envRange_noSlopes_loo <- loo(mdl_focus_envRange_noSlopes)
  saveRDS(mdl_focus_envRange_noSlopes_loo, paste0(models, "mdl_focus_envRange_noSlopes_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_envRange_noSlopes_loo
```

###### Interaction

Trying with interaction.

```{r}
mdl_focus_envRange_noSlopes_int <- brm(env_range ~ 1 + Focus * Gender_s + Focus * Word_s + Gender_s * Word_s +
                               (1 | Language),
                   data = df_prepost_model,
                   prior = priors_envRange,
                   family = lognormal(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 4000,
                   warmup = 2000,
                   seed = 998,
                   control = list(max_treedepth = 14,
                                  adapt_delta = 0.999),
                   file = paste0(models, "mdl_focus_envRange_noSlopes_int.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_envRange_noSlopes_int <- readRDS(paste0(models, "mdl_focus_envRange_noSlopes_int.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_envRange_noSlopes_int)
```

```{r}
plot(mdl_focus_envRange_noSlopes_int)
```

```{r}
pp_check(mdl_focus_envRange_noSlopes_int, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_envRange_noSlopes_int_loo.rds"))) {
  mdl_focus_envRange_noSlopes_int_loo <- readRDS(paste0(models, "mdl_focus_envRange_noSlopes_int_loo.rds"))
} else {
  mdl_focus_envRange_noSlopes_int_loo <- loo(mdl_focus_envRange_noSlopes_int)
  saveRDS(mdl_focus_envRange_noSlopes_int_loo, paste0(models, "mdl_focus_envRange_noSlopes_int_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_envRange_noSlopes_int_loo
```


##### With random structure

###### No interaction

```{r}
mdl_focus_envRange_full <- brm(env_range ~ 1 + Focus + Gender_s + Word_s +
                               (1 + Focus || Language),
                   data = df_prepost_model,
                   prior = priors_envRange,
                   family = lognormal(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 4000,
                   warmup = 2000,
                   seed = 998,
                   control = list(max_treedepth = 14,
                                  adapt_delta = 0.999),
                   file = paste0(models, "mdl_focus_envRange_full.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_envRange_full <- readRDS(paste0(models, "mdl_focus_envRange_full.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_envRange_full)
```

```{r}
plot(mdl_focus_envRange_full)
```

```{r}
pp_check(mdl_focus_envRange_full, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_envRange_full_loo.rds"))) {
  mdl_focus_envRange_full_loo <- readRDS(paste0(models, "mdl_focus_envRange_full_loo.rds"))
} else {
  mdl_focus_envRange_full_loo <- loo(mdl_focus_envRange_full)
  saveRDS(mdl_focus_envRange_full_loo, paste0(models, "mdl_focus_envRange_full_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_envRange_full_loo
```

###### Interaction

Trying with interaction.

```{r}
mdl_focus_envRange_full_int <- brm(env_range ~ 1 + Focus * Gender_s + Focus * Word_s + Gender_s * Word_s +
                               (1 + Focus || Language),
                   data = df_prepost_model,
                   prior = priors_envRange,
                   family = lognormal(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 4000,
                   warmup = 2000,
                   seed = 998,
                   control = list(max_treedepth = 14,
                                  adapt_delta = 0.999),
                   file = paste0(models, "mdl_focus_envRange_full_int.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_focus_envRange_full_int <- readRDS(paste0(models, "mdl_focus_envRange_full_int.rds"))
```

Let's check how it looks like.

```{r}
summary(mdl_focus_envRange_full_int)
```

```{r}
plot(mdl_focus_envRange_full_int)
```

```{r}
pp_check(mdl_focus_envRange_full_int, ndraws = 100)
```

Let's compute the loo for model comparison.

```{r}
# run loo mdl
if (file.exists(paste0(models, "mdl_focus_envRange_full_int_loo.rds"))) {
  mdl_focus_envRange_full_int_loo <- readRDS(paste0(models, "mdl_focus_envRange_full_int_loo.rds"))
} else {
  mdl_focus_envRange_full_int_loo <- loo(mdl_focus_envRange_full_int)
  saveRDS(mdl_focus_envRange_full_int_loo, paste0(models, "mdl_focus_envRange_full_int_loo.rds"))
}
```

Check the loo.

```{r}
mdl_focus_envRange_full_int_loo
```

##### Best-fit

```{r}
comp_envRange <- loo_compare(mdl_focus_envRange_noRS_loo,
                             mdl_focus_envRange_noRS_int_loo,
                             mdl_focus_envRange_noSlopes_loo,
                             mdl_focus_envRange_noSlopes_int_loo,
                             mdl_focus_envRange_full_loo,
                             mdl_focus_envRange_full_int_loo)
comp_envRange
```

Look at it.

```{r}
summary(mdl_focus_envRange_full_int )
```

All fine.

```{r}
plot(mdl_focus_envRange_full_int )
```

All fine.

```{r}
pp_check(mdl_focus_envRange_full_int , ndraws = 100)
```

pp_check could be better, but it is ok-ish.

---

Interpreting the results.

```{r}
summary(mdl_focus_envRange_full_int )

exp(fixef(mdl_focus_envRange_full_int ))

transform_fixef(mdl_focus_envRange_full_int)
```


```{r}
hypothesis(mdl_focus_envRange_full_int , c("Focusinformation < 0", 
                                            "Focuscontrastive < 0", 
                                            "Focuscorrective < 0", 
                                            "Gender_s > 0", 
                                            "Word_s > 0",
                                            "Focusinformation:Gender_s > 0",
                                            "Focuscontrastive:Gender_s < 0",
                                            "Focuscorrective:Gender_s > 0",
                                            "Focusinformation:Word_s < 0",
                                            "Focuscontrastive:Word_s < 0",
                                            "Focuscorrective:Word_s > 0",
                                            "Gender_s:Word_s < 0"))

plot(hypothesis(mdl_focus_envRange_full_int , c("Focusinformation < 0", 
                                            "Focuscontrastive < 0", 
                                            "Focuscorrective < 0", 
                                            "Gender_s > 0", 
                                            "Word_s > 0",
                                            "Focusinformation:Gender_s > 0",
                                            "Focuscontrastive:Gender_s < 0",
                                            "Focuscorrective:Gender_s > 0",
                                            "Focusinformation:Word_s < 0",
                                            "Focuscontrastive:Word_s < 0",
                                            "Focuscorrective:Word_s > 0",
                                            "Gender_s:Word_s < 0")))
```

###### Posterior plot

```{r}
rownames(summary(mdl_focus_envRange_full_int)$fixed)

post_focus_envRange_full_int <- mdl_focus_envRange_full_int  %>% 
  gather_draws(`b_Focusinformation`, 
               `b_Focuscontrastive`, 
               `b_Focuscorrective`, 
               `b_Gender_s`, 
               `b_Word_s`, 
               `b_Focusinformation:Gender_s`, 
               `b_Focuscontrastive:Gender_s`, 
               `b_Focuscorrective:Gender_s`, 
               `b_Focusinformation:Word_s`, 
               `b_Focuscontrastive:Word_s`, 
               `b_Focuscorrective:Word_s`, 
               `b_Gender_s:Word_s`)

# Plotting intervals with densities
postplot_focus_envRange_full_int <- 
  ggplot(post_focus_envRange_full_int, 
         aes(x = .value, y = .variable)) +
  stat_halfeye(.width = 0.95, fill = colorBlindBlack8[2], alpha = 0.7, size = 2) +
  geom_segment(x = 0, xend = 0, y = -Inf, yend = Inf,
               linetype = "dashed", color = "grey", size = 1) + 
  theme_bw() +
  labs(x = "Posterior density", y = "Variable")# +
    #scale_x_continuous(limits = c(-0.5, 0.8))

postplot_focus_envRange_full_int
ggsave(filename = paste0(plots, "postplot_focus_envRange_full_int.pdf"), plot = postplot_focus_envRange_full_int, width = 8, height = 12)
```

### Data viz model effects

```{r}
library(ggthemes)

ggplot(df_prepost_model, aes(x = Word, y = duration, fill = Word)) +
  #geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +  # Draw violin plots
  geom_boxplot(width = 0.3, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5, show.legend = FALSE) +
  labs(x = "Word",y = "Duration (ms)") +  # Adjust labels
  scale_fill_manual(values = colorBlindBlack8[2:8])  +
  #facet_wrap(~ Language) +
  theme_hc()
ggsave(filename = paste0(plots, "focus_duration.pdf"), plot = last_plot(), width = 4, height = 6)

ggplot(df_prepost_model, aes(x = Focus, y = duration, fill = Gender)) +
  #geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +  # Draw violin plots
  geom_boxplot(width = 0.3, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
  labs(x = "Focus Type",y = "Duration",fill = "Gender") +  # Adjust labels
  scale_fill_manual(values = colorBlindBlack8[2:8])  +
  #facet_wrap(~ Language) +
  theme_hc()
ggsave(filename = paste0(plots, "focus_duration_Gender.pdf"), plot = last_plot(), width = 8, height = 6)

ggplot(df_prepost_model, aes(x = Focus, y = duration, fill = Word)) +
  #geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +  # Draw violin plots
  geom_boxplot(width = 0.3, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
  labs(x = "Focus Type",y = "Duration",fill = "Word") +  # Adjust labels
  scale_fill_manual(values = colorBlindBlack8[2:8])  +
  #facet_wrap(~ Language) +
  theme_hc()
ggsave(filename = paste0(plots, "focus_duration_Word.pdf"), plot = last_plot(), width = 8, height = 6)
ggplot(df_prepost_model, aes(x = Focus, y = duration, fill = Word)) +
  #geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +  # Draw violin plots
  geom_boxplot(width = 0.3, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
  labs(x = "Focus Type",y = "Duration",fill = "Word") +  # Adjust labels
  scale_fill_manual(values = colorBlindBlack8[2:8])  +
  facet_wrap(~ Language) +
  theme_hc()
ggsave(filename = paste0(plots, "focus_duration_Word_Language.pdf"), plot = last_plot(), width = 8, height = 6)

ggplot(df_prepost_model, aes(x = Focus, y = F0_range_z, fill = Word)) +
  #geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +  # Draw violin plots
  geom_boxplot(width = 0.3, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
  labs(x = "Focus Type",y = "F0 range (z-scored)",fill = "Word") +  # Adjust labels
  scale_fill_manual(values = colorBlindBlack8[2:8])  +
  #facet_wrap(~ Language) +
  theme_hc()
ggsave(filename = paste0(plots, "focus_f0Range_Word.pdf"), plot = last_plot(), width = 8, height = 6)

ggplot(df_prepost_model, aes(x = Focus, y = F0_range_z, fill = Word)) +
  #geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +  # Draw violin plots
  geom_boxplot(width = 0.3, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
  labs(x = "Focus Type",y = "F0 range (z-scored)",fill = "Word") +  # Adjust labels
  scale_fill_manual(values = colorBlindBlack8[2:8])  +
  facet_wrap(~ Language) +
  theme_hc()
ggsave(filename = paste0(plots, "focus_f0Range_Word_Language.pdf"), plot = last_plot(), width = 8, height = 6)

ggplot(df_prepost_model, aes(x = Focus, y = F0_mean_z, fill = Word)) +
  #geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +  # Draw violin plots
  geom_boxplot(width = 0.3, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
  labs(x = "Focus Type",y = "F0 mean (z-scored)",fill = "Word") +  # Adjust labels
  scale_fill_manual(values = colorBlindBlack8[2:8]) +
  ylim(-3, 2.5)  +
  #facet_wrap(~ Language) +
  theme_hc()
ggsave(filename = paste0(plots, "focus_f0Mean_Word.pdf"), plot = last_plot(), width = 8, height = 6)

ggplot(df_prepost_model, aes(x = Focus, y = env_range_z, fill = Word)) +
  #geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +  # Draw violin plots
  geom_boxplot(width = 0.3, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
  labs(x = "Focus Type",y = "Amplitude envelope range (z-scored)",fill = "Word") +  # Adjust labels
  scale_fill_manual(values = colorBlindBlack8[2:8])  +
  ylim(-2, 5)  +
  #facet_wrap(~ Language) +
  theme_hc()
ggsave(filename = paste0(plots, "focus_envRange_Word.pdf"), plot = last_plot(), width = 8, height = 6)

ggplot(df_prepost_model, aes(x = Focus, y = env_range_z, fill = Word)) +
  #geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +  # Draw violin plots
  geom_boxplot(width = 0.3, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
  labs(x = "Focus Type",y = "Amplitude envelope range (z-scored)",fill = "Word") +  # Adjust labels
  scale_fill_manual(values = colorBlindBlack8[2:8])  +
  ylim(-2, 5)  +
  facet_wrap(~ Language) +
  theme_hc()
ggsave(filename = paste0(plots, "focus_envRange_Word_Language.pdf"), plot = last_plot(), width = 8, height = 6)

ggplot(df_prepost_model, aes(x = Focus, y = env_mean_z, fill = Word)) +
  #geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +  # Draw violin plots
  geom_boxplot(width = 0.3, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
  labs(x = "Focus Type",y = "Amplitude envelope mean (z-scored)",fill = "Word") +  # Adjust labels
  scale_fill_manual(values = colorBlindBlack8[2:8])  +
  ylim(-2, 4)  +
  #facet_wrap(~ Language) +
  theme_hc()
ggsave(filename = paste0(plots, "focus_envMean_Word.pdf"), plot = last_plot(), width = 8, height = 6)

ggplot(df_prepost_model, aes(x = Focus, y = env_mean_z, fill = Word)) +
  #geom_violin(scale = "width", trim = FALSE, alpha = 0.3) +  # Draw violin plots
  geom_boxplot(width = 0.3, outlier.shape = NA, position = position_dodge(width = 0.9), alpha = 0.5) +
  labs(x = "Focus Type",y = "Amplitude envelope mean (z-scored)",fill = "Word") +  # Adjust labels
  scale_fill_manual(values = colorBlindBlack8[2:8])  +
  #ylim(-2, 4)  +
  facet_wrap(~ Language) +
  theme_hc()
ggsave(filename = paste0(plots, "focus_envMean_Word_Language.pdf"), plot = last_plot(), width = 8, height = 6)
```


# Modeling prominence

While I wait for the answer on the levels, I will run one for prominence
ratings.

```{r}
summary(df_prepost_model$Prosodic_Prom)
```

Check distribution.

```{r}
hist(df_prepost_model$Prosodic_Prom)
```

## Priors

```{r}
get_prior(formula = Prosodic_Prom ~ 1 + F0_mean + F0_range + env_mean + env_range + duration +
            (1 + F0_mean + F0_range + env_mean + env_range + duration || Language) +
            (1 + F0_mean + F0_range + env_mean + env_range + duration || Gender) +
            (1 + F0_mean + F0_range + env_mean + env_range + duration || Age),
          data = df_prepost_model,
          family = gaussian())
```

## Full target only

```{r}
mdl_fullTargetOnly <- brm(Prosodic_Prom ~ 1 + F0_mean + F0_range + env_mean + env_range + duration +
                            (1 + F0_mean + F0_range + env_mean + env_range + duration || Language) +
                            (1 + F0_mean + F0_range + env_mean + env_range + duration || Gender),
                   data = df_prepost_model,
                   #prior = priors_intOnlyH1,
                   family = gaussian(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 4000,
                   warmup = 2000,
                   seed = 998,
                   control = list(max_treedepth = 13,
                                  adapt_delta = 0.99),
                   file = paste0(models, "mdl_fullTargetOnly.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_fullTargetOnly <- readRDS(paste0(models, "mdl_fullTargetOnly.rds"))
```

## DGfS

```{r}
mdl_prom_f0Mean <- brm(F0_mean ~ 1 + Prosodic_Prom +
                            (1 + Prosodic_Prom || Language) +
                            (1 + Prosodic_Prom || Gender),
                   data = df_prepost_model,
                   #prior = priors_intOnlyH1,
                   family = lognormal(),
                   #backend = "cmdstanr", # depends on you
                   cores = 4,
                   chains = 4,
                   iter = 2000,
                   warmup = 1000,
                   seed = 998,
                   control = list(max_treedepth = 12,
                                  adapt_delta = 0.99),
                   file = paste0(models, "mdl_prom_f0Mean.rds"))

# if we need to compress the model more
#saveRDS(mdl_fullTargetOnly, file = paste0(models, "mdl_fullTargetOnly.rds"), compress = "xz")

mdl_prom_f0Mean <- readRDS(paste0(models, "mdl_prom_f0Mean.rds"))
```




