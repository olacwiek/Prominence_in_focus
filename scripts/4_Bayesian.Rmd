---
title: "Acoustic correlates of perceived prominence in German and Catalan: Bayesian Modeling"
author: "Aleksandra Ćwiek, Alina Gregori, Paula G. Sánchez-Ramón, Frank Kügler, Pilar Prieto"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  rmarkdown::html_document:
    theme: readable
    number_sections: yes
    toc: yes
    toc_depth: 4
    toc_float: yes
    df_print: paged
    code_folding: hide
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: '3'
  html_notebook:
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
editor_options: 
  chunk_output_type: console
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

This is the analysis using Bayesian Modeling.

# Data preparation

## Source setup

```{r source setup, echo = TRUE, message=FALSE, warning = FALSE}

########## folders ##########
# current folder (first go to session -> set working directory -> to source file location)
parentfolder <- dirname(getwd())

data          <- paste0(parentfolder, '/MultIS_data/')
audiodata     <- paste0(parentfolder, '/audio_processed/')
syllables     <- paste0(audiodata,    'syllables/')
dataworkspace <- paste0(parentfolder, '/data_processed/')
datamerged    <- paste0(parentfolder, '/data_merged/')
datasets      <- paste0(parentfolder, '/datasets/')
models        <- paste0(parentfolder, '/models/')
plots         <- paste0(parentfolder, '/plots/')
scripts       <- paste0(parentfolder, '/scripts/')

########## source file ##########

#source(paste0(scripts, "adjectives-preparation.R"))

#################### packages ####################
# Data Manipulation
library(tibble)
library(stringr)
library(tidyverse) # includes readr, tidyr, dplyr, ggplot2
packageVersion("tidyverse")
library(data.table)

# Plotting
library(ggforce)
library(ggpubr)
library(gridExtra)
library(corrplot)

# Bayesian
library(brms); packageVersion("brms")
library(cmdstanr); packageVersion("cmdstanr")
library(emmeans); packageVersion("emmeans")
library(posterior); packageVersion("posterior")

# tidybayes https://mjskay.github.io/tidybayes/articles/tidy-brms.html
library(magrittr)
library(dplyr)
library(purrr)
library(forcats)
library(tidyr)
library(modelr)
library(ggdist)
library(tidybayes)
library(ggplot2)
library(cowplot)
library(rstan)
library(brms)
library(ggrepel)
library(RColorBrewer)
library(gganimate)
library(posterior)
library(distributional)

theme_set(theme_tidybayes() + panel_border())


# use all available cores for parallel computing
options(mc.cores = parallel::detectCores())

colorBlindBlack8  <- c("#000000", "#E69F00", "#56B4E9", "#009E73", 
                       "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

```

## Functions

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Function to back-transform fixed effects from a model
backtransform_fixef <- function(model) {
  
  # Extract fixed effects (population-level)
  fixef_output <- fixef(model)
  
  # Extract the estimates for the intercept and percProm levels
  intercept <- fixef_output["Intercept", "Estimate"]
  percProm1 <- fixef_output["percProm1", "Estimate"]
  percProm2 <- fixef_output["percProm2", "Estimate"]
  percProm3 <- fixef_output["percProm3", "Estimate"]
  
  # Combine the effects for each percProm level before applying exp()
  combined_effects <- data.frame(
    percProm_level = c("percProm0", "percProm1", "percProm2", "percProm3"),
    Estimate = exp(c(intercept,  # percProm0 is just the intercept
                     intercept + percProm1,  # Add percProm1 effect to intercept
                     intercept + percProm2,  # Add percProm2 effect to intercept
                     intercept + percProm3)),  # Add percProm3 effect to intercept
    # You can calculate confidence intervals by combining Q2.5 and Q97.5 as well
    Q2.5 = exp(c(fixef_output["Intercept", "Q2.5"],  # percProm0 interval
                 fixef_output["Intercept", "Q2.5"] + fixef_output["percProm1", "Q2.5"],  # percProm1 interval
                 fixef_output["Intercept", "Q2.5"] + fixef_output["percProm2", "Q2.5"],  # percProm2 interval
                 fixef_output["Intercept", "Q2.5"] + fixef_output["percProm3", "Q2.5"])),  # percProm3 interval
    Q97.5 = exp(c(fixef_output["Intercept", "Q97.5"],
                  fixef_output["Intercept", "Q97.5"] + fixef_output["percProm1", "Q97.5"],
                  fixef_output["Intercept", "Q97.5"] + fixef_output["percProm2", "Q97.5"],
                  fixef_output["Intercept", "Q97.5"] + fixef_output["percProm3", "Q97.5"]))
  )
  
  return(combined_effects)
}

combine_fixed_random_backtransforming <- function(participant_id) {
  
  # Get the random effects for the given participant
  rand_intercept <- ranef_output$participant[participant_id, , "Intercept"]
  rand_percProm1 <- ranef_output$participant[participant_id, , "percProm1"]
  rand_percProm2 <- ranef_output$participant[participant_id, , "percProm2"]
  rand_percProm3 <- ranef_output$participant[participant_id, , "percProm3"]
  
  # Combine fixed and random effects
  participant_effects <- data.frame(
    percProm_level = c("percProm0", "percProm1", "percProm2", "percProm3"),
    Estimate = exp(c(
      intercept + rand_intercept["Estimate"], 
      intercept + percProm0 + rand_intercept["Estimate"] + rand_percProm1["Estimate"],
      intercept + percProm2 + rand_intercept["Estimate"] + rand_percProm2["Estimate"],
      intercept + percProm3 + rand_intercept["Estimate"] + rand_percProm3["Estimate"]
    )),
    Est.Error = c(
      sqrt(fixef_output["Intercept", "Est.Error"]^2 + rand_intercept["Est.Error"]^2),
      sqrt(
        fixef_output["Intercept", "Est.Error"]^2 + fixef_output["percProm1", "Est.Error"]^2 +
        rand_intercept["Est.Error"]^2 + rand_percProm1["Est.Error"]^2
      ),
      sqrt(
        fixef_output["Intercept", "Est.Error"]^2 + fixef_output["percProm2", "Est.Error"]^2 +
        rand_intercept["Est.Error"]^2 + rand_percProm2["Est.Error"]^2
      ),
      sqrt(
        fixef_output["Intercept", "Est.Error"]^2 + fixef_output["percProm3", "Est.Error"]^2 +
        rand_intercept["Est.Error"]^2 + rand_percProm3["Est.Error"]^2
      )
    ),
    Q2.5 = exp(c(
      intercept + rand_intercept["Q2.5"], 
      intercept + percProm0 + rand_intercept["Q2.5"] + rand_percProm1["Q2.5"],
      intercept + percProm2 + rand_intercept["Q2.5"] + rand_percProm2["Q2.5"],
      intercept + percProm3 + rand_intercept["Q2.5"] + rand_percProm3["Q2.5"]
    )),
    Q97.5 = exp(c(
      intercept + rand_intercept["Q97.5"], 
      intercept + percProm0 + rand_intercept["Q97.5"] + rand_percProm1["Q97.5"],
      intercept + percProm2 + rand_intercept["Q97.5"] + rand_percProm2["Q97.5"],
      intercept + percProm3 + rand_intercept["Q97.5"] + rand_percProm3["Q97.5"]
    ))
  )
  
  participant_effects$participant <- participant_id
  return(participant_effects)
}

combine_fixed_random_student <- function(participant_id) {
  
  # Get the random effects for the given participant
  rand_intercept <- ranef_output$participant[participant_id, , "Intercept"]
  rand_percProm1 <- ranef_output$participant[participant_id, , "percProm1"]
  rand_percProm2 <- ranef_output$participant[participant_id, , "percProm2"]
  rand_percProm3 <- ranef_output$participant[participant_id, , "percProm3"]
  
  # Combine fixed and random effects for each percProm level
  participant_effects <- data.frame(
    percProm_level = c("percProm0", "percProm1", "percProm2", "percProm3"),
    
    # Estimate: sum of fixed and random effects
    Estimate = c(
      rand_intercept["Estimate"], 
      rand_intercept["Estimate"] + rand_percProm1["Estimate"],
      rand_intercept["Estimate"] + rand_percProm2["Estimate"],
      rand_intercept["Estimate"] + rand_percProm3["Estimate"]
    ),
    
    # Standard Error: combining errors using sqrt of sum of squares
    Est.Error = c(
      sqrt(rand_intercept["Est.Error"]^2),
      sqrt(rand_intercept["Est.Error"]^2 + rand_percProm1["Est.Error"]^2),
      sqrt(rand_intercept["Est.Error"]^2 + rand_percProm2["Est.Error"]^2),
      sqrt(rand_intercept["Est.Error"]^2 + rand_percProm3["Est.Error"]^2)
    ),
    
    # Q2.5 and Q97.5: these need to be simulated to reflect the full posterior distribution
    Q2.5 = c(
      rand_intercept["Q2.5"], 
      rand_intercept["Q2.5"] + rand_percProm1["Q2.5"],
      rand_intercept["Q2.5"] + rand_percProm2["Q2.5"],
      rand_intercept["Q2.5"] + rand_percProm3["Q2.5"]
    ),
    Q97.5 = c(
      rand_intercept["Q97.5"], 
      rand_intercept["Q97.5"] + rand_percProm1["Q97.5"],
      rand_intercept["Q97.5"] + rand_percProm2["Q97.5"],
      rand_intercept["Q97.5"] + rand_percProm3["Q97.5"]
    )
  )
  
  participant_effects$participant <- participant_id
  return(participant_effects)
}

# Function to compute summary statistics for each difference
compute_summary <- function(diff) {
  estimate <- mean(diff)
  se <- sd(diff)
  ci_lower <- quantile(diff, 0.025)
  ci_upper <- quantile(diff, 0.975)
  prob <- mean(diff > 0)  # Posterior probability that difference > 0
  return(data.frame(Estimate = estimate, SE = se, CI.Lower = ci_lower, CI.Upper = ci_upper, Prob = prob))
}
```

## Load in data frames

```{r read metadata, echo=TRUE, message=FALSE, warning=FALSE}
participant_info <- read_delim(paste0(data,"ParticipantInfo_GERCAT.csv"), delim = ";")

# Load the information about duration of each segment (if needed)
data_df <- read.table(paste0(syllables, "fileDurationsDF.csv"), header = TRUE, sep = ',')

# Load cleaned syllable data
data <- read_csv(paste0(datasets, "data_cleaned.csv"))

# Load cleaned targets data
targets <- read_csv(paste0(datasets, "targets.csv"))

# Load cleaned targets with pre-post data
data_prepost <- read_csv(paste0(datasets, "data_prepost.csv"))
```

## You can add participant info

```{r metadata merge, echo=TRUE, message=FALSE, warning=FALSE}
# Process participant_info so that participant number column is only number
participant_info$Participant <- parse_number(participant_info$Participant)

# Convert the column names of participant_info to lowercase
colnames(participant_info) <- tolower(colnames(participant_info))

# Merge the dataframes by "Participant" and "Language"
data_prepost <- merge(data_prepost, participant_info, by = c("participant", "language"), all.x = TRUE)

```

# Data preparation

We split the table in two languages. Then, we only keep the relevant
columns (top 10 features).

```{r inspect data, echo=TRUE, message=FALSE, warning=FALSE}
# Turn variables to factors
data_prepost$percProm <- as.factor(data_prepost$percProm)
data_prepost$itemNum <- as.factor(data_prepost$itemNum)
data_prepost$focus <- as.factor(data_prepost$focus)
data_prepost$participant <- as.factor(data_prepost$participant)

# Add contrast-coded gender info (in case we want to use if)
data_prepost <- data_prepost %>% 
  mutate(gender_s = case_when(gender == "female" ~ 0.5,
                              gender == "male" ~ -0.5))

# First, remove some columns for both languages
data_prepost <- data_prepost %>%
  select(-f1_freq_median, -f1_freq_median_norm, -f2_freq_median, -f2_freq_median_norm, 
         -f1_freq_medianPre, -f1_freq_median_normPre, -f2_freq_medianPre, -f2_freq_median_normPre, 
         -f1_freq_medianPost, -f1_freq_median_normPost, -f2_freq_medianPost, -f2_freq_median_normPost
         )

# Adapt duration scale (because we set the priors for ms, not s)
data_prepost$duration <- data_prepost$duration * 1000
data_prepost$durationPre <- data_prepost$durationPre * 1000
data_prepost$durationPost <- data_prepost$durationPost * 1000
data_prepost$duration_noSilence <- data_prepost$duration_noSilence * 1000
data_prepost$duration_noSilencePre <- data_prepost$duration_noSilencePre * 1000
data_prepost$duration_noSilencePost <- data_prepost$duration_noSilencePost * 1000

# Create data_prepost_german for rows where language is German
data_prepost_ger <- data_prepost %>% 
  filter(language == "German")

# Create data_prepost_catalan for rows where language is Catalan
data_prepost_cat <- data_prepost %>% 
  filter(language == "Catalan")

# Select columns for German
data_prepost_ger <- data_prepost_ger %>%
  select(fileName, language, participant, gender, gender_s, age, 
         itemNum, focus, annotationNum, annotationNumTarget, 
         word, syllText, syllTextPre, syllTextPost, percProm,
         f0_slope, f0_slope_norm,
         pitch_median, pitch_median_norm,
         ampl_sd,
         ampl_noSilence_medianPost,
         ampl_noSilence_median,
         duration,
         flux_sd,
         flux_median,
         ampl_noSilence_sd,
         pitch_medianPost, pitch_median_normPost)

# Select columns for Catalan
data_prepost_cat <- data_prepost_cat %>%
  select(fileName, language, participant, gender, gender_s, age, 
         itemNum, focus, annotationNum, annotationNumTarget, 
         word, syllText, syllTextPre, syllTextPost, percProm,
         duration,
         f0_slopePost, f0_slope_normPost,
         fmDep_medianPost,
         entropySh_sd,
         flux_medianPost,
         ampl_medianPost,
         specCentroid_median,
         duration_noSilence,
         durationPre,
         ampl_sd)

```

Add information on pauses to test separately. First in German.

```{r pauses ger, echo=TRUE, message=FALSE, warning=FALSE}
# First, let's create a copy of data_prepost_ger to work on
data_prepost_ger_updated <- data_prepost_ger

# Add a new column durationPause and pausePre initialized to NA
data_prepost_ger_updated$durationPause <- NA
data_prepost_ger_updated$pausePre <- NA

# Loop through each row in data_prepost_ger where syllTextPre is NA
for (i in 1:nrow(data_prepost_ger_updated)) {
  # Check if syllTextPre is NA
  if (is.na(data_prepost_ger_updated$syllTextPre[i])) {
    
    # Get the corresponding fileName in this row
    fileName_i <- data_prepost_ger_updated$fileName[i]
    
    # Find the index of this fileName in the data dataset
    match_idx <- which(data$fileName == fileName_i)
    
    # If a match is found, and the previous row exists (to avoid out of bounds)
    if (length(match_idx) > 0 && match_idx > 1) {
      # Look at the previous row's syllText to see if it's "-p-"
      if (data$syllText[match_idx - 1] == "-p-") {
        # Extract the duration value from the previous row
        duration_value <- data$duration[match_idx - 1]
        
        # Update syllTextPre with "-p-" in data_prepost_ger
        data_prepost_ger_updated$syllTextPre[i] <- "-p-"
        
        # Update the durationPause column with the value from data
        data_prepost_ger_updated$durationPause[i] <- duration_value
      }
    }
  }
}

rm(i, fileName_i, duration_value, match_idx)

# Create the pausePre column based on whether durationPause is NA or not
data_prepost_ger_updated$pausePre <- ifelse(is.na(data_prepost_ger_updated$durationPause), "no", "yes")

data_prepost_ger <- data_prepost_ger_updated
rm(data_prepost_ger_updated)
```

Inspect.

```{r echo=TRUE, message=FALSE, warning=FALSE}
table(data_prepost_ger$pausePre)
prop.table(table(data_prepost_ger$pausePre))
```

It does not really make sense to investigate this in German.

Now in Catalan.

```{r pauses cat, echo=TRUE, message=FALSE, warning=FALSE}
# First, let's create a copy of data_prepost_cat to work on
data_prepost_cat_updated <- data_prepost_cat

# Add a new column durationPause and pausePre initialized to NA
data_prepost_cat_updated$durationPause <- NA
data_prepost_cat_updated$pausePre <- NA

# Loop through each row in data_prepost_cat where syllTextPre is NA
for (i in 1:nrow(data_prepost_cat_updated)) {
  # Check if syllTextPre is NA
  if (is.na(data_prepost_cat_updated$syllTextPre[i])) {
    
    # Get the corresponding fileName in this row
    fileName_i <- data_prepost_cat_updated$fileName[i]
    
    # Find the index of this fileName in the data dataset
    match_idx <- which(data$fileName == fileName_i)
    
    # If a match is found, and the previous row exists (to avoid out of bounds)
    if (length(match_idx) > 0 && match_idx > 1) {
      # Look at the previous row's syllText to see if it's "-p-"
      if (data$syllText[match_idx - 1] == "-p-") {
        # Extract the duration value from the previous row
        duration_value <- data$duration[match_idx - 1]
        
        # Update syllTextPre with "-p-" in data_prepost_cat
        data_prepost_cat_updated$syllTextPre[i] <- "-p-"
        
        # Update the durationPause column with the value from data
        data_prepost_cat_updated$durationPause[i] <- duration_value
      }
    }
  }
}

rm(i, fileName_i, duration_value, match_idx)

# Create the pausePre column based on whether durationPause is NA or not
data_prepost_cat_updated$pausePre <- ifelse(is.na(data_prepost_cat_updated$durationPause), "no", "yes")

data_prepost_cat <- data_prepost_cat_updated
rm(data_prepost_cat_updated)

```

What are the values in Catalan?

```{r echo=TRUE, message=FALSE, warning=FALSE}
table(data_prepost_cat$pausePre)
prop.table(table(data_prepost_cat$pausePre))
```

It makes more sense.

# Modeling

Given the goal of comparing the thresholds of changes in acoustic
features across prominence levels, while accounting for speaker
variability differences, a hierarchical (or mixed-effects) Bayesian
model with acoustic features as outcome variables will be a suitable
approach. This model allows you to account for the variability across
participants while focusing on estimating the thresholds.

## Catalan

Let's check the correlations between acoustic features.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Calculate the correlation matrix
corrCat <- cor(data_prepost_cat[, c("duration", "f0_slopePost", "fmDep_medianPost", 
                                    "entropySh_sd", "flux_medianPost", 
                                    "ampl_medianPost", "specCentroid_median", "duration_noSilence", 
                                    "durationPre", "ampl_sd")], use = "complete.obs")
corrplot(corrCat, method = "color", tl.cex = 0.7, number.cex = 0.7, addCoef.col = "black")
```

Let's set contrasts for comparisons.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Drop unused levels of percProm
data_prepost_cat$percProm <- droplevels(data_prepost_cat$percProm)
# Set sum contrasts for percProm to compare all levels
#contrasts(data_prepost_cat$percProm) <- contr.sum(length(unique(data_prepost_cat$percProm)))
```

What is the mean for gender.

```{r echo=TRUE, message=FALSE, warning=FALSE}
summary(data_prepost_cat$gender_s)
# 0.1563
```

We go one by one the ten features from top to bottom.

### Cumulative

```{r echo=TRUE, message=FALSE, warning=FALSE}
data_prepost_cat$percProm <- factor(data_prepost_cat$percProm, 
                                   levels = c(1, 2, 3), 
                                   ordered = TRUE)
```


#### Formulas

```{r echo=TRUE, message=FALSE, warning=FALSE}
durCum <- bf(
  percProm ~ 
     duration + 
     f0_slopePost + 
     fmDep_medianPost +
     entropySh_sd +
     flux_medianPost +
     ampl_medianPost +
     specCentroid_median +
     durationPre +
     ampl_sd +
    (1 | participant)
)

durCum_ranSlopes <- bf(
  percProm ~ 
     duration + 
     f0_slopePost + 
     fmDep_medianPost +
     entropySh_sd +
     flux_medianPost +
     ampl_medianPost +
     specCentroid_median +
     durationPre +
     ampl_sd +
    (1 + duration + 
     f0_slopePost + 
     fmDep_medianPost +
     flux_medianPost +
     ampl_medianPost +
     specCentroid_median +
     durationPre +
     ampl_sd | participant)
)

durCum_allInt <- bf(
  percProm ~ 
    (duration + 
     f0_slopePost + 
     fmDep_medianPost +
     entropySh_sd +
     flux_medianPost +
     ampl_medianPost +
     specCentroid_median +
     durationPre +
     ampl_sd) * 
    (duration + 
     f0_slopePost + 
     fmDep_medianPost +
     flux_medianPost +
     ampl_medianPost +
     specCentroid_median +
     durationPre +
     ampl_sd) +
    (1 + duration + 
     f0_slopePost + 
     fmDep_medianPost +
     flux_medianPost +
     ampl_medianPost +
     specCentroid_median +
     durationPre +
     ampl_sd | participant)
)
```


#### Priors

```{r echo=FALSE, message=FALSE, warning=FALSE}
get_prior(formula = durCum,
  data = data_prepost_cat,
  family = cumulative("logit")
)

prior_durCumCat <- c(
  set_prior("normal(0, 10)", class = "b", coef = "duration"),
  set_prior("normal(0, 10)", class = "b", coef = "specCentroid_median"),
  set_prior("normal(0, 10)", class = "b", coef = "durationPre"),
  set_prior("normal(0, 2)", class = "b", coef = "f0_slopePost"),
  set_prior("normal(0, 2)", class = "b", coef = "fmDep_medianPost"),
  set_prior("normal(0, 2)", class = "b", coef = "entropySh_sd"),
  set_prior("normal(0, 2)", class = "b", coef = "flux_medianPost"),
  set_prior("normal(0, 2)", class = "b", coef = "ampl_medianPost"),
  set_prior("normal(0, 2)", class = "b", coef = "ampl_sd"),
  set_prior("cauchy(0, 2.5)", class = "sd")
)
```

#### Model

```{r echo=FALSE, message=FALSE, warning=FALSE}
mdl_durCumCat <- brm(formula = dur,
                       data = data_prepost_cat,
                       family = cumulative("logit"),
                       prior = prior_durCumCat,
                       #backend = "cmdstanr", # depends on you
                       cores = 4,
                       chains = 4,
                       iter = 8000,
                       warmup = 4000,
                       seed = 998,
                       control = list(max_treedepth = 12,
                                      adapt_delta = 0.99),
                       file = paste0(models, "mdl_durCumCat.rds"))

# if we need to compress the model more
#saveRDS(mdl_durCumCat, file = paste0(models, "mdl_durCumCat.rds"), compress = "xz")

mdl_durCumCat <- readRDS(paste0(models, "mdl_durCumCat.rds"))
```


```{r echo=TRUE, message=FALSE, warning=FALSE}
pp_check(mdl_durCumCat)

conditional_effects(mdl_durCumCat, re_formula = NA, categorical = TRUE)

hypothesis(mdl_durCumCat, c("duration = 0",
                            "f0_slopePost = 0",
                            "fmDep_medianPost = 0",
                            "entropySh_sd = 0",
                            "flux_medianPost = 0",
                            "ampl_medianPost = 0",
                            "specCentroid_median = 0",
                            "durationPre = 0",
                            "ampl_sd = 0"))
```

### Duration

#### Priors

```{r echo=FALSE, message=FALSE, warning=FALSE}
get_prior(
  duration ~ 0 +
    percProm + gender_s + 
    (0 + percProm | participant),
  data = data_prepost_cat,
  family = lognormal()
)

prior_durationCat <- c(
  #prior('normal(0, 10)', class = 'Intercept', lb = 0),
  #prior('normal(0, 5)', class = 'b'),
  prior('normal(0, 10)', class = 'b', lb = 0),
  prior('normal(0, 5)', class = 'sd') 
)
```

#### Model

```{r echo=FALSE, message=FALSE, warning=FALSE}
mdl_durationCat <- brm(duration ~ 0 +
                         percProm + gender_s +
                         (0 + percProm | participant),
                       data = data_prepost_cat,
                       family = lognormal(),
                       prior = prior_durationCat,
                       #backend = "cmdstanr", # depends on you
                       cores = 4,
                       chains = 4,
                       iter = 8000,
                       warmup = 4000,
                       seed = 998,
                       control = list(max_treedepth = 12,
                                      adapt_delta = 0.99),
                       file = paste0(models, "mdl_durationCat.rds"))

# if we need to compress the model more
#saveRDS(mdl_durationCat, file = paste0(models, "mdl_durationCat.rds"), compress = "xz")

mdl_durationCat <- readRDS(paste0(models, "mdl_durationCat.rds"))
```

Calculate R².

```{r echo=FALSE, message=FALSE, warning=FALSE}
# # Calculate Bayesian R²
# mdl_durationCat_R2 <- bayes_R2(mdl_durationCat)
# # Save the R² output
# saveRDS(mdl_durationCat_R2, file = paste0(models, "mdl_durationCat_R2.rds"))

mdl_durationCat_R2 <- readRDS(paste0(models, "mdl_durationCat_R2.rds"))

mdl_durationCat_R2
```

An R² of approximately **0.17** suggests a *modest fit*. This value
indicates that the model explains about **17.2% of the variance** in the
dependent variable `duration`. In other words, a small portion of the
variability in `duration` is accounted for by the predictors in the
model. The **95% credible interval**, ranging from **14.6% to 19.9%**,
shows some uncertainty around this estimate but provides a stable
indication of the model's limited explanatory power.

#### Fixed effects

Let's check how it looks like.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Summarize the model
summary(mdl_durationCat)

# Extract fixed effects
exp(fixef(mdl_durationCat))
```

It shows a stable increase from 1 to 3.

Diagnostic plots.

```{r echo=TRUE, message=FALSE, warning=FALSE}
plot(mdl_durationCat)
```

Posterior predictive check.

```{r echo=TRUE, message=FALSE, warning=FALSE}
pp_check(mdl_durationCat, ndraws = 100)

pp_check(mdl_durationCat, type = "error_scatter_avg", ndraws = 100)
```

Extract samples.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of fixed effects
samples_mdl_durationCat <- as_draws_array(mdl_durationCat, 
                                          variable = "^b_", 
                                          regex = TRUE)
samples_mdl_durationCat <- mutate_variables(samples_mdl_durationCat, 
                                            exp_b_percProm1 = exp(b_percProm1),
                                            exp_b_percProm2 = exp(b_percProm2),
                                            exp_b_percProm3 = exp(b_percProm3))

# Summarize posterior draws
summarize_draws(samples_mdl_durationCat)
```

Check conditional effect.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Plot conditional effects (fixed effects only)
conditional_effects(mdl_durationCat, re_formula = NA)

# Extract conditional effects data
conditional_effects(mdl_durationCat, plot = FALSE, re_formula = NA)$percProm
```

Compare conditional effects to raw values.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Calculate raw means by percProm level
data_prepost_cat %>% 
  group_by(percProm) %>%
  summarize(avg_duration = mean(duration, na.rm = TRUE))

# Summary of duration
summary(data_prepost_cat$duration)
```

##### Effect comparison

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Compute estimated marginal means on log-scale
em_mdl_durationCat <- emmeans(mdl_durationCat, ~ percProm)
# Backtransform the post.beta values
em_mdl_durationCat@post.beta <- exp(em_mdl_durationCat@post.beta)
print(em_mdl_durationCat)
plot(em_mdl_durationCat)

# Perform pairwise comparisons between levels of percProm
emPairs_mdl_durationCat <- pairs(emmeans(mdl_durationCat, ~ percProm))
# Backtransform the post.beta values
emPairs_mdl_durationCat@post.beta <- exp(emPairs_mdl_durationCat@post.beta)
print(emPairs_mdl_durationCat)
plot(emPairs_mdl_durationCat)
```

If the comparison includes 0, the contrast is not reliably different.

##### Hypothesis testing

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of the fixed effects coefficients
as_draws_df(mdl_durationCat) %>%
  # Select fixed effects for percProm levels
  select(starts_with("b_percProm")) %>%
  # Rename columns to match percProm levels
  rename_with(~ str_replace(.x, "b_percProm", "percProm"), starts_with("b_percProm")) %>%
  # Compute differences between percProm levels
  mutate(
    diff_1_2 = exp(percProm1) - exp(percProm2),
    diff_1_3 = exp(percProm1) - exp(percProm3),
    diff_2_3 = exp(percProm2) - exp(percProm3)
  ) %>%
  # Gather differences into long format
  pivot_longer(
    cols = starts_with("diff_"),
    names_to = "Comparison",
    values_to = "Difference"
  ) %>%
  # Group by comparison to compute summary statistics
  group_by(Comparison) %>%
  summarise(
    Estimate = mean(Difference),
    Est.Error = sd(Difference),
    CI.Lower = quantile(Difference, 0.025),
    CI.Upper = quantile(Difference, 0.975),
    Post.Prob = if_else(Estimate > 0,
                        mean(Difference > 0) * 100,
                        mean(Difference < 0) * 100)
  ) %>%
  ungroup() %>%
  # Add significance stars based on posterior probability
  mutate(
    Star = ifelse(Post.Prob > 95 | Post.Prob < 5, "*", ""),
    Estimate = round(Estimate, 3),
    Est.Error = round(Est.Error, 3),
    CI.Lower = round(CI.Lower, 3),
    CI.Upper = round(CI.Upper, 3),
    Post.Prob = round(Post.Prob, 2)
  ) %>%
  # Select and arrange the final columns
  select(Comparison, Estimate, Est.Error, CI.Lower, CI.Upper, Post.Prob, Star) %>%
  arrange(Comparison)
```

-   **`diff_1_2`:** Estimate = -19.6 [-29.6, -9.36], Posterior
    Probability = 99.9%; Strong evidence suggests that the `duration` at
    `percProm2` is higher than at `percProm1`. The credible interval
    does not include zero, and the high posterior probability confirms
    this difference.

-   **`diff_1_3`:** Estimate = -46.2 [-62.9, -29.3], Posterior
    Probability = 100%; Strong evidence indicates that the `duration` at
    `percProm3` is higher than at `percProm1`. The negative estimate and
    credible interval entirely below zero show a reliable difference
    between these levels.

-   **`diff_2_3`:** Estimate = -26.6 [-40.8, -12.5], Posterior
    Probability = 100%; Strong evidence that `duration` at `percProm3`
    is higher than at `percProm2`. The credible interval is entirely
    negative, supporting this increase in `duration` with rising
    `percProm`.

**Overall Implications:**

-   **Trend:** The results indicate a consistent increase in `duration`
    across `percProm` levels, moving from `percProm1` to `percProm3`.

-   **Interpretation:** Each higher level of `percProm` is associated
    with a reliably longer `duration`. The strong posterior
    probabilities and credible intervals suggest that as perceived
    prominence (percProm) increases, so does `duration`, supporting a
    stable trend in the data.

##### Plot fixef

Visualize the (non-)linearity of the effect with a violin plot of the
posteriors for each prominence level and a GAMM overlaid on top.

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_cat %>%
  data_grid(percProm = unique(percProm),
            gender_s = 0.1563) %>% # Set to average of gender
  add_epred_draws(mdl_durationCat, re_formula = NA) %>%
  mutate(
    percProm_num = as.numeric(as.character(percProm)),
    percProm = factor(percProm, levels = c("1", "2", "3"))
  ) %>%
  ggplot(aes(x = percProm_num, y = .epred, color = percProm)) +
  geom_violin(aes(group = percProm_num, fill = percProm), alpha = 0.8) +
  scale_color_manual(values = colorBlindBlack8) +
  scale_fill_manual(values = colorBlindBlack8) +
  stat_summary(fun = median, geom = "point", color = colorBlindBlack8[7], size = 2) +
  geom_smooth(
    aes(group = 1),
    method = "gam",
    formula = y ~ s(x, bs = "cs", k = 3),
    color = colorBlindBlack8[7],
    se = FALSE
  ) +
  scale_x_continuous(
    breaks = 0:3,
    labels = as.character(0:3)
  ) +
  #ylim(1, 5) +
  labs(
    x = "Perceived prominence level",
    y = "Posterior duration"
  ) +
  theme_minimal()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
post_durationCat <- 
  data_prepost_cat %>%
  data_grid(
    percProm = unique(percProm),
    gender_s = 0.1563  # Set gender_s to zero to average over gender
  ) %>%
  add_epred_draws(mdl_durationCat, re_formula = NA) %>%
  mutate(
    percProm = factor(percProm, levels = c("1", "2", "3"))
  ) %>%
  ggplot(aes(y = percProm, x = .epred, fill = percProm)) +
  ggdist::stat_halfeye(
    adjust = 0.5,
    width = 0.6,
    .width = c(0.66, 0.95),
    justification = -0.1,
    point_colour = NA
  ) +
  geom_boxplot(
    width = 0.15,
    outlier.shape = NA,
    alpha = 0.5,
    position = position_nudge(y = 0.2)
  ) +
  stat_summary(
    fun = median,
    geom = "point",
    color = "red",
    size = 2,
    position = position_nudge(y = 0.2)
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  coord_flip() +
  theme_minimal() +
  theme(text = element_text(size = 18)) +
  #xlim(1, 3.5) +
  labs(
    y = "Perceived prominence level",
    x = "Posterior duration",
    fill = "Perceived\nprominence"
  )

post_durationCat;
ggsave(plot = post_durationCat, filename = paste0(plots, "posterior_durationCat.pdf"), 
       width = 8, height = 6);
ggsave(plot = post_durationCat, filename = paste0(plots, "posterior_durationCat.jpg"), 
       width = 8, height = 6);
ggsave(plot = post_durationCat, filename = paste0(plots, "posterior_durationCat.tif"), 
       width = 8, height = 6, compression="lzw", dpi=600);
```

#### Group-level effects

First, get a general overview.

```{r echo=FALSE, message=FALSE, warning=FALSE}
as.data.frame(VarCorr(mdl_durationCat)$participant$sd) %>%
  rownames_to_column(var = "Random Effect") %>%
  select(`Random Effect`, Estimate, Est.Error, Q2.5, Q97.5)
```

-   **percProm1:** The estimated standard deviation is 0.160 (95% CrI:
    0.108 to 0.225), indicating moderate variability in participants'
    response to `percProm1`.

-   **percProm2:** The estimated standard deviation is 0.138 (95% CrI:
    0.105 to 0.182), suggesting slightly less variability in
    participants' response to `percProm2` compared to `percProm1`.

-   **percProm3:** The estimated standard deviation is 0.184 (95% CrI:
    0.119 to 0.266), showing increased variability in response to
    `percProm3` relative to the other prominence levels, indicating that
    participants exhibit a wider range of responses at this level.

**Overall Interpretation:** These results suggest that as perceived
prominence increases from `percProm1` to `percProm3`, the variability in
participants' responses tends to fluctuate, with `percProm3` showing the
highest variability. This pattern may imply that the highest level of
perceived prominence elicits a more diverse range of responses in terms
of `durationCat`.

Extract samples in interpretable units. Then, plot them so that we can
see how each participant uses the levels of percProm.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract samples for each participant x percProm
data_prepost_cat %>% 
  data_grid(
    participant = unique(participant),
    percProm = unique(percProm),
    gender_s = 0.1563 # Average over gender
  ) %>% 
  add_epred_draws(mdl_durationCat) %>% 
  median_qi()

# Plot the draws for all participants x percProm levels
data_prepost_cat %>%
  # Start by selecting unique participants and their gender_s
  select(participant, gender_s) %>%
  distinct() %>%
  # Back-transform gender_s to gender labels
  mutate(
    gender = if_else(gender_s == -0.5, "Male", "Female")
  ) %>%
  # Combine with percProm levels
  crossing(
    percProm = unique(data_prepost_cat$percProm)
  ) %>%
  # Generate posterior predictions
  add_epred_draws(mdl_durationCat) %>%
  # Summarize predictions with .66 and .95 intervals
  median_qi(.width = c(.66, .95)) %>%
  ggplot(aes(x = .epred, y = participant, color = percProm, shape = gender)) +
  # Add the thick line for 66% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.66),  # Use 66% credible interval
                 size = 1,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add the thin line for 95% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.95),  # Use 95% credible interval
                 size = 0.5,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add points with shapes
  geom_point(position = position_dodge(width = 0.7), size = 2.5) +
  scale_color_manual(values = colorBlindBlack8) +
  labs(
    x = "Posterior duration",
    y = "Participant",
    color = "Perceived prominence",
    shape = "Gender"
  ) +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines")
  )
```

First, we extract individual draws. Here, if the CrI encompasses 0, the
participant does not differ from the overall behavior on this percProm.
Then, we plot random effects for each participant and percProm level on
the model scale, representing deviations from the fixed effects.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# We focus on 95% CrI, but this can be adapted in the width parameter
mdl_durationCat %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95))

# In log without Intercept
mdl_durationCat %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95, .8, .5)) %>%
  ggplot(aes(y = as.factor(participant), x = r_participant, color = percProm, xmin = .lower, xmax = .upper)) +
  geom_pointinterval(
    position = "dodge") +
  scale_color_manual(
    values = colorBlindBlack8) +
  labs(
    x = "Individual deviations in duration",
    y = "Participant",
    color = "Perceived prominence") +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines") 
  )

```

### F0 slope (post-tonic)

#### Priors

```{r echo=FALSE, message=FALSE, warning=FALSE}
get_prior(
  f0_slopePost ~ 0 +
    percProm + gender_s + 
    (0 + percProm | participant),
  data = data_prepost_cat,
  family = "student"
)

prior_f0_slopePostCat <- c(
  #prior('normal(0, 5)', class = "b"), 
  prior('student_t(3, 0, 10)', class = "b"),
  #prior('student_t(3, 0, 10)', class = "Intercept"), 
  prior('student_t(3, 0, 10)', class = "sd") 
)
```

#### Model

```{r echo=FALSE, message=FALSE, warning=FALSE}
mdl_f0_slopePostCat <- brm(f0_slopePost ~ 0 +
                         percProm + gender_s + 
                         (0 + percProm | participant),
                       data = data_prepost_cat,
                       family = "student",
                       prior = prior_f0_slopePostCat,
                       #backend = "cmdstanr", # depends on you
                       cores = 4,
                       chains = 4,
                       iter = 8000,
                       warmup = 4000,
                       seed = 998,
                       control = list(max_treedepth = 12,
                                      adapt_delta = 0.99),
                       file = paste0(models, "mdl_f0_slopePostCat.rds"))

# if we need to compress the model more
#saveRDS(mdl_f0_slopePostCat, file = paste0(models, "mdl_f0_slopePostCat.rds"), compress = "xz")

mdl_f0_slopePostCat <- readRDS(paste0(models, "mdl_f0_slopePostCat.rds"))
```

Calculate R².

```{r echo=FALSE, message=FALSE, warning=FALSE}
# # Calculate Bayesian R²
# mdl_f0_slopePostCat_R2 <- bayes_R2(mdl_f0_slopePostCat)
# # Save the R² output
# saveRDS(mdl_f0_slopePostCat_R2, file = paste0(models, "mdl_f0_slopePostCat_R2.rds"))

mdl_f0_slopePostCat_R2 <- readRDS(paste0(models, "mdl_f0_slopePostCat_R2.rds"))

mdl_f0_slopePostCat_R2
```

An R² of approximately 0.07 suggests a **weak fit**, indicating that the
model explains only about **6.6% of the variance** in the dependent
variable `f0_slopePostCat`. In other words, a small portion of the
variability in `f0_slopePostCat` is accounted for by the predictors in
the model. The 95% credible interval, ranging from **5.3% to 8.1%**,
reflects some uncertainty around this estimate, but it generally
confirms the model's limited explanatory power.

#### Fixed effects

Let's check how it looks like.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Summarize the model
summary(mdl_f0_slopePostCat)

# Extract fixed effects
fixef(mdl_f0_slopePostCat)
```

It shows a stable increase from 1 to 2, and then a drop from 2 to 3.

Diagnostic plots.

```{r echo=TRUE, message=FALSE, warning=FALSE}
plot(mdl_f0_slopePostCat)
```

Posterior predictive check.

```{r echo=TRUE, message=FALSE, warning=FALSE}
pp_check(mdl_f0_slopePostCat, ndraws = 100)

pp_check(mdl_f0_slopePostCat, type = "error_scatter_avg", ndraws = 100)
```

Extract samples.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Extract posterior samples of fixed effects
samples_mdl_f0_slopePostCat <- as_draws_array(mdl_f0_slopePostCat, 
                                          variable = "^b_", 
                                          regex = TRUE)

# Summarize posterior draws
summarize_draws(samples_mdl_f0_slopePostCat)
```

Check conditional effect.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Plot conditional effects (fixed effects only)
conditional_effects(mdl_f0_slopePostCat, re_formula = NA)

# Extract conditional effects data
conditional_effects(mdl_f0_slopePostCat, plot = FALSE, re_formula = NA)$percProm
```

Compare conditional effects to raw values.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Calculate raw means by percProm level
data_prepost_cat %>% 
  group_by(percProm) %>%
  summarize(avg_f0_slopePost = mean(f0_slopePost, na.rm = TRUE))

# Summary of f0_slopePost
summary(data_prepost_cat$f0_slopePost)
```

##### Effect comparison

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Compute estimated marginal means on log-scale
em_mdl_f0_slopePostCat <- emmeans(mdl_f0_slopePostCat, ~ percProm)
print(em_mdl_f0_slopePostCat)
plot(em_mdl_f0_slopePostCat)

# Perform pairwise comparisons between levels of percProm
emPairs_mdl_f0_slopePostCat <- pairs(emmeans(mdl_f0_slopePostCat, ~ percProm))
print(emPairs_mdl_f0_slopePostCat)
plot(emPairs_mdl_f0_slopePostCat)
```

If the comparison includes 0, the contrast is not reliably different.

##### Hypothesis testing

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Extract posterior samples of the fixed effects coefficients
as_draws_df(mdl_f0_slopePostCat) %>%
  # Select fixed effects for percProm levels
  select(starts_with("b_percProm")) %>%
  # Rename columns to match percProm levels
  rename_with(~ str_replace(.x, "b_percProm", "percProm"), starts_with("b_percProm")) %>%
  # Compute differences between percProm levels
  mutate(
    diff_1_2 = percProm1 - percProm2,
    diff_1_3 = percProm1 - percProm3,
    diff_2_3 = percProm2 - percProm3
  ) %>%
  # Gather differences into long format
  pivot_longer(
    cols = starts_with("diff_"),
    names_to = "Comparison",
    values_to = "Difference"
  ) %>%
  # Group by comparison to compute summary statistics
  group_by(Comparison) %>%
  summarise(
    Estimate = mean(Difference),
    Est.Error = sd(Difference),
    CI.Lower = quantile(Difference, 0.025),
    CI.Upper = quantile(Difference, 0.975),
    Post.Prob = if_else(Estimate > 0,
                        mean(Difference > 0) * 100,
                        mean(Difference < 0) * 100)
  ) %>%
  ungroup() %>%
  # Add significance stars based on posterior probability
  mutate(
    Star = ifelse(Post.Prob > 95 | Post.Prob < 5, "*", ""),
    Estimate = round(Estimate, 3),
    Est.Error = round(Est.Error, 3),
    CI.Lower = round(CI.Lower, 3),
    CI.Upper = round(CI.Upper, 3),
    Post.Prob = round(Post.Prob, 2)
  ) %>%
  # Select and arrange the final columns
  select(Comparison, Estimate, Est.Error, CI.Lower, CI.Upper, Post.Prob, Star) %>%
  arrange(Comparison)
```

-   **`diff_1_2`**: Estimate = -0.058 [-0.096, -0.021], Posterior
    Probability = 99.9%; There is strong evidence that the
    `f0_slopePostCat` value increases from `percProm1` to `percProm2`.
    The negative estimate, combined with a high posterior probability
    and a credible interval that excludes zero, supports this finding.

-   **`diff_1_3`**: Estimate = 0.083 [0.036, 0.128], Posterior
    Probability = 99.9%; There is strong evidence that `f0_slopePostCat`
    is lower at `percProm3` than at `percProm1`. The positive estimate,
    high posterior probability, and credible interval entirely above
    zero indicate a reliable increase.

-   **`diff_2_3`**: Estimate = 0.141 [0.095, 0.186], Posterior
    Probability = 100%; There is strong evidence that `f0_slopePostCat`
    decreases from `percProm2` to `percProm3`. The positive estimate and
    a credible interval that does not include zero affirm this upward
    trend.

**Overall Implications:**

-   **Trend**: The findings suggest a non-linear trend in
    `f0_slopePostCat` across prominence levels, with a increase from
    `percProm1` to `percProm2` followed by a consistent decrease from
    `percProm1` (and `percProm2`) to `percProm3`.

-   **Interpretation**: The posterior probabilities and credible
    intervals indicate strong support for these changes across the
    prominence levels, suggesting that `f0_slopePostCat` varies
    significantly in response to perceived prominence, with the largest
    decrease observed between `percProm2` and `percProm3`.

##### Plot fixef

Visualize the (non-)linearity of the effect with a violin plot of the
posteriors for each prominence level and a GAMM overlaid on top.

```{r echo=TRUE, message=FALSE, warning=FALSE}
data_prepost_cat %>%
  data_grid(percProm = unique(percProm),
            gender_s = 0.1563) %>% # Set to average of gender
  add_epred_draws(mdl_f0_slopePostCat, re_formula = NA) %>%
  mutate(
    percProm_num = as.numeric(as.character(percProm)),
    percProm = factor(percProm, levels = c("1", "2", "3"))
  ) %>%
  ggplot(aes(x = percProm_num, y = .epred, color = percProm)) +
  geom_violin(aes(group = percProm_num, fill = percProm), alpha = 0.8) +
  scale_color_manual(values = colorBlindBlack8) +
  scale_fill_manual(values = colorBlindBlack8) +
  stat_summary(fun = median, geom = "point", color = colorBlindBlack8[7], size = 2) +
  geom_smooth(
    aes(group = 1),
    method = "gam",
    formula = y ~ s(x, bs = "cs", k = 3),
    color = colorBlindBlack8[7],
    se = FALSE
  ) +
  scale_x_continuous(
    breaks = 0:3,
    labels = as.character(0:3)
  ) +
  #ylim(1, 5) +
  labs(
    x = "Perceived prominence level",
    y = "Posterior f0 slope (post-tonic)"
  ) +
  theme_minimal()
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
post_f0_slopePostCat <- 
  data_prepost_cat %>%
  data_grid(
    percProm = unique(percProm),
    gender_s = 0.1563  # Set gender_s to zero to average over gender
  ) %>%
  add_epred_draws(mdl_f0_slopePostCat, re_formula = NA) %>%
  mutate(
    percProm = factor(percProm, levels = c("1", "2", "3"))
  ) %>%
  ggplot(aes(y = percProm, x = .epred, fill = percProm)) +
  ggdist::stat_halfeye(
    adjust = 0.5,
    width = 0.6,
    .width = c(0.66, 0.95),
    justification = -0.1,
    point_colour = NA
  ) +
  geom_boxplot(
    width = 0.15,
    outlier.shape = NA,
    alpha = 0.5,
    position = position_nudge(y = 0.2)
  ) +
  stat_summary(
    fun = median,
    geom = "point",
    color = "red",
    size = 2,
    position = position_nudge(y = 0.2)
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  coord_flip() +
  theme_minimal() +
  theme(text = element_text(size = 18)) +
  #xlim(1, 3.5) +
  labs(
    y = "Perceived prominence level",
    x = "Posterior f0 slope (post-tonic)",
    fill = "Perceived\nprominence"
  )

post_f0_slopePostCat;
ggsave(plot = post_f0_slopePostCat, filename = paste0(plots, "posterior_f0_slopePostCat.pdf"), 
       width = 8, height = 6);
ggsave(plot = post_f0_slopePostCat, filename = paste0(plots, "posterior_f0_slopePostCat.jpg"), 
       width = 8, height = 6);
ggsave(plot = post_f0_slopePostCat, filename = paste0(plots, "posterior_f0_slopePostCat.tif"), 
       width = 8, height = 6, compression="lzw", dpi=600);
```

#### Group-level effects

First, get a general overview.

```{r echo=TRUE, message=FALSE, warning=FALSE}
as.data.frame(VarCorr(mdl_f0_slopePostCat)$participant$sd) %>%
  rownames_to_column(var = "Random Effect") %>%
  select(`Random Effect`, Estimate, Est.Error, Q2.5, Q97.5)
```

-   **percProm1**: The estimated standard deviation of random effects at
    `percProm1` is 0.027 (95% CrI: 0.001 to 0.063), suggesting limited
    variability among participants' responses at this level. Although
    small, the credible interval indicates some uncertainty, allowing
    for variability in individual responses.

-   **percProm2**: The estimated standard deviation at `percProm2` is
    0.084 (95% CrI: 0.062 to 0.113), indicating moderate variability
    among participants. The narrower credible interval compared to
    `percProm1` suggests that the variation in response is more
    consistently observed at this level.

-   **percProm3**: The estimated standard deviation at `percProm3` is
    0.088 (95% CrI: 0.046 to 0.138), indicating moderate variability.
    The credible interval highlights that participants show more
    individualized responses at this level, which could be due to
    different interpretations of prominence.

**Overall Implications:**

-   **Trend**: Participant variability in `f0_slopePostCat` tends to
    increase as the prominence level rises from `percProm1` to
    `percProm3`.

-   **Interpretation**: These results suggest that responses at higher
    prominence levels (`percProm2` and `percProm3`) exhibit greater
    participant-specific variability, possibly reflecting more nuanced
    individual differences in response to perceived prominence at these
    levels.

Extract samples in interpretable units. Then, plot them so that we can
see how each participant uses the levels of percProm.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Extract samples for each participant x percProm
data_prepost_cat %>% 
  data_grid(
    participant = unique(participant),
    percProm = unique(percProm),
    gender_s = 0.1563 # Average over gender
  ) %>% 
  add_epred_draws(mdl_f0_slopePostCat) %>% 
  median_qi()

# Plot the draws for all participants x percProm levels
data_prepost_cat %>%
  # Start by selecting unique participants and their gender_s
  select(participant, gender_s) %>%
  distinct() %>%
  # Back-transform gender_s to gender labels
  mutate(
    gender = if_else(gender_s == -0.5, "Male", "Female")
  ) %>%
  # Combine with percProm levels
  crossing(
    percProm = unique(data_prepost_cat$percProm)
  ) %>%
  # Generate posterior predictions
  add_epred_draws(mdl_f0_slopePostCat) %>%
  # Summarize predictions with .66 and .95 intervals
  median_qi(.width = c(.66, .95)) %>%
  ggplot(aes(x = .epred, y = participant, color = percProm, shape = gender)) +
  # Add the thick line for 66% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.66),  # Use 66% credible interval
                 size = 1,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add the thin line for 95% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.95),  # Use 95% credible interval
                 size = 0.5,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add points with shapes
  geom_point(position = position_dodge(width = 0.7), size = 2.5) +
  scale_color_manual(values = colorBlindBlack8) +
  labs(
    x = "Posterior f0 slope (post-tonic)",
    y = "Participant",
    color = "Perceived prominence",
    shape = "Gender"
  ) +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines")
  )
```

First, we extract individual draws. Here, if the CrI encompasses 0, the
participant does not differ from the overall behavior on this percProm.
Then, we plot random effects for each participant and percProm level on
the model scale, representing deviations from the fixed effects.

```{r echo=TRUE, message=FALSE, warning=FALSE}
# We focus on 95% CrI, but this can be adapted in the width parameter
mdl_f0_slopePostCat %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95))

# In log without Intercept
mdl_f0_slopePostCat %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95, .8, .5)) %>%
  ggplot(aes(y = as.factor(participant), x = r_participant, color = percProm, xmin = .lower, xmax = .upper)) +
  geom_pointinterval(
    position = "dodge") +
  scale_color_manual(
    values = colorBlindBlack8) +
  labs(
    x = "Individual deviations in f0 slope (post-tonic)",
    y = "Participant",
    color = "Perceived prominence") +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines") 
  )

```

### Frequency modulation median (post-tonic)

#### Priors

```{r echo=FALSE, message=FALSE, warning=FALSE}
get_prior(
  fmDep_medianPost ~ 0 +
    percProm + gender_s + 
    (0 + percProm | participant),
  data = data_prepost_cat,
  family = lognormal()
)

prior_fmDep_medianPostCat <- c(
  #prior('normal(0, 3)', class = 'Intercept', lb = 0),
  #prior('normal(0, 1)', class = 'b'),
  prior('normal(0, 3)', class = 'b', lb = 0),
  prior('normal(0, 1)', class = 'sd')
)
```

#### Model

```{r echo=FALSE, message=FALSE, warning=FALSE}
mdl_fmDep_medianPostCat <- brm(fmDep_medianPost ~ 0 +
                         percProm + gender_s + 
                         (0 + percProm | participant),
                       data = data_prepost_cat,
                       family = lognormal(),
                       prior = prior_fmDep_medianPostCat,
                       #backend = "cmdstanr", # depends on you
                       cores = 4,
                       chains = 4,
                       iter = 8000,
                       warmup = 4000,
                       seed = 998,
                       control = list(max_treedepth = 12,
                                      adapt_delta = 0.99),
                       file = paste0(models, "mdl_fmDep_medianPostCat.rds"))

# if we need to compress the model more
#saveRDS(mdl_fmDep_medianPostCat, file = paste0(models, "mdl_fmDep_medianPostCat.rds"), compress = "xz")

mdl_fmDep_medianPostCat <- readRDS(paste0(models, "mdl_fmDep_medianPostCat.rds"))
```

Calculate R².

```{r echo=FALSE, message=FALSE, warning=FALSE}
# # Calculate Bayesian R²
# mdl_fmDep_medianPostCat_R2 <- bayes_R2(mdl_fmDep_medianPostCat)
# # Save the R² output
# saveRDS(mdl_fmDep_medianPostCat_R2, file = paste0(models, "mdl_fmDep_medianPostCat_R2.rds"))

mdl_fmDep_medianPostCat_R2 <- readRDS(paste0(models, "mdl_fmDep_medianPostCat_R2.rds"))

mdl_fmDep_medianPostCat_R2
```

An R² of approximately 0.17 suggests a **modest fit**, indicating that
the model explains about **17%** of the variance in the dependent
variable `fmDep_medianPostCat`. This means that just under one-fifth of
the variability in `fmDep_medianPostCat` is accounted for by the
predictors. The 95% credible interval, which ranges from **11.9% to
23.7%**, reflects some uncertainty around the exact R² value but still
suggests a modest level of explanatory power for the model.

#### Fixed effects

Let's check how it looks like.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Summarize the model
summary(mdl_fmDep_medianPostCat)

# Extract fixed effects
exp(fixef(mdl_fmDep_medianPostCat))
```

It shows a decrease from 1 to 2 and then increase from 2 to 3. 1 and 3
are the same.

Diagnostic plots.

```{r echo=FALSE, message=FALSE, warning=FALSE}
plot(mdl_fmDep_medianPostCat)
```

Posterior predictive check.

```{r echo=FALSE, message=FALSE, warning=FALSE}
pp_check(mdl_fmDep_medianPostCat, ndraws = 100)

pp_check(mdl_fmDep_medianPostCat, type = "error_scatter_avg", ndraws = 100)
```

Extract samples.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of fixed effects
samples_mdl_fmDep_medianPostCat <- as_draws_array(mdl_fmDep_medianPostCat, 
                                          variable = "^b_", 
                                          regex = TRUE)
samples_mdl_fmDep_medianPostCat <- mutate_variables(samples_mdl_fmDep_medianPostCat, 
                                            exp_b_percProm1 = exp(b_percProm1),
                                            exp_b_percProm2 = exp(b_percProm2),
                                            exp_b_percProm3 = exp(b_percProm3))

# Summarize posterior draws
summarize_draws(samples_mdl_fmDep_medianPostCat)
```

Check conditional effect.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Plot conditional effects (fixed effects only)
conditional_effects(mdl_fmDep_medianPostCat, re_formula = NA)

# Extract conditional effects data
conditional_effects(mdl_fmDep_medianPostCat, plot = FALSE, re_formula = NA)$percProm
```

Compare conditional effects to raw values.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Calculate raw means by percProm level
data_prepost_cat %>% 
  group_by(percProm) %>%
  summarize(avg_fmDep_medianPost = mean(fmDep_medianPost, na.rm = TRUE))

# Summary of fmDep_medianPost
summary(data_prepost_cat$fmDep_medianPost)
```

##### Effect comparison

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Compute estimated marginal means on log-scale
em_mdl_fmDep_medianPostCat <- emmeans(mdl_fmDep_medianPostCat, ~ percProm)
# Backtransform the post.beta values
em_mdl_fmDep_medianPostCat@post.beta <- exp(em_mdl_fmDep_medianPostCat@post.beta)
print(em_mdl_fmDep_medianPostCat)
plot(em_mdl_fmDep_medianPostCat)

# Perform pairwise comparisons between levels of percProm
emPairs_mdl_fmDep_medianPostCat <- pairs(emmeans(mdl_fmDep_medianPostCat, ~ percProm))
# Backtransform the post.beta values
emPairs_mdl_fmDep_medianPostCat@post.beta <- exp(emPairs_mdl_fmDep_medianPostCat@post.beta)
print(emPairs_mdl_fmDep_medianPostCat)
plot(emPairs_mdl_fmDep_medianPostCat)
```

If the comparison includes 0, the contrast is not reliably different.

##### Hypothesis testing

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of the fixed effects coefficients
as_draws_df(mdl_fmDep_medianPostCat) %>%
  # Select fixed effects for percProm levels
  select(starts_with("b_percProm")) %>%
  # Rename columns to match percProm levels
  rename_with(~ str_replace(.x, "b_percProm", "percProm"), starts_with("b_percProm")) %>%
  # Compute differences between percProm levels
  mutate(
    diff_1_2 = percProm1 - percProm2,
    diff_1_3 = percProm1 - percProm3,
    diff_2_3 = percProm2 - percProm3
  ) %>%
  # Gather differences into long format
  pivot_longer(
    cols = starts_with("diff_"),
    names_to = "Comparison",
    values_to = "Difference"
  ) %>%
  # Group by comparison to compute summary statistics
  group_by(Comparison) %>%
  summarise(
    Estimate = mean(Difference),
    Est.Error = sd(Difference),
    CI.Lower = quantile(Difference, 0.025),
    CI.Upper = quantile(Difference, 0.975),
    Post.Prob = if_else(Estimate > 0,
                        mean(Difference > 0) * 100,
                        mean(Difference < 0) * 100)
  ) %>%
  ungroup() %>%
  # Add significance stars based on posterior probability
  mutate(
    Star = ifelse(Post.Prob > 95 | Post.Prob < 5, "*", ""),
    Estimate = round(Estimate, 3),
    Est.Error = round(Est.Error, 3),
    CI.Lower = round(CI.Lower, 3),
    CI.Upper = round(CI.Upper, 3),
    Post.Prob = round(Post.Prob, 2)
  ) %>%
  # Select and arrange the final columns
  select(Comparison, Estimate, Est.Error, CI.Lower, CI.Upper, Post.Prob, Star) %>%
  arrange(Comparison)
```

-   **`diff_1_2`:** Estimate = 0.112 [-0.126, 0.532], Posterior
    Probability = 75.4%; There is moderate evidence suggesting that
    `fmDep_medianPostCat` at `percProm2` may be lower than at
    `percProm1`. However, the credible interval includes zero,
    indicating that this difference is not reliable.

-   **`diff_1_3`:** Estimate = -0.016 [-0.474, 0.455], Posterior
    Probability = 52.9%; There is no strong evidence for a difference
    between `percProm1` and `percProm3`. The posterior probability is
    near chance, and the wide credible interval includes zero, making
    the difference inconclusive.

-   **`diff_2_3`:** Estimate = -0.127 [-0.552, 0.124], Posterior
    Probability = 78.2%; There is moderate evidence that
    `fmDep_medianPostCat` at `percProm3` might be higher than at
    `percProm2`, but the credible interval includes zero, suggesting
    that this difference is not robust.

**Overall Implications:**

-   **Trend:** There is no clear, strong evidence of reliable
    differences in `fmDep_medianPostCat` between the `percProm` levels.
    While there is moderate evidence for some comparisons, the inclusion
    of zero in all credible intervals indicates that the results are
    inconclusive.

##### Plot fixef

Visualize the (non-)linearity of the effect with a violin plot of the
posteriors for each prominence level and a GAMM overlaid on top.

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_cat %>%
  data_grid(percProm = unique(percProm),
            gender_s = 0.1563) %>% # Set to average of gender
  add_epred_draws(mdl_fmDep_medianPostCat, re_formula = NA) %>%
  mutate(
    percProm_num = as.numeric(as.character(percProm)),
    percProm = factor(percProm, levels = c("1", "2", "3"))
  ) %>%
  ggplot(aes(x = percProm_num, y = .epred, color = percProm)) +
  geom_violin(aes(group = percProm_num, fill = percProm), alpha = 0.8) +
  scale_color_manual(values = colorBlindBlack8) +
  scale_fill_manual(values = colorBlindBlack8) +
  stat_summary(fun = median, geom = "point", color = colorBlindBlack8[7], size = 2) +
  geom_smooth(
    aes(group = 1),
    method = "gam",
    formula = y ~ s(x, bs = "cs", k = 3),
    color = colorBlindBlack8[7],
    se = FALSE
  ) +
  scale_x_continuous(
    breaks = 0:3,
    labels = as.character(0:3)
  ) +
  #ylim(1, 5) +
  labs(
    x = "Perceived prominence level",
    y = "Posterior freq. modulation median (post-tonic)"
  ) +
  theme_minimal()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_cat %>%
  data_grid(
    percProm = unique(percProm),
    gender_s = 0.1563  # Set gender_s to zero to average over gender
  ) %>%
  add_epred_draws(mdl_fmDep_medianPostCat, re_formula = NA) %>%
  mutate(
    percProm = factor(percProm, levels = c("1", "2", "3"))
  ) %>%
  ggplot(aes(y = percProm, x = .epred, fill = percProm)) +
  ggdist::stat_halfeye(
    adjust = 0.5,
    width = 0.6,
    .width = c(0.66, 0.95),
    justification = -0.1,
    point_colour = NA
  ) +
  geom_boxplot(
    width = 0.15,
    outlier.shape = NA,
    alpha = 0.5,
    position = position_nudge(y = 0.2)
  ) +
  stat_summary(
    fun = median,
    geom = "point",
    color = "red",
    size = 2,
    position = position_nudge(y = 0.2)
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  coord_flip() +
  theme_minimal() +
  xlim(1.5, 4) +
  labs(
    y = "Perceived prominence level",
    x = "Posterior freq. modulation median (post-tonic)"
  )
```

#### Group-level effects

First, get a general overview.

```{r echo=FALSE, message=FALSE, warning=FALSE}
as.data.frame(VarCorr(mdl_fmDep_medianPostCat)$participant$sd) %>%
  rownames_to_column(var = "Random Effect") %>%
  select(`Random Effect`, Estimate, Est.Error, Q2.5, Q97.5)
```

-   **percProm1:** The estimated standard deviation is 1.732 (95% CrI:
    1.359 to 2.221), suggesting substantial variability in participants'
    responses at `percProm1`.

-   **percProm2:** The estimated standard deviation is 1.451 (95% CrI:
    1.179 to 1.798), indicating moderate variability at `percProm2`,
    which is slightly lower than at `percProm1`.

-   **percProm3:** The estimated standard deviation is 1.457 (95% CrI:
    1.116 to 1.929), showing similar variability to `percProm2`, though
    with a slightly wider credible interval, suggesting some uncertainty
    in participants' responses at this level.

These results highlight that there is considerable participant-level
variability in `fmDep_medianPostCat` across perceived prominence levels,
with `percProm1` showing the greatest variability.

Extract samples in interpretable units. Then, plot them so that we can
see how each participant uses the levels of percProm.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract samples for each participant x percProm
data_prepost_cat %>% 
  data_grid(
    participant = unique(participant),
    percProm = unique(percProm),
    gender_s = 0.1563 # Average over gender
  ) %>% 
  add_epred_draws(mdl_fmDep_medianPostCat) %>% 
  median_qi()

# Plot the draws for all participants x percProm levels
data_prepost_cat %>%
  # Start by selecting unique participants and their gender_s
  select(participant, gender_s) %>%
  distinct() %>%
  # Back-transform gender_s to gender labels
  mutate(
    gender = if_else(gender_s == -0.5, "Male", "Female")
  ) %>%
  # Combine with percProm levels
  crossing(
    percProm = unique(data_prepost_cat$percProm)
  ) %>%
  # Generate posterior predictions
  add_epred_draws(mdl_fmDep_medianPostCat) %>%
  # Summarize predictions with .66 and .95 intervals
  median_qi(.width = c(.66, .95)) %>%
  ggplot(aes(x = .epred, y = participant, color = percProm, shape = gender)) +
  # Add the thick line for 66% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.66),  # Use 66% credible interval
                 size = 1,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add the thin line for 95% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.95),  # Use 95% credible interval
                 size = 0.5,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add points with shapes
  geom_point(position = position_dodge(width = 0.7), size = 2.5) +
  scale_color_manual(values = colorBlindBlack8) +
  labs(
    x = "Posterior freq. modulation median (post-tonic)",
    y = "Participant",
    color = "Perceived prominence",
    shape = "Gender"
  ) +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines")
  )
```

First, we extract individual draws. Here, if the CrI encompasses 0, the
participant does not differ from the overall behavior on this percProm.
Then, we plot random effects for each participant and percProm level on
the model scale, representing deviations from the fixed effects.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# We focus on 95% CrI, but this can be adapted in the width parameter
mdl_fmDep_medianPostCat %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95))

# In log without Intercept
mdl_fmDep_medianPostCat %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95, .8, .5)) %>%
  ggplot(aes(y = as.factor(participant), x = r_participant, color = percProm, xmin = .lower, xmax = .upper)) +
  geom_pointinterval(
    position = "dodge") +
  scale_color_manual(
    values = colorBlindBlack8) +
  labs(
    x = "Individual deviations in freq. modulation median (post-tonic)",
    y = "Participant",
    color = "Perceived prominence") +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines") 
  )

```

### Shannon entropy SD

#### Priors

```{r echo=FALSE, message=FALSE, warning=FALSE}
get_prior(
  entropySh_sd ~ 0 +
    percProm + gender_s + 
    (0 + percProm | participant),
  data = data_prepost_cat,
  family = lognormal()
)

prior_entropySh_sdCat <- c(
  #prior('normal(0, 1)', class = 'Intercept', lb = 0),
  #prior('normal(0, 1)', class = 'b'), 
  prior('normal(0, 1)', class = 'b', lb = 0), 
  prior('normal(0, 1)', class = 'sd')
)
```

#### Model

```{r echo=FALSE, message=FALSE, warning=FALSE}
mdl_entropySh_sdCat <- brm(entropySh_sd ~ 0 +
                         percProm + gender_s + 
                         (0 + percProm | participant),
                       data = data_prepost_cat,
                       family = lognormal(),
                       prior = prior_entropySh_sdCat,
                       #backend = "cmdstanr", # depends on you
                       cores = 4,
                       chains = 4,
                       iter = 8000,
                       warmup = 4000,
                       seed = 998,
                       control = list(max_treedepth = 12,
                                      adapt_delta = 0.99),
                       file = paste0(models, "mdl_entropySh_sdCat.rds"))

# if we need to compress the model more
#saveRDS(mdl_entropySh_sdCat, file = paste0(models, "mdl_entropySh_sdCat.rds"), compress = "xz")

mdl_entropySh_sdCat <- readRDS(paste0(models, "mdl_entropySh_sdCat.rds"))
```

Calculate R².

```{r echo=FALSE, message=FALSE, warning=FALSE}
# # Calculate Bayesian R²
# mdl_entropySh_sdCat_R2 <- bayes_R2(mdl_entropySh_sdCat)
# # Save the R² output
# saveRDS(mdl_entropySh_sdCat_R2, file = paste0(models, "mdl_entropySh_sdCat_R2.rds"))

mdl_entropySh_sdCat_R2 <- readRDS(paste0(models, "mdl_entropySh_sdCat_R2.rds"))

mdl_entropySh_sdCat_R2
```

An R² of approximately 0.26 suggests a **modest fit**. This value
indicates that the model explains about **25.7%** of the variance in the
dependent variable `entropySh_sd`. In other words, slightly more than a
quarter of the variability in `entropySh_sd` is accounted for by the
predictors in the model. The 95% credible interval, ranging from **22.7%
to 28.8%**, shows some uncertainty around this estimate, but it provides
a stable indication of the model's explanatory power.

#### Fixed effects

Let's check how it looks like.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Summarize the model
summary(mdl_entropySh_sdCat)

# Extract fixed effects
exp(fixef(mdl_entropySh_sdCat))
```

It shows a decrease from 1 to 2 and then an increase from 2 to 3, and 3
is also sligthly higher than 1.

Diagnostic plots.

```{r echo=FALSE, message=FALSE, warning=FALSE}
plot(mdl_entropySh_sdCat)
```

Posterior predictive check.

```{r echo=FALSE, message=FALSE, warning=FALSE}
pp_check(mdl_entropySh_sdCat, ndraws = 100)

pp_check(mdl_entropySh_sdCat, type = "error_scatter_avg", ndraws = 100)
```

Extract samples.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of fixed effects
samples_mdl_entropySh_sdCat <- as_draws_array(mdl_entropySh_sdCat, 
                                          variable = "^b_", 
                                          regex = TRUE)
samples_mdl_entropySh_sdCat <- mutate_variables(samples_mdl_entropySh_sdCat, 
                                            exp_b_percProm1 = exp(b_percProm1),
                                            exp_b_percProm2 = exp(b_percProm2),
                                            exp_b_percProm3 = exp(b_percProm3))

# Summarize posterior draws
summarize_draws(samples_mdl_entropySh_sdCat)
```

Check conditional effect.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Plot conditional effects (fixed effects only)
conditional_effects(mdl_entropySh_sdCat, re_formula = NA)

# Extract conditional effects data
conditional_effects(mdl_entropySh_sdCat, plot = FALSE, re_formula = NA)$percProm
```

Compare conditional effects to raw values.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Calculate raw means by percProm level
data_prepost_cat %>% 
  group_by(percProm) %>%
  summarize(avg_entropySh_sd = mean(entropySh_sd, na.rm = TRUE))

# Summary of entropySh_sd
summary(data_prepost_cat$entropySh_sd)
```

##### Effect comparison

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Compute estimated marginal means on log-scale
em_mdl_entropySh_sdCat <- emmeans(mdl_entropySh_sdCat, ~ percProm)
# Backtransform the post.beta values
em_mdl_entropySh_sdCat@post.beta <- exp(em_mdl_entropySh_sdCat@post.beta)
print(em_mdl_entropySh_sdCat)
plot(em_mdl_entropySh_sdCat)

# Perform pairwise comparisons between levels of percProm
emPairs_mdl_entropySh_sdCat <- pairs(emmeans(mdl_entropySh_sdCat, ~ percProm))
# Backtransform the post.beta values
emPairs_mdl_entropySh_sdCat@post.beta <- exp(emPairs_mdl_entropySh_sdCat@post.beta)
print(emPairs_mdl_entropySh_sdCat)
plot(emPairs_mdl_entropySh_sdCat)
```

If the comparison includes 0, the contrast is not reliably different.

##### Hypothesis testing

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of the fixed effects coefficients
as_draws_df(mdl_entropySh_sdCat) %>%
  # Select fixed effects for percProm levels
  select(starts_with("b_percProm")) %>%
  # Rename columns to match percProm levels
  rename_with(~ str_replace(.x, "b_percProm", "percProm"), starts_with("b_percProm")) %>%
  # Compute differences between percProm levels
  mutate(
    diff_1_2 = percProm1 - percProm2,
    diff_1_3 = percProm1 - percProm3,
    diff_2_3 = percProm2 - percProm3
  ) %>%
  # Gather differences into long format
  pivot_longer(
    cols = starts_with("diff_"),
    names_to = "Comparison",
    values_to = "Difference"
  ) %>%
  # Group by comparison to compute summary statistics
  group_by(Comparison) %>%
  summarise(
    Estimate = mean(Difference),
    Est.Error = sd(Difference),
    CI.Lower = quantile(Difference, 0.025),
    CI.Upper = quantile(Difference, 0.975),
    Post.Prob = if_else(Estimate > 0,
                        mean(Difference > 0) * 100,
                        mean(Difference < 0) * 100)
  ) %>%
  ungroup() %>%
  # Add significance stars based on posterior probability
  mutate(
    Star = ifelse(Post.Prob > 95 | Post.Prob < 5, "*", ""),
    Estimate = round(Estimate, 3),
    Est.Error = round(Est.Error, 3),
    CI.Lower = round(CI.Lower, 3),
    CI.Upper = round(CI.Upper, 3),
    Post.Prob = round(Post.Prob, 2)
  ) %>%
  # Select and arrange the final columns
  select(Comparison, Estimate, Est.Error, CI.Lower, CI.Upper, Post.Prob, Star) %>%
  arrange(Comparison)
```

-   **diff_1_2:** Estimate = 0.042 [-0.281, 0.44], Posterior Probability
    = 58.6%; There is no strong evidence for a difference between
    `percProm1` and `percProm2`. The credible interval includes zero,
    and the posterior probability is close to chance, making the
    difference unreliable.

-   **diff_1_3:** Estimate = -0.045 [-0.55, 0.407], Posterior
    Probability = 57.0%; There is weak evidence suggesting that
    `entropySh_sd` at `percProm3` is higher than at `percProm1`.
    However, the wide credible interval and posterior probability
    indicate a lack of reliability for this difference.

-   **diff_2_3:** Estimate = -0.087 [-0.562, 0.253], Posterior
    Probability = 65.9%; There is weak evidence that `entropySh_sd` at
    `percProm3` is higher than at `percProm2`. This difference remains
    inconclusive, given the wide credible interval and posterior
    probability below 95%.

**Overall Implications:**

-   **Trend:** There is no strong or consistent evidence of significant
    differences between perceived prominence levels for `entropySh_sd`.
    The posterior probabilities and wide credible intervals suggest that
    any potential differences are uncertain and should be interpreted
    with caution.

##### Plot fixef

Visualize the (non-)linearity of the effect with a violin plot of the
posteriors for each prominence level and a GAMM overlaid on top.

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_cat %>%
  data_grid(percProm = unique(percProm),
            gender_s = 0.1563) %>% # Set to average of gender
  add_epred_draws(mdl_entropySh_sdCat, re_formula = NA) %>%
  mutate(
    percProm_num = as.numeric(as.character(percProm)),
    percProm = factor(percProm, levels = c("1", "2", "3"))
  ) %>%
  ggplot(aes(x = percProm_num, y = .epred, color = percProm)) +
  geom_violin(aes(group = percProm_num, fill = percProm), alpha = 0.8) +
  scale_color_manual(values = colorBlindBlack8) +
  scale_fill_manual(values = colorBlindBlack8) +
  stat_summary(fun = median, geom = "point", color = colorBlindBlack8[7], size = 2) +
  geom_smooth(
    aes(group = 1),
    method = "gam",
    formula = y ~ s(x, bs = "cs", k = 3),
    color = colorBlindBlack8[7],
    se = FALSE
  ) +
  scale_x_continuous(
    breaks = 0:3,
    labels = as.character(0:3)
  ) +
  #ylim(1, 5) +
  labs(
    x = "Perceived prominence level",
    y = "Posterior Shannon entropy SD"
  ) +
  theme_minimal()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_cat %>%
  data_grid(
    percProm = unique(percProm),
    gender_s = 0.1563  # Set gender_s to zero to average over gender
  ) %>%
  add_epred_draws(mdl_entropySh_sdCat, re_formula = NA) %>%
  mutate(
    percProm = factor(percProm, levels = c("1", "2", "3"))
  ) %>%
  ggplot(aes(y = percProm, x = .epred, fill = percProm)) +
  ggdist::stat_halfeye(
    adjust = 0.5,
    width = 0.6,
    .width = c(0.66, 0.95),
    justification = -0.1,
    point_colour = NA
  ) +
  geom_boxplot(
    width = 0.15,
    outlier.shape = NA,
    alpha = 0.5,
    position = position_nudge(y = 0.2)
  ) +
  stat_summary(
    fun = median,
    geom = "point",
    color = "red",
    size = 2,
    position = position_nudge(y = 0.2)
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  coord_flip() +
  theme_minimal() +
  xlim(1, 3.5) +
  labs(
    y = "Perceived prominence level",
    x = "Posterior Shannon entropy SD"
  )
```

#### Group-level effects

First, get a general overview.

```{r echo=FALSE, message=FALSE, warning=FALSE}
as.data.frame(VarCorr(mdl_entropySh_sdCat)$participant$sd) %>%
  rownames_to_column(var = "Random Effect") %>%
  select(`Random Effect`, Estimate, Est.Error, Q2.5, Q97.5)
```

-   **percProm1:** The estimated standard deviation is 2.736 (95% CrI:
    2.312 to 3.229), indicating considerable variability in
    participants' responses at `percProm1`.

-   **percProm2:** The estimated standard deviation is 2.612 (95% CrI:
    2.224 to 3.052), suggesting moderate variability at `percProm2`,
    which is slightly lower than at `percProm1`.

-   **percProm3:** The estimated standard deviation is 2.687 (95% CrI:
    2.254 to 3.198), showing similar variability to `percProm1`, though
    with a slightly wider credible interval, suggesting some uncertainty
    in participants' responses at this level.

These results highlight that there is considerable participant-level
variability in `entropySh_sd` across perceived prominence levels, with
relatively high variability observed at each level.

Extract samples in interpretable units. Then, plot them so that we can
see how each participant uses the levels of percProm.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract samples for each participant x percProm
data_prepost_cat %>% 
  data_grid(
    participant = unique(participant),
    percProm = unique(percProm),
    gender_s = 0.1563 # Average over gender
  ) %>% 
  add_epred_draws(mdl_entropySh_sdCat) %>% 
  median_qi()

# Plot the draws for all participants x percProm levels
data_prepost_cat %>%
  # Start by selecting unique participants and their gender_s
  select(participant, gender_s) %>%
  distinct() %>%
  # Back-transform gender_s to gender labels
  mutate(
    gender = if_else(gender_s == -0.5, "Male", "Female")
  ) %>%
  # Combine with percProm levels
  crossing(
    percProm = unique(data_prepost_cat$percProm)
  ) %>%
  # Generate posterior predictions
  add_epred_draws(mdl_entropySh_sdCat) %>%
  # Summarize predictions with .66 and .95 intervals
  median_qi(.width = c(.66, .95)) %>%
  ggplot(aes(x = .epred, y = participant, color = percProm, shape = gender)) +
  # Add the thick line for 66% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.66),  # Use 66% credible interval
                 size = 1,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add the thin line for 95% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.95),  # Use 95% credible interval
                 size = 0.5,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add points with shapes
  geom_point(position = position_dodge(width = 0.7), size = 2.5) +
  scale_color_manual(values = colorBlindBlack8) +
  labs(
    x = "Posterior Shannon entropy SD",
    y = "Participant",
    color = "Perceived prominence",
    shape = "Gender"
  ) +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines")
  )
```

First, we extract individual draws. Here, if the CrI encompasses 0, the
participant does not differ from the overall behavior on this percProm.
Then, we plot random effects for each participant and percProm level on
the model scale, representing deviations from the fixed effects.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# We focus on 95% CrI, but this can be adapted in the width parameter
mdl_entropySh_sdCat %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95))

# In log without Intercept
mdl_entropySh_sdCat %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95, .8, .5)) %>%
  ggplot(aes(y = as.factor(participant), x = r_participant, color = percProm, xmin = .lower, xmax = .upper)) +
  geom_pointinterval(
    position = "dodge") +
  scale_color_manual(
    values = colorBlindBlack8) +
  labs(
    x = "Individual deviations in Shannon entropy SD",
    y = "Participant",
    color = "Perceived prominence") +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines") 
  )

```

### Flux median (post-tonic)

#### Priors

```{r echo=FALSE, message=FALSE, warning=FALSE}
get_prior(
  flux_medianPost ~ 0 +
    percProm + gender_s + 
    (0 + percProm | participant),
  data = data_prepost_cat,
  family = "zero_inflated_beta"
)

prior_flux_medianPostCat <- c(
  #prior('normal(0, 1)', class = 'Intercept', lb = 0),
  #prior('normal(0, 1)', class = 'b'), 
  prior('normal(0, 1)', class = 'b', lb = 0), 
  prior('normal(0, 1)', class = 'sd')
)
```

#### Model

```{r echo=FALSE, message=FALSE, warning=FALSE}
mdl_flux_medianPostCat <- brm(flux_medianPost ~ 0 +
                         percProm + gender_s + 
                         (0 + percProm | participant),
                       data = data_prepost_cat,
                       family = "zero_inflated_beta",
                       prior = prior_flux_medianPostCat,
                       #backend = "cmdstanr", # depends on you
                       cores = 4,
                       chains = 4,
                       iter = 8000,
                       warmup = 4000,
                       seed = 998,
                       control = list(max_treedepth = 12,
                                      adapt_delta = 0.99),
                       file = paste0(models, "mdl_flux_medianPostCat.rds"))

# if we need to compress the model more
#saveRDS(mdl_flux_medianPostCat, file = paste0(models, "mdl_flux_medianPostCat.rds"), compress = "xz")

mdl_flux_medianPostCat <- readRDS(paste0(models, "mdl_flux_medianPostCat.rds"))
```

Calculate R².

```{r echo=FALSE, message=FALSE, warning=FALSE}
# # Calculate Bayesian R²
# mdl_flux_medianPostCat_R2 <- bayes_R2(mdl_flux_medianPostCat)
# # Save the R² output
# saveRDS(mdl_flux_medianPostCat_R2, file = paste0(models, "mdl_flux_medianPostCat_R2.rds"))

mdl_flux_medianPostCat_R2 <- readRDS(paste0(models, "mdl_flux_medianPostCat_R2.rds"))

mdl_flux_medianPostCat_R2
```

An R² of approximately 0.03 suggests a **very low fit**. This value
indicates that the model explains only about **3% of the variance** in
the dependent variable `flux_medianPost`. In other words, nearly all of
the variability in `flux_medianPost` is unaccounted for by the
predictors in the model. The 95% credible interval, ranging from **2.3%
to 3.8%**, confirms the minimal explanatory power of the model,
indicating high uncertainty in the relationship between the predictors
and the response variable.

#### Fixed effects

Let's check how it looks like.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Summarize the model
summary(mdl_flux_medianPostCat)

# Extract fixed effects
fixef(mdl_flux_medianPostCat)
```

It shows a decrease from 1 to 2, and then an increase from 2 to 3. 3 is
more or less as high as 1.

Diagnostic plots.

```{r echo=FALSE, message=FALSE, warning=FALSE}
plot(mdl_flux_medianPostCat)
```

Posterior predictive check.

```{r echo=FALSE, message=FALSE, warning=FALSE}
pp_check(mdl_flux_medianPostCat, ndraws = 100)

pp_check(mdl_flux_medianPostCat, type = "error_scatter_avg", ndraws = 100)
```

Extract samples.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of fixed effects
samples_mdl_flux_medianPostCat <- as_draws_array(mdl_flux_medianPostCat, 
                                          variable = "^b_", 
                                          regex = TRUE)

# Summarize posterior draws
summarize_draws(samples_mdl_flux_medianPostCat)
```

Check conditional effect.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Plot conditional effects (fixed effects only)
conditional_effects(mdl_flux_medianPostCat, re_formula = NA)

# Extract conditional effects data
conditional_effects(mdl_flux_medianPostCat, plot = FALSE, re_formula = NA)$percProm
```

Compare conditional effects to raw values.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Calculate raw means by percProm level
data_prepost_cat %>% 
  group_by(percProm) %>%
  summarize(avg_flux_medianPost = mean(flux_medianPost, na.rm = TRUE))

# Summary of flux_medianPost
summary(data_prepost_cat$flux_medianPost)
```

##### Effect comparison

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Compute estimated marginal means on log-scale
em_mdl_flux_medianPostCat <- emmeans(mdl_flux_medianPostCat, ~ percProm)
print(em_mdl_flux_medianPostCat)
plot(em_mdl_flux_medianPostCat)

# Perform pairwise comparisons between levels of percProm
emPairs_mdl_flux_medianPostCat <- pairs(emmeans(mdl_flux_medianPostCat, ~ percProm))
print(emPairs_mdl_flux_medianPostCat)
plot(emPairs_mdl_flux_medianPostCat)
```

If the comparison includes 0, the contrast is not reliably different.

##### Hypothesis testing

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of the fixed effects coefficients
as_draws_df(mdl_flux_medianPostCat) %>%
  # Select fixed effects for percProm levels
  select(starts_with("b_percProm")) %>%
  # Rename columns to match percProm levels
  rename_with(~ str_replace(.x, "b_percProm", "percProm"), starts_with("b_percProm")) %>%
  # Compute differences between percProm levels
  mutate(
    diff_1_2 = percProm1 - percProm2,
    diff_1_3 = percProm1 - percProm3,
    diff_2_3 = percProm2 - percProm3
  ) %>%
  # Gather differences into long format
  pivot_longer(
    cols = starts_with("diff_"),
    names_to = "Comparison",
    values_to = "Difference"
  ) %>%
  # Group by comparison to compute summary statistics
  group_by(Comparison) %>%
  summarise(
    Estimate = mean(Difference),
    Est.Error = sd(Difference),
    CI.Lower = quantile(Difference, 0.025),
    CI.Upper = quantile(Difference, 0.975),
    Post.Prob = if_else(Estimate > 0,
                        mean(Difference > 0) * 100,
                        mean(Difference < 0) * 100)
  ) %>%
  ungroup() %>%
  # Add significance stars based on posterior probability
  mutate(
    Star = ifelse(Post.Prob > 95 | Post.Prob < 5, "*", ""),
    Estimate = round(Estimate, 3),
    Est.Error = round(Est.Error, 3),
    CI.Lower = round(CI.Lower, 3),
    CI.Upper = round(CI.Upper, 3),
    Post.Prob = round(Post.Prob, 2)
  ) %>%
  # Select and arrange the final columns
  select(Comparison, Estimate, Est.Error, CI.Lower, CI.Upper, Post.Prob, Star) %>%
  arrange(Comparison)
```

-   **diff_1_2:** Estimate = 0.136 [-0.249, 0.734], Posterior
    Probability = 71.4%; There is weak evidence suggesting that
    `flux_medianPost` at `percProm2` is lower than at `percProm1`.
    However, with a credible interval that includes zero and a posterior
    probability well below 95%, this difference remains inconclusive.

-   **diff_1_3:** Estimate = -0.035 [-0.763, 0.627], Posterior
    Probability = 53.5%; There is no strong evidence for a difference
    between `percProm1` and `percProm3`, with a posterior probability
    close to chance.

-   **diff_2_3:** Estimate = -0.171 [-0.85, 0.232], Posterior
    Probability = 74.4%; There is weak evidence that `flux_medianPost`
    at `percProm3` is higher than at `percProm2`, but this result is
    inconclusive due to the credible interval including zero.

**Overall Implications:**

-   **Trend:** There is no consistent or strong evidence of significant
    differences between perceived prominence levels for
    `flux_medianPost`. The posterior probabilities and wide credible
    intervals suggest that any potential differences are uncertain and
    lack reliability.

##### Plot fixef

Visualize the (non-)linearity of the effect with a violin plot of the
posteriors for each prominence level and a GAMM overlaid on top.

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_cat %>%
  data_grid(percProm = unique(percProm),
            gender_s = 0.1563) %>% # Set to average of gender
  add_epred_draws(mdl_flux_medianPostCat, re_formula = NA) %>%
  mutate(
    percProm_num = as.numeric(as.character(percProm)),
    percProm = factor(percProm, levels = c("1", "2", "3"))
  ) %>%
  ggplot(aes(x = percProm_num, y = .epred, color = percProm)) +
  geom_violin(aes(group = percProm_num, fill = percProm), alpha = 0.8) +
  scale_color_manual(values = colorBlindBlack8) +
  scale_fill_manual(values = colorBlindBlack8) +
  stat_summary(fun = median, geom = "point", color = colorBlindBlack8[7], size = 2) +
  geom_smooth(
    aes(group = 1),
    method = "gam",
    formula = y ~ s(x, bs = "cs", k = 3),
    color = colorBlindBlack8[7],
    se = FALSE
  ) +
  scale_x_continuous(
    breaks = 0:3,
    labels = as.character(0:3)
  ) +
  #ylim(1, 5) +
  labs(
    x = "Perceived prominence level",
    y = "Posterior flux median (post-tonic)"
  ) +
  theme_minimal()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_cat %>%
  data_grid(
    percProm = unique(percProm),
    gender_s = 0.1563  # Set gender_s to zero to average over gender
  ) %>%
  add_epred_draws(mdl_flux_medianPostCat, re_formula = NA) %>%
  mutate(
    percProm = factor(percProm, levels = c("1", "2", "3"))
  ) %>%
  ggplot(aes(y = percProm, x = .epred, fill = percProm)) +
  ggdist::stat_halfeye(
    adjust = 0.5,
    width = 0.6,
    .width = c(0.66, 0.95),
    justification = -0.1,
    point_colour = NA
  ) +
  geom_boxplot(
    width = 0.15,
    outlier.shape = NA,
    alpha = 0.5,
    position = position_nudge(y = 0.2)
  ) +
  stat_summary(
    fun = median,
    geom = "point",
    color = "red",
    size = 2,
    position = position_nudge(y = 0.2)
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  coord_flip() +
  theme_minimal() +
  #xlim(1, 3.5) +
  labs(
    y = "Perceived prominence level",
    x = "Posterior flux median (post-tonic)"
  )
```

#### Group-level effects

First, get a general overview.

```{r echo=FALSE, message=FALSE, warning=FALSE}
as.data.frame(VarCorr(mdl_flux_medianPostCat)$participant$sd) %>%
  rownames_to_column(var = "Random Effect") %>%
  select(`Random Effect`, Estimate, Est.Error, Q2.5, Q97.5)
```

-   **percProm1:** The estimated standard deviation is 3.185 (95% CrI:
    2.705 to 3.780), indicating considerable variability in
    participants' responses at `percProm1`.

-   **percProm2:** The estimated standard deviation is 2.875 (95% CrI:
    2.477 to 3.352), suggesting moderate participant-level variability
    at `percProm2`, slightly lower than at `percProm1`.

-   **percProm3:** The estimated standard deviation is 3.016 (95% CrI:
    2.541 to 3.611), showing similar variability to `percProm1` and
    `percProm2`.

These results highlight substantial participant-level variability in
`flux_medianPost` across perceived prominence levels, suggesting that
individual differences play a significant role in the responses at each
prominence level.

Extract samples in interpretable units. Then, plot them so that we can
see how each participant uses the levels of percProm.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract samples for each participant x percProm
data_prepost_cat %>% 
  data_grid(
    participant = unique(participant),
    percProm = unique(percProm),
    gender_s = 0.1563 # Average over gender
  ) %>% 
  add_epred_draws(mdl_flux_medianPostCat) %>% 
  median_qi()

# Plot the draws for all participants x percProm levels
data_prepost_cat %>%
  # Start by selecting unique participants and their gender_s
  select(participant, gender_s) %>%
  distinct() %>%
  # Back-transform gender_s to gender labels
  mutate(
    gender = if_else(gender_s == -0.5, "Male", "Female")
  ) %>%
  # Combine with percProm levels
  crossing(
    percProm = unique(data_prepost_cat$percProm)
  ) %>%
  # Generate posterior predictions
  add_epred_draws(mdl_flux_medianPostCat) %>%
  # Summarize predictions with .66 and .95 intervals
  median_qi(.width = c(.66, .95)) %>%
  ggplot(aes(x = .epred, y = participant, color = percProm, shape = gender)) +
  # Add the thick line for 66% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.66),  # Use 66% credible interval
                 size = 1,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add the thin line for 95% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.95),  # Use 95% credible interval
                 size = 0.5,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add points with shapes
  geom_point(position = position_dodge(width = 0.7), size = 2.5) +
  scale_color_manual(values = colorBlindBlack8) +
  labs(
    x = "Posterior flux median (post-tonic)",
    y = "Participant",
    color = "Perceived prominence",
    shape = "Gender"
  ) +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines")
  )
```

First, we extract individual draws. Here, if the CrI encompasses 0, the
participant does not differ from the overall behavior on this percProm.
Then, we plot random effects for each participant and percProm level on
the model scale, representing deviations from the fixed effects.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# We focus on 95% CrI, but this can be adapted in the width parameter
mdl_flux_medianPostCat %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95))

# In log without Intercept
mdl_flux_medianPostCat %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95, .8, .5)) %>%
  ggplot(aes(y = as.factor(participant), x = r_participant, color = percProm, xmin = .lower, xmax = .upper)) +
  geom_pointinterval(
    position = "dodge") +
  scale_color_manual(
    values = colorBlindBlack8) +
  labs(
    x = "Individual deviations in flux median (post-tonic)",
    y = "Participant",
    color = "Perceived prominence") +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines") 
  )

```

### Amplitude median (post-tonic)

#### Priors

```{r echo=FALSE, message=FALSE, warning=FALSE}
get_prior(
  ampl_medianPost ~ 0 +
    percProm + gender_s + 
    (0 + percProm | participant),
  data = data_prepost_cat,
  family = lognormal()
)

prior_ampl_medianPostCat <- c(
  #prior('normal(0, 1)', class = 'Intercept', lb = 0),
  #prior('normal(0, 1)', class = 'b'), 
  prior('normal(0, 1)', class = 'b', lb = 0), 
  prior('normal(0, 1)', class = 'sd')
)
```

#### Model

```{r echo=FALSE, message=FALSE, warning=FALSE}
mdl_ampl_medianPostCat <- brm(ampl_medianPost ~ 0 +
                         percProm + gender_s + 
                         (0 + percProm | participant),
                       data = data_prepost_cat,
                       family = lognormal(),
                       prior = prior_ampl_medianPostCat,
                       #backend = "cmdstanr", # depends on you
                       cores = 4,
                       chains = 4,
                       iter = 8000,
                       warmup = 4000,
                       seed = 998,
                       control = list(max_treedepth = 12,
                                      adapt_delta = 0.99),
                       file = paste0(models, "mdl_ampl_medianPostCat.rds"))

# if we need to compress the model more
#saveRDS(mdl_ampl_medianPostCat, file = paste0(models, "mdl_ampl_medianPostCat.rds"), compress = "xz")

mdl_ampl_medianPostCat <- readRDS(paste0(models, "mdl_ampl_medianPostCat.rds"))
```

Calculate R².

```{r echo=FALSE, message=FALSE, warning=FALSE}
# # Calculate Bayesian R²
# mdl_ampl_medianPostCat_R2 <- bayes_R2(mdl_ampl_medianPostCat)
# # Save the R² output
# saveRDS(mdl_ampl_medianPostCat_R2, file = paste0(models, "mdl_ampl_medianPostCat_R2.rds"))

mdl_ampl_medianPostCat_R2 <- readRDS(paste0(models, "mdl_ampl_medianPostCat_R2.rds"))

mdl_ampl_medianPostCat_R2
```

An R² of approximately 0.29 suggests a moderate fit, indicating that the
model explains about 29.1% of the variance in the dependent variable
`ampl_medianPost`. Thus, nearly a third of the variability in
`ampl_medianPost` is accounted for by the predictors. The 95% credible
interval (25.4% to 33.0%) indicates moderate certainty around this
explanatory power.

#### Fixed effects

Let's check how it looks like.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Summarize the model
summary(mdl_ampl_medianPostCat)

# Extract fixed effects
exp(fixef(mdl_ampl_medianPostCat))
```

It shows an increase from 1 to 2, and then a decrease from 2 to 3.

Diagnostic plots.

```{r echo=FALSE, message=FALSE, warning=FALSE}
plot(mdl_ampl_medianPostCat)
```

Posterior predictive check.

```{r echo=FALSE, message=FALSE, warning=FALSE}
pp_check(mdl_ampl_medianPostCat, ndraws = 100)

pp_check(mdl_ampl_medianPostCat, type = "error_scatter_avg", ndraws = 100)
```

Extract samples.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of fixed effects
samples_mdl_ampl_medianPostCat <- as_draws_array(mdl_ampl_medianPostCat, 
                                          variable = "^b_", 
                                          regex = TRUE)
samples_mdl_ampl_medianPostCat <- mutate_variables(samples_mdl_ampl_medianPostCat, 
                                            exp_b_percProm1 = exp(b_percProm1),
                                            exp_b_percProm2 = exp(b_percProm2),
                                            exp_b_percProm3 = exp(b_percProm3))

# Summarize posterior draws
summarize_draws(samples_mdl_ampl_medianPostCat)
```

Check conditional effect.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Plot conditional effects (fixed effects only)
conditional_effects(mdl_ampl_medianPostCat, re_formula = NA)

# Extract conditional effects data
conditional_effects(mdl_ampl_medianPostCat, plot = FALSE, re_formula = NA)$percProm
```

Compare conditional effects to raw values.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Calculate raw means by percProm level
data_prepost_cat %>% 
  group_by(percProm) %>%
  summarize(avg_ampl_medianPost = mean(ampl_medianPost, na.rm = TRUE))

# Summary of ampl_medianPost
summary(data_prepost_cat$ampl_medianPost)
```

##### Effect comparison

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Compute estimated marginal means on log-scale
em_mdl_ampl_medianPostCat <- emmeans(mdl_ampl_medianPostCat, ~ percProm)
# Backtransform the post.beta values
em_mdl_ampl_medianPostCat@post.beta <- exp(em_mdl_ampl_medianPostCat@post.beta)
print(em_mdl_ampl_medianPostCat)
plot(em_mdl_ampl_medianPostCat)

# Perform pairwise comparisons between levels of percProm
emPairs_mdl_ampl_medianPostCat <- pairs(emmeans(mdl_ampl_medianPostCat, ~ percProm))
# Backtransform the post.beta values
emPairs_mdl_ampl_medianPostCat@post.beta <- exp(emPairs_mdl_ampl_medianPostCat@post.beta)
print(emPairs_mdl_ampl_medianPostCat)
plot(emPairs_mdl_ampl_medianPostCat)
```

If the comparison includes 0, the contrast is not reliably different.

##### Hypothesis testing

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of the fixed effects coefficients
as_draws_df(mdl_ampl_medianPostCat) %>%
  # Select fixed effects for percProm levels
  select(starts_with("b_percProm")) %>%
  # Rename columns to match percProm levels
  rename_with(~ str_replace(.x, "b_percProm", "percProm"), starts_with("b_percProm")) %>%
  # Compute differences between percProm levels
  mutate(
    diff_1_2 = percProm1 - percProm2,
    diff_1_3 = percProm1 - percProm3,
    diff_2_3 = percProm2 - percProm3
  ) %>%
  # Gather differences into long format
  pivot_longer(
    cols = starts_with("diff_"),
    names_to = "Comparison",
    values_to = "Difference"
  ) %>%
  # Group by comparison to compute summary statistics
  group_by(Comparison) %>%
  summarise(
    Estimate = mean(Difference),
    Est.Error = sd(Difference),
    CI.Lower = quantile(Difference, 0.025),
    CI.Upper = quantile(Difference, 0.975),
    Post.Prob = if_else(Estimate > 0,
                        mean(Difference > 0) * 100,
                        mean(Difference < 0) * 100)
  ) %>%
  ungroup() %>%
  # Add significance stars based on posterior probability
  mutate(
    Star = ifelse(Post.Prob > 95 | Post.Prob < 5, "*", ""),
    Estimate = round(Estimate, 3),
    Est.Error = round(Est.Error, 3),
    CI.Lower = round(CI.Lower, 3),
    CI.Upper = round(CI.Upper, 3),
    Post.Prob = round(Post.Prob, 2)
  ) %>%
  # Select and arrange the final columns
  select(Comparison, Estimate, Est.Error, CI.Lower, CI.Upper, Post.Prob, Star) %>%
  arrange(Comparison)
```

-   **diff_1_2:** Estimate = -0.013 [-0.357, 0.331], Posterior
    Probability = 54.2%; There is no strong evidence for a difference
    between `percProm1` and `percProm2`, with the posterior probability
    close to chance.

-   **diff_1_3:** Estimate = -0.038 [-0.445, 0.334], Posterior
    Probability = 58.0%; There is weak evidence suggesting
    `ampl_medianPost` at `percProm3` may be slightly lower than
    `percProm1`, but it remains inconclusive.

-   **diff_2_3:** Estimate = -0.025 [-0.424, 0.327], Posterior
    Probability = 54.7%; No strong evidence for a difference between
    `percProm2` and `percProm3`, with the posterior probability close to
    chance.

**Overall Implications:** There is no strong evidence of consistent
differences in `ampl_medianPost` across perceived prominence levels,
indicating that the predictor levels do not significantly impact
`ampl_medianPost`.

##### Plot fixef

Visualize the (non-)linearity of the effect with a violin plot of the
posteriors for each prominence level and a GAMM overlaid on top.

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_cat %>%
  data_grid(percProm = unique(percProm),
            gender_s = 0.1563) %>% # Set to average of gender
  add_epred_draws(mdl_ampl_medianPostCat, re_formula = NA) %>%
  mutate(
    percProm_num = as.numeric(as.character(percProm)),
    percProm = factor(percProm, levels = c("1", "2", "3"))
  ) %>%
  ggplot(aes(x = percProm_num, y = .epred, color = percProm)) +
  geom_violin(aes(group = percProm_num, fill = percProm), alpha = 0.8) +
  scale_color_manual(values = colorBlindBlack8) +
  scale_fill_manual(values = colorBlindBlack8) +
  stat_summary(fun = median, geom = "point", color = colorBlindBlack8[7], size = 2) +
  geom_smooth(
    aes(group = 1),
    method = "gam",
    formula = y ~ s(x, bs = "cs", k = 3),
    color = colorBlindBlack8[7],
    se = FALSE
  ) +
  scale_x_continuous(
    breaks = 0:3,
    labels = as.character(0:3)
  ) +
  #ylim(1, 5) +
  labs(
    x = "Perceived prominence level",
    y = "Posterior amplitude median (post-tonic)"
  ) +
  theme_minimal()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_cat %>%
  data_grid(
    percProm = unique(percProm),
    gender_s = 0.1563  # Set gender_s to zero to average over gender
  ) %>%
  add_epred_draws(mdl_ampl_medianPostCat, re_formula = NA) %>%
  mutate(
    percProm = factor(percProm, levels = c("1", "2", "3"))
  ) %>%
  ggplot(aes(y = percProm, x = .epred, fill = percProm)) +
  ggdist::stat_halfeye(
    adjust = 0.5,
    width = 0.6,
    .width = c(0.66, 0.95),
    justification = -0.1,
    point_colour = NA
  ) +
  geom_boxplot(
    width = 0.15,
    outlier.shape = NA,
    alpha = 0.5,
    position = position_nudge(y = 0.2)
  ) +
  stat_summary(
    fun = median,
    geom = "point",
    color = "red",
    size = 2,
    position = position_nudge(y = 0.2)
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  coord_flip() +
  theme_minimal() +
  #xlim(1, 3.5) +
  labs(
    y = "Perceived prominence level",
    x = "Posterior amplitude median (post-tonic)"
  )
```

#### Group-level effects

First, get a general overview.

```{r echo=FALSE, message=FALSE, warning=FALSE}
as.data.frame(VarCorr(mdl_ampl_medianPostCat)$participant$sd) %>%
  rownames_to_column(var = "Random Effect") %>%
  select(`Random Effect`, Estimate, Est.Error, Q2.5, Q97.5)
```

-   **percProm1:** Estimated SD = 2.421 (95% CrI: 2.014 to 2.913)

-   **percProm2:** Estimated SD = 2.181 (95% CrI: 1.809 to 2.630)

-   **percProm3:** Estimated SD = 2.363 (95% CrI: 1.963 to 2.875)

Substantial variability is evident across levels, suggesting individual
differences in responses to each prominence level.

Extract samples in interpretable units. Then, plot them so that we can
see how each participant uses the levels of percProm.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract samples for each participant x percProm
data_prepost_cat %>% 
  data_grid(
    participant = unique(participant),
    percProm = unique(percProm),
    gender_s = 0.1563 # Average over gender
  ) %>% 
  add_epred_draws(mdl_ampl_medianPostCat) %>% 
  median_qi()

# Plot the draws for all participants x percProm levels
data_prepost_cat %>%
  # Start by selecting unique participants and their gender_s
  select(participant, gender_s) %>%
  distinct() %>%
  # Back-transform gender_s to gender labels
  mutate(
    gender = if_else(gender_s == -0.5, "Male", "Female")
  ) %>%
  # Combine with percProm levels
  crossing(
    percProm = unique(data_prepost_cat$percProm)
  ) %>%
  # Generate posterior predictions
  add_epred_draws(mdl_ampl_medianPostCat) %>%
  # Summarize predictions with .66 and .95 intervals
  median_qi(.width = c(.66, .95)) %>%
  ggplot(aes(x = .epred, y = participant, color = percProm, shape = gender)) +
  # Add the thick line for 66% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.66),  # Use 66% credible interval
                 size = 1,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add the thin line for 95% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.95),  # Use 95% credible interval
                 size = 0.5,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add points with shapes
  geom_point(position = position_dodge(width = 0.7), size = 2.5) +
  scale_color_manual(values = colorBlindBlack8) +
  labs(
    x = "Posterior amplitude median (post-tonic)",
    y = "Participant",
    color = "Perceived prominence",
    shape = "Gender"
  ) +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines")
  )
```

First, we extract individual draws. Here, if the CrI encompasses 0, the
participant does not differ from the overall behavior on this percProm.
Then, we plot random effects for each participant and percProm level on
the model scale, representing deviations from the fixed effects.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# We focus on 95% CrI, but this can be adapted in the width parameter
mdl_ampl_medianPostCat %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95))

# In log without Intercept
mdl_ampl_medianPostCat %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95, .8, .5)) %>%
  ggplot(aes(y = as.factor(participant), x = r_participant, color = percProm, xmin = .lower, xmax = .upper)) +
  geom_pointinterval(
    position = "dodge") +
  scale_color_manual(
    values = colorBlindBlack8) +
  labs(
    x = "Individual deviations in amplitude median (post-tonic)",
    y = "Participant",
    color = "Perceived prominence") +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines") 
  )

```

### Spectral centroid median

#### Priors

```{r echo=FALSE, message=FALSE, warning=FALSE}
get_prior(
  specCentroid_median ~ 0 +
    percProm + gender_s + 
    (0 + percProm | participant),
  data = data_prepost_cat,
  family = lognormal()
)

prior_specCentroid_medianCat <- c(
  #prior('normal(0, 10)', class = 'Intercept', lb = 0),
  #prior('normal(0, 1)', class = 'b'),
  prior('normal(0, 10)', class = 'b', lb = 0),
  prior('normal(0, 1)', class = 'sd') 
)
```

#### Model

```{r echo=FALSE, message=FALSE, warning=FALSE}
mdl_specCentroid_medianCat <- brm(specCentroid_median ~ 0 +
                         percProm + gender_s + 
                         (0 + percProm | participant),
                       data = data_prepost_cat,
                       family = lognormal(),
                       prior = prior_specCentroid_medianCat,
                       #backend = "cmdstanr", # depends on you
                       cores = 4,
                       chains = 4,
                       iter = 8000,
                       warmup = 4000,
                       seed = 998,
                       control = list(max_treedepth = 12,
                                      adapt_delta = 0.99),
                       file = paste0(models, "mdl_specCentroid_medianCat.rds"))

# if we need to compress the model more
#saveRDS(mdl_specCentroid_medianCat, file = paste0(models, "mdl_specCentroid_medianCat.rds"), compress = "xz")

mdl_specCentroid_medianCat <- readRDS(paste0(models, "mdl_specCentroid_medianCat.rds"))
```

Calculate R².

```{r echo=FALSE, message=FALSE, warning=FALSE}
# # Calculate Bayesian R²
# mdl_specCentroid_medianCat_R2 <- bayes_R2(mdl_specCentroid_medianCat)
# # Save the R² output
# saveRDS(mdl_specCentroid_medianCat_R2, file = paste0(models, "mdl_specCentroid_medianCat_R2.rds"))

mdl_specCentroid_medianCat_R2 <- readRDS(paste0(models, "mdl_specCentroid_medianCat_R2.rds"))

mdl_specCentroid_medianCat_R2
```

An R² of approximately 0.24 suggests a modest fit, with the model
explaining around 24.4% of the variance in `specCentroid_median`. The
95% credible interval (21.6% to 27.3%) suggests some certainty in this
explanatory power, though room for improvement remains.

#### Fixed effects

Let's check how it looks like.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Summarize the model
summary(mdl_specCentroid_medianCat)

# Extract fixed effects
exp(fixef(mdl_specCentroid_medianCat))
```

It shows a decrease from 1 to 3.

Diagnostic plots.

```{r echo=FALSE, message=FALSE, warning=FALSE}
plot(mdl_specCentroid_medianCat)
```

Posterior predictive check.

```{r echo=FALSE, message=FALSE, warning=FALSE}
pp_check(mdl_specCentroid_medianCat, ndraws = 100)

pp_check(mdl_specCentroid_medianCat, type = "error_scatter_avg", ndraws = 100)
```

Extract samples.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of fixed effects
samples_mdl_specCentroid_medianCat <- as_draws_array(mdl_specCentroid_medianCat, 
                                          variable = "^b_", 
                                          regex = TRUE)
samples_mdl_specCentroid_medianCat <- mutate_variables(samples_mdl_specCentroid_medianCat, 
                                            exp_b_percProm1 = exp(b_percProm1),
                                            exp_b_percProm2 = exp(b_percProm2),
                                            exp_b_percProm3 = exp(b_percProm3))

# Summarize posterior draws
summarize_draws(samples_mdl_specCentroid_medianCat)
```

Check conditional effect.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Plot conditional effects (fixed effects only)
conditional_effects(mdl_specCentroid_medianCat, re_formula = NA)

# Extract conditional effects data
conditional_effects(mdl_specCentroid_medianCat, plot = FALSE, re_formula = NA)$percProm
```

Compare conditional effects to raw values.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Calculate raw means by percProm level
data_prepost_cat %>% 
  group_by(percProm) %>%
  summarize(avg_specCentroid_median = mean(specCentroid_median, na.rm = TRUE))

# Summary of specCentroid_median
summary(data_prepost_cat$specCentroid_median)
```

##### Effect comparison

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Compute estimated marginal means on log-scale
em_mdl_specCentroid_medianCat <- emmeans(mdl_specCentroid_medianCat, ~ percProm)
# Backtransform the post.beta values
em_mdl_specCentroid_medianCat@post.beta <- exp(em_mdl_specCentroid_medianCat@post.beta)
print(em_mdl_specCentroid_medianCat)
plot(em_mdl_specCentroid_medianCat)

# Perform pairwise comparisons between levels of percProm
emPairs_mdl_specCentroid_medianCat <- pairs(emmeans(mdl_specCentroid_medianCat, ~ percProm))
# Backtransform the post.beta values
emPairs_mdl_specCentroid_medianCat@post.beta <- exp(emPairs_mdl_specCentroid_medianCat@post.beta)
print(emPairs_mdl_specCentroid_medianCat)
plot(emPairs_mdl_specCentroid_medianCat)
```

If the comparison includes 0, the contrast is not reliably different.

##### Hypothesis testing

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of the fixed effects coefficients
as_draws_df(mdl_specCentroid_medianCat) %>%
  # Select fixed effects for percProm levels
  select(starts_with("b_percProm")) %>%
  # Rename columns to match percProm levels
  rename_with(~ str_replace(.x, "b_percProm", "percProm"), starts_with("b_percProm")) %>%
  # Compute differences between percProm levels
  mutate(
    diff_1_2 = exp(percProm1) - exp(percProm2),
    diff_1_3 = exp(percProm1) - exp(percProm3),
    diff_2_3 = exp(percProm2) - exp(percProm3)
  ) %>%
  # Gather differences into long format
  pivot_longer(
    cols = starts_with("diff_"),
    names_to = "Comparison",
    values_to = "Difference"
  ) %>%
  # Group by comparison to compute summary statistics
  group_by(Comparison) %>%
  summarise(
    Estimate = mean(Difference),
    Est.Error = sd(Difference),
    CI.Lower = quantile(Difference, 0.025),
    CI.Upper = quantile(Difference, 0.975),
    Post.Prob = if_else(Estimate > 0,
                        mean(Difference > 0) * 100,
                        mean(Difference < 0) * 100)
  ) %>%
  ungroup() %>%
  # Add significance stars based on posterior probability
  mutate(
    Star = ifelse(Post.Prob > 95 | Post.Prob < 5, "*", ""),
    Estimate = round(Estimate, 3),
    Est.Error = round(Est.Error, 3),
    CI.Lower = round(CI.Lower, 3),
    CI.Upper = round(CI.Upper, 3),
    Post.Prob = round(Post.Prob, 2)
  ) %>%
  # Select and arrange the final columns
  select(Comparison, Estimate, Est.Error, CI.Lower, CI.Upper, Post.Prob, Star) %>%
  arrange(Comparison)
```

-   **diff_1_2:** Estimate = 3.54 [-3.07, 10.3], Posterior Probability
    = 85.7%; Weak evidence that `specCentroid_median` at `percProm2` is
    lower than at `percProm1`, but this difference is not conclusive.

-   **diff_1_3:** Estimate = 13.8 [5.38, 22.4], Posterior Probability
    = 99.9%; Strong evidence that `specCentroid_median` is lower at
    `percProm3` than at `percProm1`.

-   **diff_2_3:** Estimate = 10.2 [5.26, 15.1], Posterior Probability
    = 100%; Strong evidence that `specCentroid_median` is lower at
    `percProm3` than at `percProm2`.

**Overall Implications:** A trend is observed, where
`specCentroid_median` decreases with perceived prominence levels,
particularly between `percProm1` and `percProm3`.

##### Plot fixef

Visualize the (non-)linearity of the effect with a violin plot of the
posteriors for each prominence level and a GAMM overlaid on top.

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_cat %>%
  data_grid(percProm = unique(percProm),
            gender_s = 0.1563) %>% # Set to average of gender
  add_epred_draws(mdl_specCentroid_medianCat, re_formula = NA) %>%
  mutate(
    percProm_num = as.numeric(as.character(percProm)),
    percProm = factor(percProm, levels = c("1", "2", "3"))
  ) %>%
  ggplot(aes(x = percProm_num, y = .epred, color = percProm)) +
  geom_violin(aes(group = percProm_num, fill = percProm), alpha = 0.8) +
  scale_color_manual(values = colorBlindBlack8) +
  scale_fill_manual(values = colorBlindBlack8) +
  stat_summary(fun = median, geom = "point", color = colorBlindBlack8[7], size = 2) +
  geom_smooth(
    aes(group = 1),
    method = "gam",
    formula = y ~ s(x, bs = "cs", k = 3),
    color = colorBlindBlack8[7],
    se = FALSE
  ) +
  scale_x_continuous(
    breaks = 0:3,
    labels = as.character(0:3)
  ) +
  #ylim(1, 5) +
  labs(
    x = "Perceived prominence level",
    y = "Posterior CoG median"
  ) +
  theme_minimal()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
post_specCentroid_medianCat <- 
  data_prepost_cat %>%
  data_grid(
    percProm = unique(percProm),
    gender_s = 0.1563  # Set gender_s to zero to average over gender
  ) %>%
  add_epred_draws(mdl_specCentroid_medianCat, re_formula = NA) %>%
  mutate(
    percProm = factor(percProm, levels = c("1", "2", "3"))
  ) %>%
  ggplot(aes(y = percProm, x = .epred, fill = percProm)) +
  ggdist::stat_halfeye(
    adjust = 0.5,
    width = 0.6,
    .width = c(0.66, 0.95),
    justification = -0.1,
    point_colour = NA
  ) +
  geom_boxplot(
    width = 0.15,
    outlier.shape = NA,
    alpha = 0.5,
    position = position_nudge(y = 0.2)
  ) +
  stat_summary(
    fun = median,
    geom = "point",
    color = "red",
    size = 2,
    position = position_nudge(y = 0.2)
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  coord_flip() +
  theme_minimal() +
  theme(text = element_text(size = 18)) +
  #xlim(1, 3.5) +
  labs(
    y = "Perceived prominence level",
    x = "Posterior CoG median",
    fill = "Perceived\nprominence"
  )

post_specCentroid_medianCat;
ggsave(plot = post_specCentroid_medianCat, filename = paste0(plots, "posterior_specCentroid_medianCat.pdf"), 
       width = 8, height = 6);
ggsave(plot = post_specCentroid_medianCat, filename = paste0(plots, "posterior_specCentroid_medianCat.jpg"), 
       width = 8, height = 6);
ggsave(plot = post_specCentroid_medianCat, filename = paste0(plots, "posterior_specCentroid_medianCat.tif"), 
       width = 8, height = 6, compression="lzw", dpi=600);
```

#### Group-level effects

First, get a general overview.

```{r echo=FALSE, message=FALSE, warning=FALSE}
as.data.frame(VarCorr(mdl_specCentroid_medianCat)$participant$sd) %>%
  rownames_to_column(var = "Random Effect") %>%
  select(`Random Effect`, Estimate, Est.Error, Q2.5, Q97.5)
```

-   **percProm1:** Estimated SD = 0.078 (95% CrI: 0.058 to 0.103)

-   **percProm2:** Estimated SD = 0.052 (95% CrI: 0.04 to 0.068)

-   **percProm3:** Estimated SD = 0.054 (95% CrI: 0.038 to 0.075)

Variability remains moderate across levels, suggesting participant
responses vary slightly based on perceived prominence levels.

Extract samples in interpretable units. Then, plot them so that we can
see how each participant uses the levels of percProm.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract samples for each participant x percProm
data_prepost_cat %>% 
  data_grid(
    participant = unique(participant),
    percProm = unique(percProm),
    gender_s = 0.1563 # Average over gender
  ) %>% 
  add_epred_draws(mdl_specCentroid_medianCat) %>% 
  median_qi()

# Plot the draws for all participants x percProm levels
data_prepost_cat %>%
  # Start by selecting unique participants and their gender_s
  select(participant, gender_s) %>%
  distinct() %>%
  # Back-transform gender_s to gender labels
  mutate(
    gender = if_else(gender_s == -0.5, "Male", "Female")
  ) %>%
  # Combine with percProm levels
  crossing(
    percProm = unique(data_prepost_cat$percProm)
  ) %>%
  # Generate posterior predictions
  add_epred_draws(mdl_specCentroid_medianCat) %>%
  # Summarize predictions with .66 and .95 intervals
  median_qi(.width = c(.66, .95)) %>%
  ggplot(aes(x = .epred, y = participant, color = percProm, shape = gender)) +
  # Add the thick line for 66% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.66),  # Use 66% credible interval
                 size = 1,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add the thin line for 95% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.95),  # Use 95% credible interval
                 size = 0.5,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add points with shapes
  geom_point(position = position_dodge(width = 0.7), size = 2.5) +
  scale_color_manual(values = colorBlindBlack8) +
  labs(
    x = "Posterior CoG median",
    y = "Participant",
    color = "Perceived prominence",
    shape = "Gender"
  ) +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines")
  )
```

First, we extract individual draws. Here, if the CrI encompasses 0, the
participant does not differ from the overall behavior on this percProm.
Then, we plot random effects for each participant and percProm level on
the model scale, representing deviations from the fixed effects.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# We focus on 95% CrI, but this can be adapted in the width parameter
mdl_specCentroid_medianCat %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95))

# In log without Intercept
mdl_specCentroid_medianCat %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95, .8, .5)) %>%
  ggplot(aes(y = as.factor(participant), x = r_participant, color = percProm, xmin = .lower, xmax = .upper)) +
  geom_pointinterval(
    position = "dodge") +
  scale_color_manual(
    values = colorBlindBlack8) +
  labs(
    x = "Individual deviations in CoG median",
    y = "Participant",
    color = "Perceived prominence") +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines") 
  )

```

### Duration (without silences)

#### Priors

```{r echo=FALSE, message=FALSE, warning=FALSE}
get_prior(
  duration_noSilence ~ 0 +
    percProm + gender_s + 
    (0 + percProm | participant),
  data = data_prepost_cat,
  family = lognormal()
)

prior_duration_noSilenceCat <- c(
  #prior('normal(0, 10)', class = 'Intercept', lb = 0),
  #prior('normal(0, 5)', class = 'b'),
  prior('normal(0, 10)', class = 'b', lb = 0),
  prior('normal(0, 5)', class = 'sd') 
)
```

#### Model

```{r echo=FALSE, message=FALSE, warning=FALSE}
mdl_duration_noSilenceCat <- brm(duration_noSilence ~ 0 +
                         percProm + gender_s + 
                         (0 + percProm | participant),
                       data = data_prepost_cat,
                       family = lognormal(),
                       prior = prior_duration_noSilenceCat,
                       #backend = "cmdstanr", # depends on you
                       cores = 4,
                       chains = 4,
                       iter = 8000,
                       warmup = 4000,
                       seed = 998,
                       control = list(max_treedepth = 12,
                                      adapt_delta = 0.99),
                       file = paste0(models, "mdl_duration_noSilenceCat.rds"))

# if we need to compress the model more
#saveRDS(mdl_duration_noSilenceCat, file = paste0(models, "mdl_duration_noSilenceCat.rds"), compress = "xz")

mdl_duration_noSilenceCat <- readRDS(paste0(models, "mdl_duration_noSilenceCat.rds"))
```

Calculate R².

```{r echo=FALSE, message=FALSE, warning=FALSE}
# # Calculate Bayesian R²
# mdl_duration_noSilenceCat_R2 <- bayes_R2(mdl_duration_noSilenceCat)
# # Save the R² output
# saveRDS(mdl_duration_noSilenceCat_R2, file = paste0(models, "mdl_duration_noSilenceCat_R2.rds"))

mdl_duration_noSilenceCat_R2 <- readRDS(paste0(models, "mdl_duration_noSilenceCat_R2.rds"))

mdl_duration_noSilenceCat_R2
```

An R² of approximately 0.20 indicates a modest fit, with the model
explaining about 20.0% of the variance in `duration_noSilence`. The
credible interval (17.1% to 22.9%) indicates moderate certainty around
this explanatory power.

#### Fixed effects

Let's check how it looks like.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Summarize the model
summary(mdl_duration_noSilenceCat)

# Extract fixed effects
exp(fixef(mdl_duration_noSilenceCat))
```

It shows a stable increase from 1 to 3.

Diagnostic plots.

```{r echo=FALSE, message=FALSE, warning=FALSE}
plot(mdl_duration_noSilenceCat)
```

Posterior predictive check.

```{r echo=FALSE, message=FALSE, warning=FALSE}
pp_check(mdl_duration_noSilenceCat, ndraws = 100)

pp_check(mdl_duration_noSilenceCat, type = "error_scatter_avg", ndraws = 100)
```

Extract samples.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of fixed effects
samples_mdl_duration_noSilenceCat <- as_draws_array(mdl_duration_noSilenceCat, 
                                          variable = "^b_", 
                                          regex = TRUE)
samples_mdl_duration_noSilenceCat <- mutate_variables(samples_mdl_duration_noSilenceCat, 
                                            exp_b_percProm1 = exp(b_percProm1),
                                            exp_b_percProm2 = exp(b_percProm2),
                                            exp_b_percProm3 = exp(b_percProm3))

# Summarize posterior draws
summarize_draws(samples_mdl_duration_noSilenceCat)
```

Check conditional effect.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Plot conditional effects (fixed effects only)
conditional_effects(mdl_duration_noSilenceCat, re_formula = NA)

# Extract conditional effects data
conditional_effects(mdl_duration_noSilenceCat, plot = FALSE, re_formula = NA)$percProm
```

Compare conditional effects to raw values.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Calculate raw means by percProm level
data_prepost_cat %>% 
  group_by(percProm) %>%
  summarize(avg_duration_noSilence = mean(duration_noSilence, na.rm = TRUE))

# Summary of duration_noSilence
summary(data_prepost_cat$duration_noSilence)
```

##### Effect comparison

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Compute estimated marginal means on log-scale
em_mdl_duration_noSilenceCat <- emmeans(mdl_duration_noSilenceCat, ~ percProm)
# Backtransform the post.beta values
em_mdl_duration_noSilenceCat@post.beta <- exp(em_mdl_duration_noSilenceCat@post.beta)
print(em_mdl_duration_noSilenceCat)
plot(em_mdl_duration_noSilenceCat)

# Perform pairwise comparisons between levels of percProm
emPairs_mdl_duration_noSilenceCat <- pairs(emmeans(mdl_duration_noSilenceCat, ~ percProm))
# Backtransform the post.beta values
emPairs_mdl_duration_noSilenceCat@post.beta <- exp(emPairs_mdl_duration_noSilenceCat@post.beta)
print(emPairs_mdl_duration_noSilenceCat)
plot(emPairs_mdl_duration_noSilenceCat)
```

If the comparison includes 0, the contrast is not reliably different.



##### Hypothesis testing

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of the fixed effects coefficients
as_draws_df(mdl_duration_noSilenceCat) %>%
  # Select fixed effects for percProm levels
  select(starts_with("b_percProm")) %>%
  # Rename columns to match percProm levels
  rename_with(~ str_replace(.x, "b_percProm", "percProm"), starts_with("b_percProm")) %>%
  # Compute differences between percProm levels
  mutate(
    diff_1_2 = exp(percProm1) - exp(percProm2),
    diff_1_3 = exp(percProm1) - exp(percProm3),
    diff_2_3 = exp(percProm2) - exp(percProm3)
  ) %>%
  # Gather differences into long format
  pivot_longer(
    cols = starts_with("diff_"),
    names_to = "Comparison",
    values_to = "Difference"
  ) %>%
  # Group by comparison to compute summary statistics
  group_by(Comparison) %>%
  summarise(
    Estimate = mean(Difference),
    Est.Error = sd(Difference),
    CI.Lower = quantile(Difference, 0.025),
    CI.Upper = quantile(Difference, 0.975),
    Post.Prob = if_else(Estimate > 0,
                        mean(Difference > 0) * 100,
                        mean(Difference < 0) * 100)
  ) %>%
  ungroup() %>%
  # Add significance stars based on posterior probability
  mutate(
    Star = ifelse(Post.Prob > 95 | Post.Prob < 5, "*", ""),
    Estimate = round(Estimate, 3),
    Est.Error = round(Est.Error, 3),
    CI.Lower = round(CI.Lower, 3),
    CI.Upper = round(CI.Upper, 3),
    Post.Prob = round(Post.Prob, 2)
  ) %>%
  # Select and arrange the final columns
  select(Comparison, Estimate, Est.Error, CI.Lower, CI.Upper, Post.Prob, Star) %>%
  arrange(Comparison)
```

-   **diff_1_2:** Estimate = -16.6 [-26.0, -7.29], Posterior
    Probability = 99.9%; Strong evidence that `duration_noSilence`
    increases from `percProm1` to `percProm2`.

-   **diff_1_3:** Estimate = -43.1 [-57.6, -29.0], Posterior
    Probability = 100%; Strong evidence that `duration_noSilence`
    increases from `percProm1` to `percProm3`.

-   **diff_2_3:** Estimate = -26.4 [-38.7, -14.4], Posterior
    Probability = 100%; Strong evidence that `duration_noSilence`
    increases from `percProm2` to `percProm3`.

**Overall Implications:** `duration_noSilence` tends to increase as
perceived prominence levels increase, with consistent evidence
supporting this trend.

##### Plot fixef

Visualize the (non-)linearity of the effect with a violin plot of the
posteriors for each prominence level and a GAMM overlaid on top.

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_cat %>%
  data_grid(percProm = unique(percProm),
            gender_s = 0.1563) %>% # Set to average of gender
  add_epred_draws(mdl_duration_noSilenceCat, re_formula = NA) %>%
  mutate(
    percProm_num = as.numeric(as.character(percProm)),
    percProm = factor(percProm, levels = c("1", "2", "3"))
  ) %>%
  ggplot(aes(x = percProm_num, y = .epred, color = percProm)) +
  geom_violin(aes(group = percProm_num, fill = percProm), alpha = 0.8) +
  scale_color_manual(values = colorBlindBlack8) +
  scale_fill_manual(values = colorBlindBlack8) +
  stat_summary(fun = median, geom = "point", color = colorBlindBlack8[7], size = 2) +
  geom_smooth(
    aes(group = 1),
    method = "gam",
    formula = y ~ s(x, bs = "cs", k = 3),
    color = colorBlindBlack8[7],
    se = FALSE
  ) +
  scale_x_continuous(
    breaks = 0:3,
    labels = as.character(0:3)
  ) +
  #ylim(1, 5) +
  labs(
    x = "Perceived prominence level",
    y = "Posterior duration (without silences)"
  ) +
  theme_minimal()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
post_duration_noSilenceCat <- 
  data_prepost_cat %>%
  data_grid(
    percProm = unique(percProm),
    gender_s = 0.1563  # Set gender_s to zero to average over gender
  ) %>%
  add_epred_draws(mdl_duration_noSilenceCat, re_formula = NA) %>%
  mutate(
    percProm = factor(percProm, levels = c("1", "2", "3"))
  ) %>%
  ggplot(aes(y = percProm, x = .epred, fill = percProm)) +
  ggdist::stat_halfeye(
    adjust = 0.5,
    width = 0.6,
    .width = c(0.66, 0.95),
    justification = -0.1,
    point_colour = NA
  ) +
  geom_boxplot(
    width = 0.15,
    outlier.shape = NA,
    alpha = 0.5,
    position = position_nudge(y = 0.2)
  ) +
  stat_summary(
    fun = median,
    geom = "point",
    color = "red",
    size = 2,
    position = position_nudge(y = 0.2)
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  coord_flip() +
  theme_minimal() +
  theme(text = element_text(size = 18)) +
  #xlim(1, 3.5) +
  labs(
    y = "Perceived prominence level",
    x = "Posterior duration (without silences)",
    fill = "Perceived\nprominence"
  )

post_duration_noSilenceCat;
ggsave(plot = post_duration_noSilenceCat, filename = paste0(plots, "posterior_duration_noSilenceCat.pdf"), 
       width = 8, height = 6);
ggsave(plot = post_duration_noSilenceCat, filename = paste0(plots, "posterior_duration_noSilenceCat.jpg"), 
       width = 8, height = 6);
ggsave(plot = post_duration_noSilenceCat, filename = paste0(plots, "posterior_duration_noSilenceCat.tif"), 
       width = 8, height = 6, compression="lzw", dpi=600);
```

#### Group-level effects

First, get a general overview.

```{r echo=FALSE, message=FALSE, warning=FALSE}
as.data.frame(VarCorr(mdl_duration_noSilenceCat)$participant$sd) %>%
  rownames_to_column(var = "Random Effect") %>%
  select(`Random Effect`, Estimate, Est.Error, Q2.5, Q97.5)
```

-   **percProm1:** Estimated SD = 0.162 (95% CrI: 0.113 to 0.226)

-   **percProm2:** Estimated SD = 0.143 (95% CrI: 0.109 to 0.188)

-   **percProm3:** Estimated SD = 0.177 (95% CrI: 0.117 to 0.251)

Variability shows modest participant-level differences across perceived
prominence levels.

Extract samples in interpretable units. Then, plot them so that we can
see how each participant uses the levels of percProm.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract samples for each participant x percProm
data_prepost_cat %>% 
  data_grid(
    participant = unique(participant),
    percProm = unique(percProm),
    gender_s = 0.1563 # Average over gender
  ) %>% 
  add_epred_draws(mdl_duration_noSilenceCat) %>% 
  median_qi()

# Plot the draws for all participants x percProm levels
data_prepost_cat %>%
  # Start by selecting unique participants and their gender_s
  select(participant, gender_s) %>%
  distinct() %>%
  # Back-transform gender_s to gender labels
  mutate(
    gender = if_else(gender_s == -0.5, "Male", "Female")
  ) %>%
  # Combine with percProm levels
  crossing(
    percProm = unique(data_prepost_cat$percProm)
  ) %>%
  # Generate posterior predictions
  add_epred_draws(mdl_duration_noSilenceCat) %>%
  # Summarize predictions with .66 and .95 intervals
  median_qi(.width = c(.66, .95)) %>%
  ggplot(aes(x = .epred, y = participant, color = percProm, shape = gender)) +
  # Add the thick line for 66% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.66),  # Use 66% credible interval
                 size = 1,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add the thin line for 95% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.95),  # Use 95% credible interval
                 size = 0.5,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add points with shapes
  geom_point(position = position_dodge(width = 0.7), size = 2.5) +
  scale_color_manual(values = colorBlindBlack8) +
  labs(
    x = "Posterior duration (without silences)",
    y = "Participant",
    color = "Perceived prominence",
    shape = "Gender"
  ) +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines")
  )
```

First, we extract individual draws. Here, if the CrI encompasses 0, the
participant does not differ from the overall behavior on this percProm.
Then, we plot random effects for each participant and percProm level on
the model scale, representing deviations from the fixed effects.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# We focus on 95% CrI, but this can be adapted in the width parameter
mdl_duration_noSilenceCat %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95))

# In log without Intercept
mdl_duration_noSilenceCat %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95, .8, .5)) %>%
  ggplot(aes(y = as.factor(participant), x = r_participant, color = percProm, xmin = .lower, xmax = .upper)) +
  geom_pointinterval(
    position = "dodge") +
  scale_color_manual(
    values = colorBlindBlack8) +
  labs(
    x = "Individual deviations in duration (without silences)",
    y = "Participant",
    color = "Perceived prominence") +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines") 
  )

```

### Duration (pretonic)

#### Priors

```{r echo=FALSE, message=FALSE, warning=FALSE}
get_prior(
  durationPre ~ 0 +
    percProm + gender_s + 
    (0 + percProm | participant),
  data = data_prepost_cat,
  family = lognormal()
)

prior_durationPreCat <- c(
  #prior('normal(0, 10)', class = 'Intercept', lb = 0),
  #prior('normal(0, 5)', class = 'b'),
  prior('normal(0, 10)', class = 'b', lb = 0),
  prior('normal(0, 5)', class = 'sd') 
)
```

#### Model

```{r echo=FALSE, message=FALSE, warning=FALSE}
mdl_durationPreCat <- brm(durationPre ~ 0 +
                         percProm + gender_s + 
                         (0 + percProm | participant),
                       data = data_prepost_cat,
                       family = lognormal(),
                       prior = prior_durationPreCat,
                       #backend = "cmdstanr", # depends on you
                       cores = 4,
                       chains = 4,
                       iter = 8000,
                       warmup = 4000,
                       seed = 998,
                       control = list(max_treedepth = 12,
                                      adapt_delta = 0.99),
                       file = paste0(models, "mdl_durationPreCat.rds"))

# if we need to compress the model more
#saveRDS(mdl_durationPreCat, file = paste0(models, "mdl_durationPreCat.rds"), compress = "xz")

mdl_durationPreCat <- readRDS(paste0(models, "mdl_durationPreCat.rds"))
```

Calculate R².

```{r echo=FALSE, message=FALSE, warning=FALSE}
# # Calculate Bayesian R²
# mdl_durationPreCat_R2 <- bayes_R2(mdl_durationPreCat)
# # Save the R² output
# saveRDS(mdl_durationPreCat_R2, file = paste0(models, "mdl_durationPreCat_R2.rds"))

mdl_durationPreCat_R2 <- readRDS(paste0(models, "mdl_durationPreCat_R2.rds"))

mdl_durationPreCat_R2
```

An R² of approximately 0.12 indicates a relatively low fit, suggesting
the model explains around 12.4% of the variance in `durationPre`. The
95% credible interval (9.5% to 15.5%) indicates some uncertainty in the
explanatory power of the model.

#### Fixed effects

Let's check how it looks like.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Summarize the model
summary(mdl_durationPreCat)

# Extract fixed effects
exp(fixef(mdl_durationPreCat))
```

It shows a stable increase from 1 to 3.

Diagnostic plots.

```{r echo=FALSE, message=FALSE, warning=FALSE}
plot(mdl_durationPreCat)
```

Posterior predictive check.

```{r echo=FALSE, message=FALSE, warning=FALSE}
pp_check(mdl_durationPreCat, ndraws = 100)

pp_check(mdl_durationPreCat, type = "error_scatter_avg", ndraws = 100)
```

Extract samples.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of fixed effects
samples_mdl_durationPreCat <- as_draws_array(mdl_durationPreCat, 
                                          variable = "^b_", 
                                          regex = TRUE)
samples_mdl_durationPreCat <- mutate_variables(samples_mdl_durationPreCat, 
                                            exp_b_percProm1 = exp(b_percProm1),
                                            exp_b_percProm2 = exp(b_percProm2),
                                            exp_b_percProm3 = exp(b_percProm3))

# Summarize posterior draws
summarize_draws(samples_mdl_durationPreCat)
```

Check conditional effect.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Plot conditional effects (fixed effects only)
conditional_effects(mdl_durationPreCat, re_formula = NA)

# Extract conditional effects data
conditional_effects(mdl_durationPreCat, plot = FALSE, re_formula = NA)$percProm
```

Compare conditional effects to raw values.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Calculate raw means by percProm level
data_prepost_cat %>% 
  group_by(percProm) %>%
  summarize(avg_durationPre = mean(durationPre, na.rm = TRUE))

# Summary of durationPre
summary(data_prepost_cat$durationPre)
```

##### Effect comparison

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Compute estimated marginal means on log-scale
em_mdl_durationPreCat <- emmeans(mdl_durationPreCat, ~ percProm)
# Backtransform the post.beta values
em_mdl_durationPreCat@post.beta <- exp(em_mdl_durationPreCat@post.beta)
print(em_mdl_durationPreCat)
plot(em_mdl_durationPreCat)

# Perform pairwise comparisons between levels of percProm
emPairs_mdl_durationPreCat <- pairs(emmeans(mdl_durationPreCat, ~ percProm))
# Backtransform the post.beta values
emPairs_mdl_durationPreCat@post.beta <- exp(emPairs_mdl_durationPreCat@post.beta)
print(emPairs_mdl_durationPreCat)
plot(emPairs_mdl_durationPreCat)
```

If the comparison includes 0, the contrast is not reliably different.

##### Hypothesis testing

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of the fixed effects coefficients
as_draws_df(mdl_durationPreCat) %>%
  # Select fixed effects for percProm levels
  select(starts_with("b_percProm")) %>%
  # Rename columns to match percProm levels
  rename_with(~ str_replace(.x, "b_percProm", "percProm"), starts_with("b_percProm")) %>%
  # Compute differences between percProm levels
  mutate(
    diff_1_2 = exp(percProm1) - exp(percProm2),
    diff_1_3 = exp(percProm1) - exp(percProm3),
    diff_2_3 = exp(percProm2) - exp(percProm3)
  ) %>%
  # Gather differences into long format
  pivot_longer(
    cols = starts_with("diff_"),
    names_to = "Comparison",
    values_to = "Difference"
  ) %>%
  # Group by comparison to compute summary statistics
  group_by(Comparison) %>%
  summarise(
    Estimate = mean(Difference),
    Est.Error = sd(Difference),
    CI.Lower = quantile(Difference, 0.025),
    CI.Upper = quantile(Difference, 0.975),
    Post.Prob = if_else(Estimate > 0,
                        mean(Difference > 0) * 100,
                        mean(Difference < 0) * 100)
  ) %>%
  ungroup() %>%
  # Add significance stars based on posterior probability
  mutate(
    Star = ifelse(Post.Prob > 95 | Post.Prob < 5, "*", ""),
    Estimate = round(Estimate, 3),
    Est.Error = round(Est.Error, 3),
    CI.Lower = round(CI.Lower, 3),
    CI.Upper = round(CI.Upper, 3),
    Post.Prob = round(Post.Prob, 2)
  ) %>%
  # Select and arrange the final columns
  select(Comparison, Estimate, Est.Error, CI.Lower, CI.Upper, Post.Prob, Star) %>%
  arrange(Comparison)
```

-   **diff_1_2:** Estimate = -11.1 [-19.2, -3.09], Posterior
    Probability = 99.6%; Strong evidence that `durationPre` increases
    from `percProm1` to `percProm2`.

-   **diff_1_3:** Estimate = -34.0 [-49.4, -18.9], Posterior
    Probability = 100%; Strong evidence that `durationPre` increases
    from `percProm1` to `percProm3`.

-   **diff_2_3:** Estimate = -22.8 [-36.0, -10.0], Posterior
    Probability = 100%; Strong evidence that `durationPre` increases
    from `percProm2` to `percProm3`.

**Overall Implications:** A consistent pattern is observed where
`durationPre` increases as perceived prominence levels increase, with
high confidence in these differences.

##### Plot fixef

Visualize the (non-)linearity of the effect with a violin plot of the
posteriors for each prominence level and a GAMM overlaid on top.

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_cat %>%
  data_grid(percProm = unique(percProm),
            gender_s = 0.1563) %>% # Set to average of gender
  add_epred_draws(mdl_durationPreCat, re_formula = NA) %>%
  mutate(
    percProm_num = as.numeric(as.character(percProm)),
    percProm = factor(percProm, levels = c("1", "2", "3"))
  ) %>%
  ggplot(aes(x = percProm_num, y = .epred, color = percProm)) +
  geom_violin(aes(group = percProm_num, fill = percProm), alpha = 0.8) +
  scale_color_manual(values = colorBlindBlack8) +
  scale_fill_manual(values = colorBlindBlack8) +
  stat_summary(fun = median, geom = "point", color = colorBlindBlack8[7], size = 2) +
  geom_smooth(
    aes(group = 1),
    method = "gam",
    formula = y ~ s(x, bs = "cs", k = 3),
    color = colorBlindBlack8[7],
    se = FALSE
  ) +
  scale_x_continuous(
    breaks = 0:3,
    labels = as.character(0:3)
  ) +
  #ylim(1, 5) +
  labs(
    x = "Perceived prominence level",
    y = "Posterior duration (pre-tonic)"
  ) +
  theme_minimal()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
post_durationPreCat <- 
  data_prepost_cat %>%
  data_grid(
    percProm = unique(percProm),
    gender_s = 0.1563  # Set gender_s to zero to average over gender
  ) %>%
  add_epred_draws(mdl_durationPreCat, re_formula = NA) %>%
  mutate(
    percProm = factor(percProm, levels = c("1", "2", "3"))
  ) %>%
  ggplot(aes(y = percProm, x = .epred, fill = percProm)) +
  ggdist::stat_halfeye(
    adjust = 0.5,
    width = 0.6,
    .width = c(0.66, 0.95),
    justification = -0.1,
    point_colour = NA
  ) +
  geom_boxplot(
    width = 0.15,
    outlier.shape = NA,
    alpha = 0.5,
    position = position_nudge(y = 0.2)
  ) +
  stat_summary(
    fun = median,
    geom = "point",
    color = "red",
    size = 2,
    position = position_nudge(y = 0.2)
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  coord_flip() +
  theme_minimal() +
  theme(text = element_text(size = 18)) +
  #xlim(1, 3.5) +
  labs(
    y = "Perceived prominence level",
    x = "Posterior duration (pre-tonic)",
    fill = "Perceived\nprominence"
  )

post_durationPreCat;
ggsave(plot = post_durationPreCat, filename = paste0(plots, "posterior_durationPreCat.pdf"), 
       width = 8, height = 6);
ggsave(plot = post_durationPreCat, filename = paste0(plots, "posterior_durationPreCat.jpg"), 
       width = 8, height = 6);
ggsave(plot = post_durationPreCat, filename = paste0(plots, "posterior_durationPreCat.tif"), 
       width = 8, height = 6, compression="lzw", dpi=600);
```

#### Group-level effects

First, get a general overview.

```{r echo=FALSE, message=FALSE, warning=FALSE}
as.data.frame(VarCorr(mdl_durationPreCat)$participant$sd) %>%
  rownames_to_column(var = "Random Effect") %>%
  select(`Random Effect`, Estimate, Est.Error, Q2.5, Q97.5)
```

-   **percProm1:** Estimated SD = 0.135 (95% CrI: 0.079 to 0.205)

-   **percProm2:** Estimated SD = 0.098 (95% CrI: 0.070 to 0.134)

-   **percProm3:** Estimated SD = 0.219 (95% CrI: 0.149 to 0.305)

The variability is somewhat pronounced at `percProm3`, suggesting that
participants vary in responses to perceived prominence.

Extract samples in interpretable units. Then, plot them so that we can
see how each participant uses the levels of percProm.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract samples for each participant x percProm
data_prepost_cat %>% 
  data_grid(
    participant = unique(participant),
    percProm = unique(percProm),
    gender_s = 0.1563 # Average over gender
  ) %>% 
  add_epred_draws(mdl_durationPreCat) %>% 
  median_qi()

# Plot the draws for all participants x percProm levels
data_prepost_cat %>%
  # Start by selecting unique participants and their gender_s
  select(participant, gender_s) %>%
  distinct() %>%
  # Back-transform gender_s to gender labels
  mutate(
    gender = if_else(gender_s == -0.5, "Male", "Female")
  ) %>%
  # Combine with percProm levels
  crossing(
    percProm = unique(data_prepost_cat$percProm)
  ) %>%
  # Generate posterior predictions
  add_epred_draws(mdl_durationPreCat) %>%
  # Summarize predictions with .66 and .95 intervals
  median_qi(.width = c(.66, .95)) %>%
  ggplot(aes(x = .epred, y = participant, color = percProm, shape = gender)) +
  # Add the thick line for 66% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.66),  # Use 66% credible interval
                 size = 1,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add the thin line for 95% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.95),  # Use 95% credible interval
                 size = 0.5,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add points with shapes
  geom_point(position = position_dodge(width = 0.7), size = 2.5) +
  scale_color_manual(values = colorBlindBlack8) +
  labs(
    x = "Posterior duration (pre-tonic)",
    y = "Participant",
    color = "Perceived prominence",
    shape = "Gender"
  ) +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines")
  )
```

First, we extract individual draws. Here, if the CrI encompasses 0, the
participant does not differ from the overall behavior on this percProm.
Then, we plot random effects for each participant and percProm level on
the model scale, representing deviations from the fixed effects.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# We focus on 95% CrI, but this can be adapted in the width parameter
mdl_durationPreCat %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95))

# In log without Intercept
mdl_durationPreCat %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95, .8, .5)) %>%
  ggplot(aes(y = as.factor(participant), x = r_participant, color = percProm, xmin = .lower, xmax = .upper)) +
  geom_pointinterval(
    position = "dodge") +
  scale_color_manual(
    values = colorBlindBlack8) +
  labs(
    x = "Individual deviations in duration (pre-tonic)",
    y = "Participant",
    color = "Perceived prominence") +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines") 
  )

```

### Amplitude SD

#### Priors

```{r echo=FALSE, message=FALSE, warning=FALSE}
get_prior(
  ampl_sd ~ 0 +
    percProm + gender_s +
    (0 + percProm | participant),
  data = data_prepost_cat,
  family = lognormal()
)

prior_ampl_sdCat <- c(
  #prior('normal(0, 1)', class = 'Intercept', lb = 0),
  #prior('normal(0, 1)', class = 'b'), 
  prior('normal(0, 1)', class = 'b', lb = 0), 
  prior('normal(0, 1)', class = 'sd')
)
```

#### Model

```{r echo=FALSE, message=FALSE, warning=FALSE}
mdl_ampl_sdCat <- brm(ampl_sd ~ 0 +
                         percProm + gender_s +
                         (0 + percProm | participant),
                       data = data_prepost_cat,
                       family = lognormal(),
                       prior = prior_ampl_sdCat,
                       #backend = "cmdstanr", # depends on you
                       cores = 4,
                       chains = 4,
                       iter = 8000,
                       warmup = 4000,
                       seed = 998,
                       control = list(max_treedepth = 12,
                                      adapt_delta = 0.99),
                       file = paste0(models, "mdl_ampl_sdCat.rds"))

# if we need to compress the model more
#saveRDS(mdl_ampl_sdCat, file = paste0(models, "mdl_ampl_sdCat.rds"), compress = "xz")

mdl_ampl_sdCat <- readRDS(paste0(models, "mdl_ampl_sdCat.rds"))
```

Calculate R².

```{r echo=FALSE, message=FALSE, warning=FALSE}
# # Calculate Bayesian R²
# mdl_ampl_sdCat_R2 <- bayes_R2(mdl_ampl_sdCat)
# # Save the R² output
# saveRDS(mdl_ampl_sdCat_R2, file = paste0(models, "mdl_ampl_sdCat_R2.rds"))

mdl_ampl_sdCat_R2 <- readRDS(paste0(models, "mdl_ampl_sdCat_R2.rds"))

mdl_ampl_sdCat_R2
```

An R² of approximately 0.27 suggests a moderate fit, indicating the
model explains about 27.2% of the variance in `ampl_sd`. The credible
interval (24.1% to 30.3%) suggests moderate certainty around the
explanatory power.

#### Fixed effects

Let's check how it looks like.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Summarize the model
summary(mdl_ampl_sdCat)

# Extract fixed effects
exp(fixef(mdl_ampl_sdCat))
```

It shows that the DV stays more or less the same.

Diagnostic plots.

```{r echo=FALSE, message=FALSE, warning=FALSE}
plot(mdl_ampl_sdCat)
```

Posterior predictive check.

```{r echo=FALSE, message=FALSE, warning=FALSE}
pp_check(mdl_ampl_sdCat, ndraws = 100)

pp_check(mdl_ampl_sdCat, type = "error_scatter_avg", ndraws = 100)
```

Extract samples.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of fixed effects
samples_mdl_ampl_sdCat <- as_draws_array(mdl_ampl_sdCat, 
                                          variable = "^b_", 
                                          regex = TRUE)
samples_mdl_ampl_sdCat <- mutate_variables(samples_mdl_ampl_sdCat, 
                                            exp_b_percProm1 = exp(b_percProm1),
                                            exp_b_percProm2 = exp(b_percProm2),
                                            exp_b_percProm3 = exp(b_percProm3))

# Summarize posterior draws
summarize_draws(samples_mdl_ampl_sdCat)
```

Check conditional effect.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Plot conditional effects (fixed effects only)
conditional_effects(mdl_ampl_sdCat, re_formula = NA)

# Extract conditional effects data
conditional_effects(mdl_ampl_sdCat, plot = FALSE, re_formula = NA)$percProm
```

Compare conditional effects to raw values.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Calculate raw means by percProm level
data_prepost_cat %>% 
  group_by(percProm) %>%
  summarize(avg_ampl_sd = mean(ampl_sd, na.rm = TRUE))

# Summary of ampl_sd
summary(data_prepost_cat$ampl_sd)
```

##### Effect comparison

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Compute estimated marginal means on log-scale
em_mdl_ampl_sdCat <- emmeans(mdl_ampl_sdCat, ~ percProm)
# Backtransform the post.beta values
em_mdl_ampl_sdCat@post.beta <- exp(em_mdl_ampl_sdCat@post.beta)
print(em_mdl_ampl_sdCat)
plot(em_mdl_ampl_sdCat)

# Perform pairwise comparisons between levels of percProm
emPairs_mdl_ampl_sdCat <- pairs(emmeans(mdl_ampl_sdCat, ~ percProm))
# Backtransform the post.beta values
emPairs_mdl_ampl_sdCat@post.beta <- exp(emPairs_mdl_ampl_sdCat@post.beta)
print(emPairs_mdl_ampl_sdCat)
plot(emPairs_mdl_ampl_sdCat)
```

If the comparison includes 0, the contrast is not reliably different.

##### Hypothesis testing

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of the fixed effects coefficients
as_draws_df(mdl_ampl_sdCat) %>%
  # Select fixed effects for percProm levels
  select(starts_with("b_percProm")) %>%
  # Rename columns to match percProm levels
  rename_with(~ str_replace(.x, "b_percProm", "percProm"), starts_with("b_percProm")) %>%
  # Compute differences between percProm levels
  mutate(
    diff_1_2 = percProm1 - percProm2,
    diff_1_3 = percProm1 - percProm3,
    diff_2_3 = percProm2 - percProm3
  ) %>%
  # Gather differences into long format
  pivot_longer(
    cols = starts_with("diff_"),
    names_to = "Comparison",
    values_to = "Difference"
  ) %>%
  # Group by comparison to compute summary statistics
  group_by(Comparison) %>%
  summarise(
    Estimate = mean(Difference),
    Est.Error = sd(Difference),
    CI.Lower = quantile(Difference, 0.025),
    CI.Upper = quantile(Difference, 0.975),
    Post.Prob = if_else(Estimate > 0,
                        mean(Difference > 0) * 100,
                        mean(Difference < 0) * 100)
  ) %>%
  ungroup() %>%
  # Add significance stars based on posterior probability
  mutate(
    Star = ifelse(Post.Prob > 95 | Post.Prob < 5, "*", ""),
    Estimate = round(Estimate, 3),
    Est.Error = round(Est.Error, 3),
    CI.Lower = round(CI.Lower, 3),
    CI.Upper = round(CI.Upper, 3),
    Post.Prob = round(Post.Prob, 2)
  ) %>%
  # Select and arrange the final columns
  select(Comparison, Estimate, Est.Error, CI.Lower, CI.Upper, Post.Prob, Star) %>%
  arrange(Comparison)
```

-   **diff_1_2:** Estimate = -0.001 [-0.377, 0.399], Posterior
    Probability = 51.3%; No strong evidence for a difference between
    `percProm1` and `percProm2`.

-   **diff_1_3:** Estimate = -0.004 [-0.415, 0.423], Posterior
    Probability = 51.3%; No conclusive evidence for a difference between
    `percProm1` and `percProm3`.

-   **diff_2_3:** Estimate = -0.003 [-0.39, 0.375], Posterior
    Probability = 50.2%; No strong evidence for a difference between
    `percProm2` and `percProm3`.

**Overall Implications:** There is no strong evidence of significant
differences in `ampl_sd` across perceived prominence levels, suggesting
a stable response across conditions.

##### Plot fixef

Visualize the (non-)linearity of the effect with a violin plot of the
posteriors for each prominence level and a GAMM overlaid on top.

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_cat %>%
  data_grid(percProm = unique(percProm),
            gender_s = 0.1563) %>% # Set to average of gender
  add_epred_draws(mdl_ampl_sdCat, re_formula = NA) %>%
  mutate(
    percProm_num = as.numeric(as.character(percProm)),
    percProm = factor(percProm, levels = c("1", "2", "3"))
  ) %>%
  ggplot(aes(x = percProm_num, y = .epred, color = percProm)) +
  geom_violin(aes(group = percProm_num, fill = percProm), alpha = 0.8) +
  scale_color_manual(values = colorBlindBlack8) +
  scale_fill_manual(values = colorBlindBlack8) +
  stat_summary(fun = median, geom = "point", color = colorBlindBlack8[7], size = 2) +
  geom_smooth(
    aes(group = 1),
    method = "gam",
    formula = y ~ s(x, bs = "cs", k = 3),
    color = colorBlindBlack8[7],
    se = FALSE
  ) +
  scale_x_continuous(
    breaks = 0:3,
    labels = as.character(0:3)
  ) +
  #ylim(1, 5) +
  labs(
    x = "Perceived prominence level",
    y = "Posterior amplitude SD"
  ) +
  theme_minimal()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_cat %>%
  data_grid(
    percProm = unique(percProm),
    gender_s = 0.1563  # Set gender_s to zero to average over gender
  ) %>%
  add_epred_draws(mdl_ampl_sdCat, re_formula = NA) %>%
  mutate(
    percProm = factor(percProm, levels = c("1", "2", "3"))
  ) %>%
  ggplot(aes(y = percProm, x = .epred, fill = percProm)) +
  ggdist::stat_halfeye(
    adjust = 0.5,
    width = 0.6,
    .width = c(0.66, 0.95),
    justification = -0.1,
    point_colour = NA
  ) +
  geom_boxplot(
    width = 0.15,
    outlier.shape = NA,
    alpha = 0.5,
    position = position_nudge(y = 0.2)
  ) +
  stat_summary(
    fun = median,
    geom = "point",
    color = "red",
    size = 2,
    position = position_nudge(y = 0.2)
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  coord_flip() +
  theme_minimal() +
  xlim(1, 3.5) +
  labs(
    y = "Perceived prominence level",
    x = "Posterior amplitude SD"
  )
```

#### Group-level effects

First, get a general overview.

```{r echo=FALSE, message=FALSE, warning=FALSE}
as.data.frame(VarCorr(mdl_ampl_sdCat)$participant$sd) %>%
  rownames_to_column(var = "Random Effect") %>%
  select(`Random Effect`, Estimate, Est.Error, Q2.5, Q97.5)
```

-   **percProm1:** Estimated SD = 2.924 (95% CrI: 2.484 to 3.456)

-   **percProm2:** Estimated SD = 2.711 (95% CrI: 2.296 to 3.203)

-   **percProm3:** Estimated SD = 2.710 (95% CrI: 2.294 to 3.212)

Participant-level variability remains substantial across conditions,
indicating differences in individual responses.

Extract samples in interpretable units. Then, plot them so that we can
see how each participant uses the levels of percProm.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract samples for each participant x percProm
data_prepost_cat %>% 
  data_grid(
    participant = unique(participant),
    percProm = unique(percProm),
    gender_s = 0.1563 # Average over gender
  ) %>% 
  add_epred_draws(mdl_ampl_sdCat) %>% 
  median_qi()

# Plot the draws for all participants x percProm levels
data_prepost_cat %>%
  # Start by selecting unique participants and their gender_s
  select(participant, gender_s) %>%
  distinct() %>%
  # Back-transform gender_s to gender labels
  mutate(
    gender = if_else(gender_s == -0.5, "Male", "Female")
  ) %>%
  # Combine with percProm levels
  crossing(
    percProm = unique(data_prepost_cat$percProm)
  ) %>%
  # Generate posterior predictions
  add_epred_draws(mdl_ampl_sdCat) %>%
  # Summarize predictions with .66 and .95 intervals
  median_qi(.width = c(.66, .95)) %>%
  ggplot(aes(x = .epred, y = participant, color = percProm, shape = gender)) +
  # Add the thick line for 66% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.66),  # Use 66% credible interval
                 size = 1,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add the thin line for 95% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.95),  # Use 95% credible interval
                 size = 0.5,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add points with shapes
  geom_point(position = position_dodge(width = 0.7), size = 2.5) +
  scale_color_manual(values = colorBlindBlack8) +
  labs(
    x = "Posterior amplitude SD",
    y = "Participant",
    color = "Perceived prominence",
    shape = "Gender"
  ) +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines")
  )
```

First, we extract individual draws. Here, if the CrI encompasses 0, the
participant does not differ from the overall behavior on this percProm.
Then, we plot random effects for each participant and percProm level on
the model scale, representing deviations from the fixed effects.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# We focus on 95% CrI, but this can be adapted in the width parameter
mdl_ampl_sdCat %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95))

# In log without Intercept
mdl_ampl_sdCat %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95, .8, .5)) %>%
  ggplot(aes(y = as.factor(participant), x = r_participant, color = percProm, xmin = .lower, xmax = .upper)) +
  geom_pointinterval(
    position = "dodge") +
  scale_color_manual(
    values = colorBlindBlack8) +
  labs(
    x = "Individual deviations in amplitude SD",
    y = "Participant",
    color = "Perceived prominence") +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines") 
  )

```

## German

Let's check the correlations between acoustic features.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Calculate the correlation matrix
corrGer <- cor(data_prepost_ger[, c("f0_slope", "pitch_median", "ampl_sd", 
                                    "ampl_noSilence_medianPost", "ampl_noSilence_median", 
                                    "duration", "flux_sd", "flux_median", 
                                    "ampl_noSilence_sd", "pitch_medianPost")], use = "complete.obs")
corrplot(corrGer, method = "color", tl.cex = 0.7, number.cex = 0.7, addCoef.col = "black")
```

Let's set contrasts for comparisons. (Only for intercept models!)

```{r echo=FALSE, message=FALSE, warning=FALSE}
# # Set sum contrasts for percProm to compare all levels
# contrasts(data_prepost_ger$percProm) <- contr.sum(length(unique(data_prepost_ger$percProm)))
```

What is the mean for gender.

```{r echo=FALSE, message=FALSE, warning=FALSE}
summary(data_prepost_ger$gender_s)
# 0.09727
```

We go one by one the ten features from top to bottom.

### F0 slope

#### Priors

```{r echo=FALSE, message=FALSE, warning=FALSE}
get_prior(
  f0_slope ~ 0 +
    percProm + 
    gender_s +
    (0 + percProm | participant),
  data = data_prepost_ger,
  family = "student"
)

prior_f0_slopeGer <- c(
  #prior('normal(0, 5)', class = "b"), 
  prior('student_t(3, 0, 10)', class = "b"),
  #prior('student_t(3, 0, 10)', class = "Intercept"), 
  prior('student_t(3, 0, 10)', class = "sd") 
)

# Visualize the priors
prior_plot_data <- data.frame(
  x = seq(-20, 20, length.out = 1000),
  normal_b = dnorm(seq(-20, 20, length.out = 1000), mean = 0, sd = 2),
  student_t_intercept = dt((seq(-20, 20, length.out = 1000) - 0) / 10, df = 3) / 10,
  student_t_sd = dt((seq(-20, 20, length.out = 1000) - 0) / 10, df = 3) / 10
)

# Create the plot for priors
ggplot(prior_plot_data, aes(x = x)) +
  geom_line(aes(y = normal_b, color = "Fixed Effects (Normal)"), size = 1) +
  geom_line(aes(y = student_t_intercept, color = "Intercept (Student-t)"), size = 1, linetype = "dashed") +
  geom_line(aes(y = student_t_sd, color = "SD (Student-t)"), size = 1, linetype = "dotted") +
  labs(x = "Value", y = "Density") +
  scale_color_manual(values = c("Fixed Effects (Normal)" = "blue",
                                "Intercept (Student-t)" = "red",
                                "SD (Student-t)" = "green")) +
  theme_minimal()
```

#### Model

```{r echo=FALSE, message=FALSE, warning=FALSE}
mdl_f0_slopeGer <- brm(f0_slope ~ 0 +
                         percProm + 
                         gender_s +
                         (0 + percProm | participant),
                       data = data_prepost_ger,
                       family = "student",
                       prior = prior_f0_slopeGer,
                       #backend = "cmdstanr", # depends on you
                       cores = 4,
                       chains = 4,
                       iter = 8000,
                       warmup = 4000,
                       seed = 998,
                       control = list(max_treedepth = 12,
                                      adapt_delta = 0.99),
                       file = paste0(models, "mdl_f0_slopeGer.rds"))

# if we need to compress the model more
#saveRDS(mdl_f0_slopeGer, file = paste0(models, "mdl_f0_slopeGer.rds"), compress = "xz")

mdl_f0_slopeGer <- readRDS(paste0(models, "mdl_f0_slopeGer.rds"))
```

Calculate R².

```{r echo=FALSE, message=FALSE, warning=FALSE}
# # Calculate Bayesian R²
# mdl_f0_slopeGer_R2 <- bayes_R2(mdl_f0_slopeGer)
# # Save the R² output
# saveRDS(mdl_f0_slopeGer_R2, file = paste0(models, "mdl_f0_slopeGer_R2.rds"))

mdl_f0_slopeGer_R2 <- readRDS(paste0(models, "mdl_f0_slopeGer_R2.rds"))

mdl_f0_slopeGer_R2
```

An R² of approximately 0.16 suggests a **weak fit**. This means the
model explains only about 15.9% of the variance in the dependent
variable `f0_slopeGer`, indicating that the majority of the variability
in f0_slopeGer is not accounted for by the predictors in the model. The
95% credible interval, ranging from **13.9% to 18.0%**, highlights the
uncertainty but confirms that the model’s explanatory power is
relatively low.

#### Fixed effects

Let's check how it looks like.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Summarize the model
summary(mdl_f0_slopeGer)

# Extract fixed effects
fixef(mdl_f0_slopeGer)
```

It shows a gradual increase in f0_slope from percProm 0, through 1, 2,
up to 3.

Diagnostic plots.

```{r echo=FALSE, message=FALSE, warning=FALSE}
plot(mdl_f0_slopeGer)
```

Posterior predictive check.

```{r echo=FALSE, message=FALSE, warning=FALSE}
pp_check(mdl_f0_slopeGer, ndraws = 100)

pp_check(mdl_f0_slopeGer, type = "error_scatter_avg", ndraws = 100)
```

Extract samples.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of fixed effects
samples_mdl_f0_slopeGer <- as_draws_array(mdl_f0_slopeGer, 
                                          variable = "^b_", 
                                          regex = TRUE)

# Summarize posterior draws
summarize_draws(samples_mdl_f0_slopeGer)
```

Check conditional effect.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Plot conditional effects (fixed effects only)
conditional_effects(mdl_f0_slopeGer, re_formula = NA)

# Extract conditional effects data
conditional_effects(mdl_f0_slopeGer, plot = FALSE, re_formula = NA)$percProm
```

Compare conditional effects to raw values.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Calculate raw means by percProm level
data_prepost_ger %>% 
  group_by(percProm) %>%
  summarize(avg_f0_slope = mean(f0_slope, na.rm = TRUE))

# Summary of f0_slope
summary(data_prepost_ger$f0_slope)
```

Mean is the same, the posterior averages including RE correspond to raw
values.

##### Effect comparison

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Compute estimated marginal means
emmeans(mdl_f0_slopeGer, ~ percProm)

# Perform pairwise comparisons
em_mdl_f0_slopeGer <- pairs(emmeans(mdl_f0_slopeGer, ~ percProm))
em_mdl_f0_slopeGer
```

If the comparison includes 0, the contrast is not reliably different.
For example:

**percProm0 - percProm1**: The estimated difference in `f0_slope`
between `percProm0` and `percProm1` is **-0.0574**. The HPD interval is
**(-0.152, 0.0411)**, which includes zero, meaning this difference is
**not credibly different from zero** (i.e., no significant difference
between these levels).

**percProm0 - percProm2**: The estimated difference between `percProm0`
and `percProm2` is **-0.1806**, and the HPD interval is **(-0.280,
-0.0792)**. Since this interval does **not include zero**, the
difference is **credibly different from zero**, indicating a significant
difference in `f0_slope` between these two levels.

##### Hypothesis testing

In our analysis, we are interested in comparing all four levels of
perceived prominence (`percProm`) with each other to determine if there
are significant differences in `f0_slope` across these levels. Since we
are using a **no-intercept model** (i.e.,
`f0_slope ~ 0 + percProm + gender + (0 + percProm | participant)`), the
fixed effects coefficients directly represent the mean `f0_slope` for
each `percProm` level.

We choose to use our own custom pipeline instead of the `hypothesis()`
function for the following reasons:

1.  **Direct Access to Posterior Samples:** By extracting the posterior
    samples of the fixed effects coefficients, we can directly compute
    the differences between `percProm` levels. This approach allows us
    to utilize the full posterior distribution for each level in our
    comparisons.

2.  **Flexible and Comprehensive Comparisons:** Our pipeline enables us
    to compute all pairwise comparisons between `percProm` levels in a
    single, cohesive process. This flexibility is beneficial when
    dealing with multiple levels and numerous comparisons.

3.  **Customized Posterior Probability Calculations:** We can calculate
    the posterior probabilities that the differences are greater than or
    less than zero, providing a clear measure of the strength of
    evidence for each comparison.

4.  **Simplified Interpretation:** The results from our pipeline are
    presented in an easy-to-interpret format, including estimates,
    standard errors, credible intervals, and significance indicators,
    similar to the output of `hypothesis()` but tailored to our specific
    model structure.

Using our custom pipeline allows us to:

-   **Compute differences between specific levels** of `percProm`
    directly from the posterior samples of the fixed effects.

-   **Obtain posterior probabilities** for these differences, giving us
    insight into the likelihood that a true difference exists.

-   **Present the results** in a clear and interpretable manner,
    facilitating straightforward comparison and interpretation.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of the fixed effects coefficients
as_draws_df(mdl_f0_slopeGer) %>%
  # Select fixed effects for percProm levels
  select(starts_with("b_percProm")) %>%
  # Rename columns to match percProm levels
  rename_with(~ str_replace(.x, "b_percProm", "percProm"), starts_with("b_percProm")) %>%
  # Compute differences between percProm levels
  mutate(
    diff_0_1 = percProm0 - percProm1,
    diff_0_2 = percProm0 - percProm2,
    diff_0_3 = percProm0 - percProm3,
    diff_1_2 = percProm1 - percProm2,
    diff_1_3 = percProm1 - percProm3,
    diff_2_3 = percProm2 - percProm3
  ) %>%
  # Gather differences into long format
  pivot_longer(
    cols = starts_with("diff_"),
    names_to = "Comparison",
    values_to = "Difference"
  ) %>%
  # Group by comparison to compute summary statistics
  group_by(Comparison) %>%
  summarise(
    Estimate = mean(Difference),
    Est.Error = sd(Difference),
    CI.Lower = quantile(Difference, 0.025),
    CI.Upper = quantile(Difference, 0.975),
    Post.Prob = if_else(Estimate > 0,
                        mean(Difference > 0) * 100,
                        mean(Difference < 0) * 100)
  ) %>%
  ungroup() %>%
  # Add significance stars based on posterior probability
  mutate(
    Star = ifelse(Post.Prob > 95 | Post.Prob < 5, "*", ""),
    Estimate = round(Estimate, 3),
    Est.Error = round(Est.Error, 3),
    CI.Lower = round(CI.Lower, 3),
    CI.Upper = round(CI.Upper, 3),
    Post.Prob = round(Post.Prob, 2)
  ) %>%
  # Select and arrange the final columns
  select(Comparison, Estimate, Est.Error, CI.Lower, CI.Upper, Post.Prob, Star) %>%
  arrange(Comparison)
```

-   **`diff_0_1`:** Estimate = -0.056 [-0.149, 0.045], Posterior
    Probability = 89.40%; There is moderate evidence that the `f0_slope`
    at `percProm1` is higher than at `percProm0`. However, since the
    credible interval includes zero and the posterior probability is
    less than 95%, this difference is not considered reliable.

-   **`diff_0_2`:** Estimate = -0.180 [-0.278, -0.076], Posterior
    Probability = 99.60%; Strong evidence that the `f0_slope` at
    `percProm2` is higher than at `percProm0`. The negative estimate
    indicates that `percProm0` has a lower `f0_slope` compared to
    `percProm2`.

-   **`diff_0_3`:** Estimate = -0.244 [-0.350, -0.134], Posterior
    Probability = 99.90%; Strong evidence that the `f0_slope` at
    `percProm3` is higher than at `percProm0`.

-   **`diff_1_2`:** Estimate = -0.123 [-0.153, -0.095], Posterior
    Probability = 100%; Strong evidence that the `f0_slope` increases
    from `percProm1` to `percProm2`.

-   **`diff_1_3`:** Estimate = -0.188 [-0.231, -0.141], Posterior
    Probability = 100%; Strong evidence that the `f0_slope` increases
    from `percProm1` to `percProm3`.

-   **`diff_2_3`:** Estimate = -0.064 [-0.104, -0.024], Posterior
    Probability = 99.90%; Strong evidence that the `f0_slope` increases
    from `percProm2` to `percProm3`.

**Overall Implications:**

-   **Trend:** The `f0_slope` increases as `percProm` levels increase
    from 0 to 3.

-   **Interpretation:** Except for the comparison between levels 0 and
    1, all other comparisons show strong evidence (posterior probability
    \> 95%) of an increase in `f0_slope` with increasing `percProm`. As
    the perceived prominence (`percProm`) increases, the `f0_slope`
    becomes more positive (or less negative), indicating a rising pitch
    slope. This suggests that higher prominence levels are associated
    with an increase in `f0_slope`.

##### Plot fixef

Visualize the (non-)linearity of the effect with a violin plot of the
posteriors for each prominence level and a GAMM overlaid on top.

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_ger %>%
  data_grid(percProm = unique(percProm),
            gender_s = 0.09727) %>% # Set to average of gender
  add_epred_draws(mdl_f0_slopeGer, re_formula = NA) %>%
  mutate(
    percProm_num = as.numeric(as.character(percProm)),
    percProm = factor(percProm, levels = c("0", "1", "2", "3"))
  ) %>%
  ggplot(aes(x = percProm_num, y = .epred, color = percProm)) +
  geom_violin(aes(group = percProm_num, fill = percProm), alpha = 0.8) +
  scale_color_manual(values = colorBlindBlack8) +
  scale_fill_manual(values = colorBlindBlack8) +
  stat_summary(fun = median, geom = "point", color = colorBlindBlack8[7], size = 2) +
  geom_smooth(
    aes(group = 1),
    method = "gam",
    formula = y ~ s(x, bs = "cs", k = 4),
    color = colorBlindBlack8[7],
    se = FALSE
  ) +
  scale_x_continuous(
    breaks = 0:3,
    labels = as.character(0:3)
  ) +
  labs(
    x = "Perceived prominence level",
    y = "Posterior f0 slope"
  ) +
  theme_minimal()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
post_f0_slopeGer <- 
  data_prepost_ger %>%
  data_grid(
    percProm = unique(percProm),
    gender_s = 0.09727  # Set gender_s to the average of gender
  ) %>%
  add_epred_draws(mdl_f0_slopeGer, re_formula = NA) %>%
  mutate(
    percProm = factor(percProm, levels = c("0", "1", "2", "3"))
  ) %>%
  ggplot(aes(y = percProm, x = .epred, fill = percProm)) +
  ggdist::stat_halfeye(
    adjust = 0.5,
    width = 0.6,
    .width = c(0.66, 0.95),
    justification = -0.1,
    point_colour = NA
  ) +
  geom_boxplot(
    width = 0.15,
    outlier.shape = NA,
    alpha = 0.5,
    position = position_nudge(y = 0.2)
  ) +
  stat_summary(
    fun = median,
    geom = "point",
    color = "red",
    size = 2,
    position = position_nudge(y = 0.2)
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  coord_flip() +
  theme_minimal() +
  xlim(-0.20, 0.30) +
  theme(text = element_text(size = 18)) +
  labs(
    y = "Perceived prominence level",
    x = "Posterior f0 slope",
    fill = "Perceived\nprominence"
  )

post_f0_slopeGer;
ggsave(plot = post_f0_slopeGer, filename = paste0(plots, "posterior_f0_slopeGer.pdf"), 
       width = 8, height = 6);
ggsave(plot = post_f0_slopeGer, filename = paste0(plots, "posterior_f0_slopeGer.jpg"), 
       width = 8, height = 6);
ggsave(plot = post_f0_slopeGer, filename = paste0(plots, "posterior_f0_slopeGer.tif"), 
       width = 8, height = 6, compression="lzw", dpi=600);
```

#### Group-level effects

First, get a general overview.

```{r echo=FALSE, message=FALSE, warning=FALSE}
as.data.frame(VarCorr(mdl_f0_slopeGer)$participant$sd) %>%
  rownames_to_column(var = "Random Effect") %>%
  select(`Random Effect`, Estimate, Est.Error, Q2.5, Q97.5)
```

-   **percProm0:** The estimated standard deviation of the random
    intercepts is 0.1095 (95% CrI: 0.0168 to 0.2662), indicating
    moderate variability in participants' baseline `f0_slope`.

-   **percProm1:** The estimated standard deviation is 0.0506 (95% CrI:
    0.0306 to 0.0737), suggesting some variability in participants'
    response to `percProm1`.

-   **percProm2:** The estimated standard deviation is 0.0862 (95% CrI:
    0.0656 to 0.1133), indicating some (more that `percProm1`)
    variability in participants' response to `percProm2`.

-   **percProm3:** The estimated standard deviation is 0.1052 (95% CrI:
    0.0704 to 0.1492), indicating slightly more variability in response
    to `percProm3` compared to `percProm2`.

Extract samples in interpretable units. Then, plot them so that we can
see how each participant uses the levels of percProm.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract samples for each participant x percProm
data_prepost_ger %>% 
  data_grid(
    participant = unique(participant),
    percProm = unique(percProm),
    gender_s = 0.09727 # Average over gender
  ) %>% 
  add_epred_draws(mdl_f0_slopeGer) %>% 
  median_qi()

# Plot the draws for all participants x percProm levels
data_prepost_ger %>%
  # Start by selecting unique participants and their gender_s
  select(participant, gender_s) %>%
  distinct() %>%
  # Back-transform gender_s to gender labels
  mutate(
    gender = if_else(gender_s == -0.5, "Male", "Female")
  ) %>%
  # Combine with percProm levels
  crossing(
    percProm = unique(data_prepost_ger$percProm)
  ) %>%
  # Generate posterior predictions
  add_epred_draws(mdl_f0_slopeGer) %>%
  # Summarize predictions with .66 and .95 intervals
  median_qi(.width = c(.66, .95)) %>%
  ggplot(aes(x = .epred, y = participant, color = percProm, shape = gender)) +
  # Add the thick line for 66% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.66),  # Use 66% credible interval
                 size = 1,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add the thin line for 95% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.95),  # Use 95% credible interval
                 size = 0.5,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add points with shapes
  geom_point(position = position_dodge(width = 0.7), size = 2.5) +
  scale_color_manual(values = colorBlindBlack8) +
  labs(
    x = "Posterior f0 slope",
    y = "Participant",
    color = "Perceived prominence",
    shape = "Gender"
  ) +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines")
  )
```

First, we extract individual draws. Here, if the CrI encompasses 0, the
participant does not differ from the overall behavior. Then, we plot
random effects for each participant and percProm level on the model
scale, representing deviations from the fixed effects.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# We focus on 95% CrI, but this can be adapted in the width parameter
mdl_f0_slopeGer %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95))

# In log without Intercept
mdl_f0_slopeGer %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95, .8, .5)) %>%
  ggplot(aes(y = as.factor(participant), x = r_participant, color = percProm, xmin = .lower, xmax = .upper)) +
  geom_pointinterval(
    position = "dodge") +
  scale_color_manual(
    values = colorBlindBlack8) +
  labs(
    x = "Individual deviations in f0 slope",
    y = "Participant",
    color = "Perceived prominence") +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines") 
  )

```

### F0 median

#### Priors

```{r echo=FALSE, message=FALSE, warning=FALSE}
get_prior(
  pitch_median ~ 0 +
    percProm + 
    gender_s + 
    (0 + percProm | participant),
  data = data_prepost_ger,
  family = lognormal()
)

prior_pitch_medianGer <- c(
  #prior('normal(0, 10)', class = 'Intercept', lb = 0),
  #prior('normal(0, 1)', class = 'b'),  # For intercept
  prior('normal(0, 10)', class = 'b', lb = 0),
  prior('normal(0, 1)', class = 'sd')  # For random effects (participant)
)
```

#### Model

```{r echo=FALSE, message=FALSE, warning=FALSE}
mdl_pitch_medianGer <- brm(pitch_median ~ 0 +
                             percProm + 
                             gender_s + 
                             (0 + percProm | participant),
                           data = data_prepost_ger,
                           family = lognormal(),
                           prior = prior_pitch_medianGer,
                           #backend = "cmdstanr", # depends on you
                           cores = 4,
                           chains = 4,
                           iter = 8000,
                           warmup = 4000,
                           seed = 998,
                           control = list(max_treedepth = 12,
                                          adapt_delta = 0.99),
                           file = paste0(models, "mdl_pitch_medianGer.rds"))

# if we need to compress the model more
#saveRDS(mdl_pitch_medianGer, file = paste0(models, "mdl_pitch_medianGer.rds"), compress = "xz")

mdl_pitch_medianGer <- readRDS(paste0(models, "mdl_pitch_medianGer.rds"))
```

Calculate R².

```{r echo=FALSE, message=FALSE, warning=FALSE}
# # Calculate Bayesian R²
# mdl_pitch_medianGer_R2 <- bayes_R2(mdl_pitch_medianGer)
# # Save the R² output
# saveRDS(mdl_pitch_medianGer_R2, file = paste0(models, "mdl_pitch_medianGer_R2.rds"))

mdl_pitch_medianGer_R2 <- readRDS(paste0(models, "mdl_pitch_medianGer_R2.rds"))

mdl_pitch_medianGer_R2
```

An R² of around 0.57 suggests a **moderately strong fit**. This
indicates that the model explains approximately 57.4% of the variance in
the dependent variable, meaning more than half of the variability in
`pitch_medianGer` is accounted for by the predictors. The 95% credible
interval suggests the R² value is likely between **55.5% and 59.1%**,
indicating the model's performance is stable and provides a relatively
good explanation of the variance.

#### Fixed effects

Let's check how it looks like.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Summarize the model
summary(mdl_pitch_medianGer)

# Extract fixed effects
exp(fixef(mdl_pitch_medianGer))
```

It shows that pitch median falls from 0 to 1, but raises gradually from
1, through 2 to 3.

Diagnostic plots.

```{r echo=FALSE, message=FALSE, warning=FALSE}
plot(mdl_pitch_medianGer)
```

Posterior predictive check.

```{r echo=FALSE, message=FALSE, warning=FALSE}
pp_check(mdl_pitch_medianGer, ndraws = 100)

pp_check(mdl_pitch_medianGer, type = "error_scatter_avg", ndraws = 100)
```

Extract samples.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of fixed effects
samples_mdl_pitch_medianGer <- as_draws_array(mdl_pitch_medianGer, 
                                          variable = "^b_", 
                                          regex = TRUE)
samples_mdl_pitch_medianGer <- mutate_variables(samples_mdl_pitch_medianGer, 
                                                exp_b_percProm0 = exp(b_percProm0), 
                                                exp_b_percProm1 = exp(b_percProm1),
                                                exp_b_percProm2 = exp(b_percProm2),
                                                exp_b_percProm3 = exp(b_percProm3))

# Summarize posterior draws
summarize_draws(samples_mdl_pitch_medianGer)
```

Check conditional effect.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Plot conditional effects (fixed effects only)
conditional_effects(mdl_pitch_medianGer, re_formula = NA)

# Extract conditional effects data
conditional_effects(mdl_pitch_medianGer, plot = FALSE, re_formula = NA)$percProm
```

Compare conditional effects to raw values.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Calculate raw means by percProm level
data_prepost_ger %>% 
  group_by(percProm) %>%
  summarize(avg_pitch_median = mean(pitch_median, na.rm = TRUE))

# Summary of pitch_median
summary(data_prepost_ger$pitch_median)
```

##### Effect comparison

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Compute estimated marginal means on log-scale
em_mdl_pitch_medianGer <- emmeans(mdl_pitch_medianGer, ~ percProm)
# Backtransform the post.beta values
em_mdl_pitch_medianGer@post.beta <- exp(em_mdl_pitch_medianGer@post.beta)
print(em_mdl_pitch_medianGer)
plot(em_mdl_pitch_medianGer)

# Perform pairwise comparisons between levels of percProm
emPairs_mdl_pitch_medianGer <- pairs(emmeans(mdl_pitch_medianGer, ~ percProm))
# Backtransform the post.beta values
emPairs_mdl_pitch_medianGer@post.beta <- exp(emPairs_mdl_pitch_medianGer@post.beta)
print(emPairs_mdl_pitch_medianGer)
plot(emPairs_mdl_pitch_medianGer)
```

If the comparison includes 0, the contrast is not reliably different.

##### Hypothesis testing

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of the fixed effects coefficients
as_draws_df(mdl_pitch_medianGer) %>%
  # Select fixed effects for percProm levels
  select(starts_with("b_percProm")) %>%
  # Rename columns to match percProm levels
  rename_with(~ str_replace(.x, "b_percProm", "percProm"), starts_with("b_percProm")) %>%
  # Compute differences between percProm levels
  mutate(
    diff_0_1 = exp(percProm0) - exp(percProm1),
    diff_0_2 = exp(percProm0) - exp(percProm2),
    diff_0_3 = exp(percProm0) - exp(percProm3),
    diff_1_2 = exp(percProm1) - exp(percProm2),
    diff_1_3 = exp(percProm1) - exp(percProm3),
    diff_2_3 = exp(percProm2) - exp(percProm3)
  ) %>%
  # Gather differences into long format
  pivot_longer(
    cols = starts_with("diff_"),
    names_to = "Comparison",
    values_to = "Difference"
  ) %>%
  # Group by comparison to compute summary statistics
  group_by(Comparison) %>%
  summarise(
    Estimate = mean(Difference),
    Est.Error = sd(Difference),
    CI.Lower = quantile(Difference, 0.025),
    CI.Upper = quantile(Difference, 0.975),
    Post.Prob = if_else(Estimate > 0,
                        mean(Difference > 0) * 100,
                        mean(Difference < 0) * 100)
  ) %>%
  ungroup() %>%
  # Add significance stars based on posterior probability
  mutate(
    Star = ifelse(Post.Prob > 95 | Post.Prob < 5, "*", ""),
    Estimate = round(Estimate, 3),
    Est.Error = round(Est.Error, 3),
    CI.Lower = round(CI.Lower, 3),
    CI.Upper = round(CI.Upper, 3),
    Post.Prob = round(Post.Prob, 2)
  ) %>%
  # Select and arrange the final columns
  select(Comparison, Estimate, Est.Error, CI.Lower, CI.Upper, Post.Prob, Star) %>%
  arrange(Comparison)
```

-   **`diff_0_1`:** Estimate = 0.052 [-0.124, 0.226], Posterior
    Probability = 73.90%; There is weak evidence that the `pitch_median`
    at `percProm1` is higher than at `percProm0`. However, the posterior
    probability is low, and the credible interval includes zero,
    suggesting that this difference is not reliable.

-   **`diff_0_2`:** Estimate = -0.003 [-0.179, 0.168], Posterior
    Probability = 51.40%; No evidence for a difference between
    `percProm0` and `percProm2`. The estimate is nearly zero, and the
    credible interval includes zero, making this difference
    insignificant.

-   **`diff_0_3`:** Estimate = -0.068 [-0.251, 0.114], Posterior
    Probability = 77.90%; There is weak evidence that `pitch_median` at
    `percProm3` is higher than at `percProm0`. However, since the
    credible interval includes zero and the posterior probability is
    less than 95%, this difference is not considered reliable.

-   **`diff_1_2`:** Estimate = -0.055 [-0.084, -0.027], Posterior
    Probability = 100%; Strong evidence that the `pitch_median`
    increases from `percProm1` to `percProm2`. The negative estimate and
    the credible interval fully below zero support this.

-   **`diff_1_3`:** Estimate = -0.120 [-0.164, -0.077], Posterior
    Probability = 100%; Strong evidence that the `pitch_median`
    increases from `percProm1` to `percProm3`.

-   **`diff_2_3`:** Estimate = -0.065 [-0.099, -0.032], Posterior
    Probability = 100%; Strong evidence that the `pitch_median`
    increases from `percProm2` to `percProm3`.

**Overall Implications:**

-   **Trend:** The `pitch_median` generally increases as `percProm`
    levels increase from 1 to 3. However, there is weak or no evidence
    of a difference between `percProm0` and the other levels.

-   **Interpretation:** Strong evidence (posterior probability ≥ 95%) is
    present for increases in `pitch_median` between levels `percProm1`,
    `percProm2`, and `percProm3`. However, comparisons involving
    `percProm0` do not show reliable differences.

##### Plot fixef

Visualize the (non-)linearity of the effect with a violin plot of the
posteriors for each prominence level and a GAMM overlaid on top.

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_ger %>%
  data_grid(percProm = unique(percProm),
            gender_s = 0.09727) %>% # Set to average of gender
  add_epred_draws(mdl_pitch_medianGer, re_formula = NA) %>%
  mutate(
    percProm_num = as.numeric(as.character(percProm)),
    percProm = factor(percProm, levels = c("0", "1", "2", "3"))
  ) %>%
  ggplot(aes(x = percProm_num, y = .epred, color = percProm)) +
  geom_violin(aes(group = percProm_num, fill = percProm), alpha = 0.8) +
  scale_color_manual(values = colorBlindBlack8) +
  scale_fill_manual(values = colorBlindBlack8) +
  stat_summary(fun = median, geom = "point", color = colorBlindBlack8[7], size = 2) +
  geom_smooth(
    aes(group = 1),
    method = "gam",
    formula = y ~ s(x, bs = "cs", k = 4),
    color = colorBlindBlack8[7],
    se = FALSE
  ) +
  scale_x_continuous(
    breaks = 0:3,
    labels = as.character(0:3)
  ) +
  labs(
    x = "Perceived prominence level",
    y = "Posterior f0 median"
  ) +
  theme_minimal()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
post_pitch_medianGer <- 
  data_prepost_ger %>%
  data_grid(
    percProm = unique(percProm),
    gender_s = 0.09727  # Set gender_s to zero to average over gender
  ) %>%
  add_epred_draws(mdl_pitch_medianGer, re_formula = NA) %>%
  mutate(
    percProm = factor(percProm, levels = c("0", "1", "2", "3"))
  ) %>%
  ggplot(aes(y = percProm, x = .epred, fill = percProm)) +
  ggdist::stat_halfeye(
    adjust = 0.5,
    width = 0.6,
    .width = c(0.66, 0.95),
    justification = -0.1,
    point_colour = NA
  ) +
  geom_boxplot(
    width = 0.15,
    outlier.shape = NA,
    alpha = 0.5,
    position = position_nudge(y = 0.2)
  ) +
  stat_summary(
    fun = median,
    geom = "point",
    color = "red",
    size = 2,
    position = position_nudge(y = 0.2)
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  coord_flip() +
  theme_minimal() +
  xlim(140, 230) +
  theme(text = element_text(size = 18)) +
  labs(
    y = "Perceived prominence level",
    x = "Posterior f0 median",
    fill = "Perceived\nprominence"
  )

post_pitch_medianGer;
ggsave(plot = post_pitch_medianGer, filename = paste0(plots, "posterior_pitch_medianGer.pdf"), 
       width = 8, height = 6);
ggsave(plot = post_pitch_medianGer, filename = paste0(plots, "posterior_pitch_medianGer.jpg"), 
       width = 8, height = 6);
ggsave(plot = post_pitch_medianGer, filename = paste0(plots, "posterior_pitch_medianGer.tif"), 
       width = 8, height = 6, compression="lzw", dpi=600);
```

#### Group-level effects

First, get a general overview.

```{r echo=FALSE, message=FALSE, warning=FALSE}
as.data.frame(VarCorr(mdl_pitch_medianGer)$participant$sd) %>%
  rownames_to_column(var = "Random Effect") %>%
  select(`Random Effect`, Estimate, Est.Error, Q2.5, Q97.5)
```

-   **percProm0:** The estimated standard deviation of the random
    effects for `percProm0` is 0.2853 (95% CrI: 0.1642 to 0.4785),
    indicating substantial variability in participants' baseline
    `pitch_median`.

-   **percProm1:** The estimated standard deviation is 0.0892 (95% CrI:
    0.0649 to 0.1211), suggesting relatively low variability in
    participants' response to `percProm1`.

-   **percProm2:** The estimated standard deviation is 0.0716 (95% CrI:
    0.0541 to 0.0951), indicating even lower variability in
    participants' response to `percProm2`.

-   **percProm3:** The estimated standard deviation is 0.1068 (95% CrI:
    0.0771 to 0.1451), indicating moderate variability in participants'
    response to `percProm3`, slightly higher than for `percProm2`.

Extract samples in interpretable units. Then, plot them so that we can
see how each participant uses the levels of percProm.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract samples for each participant x percProm
data_prepost_ger %>% 
  data_grid(
    participant = unique(participant),
    percProm = unique(percProm),
    gender_s = 0.09727 # Average over gender
  ) %>% 
  add_epred_draws(mdl_pitch_medianGer) %>% 
  median_qi()

# Plot the draws for all participants x percProm levels
data_prepost_ger %>%
  # Start by selecting unique participants and their gender_s
  select(participant, gender_s) %>%
  distinct() %>%
  # Back-transform gender_s to gender labels
  mutate(
    gender = if_else(gender_s == -0.5, "Male", "Female")
  ) %>%
  # Combine with percProm levels
  crossing(
    percProm = unique(data_prepost_ger$percProm)
  ) %>%
  # Generate posterior predictions
  add_epred_draws(mdl_pitch_medianGer) %>%
  # Summarize predictions with .66 and .95 intervals
  median_qi(.width = c(.66, .95)) %>%
  ggplot(aes(x = .epred, y = participant, color = percProm, shape = gender)) +
  # Add the thick line for 66% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.66),  # Use 66% credible interval
                 size = 1,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add the thin line for 95% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.95),  # Use 95% credible interval
                 size = 0.5,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add points with shapes
  geom_point(position = position_dodge(width = 0.7), size = 2.5) +
  scale_color_manual(values = colorBlindBlack8) +
  labs(
    x = "Posterior f0 median",
    y = "Participant",
    color = "Perceived prominence",
    shape = "Gender"
  ) +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines")
  )
```

First, we extract individual draws. Here, if the CrI encompasses 0, the
participant does not differ from the overall behavior on this percProm.
Then, we plot random effects for each participant and percProm level on
the model scale, representing deviations from the fixed effects.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# We focus on 95% CrI, but this can be adapted in the width parameter
mdl_pitch_medianGer %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95))

# In log without Intercept
mdl_pitch_medianGer %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95, .8, .5)) %>%
  ggplot(aes(y = as.factor(participant), x = r_participant, color = percProm, xmin = .lower, xmax = .upper)) +
  geom_pointinterval(
    position = "dodge") +
  scale_color_manual(
    values = colorBlindBlack8) +
  labs(
    x = "Individual deviations in f0 median",
    y = "Participant",
    color = "Perceived prominence") +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines") 
  )

```

### Amplitude SD

#### Priors

```{r echo=FALSE, message=FALSE, warning=FALSE}
get_prior(
  ampl_sd ~ 0 +
    percProm + 
    gender_s + 
    (0 + percProm | participant),
  data = data_prepost_ger,
  family = lognormal()
)

prior_ampl_sdGer <- c(
  #prior('normal(0, 1)', class = 'Intercept', lb = 0),
  #prior('normal(0, 1)', class = 'b'),  # For intercept
  prior('normal(0, 1)', class = 'b', lb = 0),
  prior('normal(0, 1)', class = 'sd')  # For random effects (participant)
)
```

#### Model

```{r echo=FALSE, message=FALSE, warning=FALSE}
mdl_ampl_sdGer <- brm(ampl_sd ~ 0 +
                        percProm + 
                        gender_s +
                        (0 + percProm | participant),
                      data = data_prepost_ger,
                       family = lognormal(),
                       prior = prior_ampl_sdGer,
                       #backend = "cmdstanr", # depends on you
                       cores = 4,
                       chains = 4,
                       iter = 8000,
                       warmup = 4000,
                       seed = 998,
                       control = list(max_treedepth = 12,
                                      adapt_delta = 0.99),
                       file = paste0(models, "mdl_ampl_sdGer.rds"))

# if we need to compress the model more
#saveRDS(mdl_ampl_sdGer, file = paste0(models, "mdl_ampl_sdGer.rds"), compress = "xz")

mdl_ampl_sdGer <- readRDS(paste0(models, "mdl_ampl_sdGer.rds"))
```

Calculate R².

```{r echo=FALSE, message=FALSE, warning=FALSE}
# # Calculate Bayesian R²
# mdl_ampl_sdGer_R2 <- bayes_R2(mdl_ampl_sdGer)
# # Save the R² output
# saveRDS(mdl_ampl_sdGer_R2, file = paste0(models, "mdl_ampl_sdGer_R2.rds"))

mdl_ampl_sdGer_R2 <- readRDS(paste0(models, "mdl_ampl_sdGer_R2.rds"))

mdl_ampl_sdGer_R2
```

An R² of around 0.53 suggests a **moderate fit**. The model explains
approximately 52.8% of the variance in the dependent variable, meaning
just over half of the variability in `ampl_sdGer` is accounted for by
the predictors. The 95% credible interval shows some uncertainty about
the exact R² value, but it is likely between **49.6% and 55.8%**. This
range indicates that the model's ability to explain the variance is
relatively stable.

#### Fixed effects

Let's check how it looks like.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Summarize the model
summary(mdl_ampl_sdGer)

# Extract fixed effects
exp(fixef(mdl_ampl_sdGer))
```

It shows that ampl_sd falls from 0 to 1 and 1 to 2, but raises from 2 to
3 (surpassing 0).

Diagnostic plots.

```{r echo=FALSE, message=FALSE, warning=FALSE}
plot(mdl_ampl_sdGer)
```

Posterior predictive check.

```{r echo=FALSE, message=FALSE, warning=FALSE}
pp_check(mdl_ampl_sdGer, ndraws = 100)

pp_check(mdl_ampl_sdGer, type = "error_scatter_avg", ndraws = 100)
```

Extract samples.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of fixed effects
samples_mdl_ampl_sdGer <- as_draws_array(mdl_ampl_sdGer, 
                                          variable = "^b_", 
                                          regex = TRUE)
samples_mdl_ampl_sdGer <- mutate_variables(samples_mdl_ampl_sdGer, 
                                                exp_b_percProm0 = exp(b_percProm0), 
                                                exp_b_percProm1 = exp(b_percProm1),
                                                exp_b_percProm2 = exp(b_percProm2),
                                                exp_b_percProm3 = exp(b_percProm3))

# Summarize posterior draws
summarize_draws(samples_mdl_ampl_sdGer)
```

Check conditional effect.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Plot conditional effects (fixed effects only)
conditional_effects(mdl_ampl_sdGer, re_formula = NA)

# Extract conditional effects data
conditional_effects(mdl_ampl_sdGer, plot = FALSE, re_formula = NA)$percProm
```

Compare conditional effects to raw values.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Calculate raw means by percProm level
data_prepost_ger %>% 
  group_by(percProm) %>%
  summarize(avg_ampl_sd = mean(ampl_sd, na.rm = TRUE))

# Summary of ampl_sd
summary(data_prepost_ger$ampl_sd)
```

##### Effect comparison

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Compute estimated marginal means on log-scale
em_mdl_ampl_sdGer <- emmeans(mdl_ampl_sdGer, ~ percProm)
# Backtransform the post.beta values
em_mdl_ampl_sdGer@post.beta <- exp(em_mdl_ampl_sdGer@post.beta)
print(em_mdl_ampl_sdGer)
plot(em_mdl_ampl_sdGer)

# Perform pairwise comparisons between levels of percProm
emPairs_mdl_ampl_sdGer <- pairs(emmeans(mdl_ampl_sdGer, ~ percProm))
# Backtransform the post.beta values
emPairs_mdl_ampl_sdGer@post.beta <- exp(emPairs_mdl_ampl_sdGer@post.beta)
print(emPairs_mdl_ampl_sdGer)
plot(emPairs_mdl_ampl_sdGer)
```

If the comparison includes 0, the contrast is not reliably different.

##### Hypothesis testing

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of the fixed effects coefficients
as_draws_df(mdl_ampl_sdGer) %>%
  # Select fixed effects for percProm levels
  select(starts_with("b_percProm")) %>%
  # Rename columns to match percProm levels
  rename_with(~ str_replace(.x, "b_percProm", "percProm"), starts_with("b_percProm")) %>%
  # Compute differences between percProm levels
  mutate(
    diff_0_1 = exp(percProm0) - exp(percProm1),
    diff_0_2 = exp(percProm0) - exp(percProm2),
    diff_0_3 = exp(percProm0) - exp(percProm3),
    diff_1_2 = exp(percProm1) - exp(percProm2),
    diff_1_3 = exp(percProm1) - exp(percProm3),
    diff_2_3 = exp(percProm2) - exp(percProm3)
  ) %>%
  # Gather differences into long format
  pivot_longer(
    cols = starts_with("diff_"),
    names_to = "Comparison",
    values_to = "Difference"
  ) %>%
  # Group by comparison to compute summary statistics
  group_by(Comparison) %>%
  summarise(
    Estimate = mean(Difference),
    Est.Error = sd(Difference),
    CI.Lower = quantile(Difference, 0.025),
    CI.Upper = quantile(Difference, 0.975),
    Post.Prob = if_else(Estimate > 0,
                        mean(Difference > 0) * 100,
                        mean(Difference < 0) * 100)
  ) %>%
  ungroup() %>%
  # Add significance stars based on posterior probability
  mutate(
    Star = ifelse(Post.Prob > 95 | Post.Prob < 5, "*", ""),
    Estimate = round(Estimate, 3),
    Est.Error = round(Est.Error, 3),
    CI.Lower = round(CI.Lower, 3),
    CI.Upper = round(CI.Upper, 3),
    Post.Prob = round(Post.Prob, 2)
  ) %>%
  # Select and arrange the final columns
  select(Comparison, Estimate, Est.Error, CI.Lower, CI.Upper, Post.Prob, Star) %>%
  arrange(Comparison)
```

-   **`diff_0_1`:** Estimate = 0.121 [-0.277, 0.712], Posterior
    Probability = 68.10%; There is weak evidence that the `ampl_sd` at
    `percProm1` is higher than at `percProm0`. However, the posterior
    probability is relatively low, and the credible interval includes
    zero, suggesting that this difference is not reliable.

-   **`diff_0_2`:** Estimate = 0.050 [-0.419, 0.666], Posterior
    Probability = 54.50%; There is no strong evidence for a difference
    between `percProm0` and `percProm2`. The credible interval spans
    zero, and the posterior probability is low.

-   **`diff_0_3`:** Estimate = -0.045 [-0.686, 0.614], Posterior
    Probability = 57.00%; There is no clear evidence that the `ampl_sd`
    at `percProm0` differs from that at `percProm3`. The posterior
    probability is too low to support a reliable conclusion.

-   **`diff_1_2`:** Estimate = -0.071 [-0.441, 0.252], Posterior
    Probability = 66.20%; There is moderate but weak evidence suggesting
    that the `ampl_sd` at `percProm1` is lower than at `percProm2`, but
    the credible interval includes zero.

-   **`diff_1_3`:** Estimate = -0.166 [-0.738, 0.243], Posterior
    Probability = 74.90%; There is moderate evidence that the `ampl_sd`
    at `percProm1` is lower than at `percProm3`, but this difference is
    not strong enough to be considered conclusive.

-   **`diff_2_3`:** Estimate = -0.095 [-0.639, 0.342], Posterior
    Probability = 63.70%; There is no clear evidence for a difference
    between `percProm2` and `percProm3`, as the credible interval
    includes zero and the posterior probability is moderate.

**Overall Implications:**

-   **Trend:** There is no strong evidence of consistent differences in
    `ampl_sd` across `percProm` levels. Most comparisons show weak or
    inconclusive results, with posterior probabilities below 95%, and
    credible intervals that include zero.

-   **Interpretation:** The comparisons do not provide strong support
    for significant variability in `ampl_sd` across the perceived
    prominence levels, suggesting that changes in `percProm` may not
    have a substantial impact on `ampl_sd`.

##### Plot fixef

Visualize the (non-)linearity of the effect with a violin plot of the
posteriors for each prominence level and a GAMM overlaid on top.

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_ger %>%
  data_grid(percProm = unique(percProm),
            gender_s = 0.09727) %>% # Set to average of gender
  add_epred_draws(mdl_ampl_sdGer, re_formula = NA) %>%
  mutate(
    percProm_num = as.numeric(as.character(percProm)),
    percProm = factor(percProm, levels = c("0", "1", "2", "3"))
  ) %>%
  ggplot(aes(x = percProm_num, y = .epred, color = percProm)) +
  geom_violin(aes(group = percProm_num, fill = percProm), alpha = 0.8) +
  scale_color_manual(values = colorBlindBlack8) +
  scale_fill_manual(values = colorBlindBlack8) +
  stat_summary(fun = median, geom = "point", color = colorBlindBlack8[7], size = 2) +
  geom_smooth(
    aes(group = 1),
    method = "gam",
    formula = y ~ s(x, bs = "cs", k = 4),
    color = colorBlindBlack8[7],
    se = FALSE
  ) +
  scale_x_continuous(
    breaks = 0:3,
    labels = as.character(0:3)
  ) +
  ylim(1, 5) +
  labs(
    x = "Perceived prominence level",
    y = "Posterior amplitude SD"
  ) +
  theme_minimal()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_ger %>%
  data_grid(
    percProm = unique(percProm),
    gender_s = 0.09727  # Set gender_s to zero to average over gender
  ) %>%
  add_epred_draws(mdl_ampl_sdGer, re_formula = NA) %>%
  mutate(
    percProm = factor(percProm, levels = c("0", "1", "2", "3"))
  ) %>%
  ggplot(aes(y = percProm, x = .epred, fill = percProm)) +
  ggdist::stat_halfeye(
    adjust = 0.5,
    width = 0.6,
    .width = c(0.66, 0.95),
    justification = -0.1,
    point_colour = NA
  ) +
  geom_boxplot(
    width = 0.15,
    outlier.shape = NA,
    alpha = 0.5,
    position = position_nudge(y = 0.2)
  ) +
  stat_summary(
    fun = median,
    geom = "point",
    color = "red",
    size = 2,
    position = position_nudge(y = 0.2)
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  coord_flip() +
  theme_minimal() +
  xlim(1, 3.5) +
  labs(
    y = "Perceived prominence level",
    x = "Posterior amplitude SD"
  )
```

#### Group-level effects

First, get a general overview.

```{r echo=FALSE, message=FALSE, warning=FALSE}
as.data.frame(VarCorr(mdl_ampl_sdGer)$participant$sd) %>%
  rownames_to_column(var = "Random Effect") %>%
  select(`Random Effect`, Estimate, Est.Error, Q2.5, Q97.5)
```

-   **percProm0:** The estimated standard deviation of the random
    effects for `percProm0` is 3.650 (95% CrI: 3.167 to 4.229),
    indicating considerable variability in participants' `ampl_sd` at
    this prominence level.

-   **percProm1:** The estimated standard deviation for `percProm1` is
    3.122 (95% CrI: 2.738 to 3.555), suggesting some variability in
    participants' `ampl_sd` at this level, although slightly lower than
    for `percProm0`.

-   **percProm2:** The estimated standard deviation for `percProm2` is
    2.985 (95% CrI: 2.612 to 3.417), indicating moderate variability in
    `ampl_sd` at this prominence level, showing a further decrease
    compared to `percProm1`.

-   **percProm3:** The estimated standard deviation for `percProm3` is
    2.877 (95% CrI: 2.479 to 3.372), suggesting that the variability in
    `ampl_sd` is slightly less than at `percProm2`, but still present
    across participants.

**Overall Interpretation:**

-   **Trend:** There is a gradual decrease in variability in `ampl_sd`
    as the `percProm` levels increase from 0 to 3. This suggests that
    participants' responses in terms of `ampl_sd` become slightly more
    consistent as the perceived prominence level increases.

-   **Implications:** The relatively high standard deviations across all
    levels indicate that participants' responses show substantial
    variability in `ampl_sd`. However, the decrease in variability from
    `percProm0` to `percProm3` suggests that participants may become
    slightly more uniform in their `ampl_sd` responses as prominence
    increases.

Extract samples in interpretable units. Then, plot them so that we can
see how each participant uses the levels of percProm.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract samples for each participant x percProm
data_prepost_ger %>% 
  data_grid(
    participant = unique(participant),
    percProm = unique(percProm),
    gender_s = 0.09727 # Average over gender
  ) %>% 
  add_epred_draws(mdl_ampl_sdGer) %>% 
  median_qi()

# Plot the draws for all participants x percProm levels
data_prepost_ger %>%
  # Start by selecting unique participants and their gender_s
  select(participant, gender_s) %>%
  distinct() %>%
  # Back-transform gender_s to gender labels
  mutate(
    gender = if_else(gender_s == -0.5, "Male", "Female")
  ) %>%
  # Combine with percProm levels
  crossing(
    percProm = unique(data_prepost_ger$percProm)
  ) %>%
  # Generate posterior predictions
  add_epred_draws(mdl_ampl_sdGer) %>%
  # Summarize predictions with .66 and .95 intervals
  median_qi(.width = c(.66, .95)) %>%
  ggplot(aes(x = .epred, y = participant, color = percProm, shape = gender)) +
  # Add the thick line for 66% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.66),  # Use 66% credible interval
                 size = 1,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add the thin line for 95% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.95),  # Use 95% credible interval
                 size = 0.5,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add points with shapes
  geom_point(position = position_dodge(width = 0.7), size = 2.5) +
  scale_color_manual(values = colorBlindBlack8) +
  labs(
    x = "Posterior amplitude SD",
    y = "Participant",
    color = "Perceived prominence",
    shape = "Gender"
  ) +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines")
  )
```

First, we extract individual draws. Here, if the CrI encompasses 0, the
participant does not differ from the overall behavior on this percProm.
Then, we plot random effects for each participant and percProm level on
the model scale, representing deviations from the fixed effects.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# We focus on 95% CrI, but this can be adapted in the width parameter
mdl_ampl_sdGer %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95))

# In log without Intercept
mdl_ampl_sdGer %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95, .8, .5)) %>%
  ggplot(aes(y = as.factor(participant), x = r_participant, color = percProm, xmin = .lower, xmax = .upper)) +
  geom_pointinterval(
    position = "dodge") +
  scale_color_manual(
    values = colorBlindBlack8) +
  labs(
    x = "Individual deviations in amplitude SD",
    y = "Participant",
    color = "Perceived prominence") +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines") 
  )

```

### Amplitude median without silences (post-tonic)

#### Priors

```{r echo=FALSE, message=FALSE, warning=FALSE}
get_prior(
  ampl_noSilence_medianPost ~ 0 +
    percProm + gender_s + 
    (0 + percProm | participant),
  data = data_prepost_ger,
  family = lognormal()
)

prior_ampl_noSilence_medianPostGer <- c(
  #prior('normal(0, 1)', class = 'Intercept', lb = 0),
  #prior('normal(0, 1)', class = 'b'),  # For intercept
  prior('normal(0, 1)', class = 'b', lb = 0),
  prior('normal(0, 1)', class = 'sd')  # For random effects (participant)
)
```

#### Model

```{r echo=FALSE, message=FALSE, warning=FALSE}
mdl_ampl_noSilence_medianPostGer <- brm(ampl_noSilence_medianPost ~ 0 +
                         percProm + gender_s + 
                         (0 + percProm | participant),
                       data = data_prepost_ger,
                       family = lognormal(),
                       prior = prior_ampl_noSilence_medianPostGer,
                       #backend = "cmdstanr", # depends on you
                       cores = 4,
                       chains = 4,
                       iter = 8000,
                       warmup = 4000,
                       seed = 998,
                       control = list(max_treedepth = 12,
                                      adapt_delta = 0.99),
                       file = paste0(models, "mdl_ampl_noSilence_medianPostGer.rds"))

# if we need to compress the model more
#saveRDS(mdl_ampl_noSilence_medianPostGer, file = paste0(models, "mdl_ampl_noSilence_medianPostGer.rds"), compress = "xz")

mdl_ampl_noSilence_medianPostGer <- readRDS(paste0(models, "mdl_ampl_noSilence_medianPostGer.rds"))
```

Calculate R².

```{r echo=FALSE, message=FALSE, warning=FALSE}
# # Calculate Bayesian R²
# mdl_ampl_noSilence_medianPostGer_R2 <- bayes_R2(mdl_ampl_noSilence_medianPostGer)
# # Save the R² output
# saveRDS(mdl_ampl_noSilence_medianPostGer_R2, file = paste0(models, "mdl_ampl_noSilence_medianPostGer_R2.rds"))

mdl_ampl_noSilence_medianPostGer_R2 <- readRDS(paste0(models, "mdl_ampl_noSilence_medianPostGer_R2.rds"))

mdl_ampl_noSilence_medianPostGer_R2
```

An R² of around 0.49 suggests a **moderate fit**. This value means that
the model explains approximately 49.2% of the variance in the dependent
variable. In other words, just under half of the variability in
`ampl_noSilence_medianPost` is accounted for by the predictors in the
model. The 95% credible interval indicates that there is some
uncertainty about the exact R² value, but it is likely between **45.4%
and 52.8%**. This range suggests that the model's ability to explain the
variance is relatively stable.

#### Fixed effects

Let's check how it looks like.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Summarize the model
summary(mdl_ampl_noSilence_medianPostGer)

# Extract fixed effects
exp(fixef(mdl_ampl_noSilence_medianPostGer))
```

It shows that ampl_noSilence_medianPost falls from 0 to 1 and 1 to 2,
but raises from 2 to 3 (surpassing 0).

Diagnostic plots.

```{r echo=FALSE, message=FALSE, warning=FALSE}
plot(mdl_ampl_noSilence_medianPostGer)
```

Posterior predictive check.

```{r echo=FALSE, message=FALSE, warning=FALSE}
pp_check(mdl_ampl_noSilence_medianPostGer, ndraws = 100)

pp_check(mdl_ampl_noSilence_medianPostGer, type = "error_scatter_avg", ndraws = 100)
```

Extract samples.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of fixed effects
samples_mdl_ampl_noSilence_medianPostGer <- as_draws_array(mdl_ampl_noSilence_medianPostGer, 
                                          variable = "^b_", 
                                          regex = TRUE)
samples_mdl_ampl_noSilence_medianPostGer <- mutate_variables(samples_mdl_ampl_noSilence_medianPostGer, 
                                                exp_b_percProm0 = exp(b_percProm0), 
                                                exp_b_percProm1 = exp(b_percProm1),
                                                exp_b_percProm2 = exp(b_percProm2),
                                                exp_b_percProm3 = exp(b_percProm3))

# Summarize posterior draws
summarize_draws(samples_mdl_ampl_noSilence_medianPostGer)
```

Check conditional effect.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Plot conditional effects (fixed effects only)
conditional_effects(mdl_ampl_noSilence_medianPostGer, re_formula = NA)

# Extract conditional effects data
conditional_effects(mdl_ampl_noSilence_medianPostGer, plot = FALSE, re_formula = NA)$percProm
```

Compare conditional effects to raw values.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Calculate raw means by percProm level
data_prepost_ger %>% 
  group_by(percProm) %>%
  summarize(avg_ampl_noSilence_medianPost = mean(ampl_noSilence_medianPost, na.rm = TRUE))

# Summary of ampl_noSilence_medianPost
summary(data_prepost_ger$ampl_noSilence_medianPost)
```

##### Effect comparison

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Compute estimated marginal means on log-scale
em_mdl_ampl_noSilence_medianPostGer <- emmeans(mdl_ampl_noSilence_medianPostGer, ~ percProm)
# Backtransform the post.beta values
em_mdl_ampl_noSilence_medianPostGer@post.beta <- exp(em_mdl_ampl_noSilence_medianPostGer@post.beta)
print(em_mdl_ampl_noSilence_medianPostGer)
plot(em_mdl_ampl_noSilence_medianPostGer)

# Perform pairwise comparisons between levels of percProm
emPairs_mdl_ampl_noSilence_medianPostGer <- pairs(emmeans(mdl_ampl_noSilence_medianPostGer, ~ percProm))
# Backtransform the post.beta values
emPairs_mdl_ampl_noSilence_medianPostGer@post.beta <- exp(emPairs_mdl_ampl_noSilence_medianPostGer@post.beta)
print(emPairs_mdl_ampl_noSilence_medianPostGer)
plot(emPairs_mdl_ampl_noSilence_medianPostGer)
```

If the comparison includes 0, the contrast is not reliably different.

##### Hypothesis testing

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of the fixed effects coefficients
as_draws_df(mdl_ampl_noSilence_medianPostGer) %>%
  # Select fixed effects for percProm levels
  select(starts_with("b_percProm")) %>%
  # Rename columns to match percProm levels
  rename_with(~ str_replace(.x, "b_percProm", "percProm"), starts_with("b_percProm")) %>%
  # Compute differences between percProm levels
  mutate(
    diff_0_1 = exp(percProm0) - exp(percProm1),
    diff_0_2 = exp(percProm0) - exp(percProm2),
    diff_0_3 = exp(percProm0) - exp(percProm3),
    diff_1_2 = exp(percProm1) - exp(percProm2),
    diff_1_3 = exp(percProm1) - exp(percProm3),
    diff_2_3 = exp(percProm2) - exp(percProm3)
  ) %>%
  # Gather differences into long format
  pivot_longer(
    cols = starts_with("diff_"),
    names_to = "Comparison",
    values_to = "Difference"
  ) %>%
  # Group by comparison to compute summary statistics
  group_by(Comparison) %>%
  summarise(
    Estimate = mean(Difference),
    Est.Error = sd(Difference),
    CI.Lower = quantile(Difference, 0.025),
    CI.Upper = quantile(Difference, 0.975),
    Post.Prob = if_else(Estimate > 0,
                        mean(Difference > 0) * 100,
                        mean(Difference < 0) * 100)
  ) %>%
  ungroup() %>%
  # Add significance stars based on posterior probability
  mutate(
    Star = ifelse(Post.Prob > 95 | Post.Prob < 5, "*", ""),
    Estimate = round(Estimate, 3),
    Est.Error = round(Est.Error, 3),
    CI.Lower = round(CI.Lower, 3),
    CI.Upper = round(CI.Upper, 3),
    Post.Prob = round(Post.Prob, 2)
  ) %>%
  # Select and arrange the final columns
  select(Comparison, Estimate, Est.Error, CI.Lower, CI.Upper, Post.Prob, Star) %>%
  arrange(Comparison)
```

-   **`diff_0_1`:** Estimate = 0.082 [-0.287, 0.589], Posterior
    Probability = 64.2%; There is weak evidence that the
    `ampl_noSilence_medianPost` at `percProm1` is higher than at
    `percProm0`. The credible interval includes zero, and the posterior
    probability is below 95%, so this difference is not considered
    reliable.

-   **`diff_0_2`:** Estimate = 0.015 [-0.459, 0.559], Posterior
    Probability = 50.8%; There is no strong evidence for a difference
    between `percProm0` and `percProm2`, with the posterior probability
    close to chance.

-   **`diff_0_3`:** Estimate = -0.103 [-0.706, 0.481], Posterior
    Probability = 64.8%; There is weak evidence that the
    `ampl_noSilence_medianPost` at `percProm3` is lower than at
    `percProm0`. However, the credible interval includes zero, making
    the difference unreliable.

-   **`diff_1_2`:** Estimate = -0.067 [-0.481, 0.282], Posterior
    Probability = 64.6%; There is weak evidence that
    `ampl_noSilence_medianPost` decreases slightly from `percProm1` to
    `percProm2`, but the result is not conclusive due to the wide
    credible interval.

-   **`diff_1_3`:** Estimate = -0.185 [-0.747, 0.233], Posterior
    Probability = 77.8%; There is moderate evidence that
    `ampl_noSilence_medianPost` decreases from `percProm1` to
    `percProm3`. However, since the credible interval includes zero, the
    evidence remains inconclusive.

-   **`diff_2_3`:** Estimate = -0.119 [-0.649, 0.336], Posterior
    Probability = 68.1%; There is weak evidence that the
    `ampl_noSilence_medianPost` decreases slightly from `percProm2` to
    `percProm3`, but the result is not reliable due to the wide credible
    interval.

**Overall Implications:**

-   **Trend:** There is no strong or consistent evidence of significant
    differences between `percProm` levels for the variable
    `ampl_noSilence_medianPost`. The posterior probabilities and wide
    credible intervals suggest that any potential differences are
    uncertain and should be interpreted with caution.

##### Plot fixef

Visualize the (non-)linearity of the effect with a violin plot of the
posteriors for each prominence level and a GAMM overlaid on top.

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_ger %>%
  data_grid(percProm = unique(percProm),
            gender_s = 0.09727) %>% # Set to average of gender
  add_epred_draws(mdl_ampl_noSilence_medianPostGer, re_formula = NA) %>%
  mutate(
    percProm_num = as.numeric(as.character(percProm)),
    percProm = factor(percProm, levels = c("0", "1", "2", "3"))
  ) %>%
  ggplot(aes(x = percProm_num, y = .epred, color = percProm)) +
  geom_violin(aes(group = percProm_num, fill = percProm), alpha = 0.8) +
  scale_color_manual(values = colorBlindBlack8) +
  scale_fill_manual(values = colorBlindBlack8) +
  stat_summary(fun = median, geom = "point", color = colorBlindBlack8[7], size = 2) +
  geom_smooth(
    aes(group = 1),
    method = "gam",
    formula = y ~ s(x, bs = "cs", k = 4),
    color = colorBlindBlack8[7],
    se = FALSE
  ) +
  scale_x_continuous(
    breaks = 0:3,
    labels = as.character(0:3)
  ) +
  ylim(1, 5) +
  labs(
    x = "Perceived prominence level",
    y = "Posterior amplitude median (no silences, post-tonic)"
  ) +
  theme_minimal()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_ger %>%
  data_grid(
    percProm = unique(percProm),
    gender_s = 0.09727  # Set gender_s to zero to average over gender
  ) %>%
  add_epred_draws(mdl_ampl_noSilence_medianPostGer, re_formula = NA) %>%
  mutate(
    percProm = factor(percProm, levels = c("0", "1", "2", "3"))
  ) %>%
  ggplot(aes(y = percProm, x = .epred, fill = percProm)) +
  ggdist::stat_halfeye(
    adjust = 0.5,
    width = 0.6,
    .width = c(0.66, 0.95),
    justification = -0.1,
    point_colour = NA
  ) +
  geom_boxplot(
    width = 0.15,
    outlier.shape = NA,
    alpha = 0.5,
    position = position_nudge(y = 0.2)
  ) +
  stat_summary(
    fun = median,
    geom = "point",
    color = "red",
    size = 2,
    position = position_nudge(y = 0.2)
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  coord_flip() +
  theme_minimal() +
  xlim(1, 3.5) +
  labs(
    y = "Perceived prominence level",
    x = "Posterior amplitude median (no silences, post-tonic)"
  )
```

#### Group-level effects

First, get a general overview.

```{r echo=FALSE, message=FALSE, warning=FALSE}
as.data.frame(VarCorr(mdl_ampl_noSilence_medianPostGer)$participant$sd) %>%
  rownames_to_column(var = "Random Effect") %>%
  select(`Random Effect`, Estimate, Est.Error, Q2.5, Q97.5)
```

-   **percProm0:** The estimated standard deviation of the random
    intercepts for `percProm0` is 3.36 (95% CrI: 2.88 to 3.93),
    indicating a high level of variability in participants' baseline
    `ampl_noSilence_medianPost` at this level.

-   **percProm1:** The estimated standard deviation for `percProm1` is
    2.91 (95% CrI: 2.53 to 3.35), showing moderate variability in
    participants' response to `percProm1`. The range of uncertainty
    suggests that this variability is stable across participants.

-   **percProm2:** The estimated standard deviation for `percProm2` is
    2.65 (95% CrI: 2.29 to 3.09), indicating that participants'
    responses to `percProm2` are less variable compared to `percProm0`
    and `percProm1`.

-   **percProm3:** The estimated standard deviation for `percProm3` is
    2.57 (95% CrI: 2.18 to 3.07), suggesting a similar degree of
    variability as `percProm2`, with slightly lower variability compared
    to the other `percProm` levels.

Extract samples in interpretable units. Then, plot them so that we can
see how each participant uses the levels of percProm.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract samples for each participant x percProm
data_prepost_ger %>% 
  data_grid(
    participant = unique(participant),
    percProm = unique(percProm),
    gender_s = 0.09727 # Average over gender
  ) %>% 
  add_epred_draws(mdl_ampl_noSilence_medianPostGer) %>% 
  median_qi()

# Plot the draws for all participants x percProm levels
data_prepost_ger %>%
  # Start by selecting unique participants and their gender_s
  select(participant, gender_s) %>%
  distinct() %>%
  # Back-transform gender_s to gender labels
  mutate(
    gender = if_else(gender_s == -0.5, "Male", "Female")
  ) %>%
  # Combine with percProm levels
  crossing(
    percProm = unique(data_prepost_ger$percProm)
  ) %>%
  # Generate posterior predictions
  add_epred_draws(mdl_ampl_noSilence_medianPostGer) %>%
  # Summarize predictions with .66 and .95 intervals
  median_qi(.width = c(.66, .95)) %>%
  ggplot(aes(x = .epred, y = participant, color = percProm, shape = gender)) +
  # Add the thick line for 66% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.66),  # Use 66% credible interval
                 size = 1,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add the thin line for 95% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.95),  # Use 95% credible interval
                 size = 0.5,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add points with shapes
  geom_point(position = position_dodge(width = 0.7), size = 2.5) +
  scale_color_manual(values = colorBlindBlack8) +
  labs(
    x = "Posterior amplitude median (no silences, post-tonic)",
    y = "Participant",
    color = "Perceived prominence",
    shape = "Gender"
  ) +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines")
  )
```

First, we extract individual draws. Here, if the CrI encompasses 0, the
participant does not differ from the overall behavior on this percProm.
Then, we plot random effects for each participant and percProm level on
the model scale, representing deviations from the fixed effects.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# We focus on 95% CrI, but this can be adapted in the width parameter
mdl_ampl_noSilence_medianPostGer %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95))

# In log without Intercept
mdl_ampl_noSilence_medianPostGer %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95, .8, .5)) %>%
  ggplot(aes(y = as.factor(participant), x = r_participant, color = percProm, xmin = .lower, xmax = .upper)) +
  geom_pointinterval(
    position = "dodge") +
  scale_color_manual(
    values = colorBlindBlack8) +
  labs(
    x = "Individual deviations amplitude median (no silences, post-tonic)",
    y = "Participant",
    color = "Perceived prominence") +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines") 
  )

```

### Amplitude median without silences

#### Priors

```{r echo=FALSE, message=FALSE, warning=FALSE}
get_prior(
  ampl_noSilence_median ~ 0 +
    percProm + gender_s + 
    (0 + percProm | participant),
  data = data_prepost_ger,
  family = lognormal()
)

prior_ampl_noSilence_medianGer <- c(
  #prior('normal(0, 1)', class = 'Intercept', lb = 0),
  #prior('normal(0, 1)', class = 'b'),  # For intercept
  prior('normal(0, 1)', class = 'b', lb = 0),
  prior('normal(0, 1)', class = 'sd')  # For random effects (participant)
)
```

#### Model

```{r echo=FALSE, message=FALSE, warning=FALSE}
mdl_ampl_noSilence_medianGer <- brm(ampl_noSilence_median ~ 0 +
                         percProm + gender_s + 
                         (0 + percProm | participant),
                       data = data_prepost_ger,
                       family = lognormal(),
                       prior = prior_ampl_noSilence_medianGer,
                       #backend = "cmdstanr", # depends on you
                       cores = 4,
                       chains = 4,
                       iter = 8000,
                       warmup = 4000,
                       seed = 998,
                       control = list(max_treedepth = 12,
                                      adapt_delta = 0.99),
                       file = paste0(models, "mdl_ampl_noSilence_medianGer.rds"))

# if we need to compress the model more
#saveRDS(mdl_ampl_noSilence_medianGer, file = paste0(models, "mdl_ampl_noSilence_medianGer.rds"), compress = "xz")

mdl_ampl_noSilence_medianGer <- readRDS(paste0(models, "mdl_ampl_noSilence_medianGer.rds"))
```

Calculate R².

```{r echo=FALSE, message=FALSE, warning=FALSE}
# # Calculate Bayesian R²
# mdl_ampl_noSilence_medianGer_R2 <- bayes_R2(mdl_ampl_noSilence_medianGer)
# # Save the R² output
# saveRDS(mdl_ampl_noSilence_medianGer_R2, file = paste0(models, "mdl_ampl_noSilence_medianGer_R2.rds"))

mdl_ampl_noSilence_medianGer_R2 <- readRDS(paste0(models, "mdl_ampl_noSilence_medianGer_R2.rds"))

mdl_ampl_noSilence_medianGer_R2
```

An R² of approximately 0.53 indicates a **moderate fit**, meaning that
the model explains about 53.3% of the variance in the dependent
variable, `ampl_noSilence_medianGer`. In other words, just over half of
the variability in `ampl_noSilence_medianGer` is accounted for by the
model’s predictors. The 95% credible interval, ranging from **50.1% to
56.4%**, suggests that the model's explanatory power is relatively
stable, with some uncertainty around the exact value. This indicates a
solid but not overwhelming predictive performance.

#### Fixed effects

Let's check how it looks like.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Summarize the model
summary(mdl_ampl_noSilence_medianGer)

# Extract fixed effects
exp(fixef(mdl_ampl_noSilence_medianGer))
```

It shows that ampl_noSilence_median falls from 0 to 1 and 1 to 2, but
raises from 2 to 3 (surpassing 0).

Diagnostic plots.

```{r echo=FALSE, message=FALSE, warning=FALSE}
plot(mdl_ampl_noSilence_medianGer)
```

Posterior predictive check.

```{r echo=FALSE, message=FALSE, warning=FALSE}
pp_check(mdl_ampl_noSilence_medianGer, ndraws = 100)

pp_check(mdl_ampl_noSilence_medianGer, type = "error_scatter_avg", ndraws = 100)
```

Extract samples.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of fixed effects
samples_mdl_ampl_noSilence_medianGer <- as_draws_array(mdl_ampl_noSilence_medianGer, 
                                          variable = "^b_", 
                                          regex = TRUE)
samples_mdl_ampl_noSilence_medianGer <- mutate_variables(samples_mdl_ampl_noSilence_medianGer, 
                                                exp_b_percProm0 = exp(b_percProm0), 
                                                exp_b_percProm1 = exp(b_percProm1),
                                                exp_b_percProm2 = exp(b_percProm2),
                                                exp_b_percProm3 = exp(b_percProm3))

# Summarize posterior draws
summarize_draws(samples_mdl_ampl_noSilence_medianGer)
```

Check conditional effect.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Plot conditional effects (fixed effects only)
conditional_effects(mdl_ampl_noSilence_medianGer, re_formula = NA)

# Extract conditional effects data
conditional_effects(mdl_ampl_noSilence_medianGer, plot = FALSE, re_formula = NA)$percProm
```

Compare conditional effects to raw values.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Calculate raw means by percProm level
data_prepost_ger %>% 
  group_by(percProm) %>%
  summarize(avg_ampl_noSilence_median = mean(ampl_noSilence_median, na.rm = TRUE))

# Summary of ampl_noSilence_median
summary(data_prepost_ger$ampl_noSilence_median)
```

##### Effect comparison

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Compute estimated marginal means on log-scale
em_mdl_ampl_noSilence_medianGer <- emmeans(mdl_ampl_noSilence_medianGer, ~ percProm)
# Backtransform the post.beta values
em_mdl_ampl_noSilence_medianGer@post.beta <- exp(em_mdl_ampl_noSilence_medianGer@post.beta)
print(em_mdl_ampl_noSilence_medianGer)
plot(em_mdl_ampl_noSilence_medianGer)

# Perform pairwise comparisons between levels of percProm
emPairs_mdl_ampl_noSilence_medianGer <- pairs(emmeans(mdl_ampl_noSilence_medianGer, ~ percProm))
# Backtransform the post.beta values
emPairs_mdl_ampl_noSilence_medianGer@post.beta <- exp(emPairs_mdl_ampl_noSilence_medianGer@post.beta)
print(emPairs_mdl_ampl_noSilence_medianGer)
plot(emPairs_mdl_ampl_noSilence_medianGer)
```

If the comparison includes 0, the contrast is not reliably different.

##### Hypothesis testing

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of the fixed effects coefficients
as_draws_df(mdl_ampl_noSilence_medianGer) %>%
  # Select fixed effects for percProm levels
  select(starts_with("b_percProm")) %>%
  # Rename columns to match percProm levels
  rename_with(~ str_replace(.x, "b_percProm", "percProm"), starts_with("b_percProm")) %>%
  # Compute differences between percProm levels
  mutate(
    diff_0_1 = exp(percProm0) - exp(percProm1),
    diff_0_2 = exp(percProm0) - exp(percProm2),
    diff_0_3 = exp(percProm0) - exp(percProm3),
    diff_1_2 = exp(percProm1) - exp(percProm2),
    diff_1_3 = exp(percProm1) - exp(percProm3),
    diff_2_3 = exp(percProm2) - exp(percProm3)
  ) %>%
  # Gather differences into long format
  pivot_longer(
    cols = starts_with("diff_"),
    names_to = "Comparison",
    values_to = "Difference"
  ) %>%
  # Group by comparison to compute summary statistics
  group_by(Comparison) %>%
  summarise(
    Estimate = mean(Difference),
    Est.Error = sd(Difference),
    CI.Lower = quantile(Difference, 0.025),
    CI.Upper = quantile(Difference, 0.975),
    Post.Prob = if_else(Estimate > 0,
                        mean(Difference > 0) * 100,
                        mean(Difference < 0) * 100)
  ) %>%
  ungroup() %>%
  # Add significance stars based on posterior probability
  mutate(
    Star = ifelse(Post.Prob > 95 | Post.Prob < 5, "*", ""),
    Estimate = round(Estimate, 3),
    Est.Error = round(Est.Error, 3),
    CI.Lower = round(CI.Lower, 3),
    CI.Upper = round(CI.Upper, 3),
    Post.Prob = round(Post.Prob, 2)
  ) %>%
  # Select and arrange the final columns
  select(Comparison, Estimate, Est.Error, CI.Lower, CI.Upper, Post.Prob, Star) %>%
  arrange(Comparison)
```

-   **`diff_0_1`:** Estimate = 0.10 [-0.222, 0.598], Posterior
    Probability = 67.4%; There is weak evidence that
    `ampl_noSilence_medianGer` at `percProm1` is higher than at
    `percProm0`. The credible interval includes zero, and the posterior
    probability is low, suggesting this difference is not reliable.

-   **`diff_0_2`:** Estimate = 0.01 [-0.421, 0.534], Posterior
    Probability = 48.9%; There is no strong evidence for a difference
    between `percProm0` and `percProm2`, with the estimate very close to
    zero and the posterior probability reflecting uncertainty.

-   **`diff_0_3`:** Estimate = -0.119 [-0.682, 0.462], Posterior
    Probability = 68.3%; There is weak evidence that
    `ampl_noSilence_medianGer` at `percProm3` is higher than at
    `percProm0`, but the difference is not statistically significant, as
    the credible interval includes zero.

-   **`diff_1_2`:** Estimate = -0.091 [-0.445, 0.192], Posterior
    Probability = 71.8%; There is weak evidence of a decrease in
    `ampl_noSilence_medianGer` from `percProm1` to `percProm2`, but the
    interval includes zero, and the posterior probability does not reach
    a conclusive level.

-   **`diff_1_3`:** Estimate = -0.219 [-0.714, 0.15], Posterior
    Probability = 84.8%; There is moderate evidence that
    `ampl_noSilence_medianGer` at `percProm1` is lower than at
    `percProm3`, but the evidence is not strong enough to be reliable.

-   **`diff_2_3`:** Estimate = -0.128 [-0.615, 0.292], Posterior
    Probability = 70.6%; Weak evidence suggests that
    `ampl_noSilence_medianGer` increase from `percProm2` to `percProm3`,
    though this difference is not significant as the interval includes
    zero.

**Overall Interpretation:**

-   **Trend:** There is weak to moderate evidence of differences between
    prominence levels in `ampl_noSilence_medianGer`, but none of the
    comparisons reach a high level of statistical significance
    (posterior probability \> 95%).

-   **Interpretation:** While some trends suggest a decrease in
    `ampl_noSilence_medianGer` as `percProm` increases, the differences
    are not strong enough to draw reliable conclusions from these data.

##### Plot fixef

Visualize the (non-)linearity of the effect with a violin plot of the
posteriors for each prominence level and a GAMM overlaid on top.

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_ger %>%
  data_grid(percProm = unique(percProm),
            gender_s = 0.09727) %>% # Set to average of gender
  add_epred_draws(mdl_ampl_noSilence_medianGer, re_formula = NA) %>%
  mutate(
    percProm_num = as.numeric(as.character(percProm)),
    percProm = factor(percProm, levels = c("0", "1", "2", "3"))
  ) %>%
  ggplot(aes(x = percProm_num, y = .epred, color = percProm)) +
  geom_violin(aes(group = percProm_num, fill = percProm), alpha = 0.8) +
  scale_color_manual(values = colorBlindBlack8) +
  scale_fill_manual(values = colorBlindBlack8) +
  stat_summary(fun = median, geom = "point", color = colorBlindBlack8[7], size = 2) +
  geom_smooth(
    aes(group = 1),
    method = "gam",
    formula = y ~ s(x, bs = "cs", k = 4),
    color = colorBlindBlack8[7],
    se = FALSE
  ) +
  scale_x_continuous(
    breaks = 0:3,
    labels = as.character(0:3)
  ) +
  ylim(1, 5) +
  labs(
    x = "Perceived prominence level",
    y = "Posterior amplitude median (no silences)"
  ) +
  theme_minimal()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_ger %>%
  data_grid(
    percProm = unique(percProm),
    gender_s = 0.09727  # Set gender_s to zero to average over gender
  ) %>%
  add_epred_draws(mdl_ampl_noSilence_medianGer, re_formula = NA) %>%
  mutate(
    percProm = factor(percProm, levels = c("0", "1", "2", "3"))
  ) %>%
  ggplot(aes(y = percProm, x = .epred, fill = percProm)) +
  ggdist::stat_halfeye(
    adjust = 0.5,
    width = 0.6,
    .width = c(0.66, 0.95),
    justification = -0.1,
    point_colour = NA
  ) +
  geom_boxplot(
    width = 0.15,
    outlier.shape = NA,
    alpha = 0.5,
    position = position_nudge(y = 0.2)
  ) +
  stat_summary(
    fun = median,
    geom = "point",
    color = "red",
    size = 2,
    position = position_nudge(y = 0.2)
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  coord_flip() +
  theme_minimal() +
  xlim(1, 3.5) +
  labs(
    y = "Perceived prominence level",
    x = "Posterior amplitude median (no silences)"
  )
```

#### Group-level effects

First, get a general overview.

```{r echo=FALSE, message=FALSE, warning=FALSE}
as.data.frame(VarCorr(mdl_ampl_noSilence_medianGer)$participant$sd) %>%
  rownames_to_column(var = "Random Effect") %>%
  select(`Random Effect`, Estimate, Est.Error, Q2.5, Q97.5)
```

-   **percProm0:** The estimated standard deviation of the random
    effects for `percProm0` is 3.23 (95% CrI: 2.77 to 3.78), indicating
    substantial variability between participants at the lowest
    prominence level.

-   **percProm1:** The estimated standard deviation for `percProm1` is
    2.73 (95% CrI: 2.38 to 3.15), suggesting notable variability in
    participants' responses to `percProm1`. The variability is slightly
    lower than at `percProm0`.

-   **percProm2:** The estimated standard deviation for `percProm2` is
    2.63 (95% CrI: 2.27 to 3.06), indicating some decrease in
    variability compared to `percProm1`.

-   **percProm3:** The estimated standard deviation for `percProm3` is
    2.51 (95% CrI: 2.13 to 2.98), suggesting that variability in
    participants' responses to `percProm3` is the lowest among all
    prominence levels, but still substantial.

**Implication:** The variability in responses across participants
decreases as the perceived prominence level (`percProm`) increases from
`percProm0` to `percProm3`. However, there is still considerable
individual variability at all levels, particularly at the lower levels
of prominence.

Extract samples in interpretable units. Then, plot them so that we can
see how each participant uses the levels of percProm.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract samples for each participant x percProm
data_prepost_ger %>% 
  data_grid(
    participant = unique(participant),
    percProm = unique(percProm),
    gender_s = 0.09727 # Average over gender
  ) %>% 
  add_epred_draws(mdl_ampl_noSilence_medianGer) %>% 
  median_qi()

# Plot the draws for all participants x percProm levels
data_prepost_ger %>%
  # Start by selecting unique participants and their gender_s
  select(participant, gender_s) %>%
  distinct() %>%
  # Back-transform gender_s to gender labels
  mutate(
    gender = if_else(gender_s == -0.5, "Male", "Female")
  ) %>%
  # Combine with percProm levels
  crossing(
    percProm = unique(data_prepost_ger$percProm)
  ) %>%
  # Generate posterior predictions
  add_epred_draws(mdl_ampl_noSilence_medianGer) %>%
  # Summarize predictions with .66 and .95 intervals
  median_qi(.width = c(.66, .95)) %>%
  ggplot(aes(x = .epred, y = participant, color = percProm, shape = gender)) +
  # Add the thick line for 66% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.66),  # Use 66% credible interval
                 size = 1,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add the thin line for 95% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.95),  # Use 95% credible interval
                 size = 0.5,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add points with shapes
  geom_point(position = position_dodge(width = 0.7), size = 2.5) +
  scale_color_manual(values = colorBlindBlack8) +
  labs(
    x = "Posterior amplitude median (no silences)",
    y = "Participant",
    color = "Perceived prominence",
    shape = "Gender"
  ) +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines")
  )
```

First, we extract individual draws. Here, if the CrI encompasses 0, the
participant does not differ from the overall behavior on this percProm.
Then, we plot random effects for each participant and percProm level on
the model scale, representing deviations from the fixed effects.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# We focus on 95% CrI, but this can be adapted in the width parameter
mdl_ampl_noSilence_medianGer %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95))

# In log without Intercept
mdl_ampl_noSilence_medianGer %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95, .8, .5)) %>%
  ggplot(aes(y = as.factor(participant), x = r_participant, color = percProm, xmin = .lower, xmax = .upper)) +
  geom_pointinterval(
    position = "dodge") +
  scale_color_manual(
    values = colorBlindBlack8) +
  labs(
    x = "Individual deviations in amplitude median (no silences)",
    y = "Participant",
    color = "Perceived prominence") +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines") 
  )

```

### Duration

#### Priors

```{r echo=FALSE, message=FALSE, warning=FALSE}
get_prior(
  duration ~ 0 +
    percProm + gender_s + 
    (0 + percProm | participant),
  data = data_prepost_ger,
  family = lognormal()
)

prior_durationGer <- c(
  #prior('normal(0, 10)', class = 'Intercept', lb = 0),
  #prior('normal(0, 5)', class = 'b'),
  prior('normal(0, 10)', class = 'b', lb = 0),
  prior('normal(0, 5)', class = 'sd') 
)
```

#### Model

```{r echo=FALSE, message=FALSE, warning=FALSE}
mdl_durationGer <- brm(duration ~ 0 +
                         percProm + gender_s + 
                         (0 + percProm | participant),
                       data = data_prepost_ger,
                       family = lognormal(),
                       prior = prior_durationGer,
                       #backend = "cmdstanr", # depends on you
                       cores = 4,
                       chains = 4,
                       iter = 8000,
                       warmup = 4000,
                       seed = 998,
                       control = list(max_treedepth = 12,
                                      adapt_delta = 0.99),
                       file = paste0(models, "mdl_durationGer.rds"))

# if we need to compress the model more
#saveRDS(mdl_durationGer, file = paste0(models, "mdl_durationGer.rds"), compress = "xz")

mdl_durationGer <- readRDS(paste0(models, "mdl_durationGer.rds"))
```

Calculate R².

```{r echo=FALSE, message=FALSE, warning=FALSE}
# # Calculate Bayesian R²
# mdl_durationGer_R2 <- bayes_R2(mdl_durationGer)
# # Save the R² output
# saveRDS(mdl_durationGer_R2, file = paste0(models, "mdl_durationGer_R2.rds"))

mdl_durationGer_R2 <- readRDS(paste0(models, "mdl_durationGer_R2.rds"))

mdl_durationGer_R2
```

An R² of approximately 0.25 suggests a **modest fit**. This value
indicates that the model explains about 25.4% of the variance in the
dependent variable `duration`. In other words, a quarter of the
variability in `duration` is accounted for by the predictors in the
model. The 95% credible interval, ranging from **22.2% to 28.7%**, shows
that there is some uncertainty around this estimate, but it provides a
stable indication of the model's explanatory power.

#### Fixed effects

Let's check how it looks like.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Summarize the model
summary(mdl_durationGer)

# Extract fixed effects
exp(fixef(mdl_durationGer))
```

It shows a stable increase from 0 to 3.

Diagnostic plots.

```{r echo=FALSE, message=FALSE, warning=FALSE}
plot(mdl_durationGer)
```

Posterior predictive check.

```{r echo=FALSE, message=FALSE, warning=FALSE}
pp_check(mdl_durationGer, ndraws = 100)

pp_check(mdl_durationGer, type = "error_scatter_avg", ndraws = 100)
```

Extract samples.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of fixed effects
samples_mdl_durationGer <- as_draws_array(mdl_durationGer, 
                                          variable = "^b_", 
                                          regex = TRUE)
samples_mdl_durationGer <- mutate_variables(samples_mdl_durationGer, 
                                                exp_b_percProm0 = exp(b_percProm0), 
                                                exp_b_percProm1 = exp(b_percProm1),
                                                exp_b_percProm2 = exp(b_percProm2),
                                                exp_b_percProm3 = exp(b_percProm3))

# Summarize posterior draws
summarize_draws(samples_mdl_durationGer)
```

Check conditional effect.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Plot conditional effects (fixed effects only)
conditional_effects(mdl_durationGer, re_formula = NA)

# Extract conditional effects data
conditional_effects(mdl_durationGer, plot = FALSE, re_formula = NA)$percProm
```

Compare conditional effects to raw values.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Calculate raw means by percProm level
data_prepost_ger %>% 
  group_by(percProm) %>%
  summarize(avg_duration = mean(duration, na.rm = TRUE))

# Summary of duration
summary(data_prepost_ger$duration)
```

##### Effect comparison

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Compute estimated marginal means on log-scale
em_mdl_durationGer <- emmeans(mdl_durationGer, ~ percProm)
# Backtransform the post.beta values
em_mdl_durationGer@post.beta <- exp(em_mdl_durationGer@post.beta)
print(em_mdl_durationGer)
plot(em_mdl_durationGer)

# Perform pairwise comparisons between levels of percProm
emPairs_mdl_durationGer <- pairs(emmeans(mdl_durationGer, ~ percProm))
# Backtransform the post.beta values
emPairs_mdl_durationGer@post.beta <- exp(emPairs_mdl_durationGer@post.beta)
print(emPairs_mdl_durationGer)
plot(emPairs_mdl_durationGer)
```

If the comparison includes 0, the contrast is not reliably different.

##### Hypothesis testing

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of the fixed effects coefficients
as_draws_df(mdl_durationGer) %>%
  # Select fixed effects for percProm levels
  select(starts_with("b_percProm")) %>%
  # Rename columns to match percProm levels
  rename_with(~ str_replace(.x, "b_percProm", "percProm"), starts_with("b_percProm")) %>%
  # Compute differences between percProm levels
  mutate(
    diff_0_1 = exp(percProm0) - exp(percProm1),
    diff_0_2 = exp(percProm0) - exp(percProm2),
    diff_0_3 = exp(percProm0) - exp(percProm3),
    diff_1_2 = exp(percProm1) - exp(percProm2),
    diff_1_3 = exp(percProm1) - exp(percProm3),
    diff_2_3 = exp(percProm2) - exp(percProm3)
  ) %>%
  # Gather differences into long format
  pivot_longer(
    cols = starts_with("diff_"),
    names_to = "Comparison",
    values_to = "Difference"
  ) %>%
  # Group by comparison to compute summary statistics
  group_by(Comparison) %>%
  summarise(
    Estimate = mean(Difference),
    Est.Error = sd(Difference),
    CI.Lower = quantile(Difference, 0.025),
    CI.Upper = quantile(Difference, 0.975),
    Post.Prob = if_else(Estimate > 0,
                        mean(Difference > 0) * 100,
                        mean(Difference < 0) * 100)
  ) %>%
  ungroup() %>%
  # Add significance stars based on posterior probability
  mutate(
    Star = ifelse(Post.Prob > 95 | Post.Prob < 5, "*", ""),
    Estimate = round(Estimate, 3),
    Est.Error = round(Est.Error, 3),
    CI.Lower = round(CI.Lower, 3),
    CI.Upper = round(CI.Upper, 3),
    Post.Prob = round(Post.Prob, 2)
  ) %>%
  # Select and arrange the final columns
  select(Comparison, Estimate, Est.Error, CI.Lower, CI.Upper, Post.Prob, Star) %>%
  arrange(Comparison)
```

-   **`diff_0_1`:** Estimate = -0.108 [-0.217, 0.003], Posterior
    Probability = 97.3%; There is strong evidence that the `duration` at
    `percProm1` is higher than at `percProm0`, with the credible
    interval slightly crossing zero.

-   **`diff_0_2`:** Estimate = -0.221 [-0.332, -0.108], Posterior
    Probability = 100%; Strong evidence that `duration` at `percProm2`
    is higher than at `percProm0`, as indicated by the negative estimate
    and a credible interval entirely below zero.

-   **`diff_0_3`:** Estimate = -0.311 [-0.441, -0.177], Posterior
    Probability = 100%; Strong evidence that `duration` at `percProm3`
    is higher than at `percProm0`.

-   **`diff_1_2`:** Estimate = -0.113 [-0.154, -0.073], Posterior
    Probability = 100%; Strong evidence of an increase in `duration`
    from `percProm1` to `percProm2`.

-   **`diff_1_3`:** Estimate = -0.202 [-0.276, -0.128], Posterior
    Probability = 100%; Strong evidence of an increase in `duration`
    from `percProm1` to `percProm3`.

-   **`diff_2_3`:** Estimate = -0.089 [-0.146, -0.032], Posterior
    Probability = 99.8%; Strong evidence of an increase in `duration`
    from `percProm2` to `percProm3`.

**Overall Implications:**

-   **Trend:** The `duration` increases as `percProm` levels increase
    from 0 to 3.

-   **Interpretation:** All comparisons, except for the borderline case
    of `diff_0_1`, show strong evidence (posterior probability \> 95%)
    of an increase in `duration` with increasing `percProm`. This
    suggests that higher prominence levels are associated with a longer
    `duration`.

##### Plot fixef

Visualize the (non-)linearity of the effect with a violin plot of the
posteriors for each prominence level and a GAMM overlaid on top.

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_ger %>%
  data_grid(percProm = unique(percProm),
            gender_s = 0.09727) %>% # Set to average of gender
  add_epred_draws(mdl_durationGer, re_formula = NA) %>%
  mutate(
    percProm_num = as.numeric(as.character(percProm)),
    percProm = factor(percProm, levels = c("0", "1", "2", "3"))
  ) %>%
  ggplot(aes(x = percProm_num, y = .epred, color = percProm)) +
  geom_violin(aes(group = percProm_num, fill = percProm), alpha = 0.8) +
  scale_color_manual(values = colorBlindBlack8) +
  scale_fill_manual(values = colorBlindBlack8) +
  stat_summary(fun = median, geom = "point", color = colorBlindBlack8[7], size = 2) +
  geom_smooth(
    aes(group = 1),
    method = "gam",
    formula = y ~ s(x, bs = "cs", k = 4),
    color = colorBlindBlack8[7],
    se = FALSE
  ) +
  scale_x_continuous(
    breaks = 0:3,
    labels = as.character(0:3)
  ) +
  #ylim(1, 5) +
  labs(
    x = "Perceived prominence level",
    y = "Posterior duration"
  ) +
  theme_minimal()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
post_durationGer <- 
  data_prepost_ger %>%
  data_grid(
    percProm = unique(percProm),
    gender_s = 0.09727  # Set gender_s to zero to average over gender
  ) %>%
  add_epred_draws(mdl_durationGer, re_formula = NA) %>%
  mutate(
    percProm = factor(percProm, levels = c("0", "1", "2", "3"))
  ) %>%
  ggplot(aes(y = percProm, x = .epred, fill = percProm)) +
  ggdist::stat_halfeye(
    adjust = 0.5,
    width = 0.6,
    .width = c(0.66, 0.95),
    justification = -0.1,
    point_colour = NA
  ) +
  geom_boxplot(
    width = 0.15,
    outlier.shape = NA,
    alpha = 0.5,
    position = position_nudge(y = 0.2)
  ) +
  stat_summary(
    fun = median,
    geom = "point",
    color = "red",
    size = 2,
    position = position_nudge(y = 0.2)
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  coord_flip() +
  theme_minimal() +
  theme(text = element_text(size = 18)) +
  labs(
    y = "Perceived prominence level",
    x = "Posterior duration",
    fill = "Perceived\nprominence"
  )

post_durationGer;
ggsave(plot = post_durationGer, filename = paste0(plots, "posterior_durationGer.pdf"), 
       width = 8, height = 6);
ggsave(plot = post_durationGer, filename = paste0(plots, "posterior_durationGer.jpg"), 
       width = 8, height = 6);
ggsave(plot = post_durationGer, filename = paste0(plots, "posterior_durationGer.tif"), 
       width = 8, height = 6, compression="lzw", dpi=600);
```

#### Group-level effects

First, get a general overview.

```{r echo=FALSE, message=FALSE, warning=FALSE}
as.data.frame(VarCorr(mdl_durationGer)$participant$sd) %>%
  rownames_to_column(var = "Random Effect") %>%
  select(`Random Effect`, Estimate, Est.Error, Q2.5, Q97.5)
```

-   **`percProm0`:** The estimated standard deviation of the random
    intercepts for `percProm0` is 0.119 (95% CrI: 0.006 to 0.288),
    suggesting modest variability in participants' baseline `duration`
    at the lowest prominence level.

-   **`percProm1`:** The estimated standard deviation is 0.116 (95% CrI:
    0.083 to 0.157), indicating some variability in participants'
    responses to `percProm1`.

-   **`percProm2`:** The estimated standard deviation is 0.161 (95% CrI:
    0.125 to 0.208), showing a slightly higher variability in response
    to `percProm2` compared to `percProm1`.

-   **`percProm3`:** The estimated standard deviation is 0.237 (95% CrI:
    0.177 to 0.315), indicating the most variability among participants
    at the highest prominence level (`percProm3`).

**Implications:**

-   The variability in participants' `duration` responses increases with
    higher prominence levels, with the most substantial variation seen
    at `percProm3`. This pattern suggests that participants' realization
    of higher prominence levels is less uniform.

Extract samples in interpretable units. Then, plot them so that we can
see how each participant uses the levels of percProm.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract samples for each participant x percProm
data_prepost_ger %>% 
  data_grid(
    participant = unique(participant),
    percProm = unique(percProm),
    gender_s = 0.09727 # Average over gender
  ) %>% 
  add_epred_draws(mdl_durationGer) %>% 
  median_qi()

# Plot the draws for all participants x percProm levels
data_prepost_ger %>%
  # Start by selecting unique participants and their gender_s
  select(participant, gender_s) %>%
  distinct() %>%
  # Back-transform gender_s to gender labels
  mutate(
    gender = if_else(gender_s == -0.5, "Male", "Female")
  ) %>%
  # Combine with percProm levels
  crossing(
    percProm = unique(data_prepost_ger$percProm)
  ) %>%
  # Generate posterior predictions
  add_epred_draws(mdl_durationGer) %>%
  # Summarize predictions with .66 and .95 intervals
  median_qi(.width = c(.66, .95)) %>%
  ggplot(aes(x = .epred, y = participant, color = percProm, shape = gender)) +
  # Add the thick line for 66% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.66),  # Use 66% credible interval
                 size = 1,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add the thin line for 95% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.95),  # Use 95% credible interval
                 size = 0.5,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add points with shapes
  geom_point(position = position_dodge(width = 0.7), size = 2.5) +
  scale_color_manual(values = colorBlindBlack8) +
  labs(
    x = "Posterior duration",
    y = "Participant",
    color = "Perceived prominence",
    shape = "Gender"
  ) +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines")
  )
```

First, we extract individual draws. Here, if the CrI encompasses 0, the
participant does not differ from the overall behavior on this percProm.
Then, we plot random effects for each participant and percProm level on
the model scale, representing deviations from the fixed effects.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# We focus on 95% CrI, but this can be adapted in the width parameter
mdl_durationGer %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95))

# In log without Intercept
mdl_durationGer %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95, .8, .5)) %>%
  ggplot(aes(y = as.factor(participant), x = r_participant, color = percProm, xmin = .lower, xmax = .upper)) +
  geom_pointinterval(
    position = "dodge") +
  scale_color_manual(
    values = colorBlindBlack8) +
  labs(
    x = "Individual deviations in duration",
    y = "Participant",
    color = "Perceived prominence") +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines") 
  )

```

### Flux SD

#### Priors

```{r echo=FALSE, message=FALSE, warning=FALSE}
get_prior(
  flux_sd ~ 0 +
    percProm + gender_s + 
    (0 + percProm | participant),
  data = data_prepost_ger,
  family = lognormal()
)

prior_flux_sdGer <- c(
  #prior('normal(0, 1)', class = 'Intercept', lb = 0),
  #prior('normal(0, 1)', class = 'b'),  # For intercept
  prior('normal(0, 1)', class = 'b', lb = 0),
  prior('normal(0, 1)', class = 'sd')  # For random effects (participant)
)
```

#### Model

```{r echo=FALSE, message=FALSE, warning=FALSE}
mdl_flux_sdGer <- brm(flux_sd ~ 0 +
                         percProm + gender_s + 
                         (0 + percProm | participant),
                       data = data_prepost_ger,
                       family = lognormal(),
                       prior = prior_flux_sdGer,
                       #backend = "cmdstanr", # depends on you
                       cores = 4,
                       chains = 4,
                       iter = 8000,
                       warmup = 4000,
                       seed = 998,
                       control = list(max_treedepth = 12,
                                      adapt_delta = 0.99),
                       file = paste0(models, "mdl_flux_sdGer.rds"))

# if we need to compress the model more
#saveRDS(mdl_flux_sdGer, file = paste0(models, "mdl_flux_sdGer.rds"), compress = "xz")

mdl_flux_sdGer <- readRDS(paste0(models, "mdl_flux_sdGer.rds"))
```

Calculate R².

```{r echo=FALSE, message=FALSE, warning=FALSE}
# # Calculate Bayesian R²
# mdl_flux_sdGer_R2 <- bayes_R2(mdl_flux_sdGer)
# # Save the R² output
# saveRDS(mdl_flux_sdGer_R2, file = paste0(models, "mdl_flux_sdGer_R2.rds"))

mdl_flux_sdGer_R2 <- readRDS(paste0(models, "mdl_flux_sdGer_R2.rds"))

mdl_flux_sdGer_R2
```

An R² of approximately 0.42 suggests a **moderate fit**. This value
means that the model explains about 41.7% of the variance in the
`flux_sd` variable. In other words, a little over 40% of the variability
in `flux_sd` is accounted for by the predictors in the model. The 95%
credible interval indicates some uncertainty about the exact R² value,
but it is likely between **35.0% and 48.3%**. This range shows that
while the model explains a significant portion of the variance, there is
still room for improvement in capturing all the variability in
`flux_sd`.

#### Fixed effects

Let's check how it looks like.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Summarize the model
summary(mdl_flux_sdGer)

# Extract fixed effects
exp(fixef(mdl_flux_sdGer))
```

It shows that flux_sd systematically falls from 0 to 3.

Diagnostic plots.

```{r echo=FALSE, message=FALSE, warning=FALSE}
plot(mdl_flux_sdGer)
```

Posterior predictive check.

```{r echo=FALSE, message=FALSE, warning=FALSE}
pp_check(mdl_flux_sdGer, ndraws = 100)

pp_check(mdl_flux_sdGer, type = "error_scatter_avg", ndraws = 100)
```

Extract samples.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of fixed effects
samples_mdl_flux_sdGer <- as_draws_array(mdl_flux_sdGer, 
                                          variable = "^b_", 
                                          regex = TRUE)
samples_mdl_flux_sdGer <- mutate_variables(samples_mdl_flux_sdGer, 
                                                exp_b_percProm0 = exp(b_percProm0), 
                                                exp_b_percProm1 = exp(b_percProm1),
                                                exp_b_percProm2 = exp(b_percProm2),
                                                exp_b_percProm3 = exp(b_percProm3))

# Summarize posterior draws
summarize_draws(samples_mdl_flux_sdGer)
```

Check conditional effect.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Plot conditional effects (fixed effects only)
conditional_effects(mdl_flux_sdGer, re_formula = NA)

# Extract conditional effects data
conditional_effects(mdl_flux_sdGer, plot = FALSE, re_formula = NA)$percProm
```

Compare conditional effects to raw values.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Calculate raw means by percProm level
data_prepost_ger %>% 
  group_by(percProm) %>%
  summarize(avg_flux_sd = mean(flux_sd, na.rm = TRUE))

# Summary of flux_sd
summary(data_prepost_ger$flux_sd)
```

##### Effect comparison

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Compute estimated marginal means on log-scale
em_mdl_flux_sdGer <- emmeans(mdl_flux_sdGer, ~ percProm)
# Backtransform the post.beta values
em_mdl_flux_sdGer@post.beta <- exp(em_mdl_flux_sdGer@post.beta)
print(em_mdl_flux_sdGer)
plot(em_mdl_flux_sdGer)

# Perform pairwise comparisons between levels of percProm
emPairs_mdl_flux_sdGer <- pairs(emmeans(mdl_flux_sdGer, ~ percProm))
# Backtransform the post.beta values
emPairs_mdl_flux_sdGer@post.beta <- exp(emPairs_mdl_flux_sdGer@post.beta)
print(emPairs_mdl_flux_sdGer)
plot(emPairs_mdl_flux_sdGer)
```

If the comparison includes 0, the contrast is not reliably different.

##### Hypothesis testing

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of the fixed effects coefficients
as_draws_df(mdl_flux_sdGer) %>%
  # Select fixed effects for percProm levels
  select(starts_with("b_percProm")) %>%
  # Rename columns to match percProm levels
  rename_with(~ str_replace(.x, "b_percProm", "percProm"), starts_with("b_percProm")) %>%
  # Compute differences between percProm levels
  mutate(
    diff_0_1 = exp(percProm0) - exp(percProm1),
    diff_0_2 = exp(percProm0) - exp(percProm2),
    diff_0_3 = exp(percProm0) - exp(percProm3),
    diff_1_2 = exp(percProm1) - exp(percProm2),
    diff_1_3 = exp(percProm1) - exp(percProm3),
    diff_2_3 = exp(percProm2) - exp(percProm3)
  ) %>%
  # Gather differences into long format
  pivot_longer(
    cols = starts_with("diff_"),
    names_to = "Comparison",
    values_to = "Difference"
  ) %>%
  # Group by comparison to compute summary statistics
  group_by(Comparison) %>%
  summarise(
    Estimate = mean(Difference),
    Est.Error = sd(Difference),
    CI.Lower = quantile(Difference, 0.025),
    CI.Upper = quantile(Difference, 0.975),
    Post.Prob = if_else(Estimate > 0,
                        mean(Difference > 0) * 100,
                        mean(Difference < 0) * 100)
  ) %>%
  ungroup() %>%
  # Add significance stars based on posterior probability
  mutate(
    Star = ifelse(Post.Prob > 95 | Post.Prob < 5, "*", ""),
    Estimate = round(Estimate, 3),
    Est.Error = round(Est.Error, 3),
    CI.Lower = round(CI.Lower, 3),
    CI.Upper = round(CI.Upper, 3),
    Post.Prob = round(Post.Prob, 2)
  ) %>%
  # Select and arrange the final columns
  select(Comparison, Estimate, Est.Error, CI.Lower, CI.Upper, Post.Prob, Star) %>%
  arrange(Comparison)
```

-   **`diff_0_1`:** Estimate = 0.026 [-0.528, 0.697], Posterior
    Probability = 51.70%; There is no strong evidence for a difference
    between `flux_sd` at `percProm0` and `percProm1`. The estimate is
    positive, but the credible interval includes zero, suggesting
    uncertainty in this comparison.

-   **`diff_0_2`:** Estimate = 0.111 [-0.342, 0.755], Posterior
    Probability = 64.50%; There is moderate evidence that `flux_sd` at
    `percProm2` is higher than at `percProm0`, but the evidence is not
    strong, as the credible interval still includes zero.

-   **`diff_0_3`:** Estimate = 0.143 [-0.262, 0.786], Posterior
    Probability = 70.60%; There is moderate evidence that `flux_sd`
    increases from `percProm0` to `percProm3`, but again, the credible
    interval includes zero, making the difference not conclusive.

-   **`diff_1_2`:** Estimate = 0.084 [-0.303, 0.554], Posterior
    Probability = 65.50%; Moderate evidence suggests that `flux_sd`
    increases slightly from `percProm1` to `percProm2`, but the credible
    interval includes zero, indicating uncertainty in the direction of
    the effect.

-   **`diff_1_3`:** Estimate = 0.116 [-0.256, 0.597], Posterior
    Probability = 70.90%; There is moderate evidence that `flux_sd`
    increases from `percProm1` to `percProm3`, but the evidence is not
    strong enough to confirm the increase.

-   **`diff_2_3`:** Estimate = 0.032 [-0.293, 0.388], Posterior
    Probability = 57.70%; There is weak evidence for a difference
    between `percProm2` and `percProm3`. The credible interval includes
    zero, indicating considerable uncertainty.

**Overall Implications:**

-   **Trend:** While the estimates suggest a possible increase in
    `flux_sd` as `percProm` levels increase, the credible intervals for
    most comparisons include zero, indicating that the evidence is not
    strong enough to confirm these differences.

-   **Interpretation:** The comparisons do not show strong or consistent
    evidence of an increase in `flux_sd` across prominence levels. The
    posterior probabilities are all below 95%, indicating that none of
    the comparisons can be considered reliable.

##### Plot fixef

Visualize the (non-)linearity of the effect with a violin plot of the
posteriors for each prominence level and a GAMM overlaid on top.

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_ger %>%
  data_grid(percProm = unique(percProm),
            gender_s = 0.09727) %>% # Set to average of gender
  add_epred_draws(mdl_flux_sdGer, re_formula = NA) %>%
  mutate(
    percProm_num = as.numeric(as.character(percProm)),
    percProm = factor(percProm, levels = c("0", "1", "2", "3"))
  ) %>%
  ggplot(aes(x = percProm_num, y = .epred, color = percProm)) +
  geom_violin(aes(group = percProm_num, fill = percProm), alpha = 0.8) +
  scale_color_manual(values = colorBlindBlack8) +
  scale_fill_manual(values = colorBlindBlack8) +
  stat_summary(fun = median, geom = "point", color = colorBlindBlack8[7], size = 2) +
  geom_smooth(
    aes(group = 1),
    method = "gam",
    formula = y ~ s(x, bs = "cs", k = 4),
    color = colorBlindBlack8[7],
    se = FALSE
  ) +
  scale_x_continuous(
    breaks = 0:3,
    labels = as.character(0:3)
  ) +
  ylim(1.5, 5) +
  labs(
    x = "Perceived prominence level",
    y = "Posterior flux SD"
  ) +
  theme_minimal()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_ger %>%
  data_grid(
    percProm = unique(percProm),
    gender_s = 0.09727  # Set gender_s to zero to average over gender
  ) %>%
  add_epred_draws(mdl_flux_sdGer, re_formula = NA) %>%
  mutate(
    percProm = factor(percProm, levels = c("0", "1", "2", "3"))
  ) %>%
  ggplot(aes(y = percProm, x = .epred, fill = percProm)) +
  ggdist::stat_halfeye(
    adjust = 0.5,
    width = 0.6,
    .width = c(0.66, 0.95),
    justification = -0.1,
    point_colour = NA
  ) +
  geom_boxplot(
    width = 0.15,
    outlier.shape = NA,
    alpha = 0.5,
    position = position_nudge(y = 0.2)
  ) +
  stat_summary(
    fun = median,
    geom = "point",
    color = "red",
    size = 2,
    position = position_nudge(y = 0.2)
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  coord_flip() +
  theme_minimal() +
  xlim(1.5, 5) +
  labs(
    y = "Perceived prominence level",
    x = "Posterior flux SD"
  )
```

#### Group-level effects

First, get a general overview.

```{r echo=FALSE, message=FALSE, warning=FALSE}
as.data.frame(VarCorr(mdl_flux_sdGer)$participant$sd) %>%
  rownames_to_column(var = "Random Effect") %>%
  select(`Random Effect`, Estimate, Est.Error, Q2.5, Q97.5)
```

-   **percProm0:** The estimated standard deviation of the random
    intercepts at `percProm0` is 1.984 (95% CrI: 1.508 to 2.595),
    indicating notable variability in participants' `flux_sd` at this
    level.

-   **percProm1:** The estimated standard deviation at `percProm1` is
    2.223 (95% CrI: 1.840 to 2.716), suggesting an increase in
    variability in participants' `flux_sd` compared to `percProm0`.

-   **percProm2:** The estimated standard deviation at `percProm2` is
    2.294 (95% CrI: 1.925 to 2.731), indicating a slight increase in
    variability compared to `percProm1`.

-   **percProm3:** The estimated standard deviation at `percProm3` is
    2.466 (95% CrI: 2.073 to 2.924), showing further increased
    variability in participants' `flux_sd` compared to the other
    prominence levels.

**Interpretation:** The increasing standard deviations across `percProm`
levels suggest that variability in participants' `flux_sd` tends to grow
as perceived prominence increases. This implies greater individual
differences in how participants’ `flux_sd` changes across different
levels of prominence.

Extract samples in interpretable units. Then, plot them so that we can
see how each participant uses the levels of percProm.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract samples for each participant x percProm
data_prepost_ger %>% 
  data_grid(
    participant = unique(participant),
    percProm = unique(percProm),
    gender_s = 0.09727 # Average over gender
  ) %>% 
  add_epred_draws(mdl_flux_sdGer) %>% 
  median_qi()

# Plot the draws for all participants x percProm levels
data_prepost_ger %>%
  # Start by selecting unique participants and their gender_s
  select(participant, gender_s) %>%
  distinct() %>%
  # Back-transform gender_s to gender labels
  mutate(
    gender = if_else(gender_s == -0.5, "Male", "Female")
  ) %>%
  # Combine with percProm levels
  crossing(
    percProm = unique(data_prepost_ger$percProm)
  ) %>%
  # Generate posterior predictions
  add_epred_draws(mdl_flux_sdGer) %>%
  # Summarize predictions with .66 and .95 intervals
  median_qi(.width = c(.66, .95)) %>%
  ggplot(aes(x = .epred, y = participant, color = percProm, shape = gender)) +
  # Add the thick line for 66% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.66),  # Use 66% credible interval
                 size = 1,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add the thin line for 95% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.95),  # Use 95% credible interval
                 size = 0.5,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add points with shapes
  geom_point(position = position_dodge(width = 0.7), size = 2.5) +
  scale_color_manual(values = colorBlindBlack8) +
  labs(
    x = "Posterior flux SD",
    y = "Participant",
    color = "Perceived prominence",
    shape = "Gender"
  ) +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines")
  )
```

First, we extract individual draws. Here, if the CrI encompasses 0, the
participant does not differ from the overall behavior on this percProm.
Then, we plot random effects for each participant and percProm level on
the model scale, representing deviations from the fixed effects.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# We focus on 95% CrI, but this can be adapted in the width parameter
mdl_flux_sdGer %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95))

# In log without Intercept
mdl_flux_sdGer %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95, .8, .5)) %>%
  ggplot(aes(y = as.factor(participant), x = r_participant, color = percProm, xmin = .lower, xmax = .upper)) +
  geom_pointinterval(
    position = "dodge") +
  scale_color_manual(
    values = colorBlindBlack8) +
  labs(
    x = "Individual deviations in flux SD",
    y = "Participant",
    color = "Perceived prominence") +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines") 
  )

```

### Flux median

#### Priors

```{r echo=FALSE, message=FALSE, warning=FALSE}
get_prior(
  flux_median ~ 0 +
    percProm + gender_s + 
    (0 + percProm | participant),
  data = data_prepost_ger,
  family = lognormal()
)

prior_flux_medianGer <- c(
  #prior('normal(0, 1)', class = 'Intercept', lb = 0),
  #prior('normal(0, 1)', class = 'b'),  # For intercept
  prior('normal(0, 1)', class = 'b', lb = 0),
  prior('normal(0, 1)', class = 'sd')  # For random effects (participant)
)
```

#### Model

```{r echo=FALSE, message=FALSE, warning=FALSE}
mdl_flux_medianGer <- brm(flux_median ~ 0 +
                         percProm + gender_s + 
                         (0 + percProm | participant),
                       data = data_prepost_ger,
                       family = lognormal(),
                       prior = prior_flux_medianGer,
                       #backend = "cmdstanr", # depends on you
                       cores = 4,
                       chains = 4,
                       iter = 8000,
                       warmup = 4000,
                       seed = 998,
                       control = list(max_treedepth = 12,
                                      adapt_delta = 0.99),
                       file = paste0(models, "mdl_flux_medianGer.rds"))

# if we need to compress the model more
#saveRDS(mdl_flux_medianGer, file = paste0(models, "mdl_flux_medianGer.rds"), compress = "xz")

mdl_flux_medianGer <- readRDS(paste0(models, "mdl_flux_medianGer.rds"))
```

Calculate R².

```{r echo=FALSE, message=FALSE, warning=FALSE}
# # Calculate Bayesian R²
# mdl_flux_medianGer_R2 <- bayes_R2(mdl_flux_medianGer)
# # Save the R² output
# saveRDS(mdl_flux_medianGer_R2, file = paste0(models, "mdl_flux_medianGer_R2.rds"))

mdl_flux_medianGer_R2 <- readRDS(paste0(models, "mdl_flux_medianGer_R2.rds"))

mdl_flux_medianGer_R2
```

An R² of 0.489 (95% CrI: 0.470 to 0.501) indicates a **moderate fit**,
meaning that approximately **48.9%** of the variance in `flux_median` is
explained by the model. This credible interval suggests a stable
estimate within a range of explained variability.

#### Fixed effects

Let's check how it looks like.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Summarize the model
summary(mdl_flux_medianGer)

# Extract fixed effects
exp(fixef(mdl_flux_medianGer))
```

It shows that flux_median falls from 0 to 1 and 1 to 2, but raises from
2 to 3.

Diagnostic plots.

```{r echo=FALSE, message=FALSE, warning=FALSE}
plot(mdl_flux_medianGer)
```

Posterior predictive check.

```{r echo=FALSE, message=FALSE, warning=FALSE}
pp_check(mdl_flux_medianGer, ndraws = 100)

pp_check(mdl_flux_medianGer, type = "error_scatter_avg", ndraws = 100)
```

Extract samples.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of fixed effects
samples_mdl_flux_medianGer <- as_draws_array(mdl_flux_medianGer, 
                                          variable = "^b_", 
                                          regex = TRUE)
samples_mdl_flux_medianGer <- mutate_variables(samples_mdl_flux_medianGer, 
                                                exp_b_percProm0 = exp(b_percProm0), 
                                                exp_b_percProm1 = exp(b_percProm1),
                                                exp_b_percProm2 = exp(b_percProm2),
                                                exp_b_percProm3 = exp(b_percProm3))

# Summarize posterior draws
summarize_draws(samples_mdl_flux_medianGer)
```

Check conditional effect.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Plot conditional effects (fixed effects only)
conditional_effects(mdl_flux_medianGer, re_formula = NA)

# Extract conditional effects data
conditional_effects(mdl_flux_medianGer, plot = FALSE, re_formula = NA)$percProm
```

Compare conditional effects to raw values.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Calculate raw means by percProm level
data_prepost_ger %>% 
  group_by(percProm) %>%
  summarize(avg_flux_median = mean(flux_median, na.rm = TRUE))

# Summary of flux_median
summary(data_prepost_ger$flux_median)
```

##### Effect comparison

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Compute estimated marginal means on log-scale
em_mdl_flux_medianGer <- emmeans(mdl_flux_medianGer, ~ percProm)
# Backtransform the post.beta values
em_mdl_flux_medianGer@post.beta <- exp(em_mdl_flux_medianGer@post.beta)
print(em_mdl_flux_medianGer)
plot(em_mdl_flux_medianGer)

# Perform pairwise comparisons between levels of percProm
emPairs_mdl_flux_medianGer <- pairs(emmeans(mdl_flux_medianGer, ~ percProm))
# Backtransform the post.beta values
emPairs_mdl_flux_medianGer@post.beta <- exp(emPairs_mdl_flux_medianGer@post.beta)
print(emPairs_mdl_flux_medianGer)
plot(emPairs_mdl_flux_medianGer)
```

If the comparison includes 0, the contrast is not reliably different.

##### Hypothesis testing

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of the fixed effects coefficients
as_draws_df(mdl_flux_medianGer) %>%
  # Select fixed effects for percProm levels
  select(starts_with("b_percProm")) %>%
  # Rename columns to match percProm levels
  rename_with(~ str_replace(.x, "b_percProm", "percProm"), starts_with("b_percProm")) %>%
  # Compute differences between percProm levels
  mutate(
    diff_0_1 = exp(percProm0) - exp(percProm1),
    diff_0_2 = exp(percProm0) - exp(percProm2),
    diff_0_3 = exp(percProm0) - exp(percProm3),
    diff_1_2 = exp(percProm1) - exp(percProm2),
    diff_1_3 = exp(percProm1) - exp(percProm3),
    diff_2_3 = exp(percProm2) - exp(percProm3)
  ) %>%
  # Gather differences into long format
  pivot_longer(
    cols = starts_with("diff_"),
    names_to = "Comparison",
    values_to = "Difference"
  ) %>%
  # Group by comparison to compute summary statistics
  group_by(Comparison) %>%
  summarise(
    Estimate = mean(Difference),
    Est.Error = sd(Difference),
    CI.Lower = quantile(Difference, 0.025),
    CI.Upper = quantile(Difference, 0.975),
    Post.Prob = if_else(Estimate > 0,
                        mean(Difference > 0) * 100,
                        mean(Difference < 0) * 100)
  ) %>%
  ungroup() %>%
  # Add significance stars based on posterior probability
  mutate(
    Star = ifelse(Post.Prob > 95 | Post.Prob < 5, "*", ""),
    Estimate = round(Estimate, 3),
    Est.Error = round(Est.Error, 3),
    CI.Lower = round(CI.Lower, 3),
    CI.Upper = round(CI.Upper, 3),
    Post.Prob = round(Post.Prob, 2)
  ) %>%
  # Select and arrange the final columns
  select(Comparison, Estimate, Est.Error, CI.Lower, CI.Upper, Post.Prob, Star) %>%
  arrange(Comparison)
```

-   **diff_0_1:** Estimate = `0.033` [-0.670, 0.777], Posterior
    Probability = 53.7%; There is no strong evidence for a difference
    between `percProm0` and `percProm1`, with the posterior probability
    close to chance.

-   **diff_0_2:** Estimate = `0.119` [-0.415, 0.829], Posterior
    Probability = 64.0%; There is weak evidence suggesting that
    `flux_median` at `percProm2` is higher than at `percProm0`, though
    the credible interval includes zero, making the difference
    unreliable.

-   **diff_0_3:** Estimate = `0.081` [-0.521, 0.807], Posterior
    Probability = 58.6%; No strong evidence for a difference between
    `percProm0` and `percProm3`, with a credible interval spanning zero.

-   **diff_1_2:** Estimate = `0.086` [-0.418, 0.741], Posterior
    Probability = 60.8%; Weak evidence indicates that `flux_median` may
    increase from `percProm1` to `percProm2`, though the result is
    inconclusive.

-   **diff_1_3:** Estimate = `0.047` [-0.539, 0.723], Posterior
    Probability = 55.5%; There is no strong evidence for a difference
    between `percProm1` and `percProm3`, given the credible interval
    includes zero.

-   **diff_2_3:** Estimate = `-0.038` [-0.569, 0.441], Posterior
    Probability = 55.7%; There is weak evidence of a slight decrease in
    `flux_median` from `percProm2` to `percProm3`, but the difference is
    unreliable.

**Overall Implications:**

-   **Trend:** There is no strong or consistent evidence of significant
    differences between `percProm` levels for `flux_median`. The
    posterior probabilities and wide credible intervals suggest that any
    potential differences are uncertain and should be interpreted
    cautiously.

##### Plot fixef

Visualize the (non-)linearity of the effect with a violin plot of the
posteriors for each prominence level and a GAMM overlaid on top.

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_ger %>%
  data_grid(percProm = unique(percProm),
            gender_s = 0.09727) %>% # Set to average of gender
  add_epred_draws(mdl_flux_medianGer, re_formula = NA) %>%
  mutate(
    percProm_num = as.numeric(as.character(percProm)),
    percProm = factor(percProm, levels = c("0", "1", "2", "3"))
  ) %>%
  ggplot(aes(x = percProm_num, y = .epred, color = percProm)) +
  geom_violin(aes(group = percProm_num, fill = percProm), alpha = 0.8) +
  scale_color_manual(values = colorBlindBlack8) +
  scale_fill_manual(values = colorBlindBlack8) +
  stat_summary(fun = median, geom = "point", color = colorBlindBlack8[7], size = 2) +
  geom_smooth(
    aes(group = 1),
    method = "gam",
    formula = y ~ s(x, bs = "cs", k = 4),
    color = colorBlindBlack8[7],
    se = FALSE
  ) +
  scale_x_continuous(
    breaks = 0:3,
    labels = as.character(0:3)
  ) +
  #ylim(1, 5) +
  labs(
    x = "Perceived prominence level",
    y = "Posterior flux median"
  ) +
  theme_minimal()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_ger %>%
  data_grid(
    percProm = unique(percProm),
    gender_s = 0  # Set gender_s to zero to average over gender
  ) %>%
  add_epred_draws(mdl_flux_medianGer, re_formula = NA) %>%
  mutate(
    percProm = factor(percProm, levels = c("0", "1", "2", "3"))
  ) %>%
  ggplot(aes(y = percProm, x = .epred, fill = percProm)) +
  ggdist::stat_halfeye(
    adjust = 0.5,
    width = 0.6,
    .width = c(0.66, 0.95),
    justification = -0.1,
    point_colour = NA
  ) +
  geom_boxplot(
    width = 0.15,
    outlier.shape = NA,
    alpha = 0.5,
    position = position_nudge(y = 0.2)
  ) +
  stat_summary(
    fun = median,
    geom = "point",
    color = "red",
    size = 2,
    position = position_nudge(y = 0.2)
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  coord_flip() +
  theme_minimal() +
  xlim(10, 70) +
  labs(
    y = "Perceived prominence level",
    x = "Posterior flux median"
  )
```

#### Group-level effects

First, get a general overview.

```{r echo=FALSE, message=FALSE, warning=FALSE}
as.data.frame(VarCorr(mdl_flux_medianGer)$participant$sd) %>%
  rownames_to_column(var = "Random Effect") %>%
  select(`Random Effect`, Estimate, Est.Error, Q2.5, Q97.5)
```

-   **percProm0:** SD = 1.984 (95% CrI: 1.508 to 2.595), indicating
    moderate variability in participants' `flux_median`.

-   **percProm1:** SD = 2.223 (95% CrI: 1.840 to 2.716), suggesting an
    increase in variability compared to `percProm0`.

-   **percProm2:** SD = 2.294 (95% CrI: 1.925 to 2.731), indicating
    further increased variability.

-   **percProm3:** SD = 2.466 (95% CrI: 2.073 to 2.924), showing the
    highest variability, indicating substantial differences across
    participants in `flux_median`.

Extract samples in interpretable units. Then, plot them so that we can
see how each participant uses the levels of percProm.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract samples for each participant x percProm
data_prepost_ger %>% 
  data_grid(
    participant = unique(participant),
    percProm = unique(percProm),
    gender_s = 0.09727 # Average over gender
  ) %>% 
  add_epred_draws(mdl_flux_medianGer) %>% 
  median_qi()

# Plot the draws for all participants x percProm levels
data_prepost_ger %>%
  # Start by selecting unique participants and their gender_s
  select(participant, gender_s) %>%
  distinct() %>%
  # Back-transform gender_s to gender labels
  mutate(
    gender = if_else(gender_s == -0.5, "Male", "Female")
  ) %>%
  # Combine with percProm levels
  crossing(
    percProm = unique(data_prepost_ger$percProm)
  ) %>%
  # Generate posterior predictions
  add_epred_draws(mdl_flux_medianGer) %>%
  # Summarize predictions with .66 and .95 intervals
  median_qi(.width = c(.66, .95)) %>%
  ggplot(aes(x = .epred, y = participant, color = percProm, shape = gender)) +
  # Add the thick line for 66% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.66),  # Use 66% credible interval
                 size = 1,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add the thin line for 95% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.95),  # Use 95% credible interval
                 size = 0.5,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add points with shapes
  geom_point(position = position_dodge(width = 0.7), size = 2.5) +
  scale_color_manual(values = colorBlindBlack8) +
  labs(
    x = "Posterior flux median",
    y = "Participant",
    color = "Perceived prominence",
    shape = "Gender"
  ) +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines")
  )
```

First, we extract individual draws. Here, if the CrI encompasses 0, the
participant does not differ from the overall behavior on this percProm.
Then, we plot random effects for each participant and percProm level on
the model scale, representing deviations from the fixed effects.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# We focus on 95% CrI, but this can be adapted in the width parameter
mdl_flux_medianGer %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95))

# In log without Intercept
mdl_flux_medianGer %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95, .8, .5)) %>%
  ggplot(aes(y = as.factor(participant), x = r_participant, color = percProm, xmin = .lower, xmax = .upper)) +
  geom_pointinterval(
    position = "dodge") +
  scale_color_manual(
    values = colorBlindBlack8) +
  labs(
    x = "Individual deviations in flux median",
    y = "Participant",
    color = "Perceived prominence") +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines") 
  )

```

### Amplitude SD without silences

#### Priors

```{r echo=FALSE, message=FALSE, warning=FALSE}
get_prior(
  ampl_noSilence_sd ~ 0 +
    percProm + gender_s + 
    (0 + percProm | participant),
  data = data_prepost_ger,
  family = lognormal()
)

prior_ampl_noSilence_sdGer <- c(
  #prior('normal(0, 1)', class = 'Intercept', lb = 0),
  #prior('normal(0, 1)', class = 'b'),  # For intercept
  prior('normal(0, 1)', class = 'b', lb = 0),
  prior('normal(0, 1)', class = 'sd')  # For random effects (participant)
)
```

#### Model

```{r echo=FALSE, message=FALSE, warning=FALSE}
mdl_ampl_noSilence_sdGer <- brm(ampl_noSilence_sd ~ 0 +
                         percProm + gender_s + 
                         (0 + percProm | participant),
                       data = data_prepost_ger,
                       family = lognormal(),
                       prior = prior_ampl_noSilence_sdGer,
                       #backend = "cmdstanr", # depends on you
                       cores = 4,
                       chains = 4,
                       iter = 8000,
                       warmup = 4000,
                       seed = 998,
                       control = list(max_treedepth = 12,
                                      adapt_delta = 0.99),
                       file = paste0(models, "mdl_ampl_noSilence_sdGer.rds"))

# if we need to compress the model more
#saveRDS(mdl_ampl_noSilence_sdGer, file = paste0(models, "mdl_ampl_noSilence_sdGer.rds"), compress = "xz")

mdl_ampl_noSilence_sdGer <- readRDS(paste0(models, "mdl_ampl_noSilence_sdGer.rds"))
```

Calculate R².

```{r echo=FALSE, message=FALSE, warning=FALSE}
# # Calculate Bayesian R²
# mdl_ampl_noSilence_sdGer_R2 <- bayes_R2(mdl_ampl_noSilence_sdGer)
# # Save the R² output
# saveRDS(mdl_ampl_noSilence_sdGer_R2, file = paste0(models, "mdl_ampl_noSilence_sdGer_R2.rds"))

mdl_ampl_noSilence_sdGer_R2 <- readRDS(paste0(models, "mdl_ampl_noSilence_sdGer_R2.rds"))

mdl_ampl_noSilence_sdGer_R2
```

An R² of 0.530 (95% CrI: 0.498 to 0.559) indicates a **moderate fit**,
with approximately **53%** of the variance in `ampl_noSilence_sd`
explained by the model. The narrow credible interval suggests stability
in the estimate.

#### Fixed effects

Let's check how it looks like.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Summarize the model
summary(mdl_ampl_noSilence_sdGer)

# Extract fixed effects
exp(fixef(mdl_ampl_noSilence_sdGer))
```

It shows that ampl_noSilence_sd falls from 0 to 1 and 1 to 2, but raises
from 2 to 3 (surpassing 0).

Diagnostic plots.

```{r echo=FALSE, message=FALSE, warning=FALSE}
plot(mdl_ampl_noSilence_sdGer)
```

Posterior predictive check.

```{r echo=FALSE, message=FALSE, warning=FALSE}
pp_check(mdl_ampl_noSilence_sdGer, ndraws = 100)

pp_check(mdl_ampl_noSilence_sdGer, type = "error_scatter_avg", ndraws = 100)
```

Extract samples.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of fixed effects
samples_mdl_ampl_noSilence_sdGer <- as_draws_array(mdl_ampl_noSilence_sdGer, 
                                          variable = "^b_", 
                                          regex = TRUE)
samples_mdl_ampl_noSilence_sdGer <- mutate_variables(samples_mdl_ampl_noSilence_sdGer, 
                                                exp_b_percProm0 = exp(b_percProm0), 
                                                exp_b_percProm1 = exp(b_percProm1),
                                                exp_b_percProm2 = exp(b_percProm2),
                                                exp_b_percProm3 = exp(b_percProm3))

# Summarize posterior draws
summarize_draws(samples_mdl_ampl_noSilence_sdGer)
```

Check conditional effect.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Plot conditional effects (fixed effects only)
conditional_effects(mdl_ampl_noSilence_sdGer, re_formula = NA)

# Extract conditional effects data
conditional_effects(mdl_ampl_noSilence_sdGer, plot = FALSE, re_formula = NA)$percProm
```

Compare conditional effects to raw values.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Calculate raw means by percProm level
data_prepost_ger %>% 
  group_by(percProm) %>%
  summarize(avg_ampl_noSilence_sd = mean(ampl_noSilence_sd, na.rm = TRUE))

# Summary of ampl_noSilence_sd
summary(data_prepost_ger$ampl_noSilence_sd)
```

##### Effect comparison

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Compute estimated marginal means on log-scale
em_mdl_ampl_noSilence_sdGer <- emmeans(mdl_ampl_noSilence_sdGer, ~ percProm)
# Backtransform the post.beta values
em_mdl_ampl_noSilence_sdGer@post.beta <- exp(em_mdl_ampl_noSilence_sdGer@post.beta)
print(em_mdl_ampl_noSilence_sdGer)
plot(em_mdl_ampl_noSilence_sdGer)

# Perform pairwise comparisons between levels of percProm
emPairs_mdl_ampl_noSilence_sdGer <- pairs(emmeans(mdl_ampl_noSilence_sdGer, ~ percProm))
# Backtransform the post.beta values
emPairs_mdl_ampl_noSilence_sdGer@post.beta <- exp(emPairs_mdl_ampl_noSilence_sdGer@post.beta)
print(emPairs_mdl_ampl_noSilence_sdGer)
plot(emPairs_mdl_ampl_noSilence_sdGer)
```

If the comparison includes 0, the contrast is not reliably different.

##### Hypothesis testing

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of the fixed effects coefficients
as_draws_df(mdl_ampl_noSilence_sdGer) %>%
  # Select fixed effects for percProm levels
  select(starts_with("b_percProm")) %>%
  # Rename columns to match percProm levels
  rename_with(~ str_replace(.x, "b_percProm", "percProm"), starts_with("b_percProm")) %>%
  # Compute differences between percProm levels
  mutate(
    diff_0_1 = exp(percProm0) - exp(percProm1),
    diff_0_2 = exp(percProm0) - exp(percProm2),
    diff_0_3 = exp(percProm0) - exp(percProm3),
    diff_1_2 = exp(percProm1) - exp(percProm2),
    diff_1_3 = exp(percProm1) - exp(percProm3),
    diff_2_3 = exp(percProm2) - exp(percProm3)
  ) %>%
  # Gather differences into long format
  pivot_longer(
    cols = starts_with("diff_"),
    names_to = "Comparison",
    values_to = "Difference"
  ) %>%
  # Group by comparison to compute summary statistics
  group_by(Comparison) %>%
  summarise(
    Estimate = mean(Difference),
    Est.Error = sd(Difference),
    CI.Lower = quantile(Difference, 0.025),
    CI.Upper = quantile(Difference, 0.975),
    Post.Prob = if_else(Estimate > 0,
                        mean(Difference > 0) * 100,
                        mean(Difference < 0) * 100)
  ) %>%
  ungroup() %>%
  # Add significance stars based on posterior probability
  mutate(
    Star = ifelse(Post.Prob > 95 | Post.Prob < 5, "*", ""),
    Estimate = round(Estimate, 3),
    Est.Error = round(Est.Error, 3),
    CI.Lower = round(CI.Lower, 3),
    CI.Upper = round(CI.Upper, 3),
    Post.Prob = round(Post.Prob, 2)
  ) %>%
  # Select and arrange the final columns
  select(Comparison, Estimate, Est.Error, CI.Lower, CI.Upper, Post.Prob, Star) %>%
  arrange(Comparison)
```

-   **diff_0_1:** Estimate = `0.119` [-0.271, 0.685], Posterior
    Probability = 68.2%; There is weak evidence that `ampl_noSilence_sd`
    at `percProm1` is higher than at `percProm0`, but the result is not
    conclusive.

-   **diff_0_2:** Estimate = `0.052` [-0.401, 0.649], Posterior
    Probability = 55.0%; There is no strong evidence for a difference
    between `percProm0` and `percProm2`, with the posterior probability
    close to chance.

-   **diff_0_3:** Estimate = `-0.036` [-0.650, 0.595], Posterior
    Probability = 55.6%; There is no conclusive evidence of a difference
    between `percProm0` and `percProm3`, given the wide credible
    interval.

-   **diff_1_2:** Estimate = `-0.067` [-0.427, 0.261], Posterior
    Probability = 66.6%; Weak evidence suggests a slight decrease in
    `ampl_noSilence_sd` from `percProm1` to `percProm2`, though this
    difference remains unreliable.

-   **diff_1_3:** Estimate = `-0.155` [-0.707, 0.251], Posterior
    Probability = 74.5%; Moderate evidence of a decrease in
    `ampl_noSilence_sd` from `percProm1` to `percProm3`, but it is not
    conclusive due to the inclusion of zero.

-   **diff_2_3:** Estimate = `-0.088` [-0.606, 0.329], Posterior
    Probability = 63.8%; Weak evidence that `ampl_noSilence_sd`
    decreases from `percProm2` to `percProm3`, though the result is not
    reliable.

**Overall Implications:**

-   **Trend:** There is no consistent or strong evidence of significant
    differences between `percProm` levels for `ampl_noSilence_sd`. The
    posterior probabilities and wide credible intervals imply that any
    potential differences are uncertain and should be interpreted with
    caution.

##### Plot fixef

Visualize the (non-)linearity of the effect with a violin plot of the
posteriors for each prominence level and a GAMM overlaid on top.

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_ger %>%
  data_grid(percProm = unique(percProm),
            gender_s = 0.09727) %>% # Set to average of gender
  add_epred_draws(mdl_ampl_noSilence_sdGer, re_formula = NA) %>%
  mutate(
    percProm_num = as.numeric(as.character(percProm)),
    percProm = factor(percProm, levels = c("0", "1", "2", "3"))
  ) %>%
  ggplot(aes(x = percProm_num, y = .epred, color = percProm)) +
  geom_violin(aes(group = percProm_num, fill = percProm), alpha = 0.8) +
  scale_color_manual(values = colorBlindBlack8) +
  scale_fill_manual(values = colorBlindBlack8) +
  stat_summary(fun = median, geom = "point", color = colorBlindBlack8[7], size = 2) +
  geom_smooth(
    aes(group = 1),
    method = "gam",
    formula = y ~ s(x, bs = "cs", k = 4),
    color = colorBlindBlack8[7],
    se = FALSE
  ) +
  scale_x_continuous(
    breaks = 0:3,
    labels = as.character(0:3)
  ) +
  ylim(1, 5) +
  labs(
    x = "Perceived prominence level",
    y = "Posterior amplitude SD (no silences)"
  ) +
  theme_minimal()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_ger %>%
  data_grid(
    percProm = unique(percProm),
    gender_s = 0  # Set gender_s to zero to average over gender
  ) %>%
  add_epred_draws(mdl_ampl_noSilence_sdGer, re_formula = NA) %>%
  mutate(
    percProm = factor(percProm, levels = c("0", "1", "2", "3"))
  ) %>%
  ggplot(aes(y = percProm, x = .epred, fill = percProm)) +
  ggdist::stat_halfeye(
    adjust = 0.5,
    width = 0.6,
    .width = c(0.66, 0.95),
    justification = -0.1,
    point_colour = NA
  ) +
  geom_boxplot(
    width = 0.15,
    outlier.shape = NA,
    alpha = 0.5,
    position = position_nudge(y = 0.2)
  ) +
  stat_summary(
    fun = median,
    geom = "point",
    color = "red",
    size = 2,
    position = position_nudge(y = 0.2)
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  coord_flip() +
  theme_minimal() +
  xlim(1, 3.5) +
  labs(
    y = "Perceived prominence level",
    x = "Posterior amplitude SD (no silences)"
  )
```

#### Group-level effects

First, get a general overview.

```{r echo=FALSE, message=FALSE, warning=FALSE}
as.data.frame(VarCorr(mdl_ampl_noSilence_sdGer)$participant$sd) %>%
  rownames_to_column(var = "Random Effect") %>%
  select(`Random Effect`, Estimate, Est.Error, Q2.5, Q97.5)
```

-   **percProm0:** SD = 3.672 (95% CrI: 3.183 to 4.263), indicating high
    variability in participants’ `ampl_noSilence_sd`.

-   **percProm1:** SD = 3.142 (95% CrI: 2.752 to 3.587), suggesting
    reduced variability.

-   **percProm2:** SD = 3.009 (95% CrI: 2.625 to 3.451), indicating a
    slight decrease in variability compared to `percProm1`.

-   **percProm3:** SD = 2.905 (95% CrI: 2.504 to 3.408), showing the
    lowest variability, suggesting participants’ responses are more
    consistent at this level.

Extract samples in interpretable units. Then, plot them so that we can
see how each participant uses the levels of percProm.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract samples for each participant x percProm
data_prepost_ger %>% 
  data_grid(
    participant = unique(participant),
    percProm = unique(percProm),
    gender_s = 0.09727 # Average over gender
  ) %>% 
  add_epred_draws(mdl_ampl_noSilence_sdGer) %>% 
  median_qi()

# Plot the draws for all participants x percProm levels
data_prepost_ger %>%
  # Start by selecting unique participants and their gender_s
  select(participant, gender_s) %>%
  distinct() %>%
  # Back-transform gender_s to gender labels
  mutate(
    gender = if_else(gender_s == -0.5, "Male", "Female")
  ) %>%
  # Combine with percProm levels
  crossing(
    percProm = unique(data_prepost_ger$percProm)
  ) %>%
  # Generate posterior predictions
  add_epred_draws(mdl_ampl_noSilence_sdGer) %>%
  # Summarize predictions with .66 and .95 intervals
  median_qi(.width = c(.66, .95)) %>%
  ggplot(aes(x = .epred, y = participant, color = percProm, shape = gender)) +
  # Add the thick line for 66% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.66),  # Use 66% credible interval
                 size = 1,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add the thin line for 95% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.95),  # Use 95% credible interval
                 size = 0.5,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add points with shapes
  geom_point(position = position_dodge(width = 0.7), size = 2.5) +
  scale_color_manual(values = colorBlindBlack8) +
  labs(
    x = "Posterior amplitude SD (no silences)",
    y = "Participant",
    color = "Perceived prominence",
    shape = "Gender"
  ) +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines")
  )
```

First, we extract individual draws. Here, if the CrI encompasses 0, the
participant does not differ from the overall behavior on this percProm.
Then, we plot random effects for each participant and percProm level on
the model scale, representing deviations from the fixed effects.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# We focus on 95% CrI, but this can be adapted in the width parameter
mdl_ampl_noSilence_sdGer %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95))

# In log without Intercept
mdl_ampl_noSilence_sdGer %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95, .8, .5)) %>%
  ggplot(aes(y = as.factor(participant), x = r_participant, color = percProm, xmin = .lower, xmax = .upper)) +
  geom_pointinterval(
    position = "dodge") +
  scale_color_manual(
    values = colorBlindBlack8) +
  labs(
    x = "Individual deviations in amplitude SD (no silences)",
    y = "Participant",
    color = "Perceived prominence") +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines") 
  )

```

### F0 median (post-tonic)

#### Priors

```{r echo=FALSE, message=FALSE, warning=FALSE}
get_prior(
  pitch_medianPost ~ 0 +
    percProm + gender_s +
    (0 + percProm | participant),
  data = data_prepost_ger,
  family = lognormal()
)

prior_pitch_medianPostGer <- c(
  #prior('normal(0, 5)', class = 'Intercept', lb = 0),
  #prior('normal(0, 1)', class = 'b'),  # For intercept
  prior('normal(0, 10)', class = 'b', lb = 0),
  prior('normal(0, 1)', class = 'sd')  # For random effects (participant)
)
```

#### Model

```{r echo=FALSE, message=FALSE, warning=FALSE}
mdl_pitch_medianPostGer <- brm(pitch_medianPost ~ 0 +
                         percProm + gender_s +
                         (0 + percProm | participant),
                       data = data_prepost_ger,
                       family = lognormal(),
                       prior = prior_pitch_medianPostGer,
                       #backend = "cmdstanr", # depends on you
                       cores = 4,
                       chains = 4,
                       iter = 8000,
                       warmup = 4000,
                       seed = 998,
                       control = list(max_treedepth = 12,
                                      adapt_delta = 0.99),
                       file = paste0(models, "mdl_pitch_medianPostGer.rds"))

# if we need to compress the model more
#saveRDS(mdl_pitch_medianPostGer, file = paste0(models, "mdl_pitch_medianPostGer.rds"), compress = "xz")

mdl_pitch_medianPostGer <- readRDS(paste0(models, "mdl_pitch_medianPostGer.rds"))
```

Calculate R².

```{r echo=FALSE, message=FALSE, warning=FALSE}
# # Calculate Bayesian R²
# mdl_pitch_medianPostGer_R2 <- bayes_R2(mdl_pitch_medianPostGer)
# # Save the R² output
# saveRDS(mdl_pitch_medianPostGer_R2, file = paste0(models, "mdl_pitch_medianPostGer_R2.rds"))

mdl_pitch_medianPostGer_R2 <- readRDS(paste0(models, "mdl_pitch_medianPostGer_R2.rds"))

mdl_pitch_medianPostGer_R2
```

An R² of 0.433 (95% CrI: 0.408 to 0.456) suggests a **moderate fit**,
with approximately **43.3%** of the variance in `pitch_medianPost`
explained by the model. The interval implies a stable estimate within
the range.

#### Fixed effects

Let's check how it looks like.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Summarize the model
summary(mdl_pitch_medianPostGer)

# Extract fixed effects
exp(fixef(mdl_pitch_medianPostGer))
```

It shows that pitch_medianPost is the same on 0 and 1, and raises to
stay the same on 2 and 3.

Diagnostic plots.

```{r echo=FALSE, message=FALSE, warning=FALSE}
plot(mdl_pitch_medianPostGer)
```

Posterior predictive check.

```{r echo=FALSE, message=FALSE, warning=FALSE}
pp_check(mdl_pitch_medianPostGer, ndraws = 100)

pp_check(mdl_pitch_medianPostGer, type = "error_scatter_avg", ndraws = 100)
```

Extract samples.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of fixed effects
samples_mdl_pitch_medianPostGer <- as_draws_array(mdl_pitch_medianPostGer, 
                                          variable = "^b_", 
                                          regex = TRUE)
samples_mdl_pitch_medianPostGer <- mutate_variables(samples_mdl_pitch_medianPostGer, 
                                                exp_b_percProm0 = exp(b_percProm0), 
                                                exp_b_percProm1 = exp(b_percProm1),
                                                exp_b_percProm2 = exp(b_percProm2),
                                                exp_b_percProm3 = exp(b_percProm3))

# Summarize posterior draws
summarize_draws(samples_mdl_pitch_medianPostGer)
```

Check conditional effect.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Plot conditional effects (fixed effects only)
conditional_effects(mdl_pitch_medianPostGer, re_formula = NA)

# Extract conditional effects data
conditional_effects(mdl_pitch_medianPostGer, plot = FALSE, re_formula = NA)$percProm
```

Compare conditional effects to raw values.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Calculate raw means by percProm level
data_prepost_ger %>% 
  group_by(percProm) %>%
  summarize(avg_pitch_medianPost = mean(pitch_medianPost, na.rm = TRUE))

# Summary of pitch_medianPost
summary(data_prepost_ger$pitch_medianPost)
```

##### Effect comparison

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Compute estimated marginal means on log-scale
em_mdl_pitch_medianPostGer <- emmeans(mdl_pitch_medianPostGer, ~ percProm)
# Backtransform the post.beta values
em_mdl_pitch_medianPostGer@post.beta <- exp(em_mdl_pitch_medianPostGer@post.beta)
print(em_mdl_pitch_medianPostGer)
plot(em_mdl_pitch_medianPostGer)

# Perform pairwise comparisons between levels of percProm
emPairs_mdl_pitch_medianPostGer <- pairs(emmeans(mdl_pitch_medianPostGer, ~ percProm))
# Backtransform the post.beta values
emPairs_mdl_pitch_medianPostGer@post.beta <- exp(emPairs_mdl_pitch_medianPostGer@post.beta)
print(emPairs_mdl_pitch_medianPostGer)
plot(emPairs_mdl_pitch_medianPostGer)
```

If the comparison includes 0, the contrast is not reliably different.

##### Hypothesis testing

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract posterior samples of the fixed effects coefficients
as_draws_df(mdl_pitch_medianPostGer) %>%
  # Select fixed effects for percProm levels
  select(starts_with("b_percProm")) %>%
  # Rename columns to match percProm levels
  rename_with(~ str_replace(.x, "b_percProm", "percProm"), starts_with("b_percProm")) %>%
  # Compute differences between percProm levels
  mutate(
    diff_0_1 = exp(percProm0) - exp(percProm1),
    diff_0_2 = exp(percProm0) - exp(percProm2),
    diff_0_3 = exp(percProm0) - exp(percProm3),
    diff_1_2 = exp(percProm1) - exp(percProm2),
    diff_1_3 = exp(percProm1) - exp(percProm3),
    diff_2_3 = exp(percProm2) - exp(percProm3)
  ) %>%
  # Gather differences into long format
  pivot_longer(
    cols = starts_with("diff_"),
    names_to = "Comparison",
    values_to = "Difference"
  ) %>%
  # Group by comparison to compute summary statistics
  group_by(Comparison) %>%
  summarise(
    Estimate = mean(Difference),
    Est.Error = sd(Difference),
    CI.Lower = quantile(Difference, 0.025),
    CI.Upper = quantile(Difference, 0.975),
    Post.Prob = if_else(Estimate > 0,
                        mean(Difference > 0) * 100,
                        mean(Difference < 0) * 100)
  ) %>%
  ungroup() %>%
  # Add significance stars based on posterior probability
  mutate(
    Star = ifelse(Post.Prob > 95 | Post.Prob < 5, "*", ""),
    Estimate = round(Estimate, 3),
    Est.Error = round(Est.Error, 3),
    CI.Lower = round(CI.Lower, 3),
    CI.Upper = round(CI.Upper, 3),
    Post.Prob = round(Post.Prob, 2)
  ) %>%
  # Select and arrange the final columns
  select(Comparison, Estimate, Est.Error, CI.Lower, CI.Upper, Post.Prob, Star) %>%
  arrange(Comparison)
```

-   **diff_0_1:** Estimate = `0.002` [-0.109, 0.109], Posterior
    Probability = 51.7%; No strong evidence for a difference between
    `percProm0` and `percProm1`, with a posterior probability close to
    chance.

-   **diff_0_2:** Estimate = `-0.08` [-0.190, 0.024], Posterior
    Probability = 93.5%; Moderate evidence that `pitch_medianPost` at
    `percProm0` is slightly lower than at `percProm2`, but not
    conclusive as the credible interval includes zero.

-   **diff_0_3:** Estimate = `-0.076` [-0.191, 0.033], Posterior
    Probability = 91.9%; Moderate evidence suggests a slight decrease in
    `pitch_medianPost` at `percProm3` compared to `percProm0`, though it
    remains inconclusive.

-   **diff_1_2:** Estimate = `-0.081` [-0.113, -0.05], Posterior
    Probability = 100%; Strong evidence of a decrease in
    `pitch_medianPost` from `percProm1` to `percProm2`, as the credible
    interval lies entirely below zero.

-   **diff_1_3:** Estimate = `-0.078` [-0.119, -0.036], Posterior
    Probability = 100%; Strong evidence that `pitch_medianPost` at
    `percProm1` is lower than at `percProm3`, with a negative estimate
    and high posterior probability.

-   **diff_2_3:** Estimate = `0.004` [-0.031, 0.038], Posterior
    Probability = 58.1%; No strong evidence for a difference between
    `percProm2` and `percProm3`.

**Overall Implications:**

-   **Trend:** There is strong evidence of a decreasing trend in
    `pitch_medianPost` from `percProm1` to both `percProm2` and
    `percProm3`. While the comparisons involving `percProm0` are
    inconclusive, these findings suggest that as perceived prominence
    increases, `pitch_medianPost` generally decreases across most
    levels.

##### Plot fixef

Visualize the (non-)linearity of the effect with a violin plot of the
posteriors for each prominence level and a GAMM overlaid on top.

```{r echo=FALSE, message=FALSE, warning=FALSE}
data_prepost_ger %>%
  data_grid(percProm = unique(percProm),
            gender_s = 0.09727) %>% # Set to average of gender
  add_epred_draws(mdl_pitch_medianPostGer, re_formula = NA) %>%
  mutate(
    percProm_num = as.numeric(as.character(percProm)),
    percProm = factor(percProm, levels = c("0", "1", "2", "3"))
  ) %>%
  ggplot(aes(x = percProm_num, y = .epred, color = percProm)) +
  geom_violin(aes(group = percProm_num, fill = percProm), alpha = 0.8) +
  scale_color_manual(values = colorBlindBlack8) +
  scale_fill_manual(values = colorBlindBlack8) +
  stat_summary(fun = median, geom = "point", color = colorBlindBlack8[7], size = 2) +
  geom_smooth(
    aes(group = 1),
    method = "gam",
    formula = y ~ s(x, bs = "cs", k = 4),
    color = colorBlindBlack8[7],
    se = FALSE
  ) +
  scale_x_continuous(
    breaks = 0:3,
    labels = as.character(0:3)
  ) +
  #ylim(1, 5) +
  labs(
    x = "Perceived prominence level",
    y = "Posterior f0 median (post-tonic)"
  ) +
  theme_minimal()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
post_pitch_medianPostGer <- 
  data_prepost_ger %>%
  data_grid(
    percProm = unique(percProm),
    gender_s = 0  # Set gender_s to zero to average over gender
  ) %>%
  add_epred_draws(mdl_pitch_medianPostGer, re_formula = NA) %>%
  mutate(
    percProm = factor(percProm, levels = c("0", "1", "2", "3"))
  ) %>%
  ggplot(aes(y = percProm, x = .epred, fill = percProm)) +
  ggdist::stat_halfeye(
    adjust = 0.5,
    width = 0.6,
    .width = c(0.66, 0.95),
    justification = -0.1,
    point_colour = NA
  ) +
  geom_boxplot(
    width = 0.15,
    outlier.shape = NA,
    alpha = 0.5,
    position = position_nudge(y = 0.2)
  ) +
  stat_summary(
    fun = median,
    geom = "point",
    color = "red",
    size = 2,
    position = position_nudge(y = 0.2)
  ) +
  scale_fill_manual(values = colorBlindBlack8) +
  coord_flip() +
  theme_minimal() +
  theme(text = element_text(size = 18)) +
  labs(
    y = "Perceived prominence level",
    x = "Posterior f0 median (post-tonic)",
    fill = "Perceived\nprominence"
  )

post_pitch_medianPostGer;
ggsave(plot = post_pitch_medianPostGer, filename = paste0(plots, "posterior_pitch_medianPostGer.pdf"), 
       width = 8, height = 6);
ggsave(plot = post_pitch_medianPostGer, filename = paste0(plots, "posterior_pitch_medianPostGer.jpg"), 
       width = 8, height = 6);
ggsave(plot = post_pitch_medianPostGer, filename = paste0(plots, "posterior_pitch_medianPostGer.tif"), 
       width = 8, height = 6, compression="lzw", dpi=600);
```

#### Group-level effects

First, get a general overview.

```{r echo=FALSE, message=FALSE, warning=FALSE}
as.data.frame(VarCorr(mdl_pitch_medianPostGer)$participant$sd) %>%
  rownames_to_column(var = "Random Effect") %>%
  select(`Random Effect`, Estimate, Est.Error, Q2.5, Q97.5)
```

-   **percProm0:** SD = 0.133 (95% CrI: 0.023 to 0.267), indicating
    minor variability in `pitch_medianPost`.

-   **percProm1:** SD = 0.092 (95% CrI: 0.065 to 0.125), suggesting
    lower variability in response at `percProm1`.

-   **percProm2:** SD = 0.079 (95% CrI: 0.059 to 0.105), indicating a
    further decrease in variability compared to `percProm1`.

-   **percProm3:** SD = 0.083 (95% CrI: 0.050 to 0.123), showing
    slightly more variability than `percProm2`.

Extract samples in interpretable units. Then, plot them so that we can
see how each participant uses the levels of percProm.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Extract samples for each participant x percProm
data_prepost_ger %>% 
  data_grid(
    participant = unique(participant),
    percProm = unique(percProm),
    gender_s = 0.09727 # Average over gender
  ) %>% 
  add_epred_draws(mdl_pitch_medianPostGer) %>% 
  median_qi()

# Plot the draws for all participants x percProm levels
data_prepost_ger %>%
  # Start by selecting unique participants and their gender_s
  select(participant, gender_s) %>%
  distinct() %>%
  # Back-transform gender_s to gender labels
  mutate(
    gender = if_else(gender_s == -0.5, "Male", "Female")
  ) %>%
  # Combine with percProm levels
  crossing(
    percProm = unique(data_prepost_ger$percProm)
  ) %>%
  # Generate posterior predictions
  add_epred_draws(mdl_pitch_medianPostGer) %>%
  # Summarize predictions with .66 and .95 intervals
  median_qi(.width = c(.66, .95)) %>%
  ggplot(aes(x = .epred, y = participant, color = percProm, shape = gender)) +
  # Add the thick line for 66% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.66),  # Use 66% credible interval
                 size = 1,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add the thin line for 95% credible interval
  geom_linerange(aes(xmin = .lower, xmax = .upper, group = .width), 
                 data = ~ filter(., .width == 0.95),  # Use 95% credible interval
                 size = 0.5,
                 alpha = 0.8,
                 position = position_dodge2(width = 0.7, padding = 0.5)) +
  # Add points with shapes
  geom_point(position = position_dodge(width = 0.7), size = 2.5) +
  scale_color_manual(values = colorBlindBlack8) +
  labs(
    x = "Posterior f0 median (post-tonic)",
    y = "Participant",
    color = "Perceived prominence",
    shape = "Gender"
  ) +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines")
  )
```

First, we extract individual draws. Here, if the CrI encompasses 0, the
participant does not differ from the overall behavior on this percProm.
Then, we plot random effects for each participant and percProm level on
the model scale, representing deviations from the fixed effects.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# We focus on 95% CrI, but this can be adapted in the width parameter
mdl_pitch_medianPostGer %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95))

# In log without Intercept
mdl_pitch_medianPostGer %>% 
  spread_draws(r_participant[participant,percProm]) %>% 
  median_qi(r_participant, .width = c(.95, .8, .5)) %>%
  ggplot(aes(y = as.factor(participant), x = r_participant, color = percProm, xmin = .lower, xmax = .upper)) +
  geom_pointinterval(
    position = "dodge") +
  scale_color_manual(
    values = colorBlindBlack8) +
  labs(
    x = "Individual deviations in f0 median (post-tonic)",
    y = "Participant",
    color = "Perceived prominence") +
  theme_minimal() +
  facet_wrap(~ participant, ncol = 3, scales = "free_y") +
  theme(
    strip.text = element_blank(),
    panel.spacing = unit(0, "lines") 
  )

```

This concludes the analysis.

# Session info

```{r echo=TRUE, message=FALSE, warning=FALSE}
sessionInfo()
```
